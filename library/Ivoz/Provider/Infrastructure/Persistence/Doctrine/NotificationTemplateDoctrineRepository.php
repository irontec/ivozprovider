<?php

namespace Ivoz\Provider\Infrastructure\Persistence\Doctrine;

use Doctrine\Bundle\DoctrineBundle\Repository\ServiceEntityRepository;
use Ivoz\Provider\Domain\Model\BalanceNotification\BalanceNotificationInterface;
use Ivoz\Provider\Domain\Model\CallCsvReport\CallCsvReportInterface;
use Ivoz\Provider\Domain\Model\Company\CompanyInterface;
use Ivoz\Provider\Domain\Model\Language\LanguageInterface;
use Ivoz\Provider\Domain\Model\NotificationTemplate\NotificationTemplate;
use Ivoz\Provider\Domain\Model\NotificationTemplate\NotificationTemplateInterface;
use Ivoz\Provider\Domain\Model\NotificationTemplate\NotificationTemplateRepository;
use Doctrine\Persistence\ManagerRegistry;

/**
 * NotificationTemplateDoctrineRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class NotificationTemplateDoctrineRepository extends ServiceEntityRepository implements NotificationTemplateRepository
{
    public function __construct(ManagerRegistry $registry)
    {
        parent::__construct($registry, NotificationTemplate::class);
    }

    /**
     * @return null | NotificationTemplateInterface
     */
    public function findCallCsvTemplateByCallCsvReport(CallCsvReportInterface $callCsvReport)
    {
        $template = $this->getNotificationTemplateByReport($callCsvReport);
        $company = $callCsvReport->getCompany();
        $brand = $callCsvReport->getBrand();

        $language = $company
            ? $company->getLanguage()
            : $brand->getLanguage();

        if ($template
            && $template->getContentsByLanguage($language)
        ) {
            return $template;
        }

        /** @var NotificationTemplateInterface $response */
        $response = $this->findOneBy([
            'brand' => null,
            'type' => 'callCsv'
        ]);

        return $response;
    }

    /**
     * @param CallCsvReportInterface $callCsvReport
     * @return NotificationTemplateInterface | null
     */
    private function getNotificationTemplateByReport(CallCsvReportInterface $callCsvReport)
    {
        $company = $callCsvReport->getCompany();
        if ($company) {
            $callCsvNotificationTemplate = $company->getCallCsvNotificationTemplate();
            if (!$callCsvNotificationTemplate) {
                $brand = $company->getBrand();
                $callCsvNotificationTemplate = $brand->getCallCsvNotificationTemplate();
            }
            return $callCsvNotificationTemplate;
        }

        $scheduler = $callCsvReport
            ->getCallCsvScheduler();

        if (!$scheduler) {
            return null;
        }

        return $scheduler->getCallCsvNotificationTemplate();
    }

    /**
     * @param CompanyInterface $company
     * @return NotificationTemplateInterface
     */
    public function findInvoiceNotificationTemplateByCompany(
        CompanyInterface $company
    ) {
        $language = $company->getLanguage();
        $invoiceNotificationTemplate = $company->getInvoiceNotificationTemplate();

        if ($invoiceNotificationTemplate
            && $invoiceNotificationTemplate->getContentsByLanguage($language)
        ) {
            return $invoiceNotificationTemplate;
        }

        /** @var NotificationTemplateInterface $response */
        $response = $this->findOneBy([
            'brand' => null,
            'type' => 'invoice'
        ]);

        return $response;
    }

    /**
     * @return null | NotificationTemplateInterface
     */
    public function findFaxTemplateByCompany(CompanyInterface $company)
    {
        $language = $company->getLanguage();
        $faxNotificationTemplate = $company->getFaxNotificationTemplate();
        if ($faxNotificationTemplate) {
            if ($faxNotificationTemplate->getContentsByLanguage($language)) {
                return $faxNotificationTemplate;
            }
        }

        // no company template associated, fallback to brand notification template for faxes
        $faxNotificationTemplate = $company
            ->getBrand()
            ->getFaxNotificationTemplate();

        if ($faxNotificationTemplate) {
            if ($faxNotificationTemplate->getContentsByLanguage($language)) {
                return $faxNotificationTemplate;
            }
        }

        // use generic template
        /** @var NotificationTemplateInterface $response */
        $response = $this->findOneBy([
            'brand' => null,
            'type' => 'fax'
        ]);

        return $response;
    }

    /**
     * @return null | NotificationTemplateInterface
     */
    public function findMaxDailyUsageTemplateByCompany(CompanyInterface $company)
    {
        $notificationTemplate = $company->getMaxDailyUsageNotificationTemplate();
        if (!$notificationTemplate) {
            $notificationTemplate = $company
                ->getBrand()
                ->getMaxDailyUsageNotificationTemplate();
        }

        $language = $company->getLanguage();
        if (!$language) {
            $language = $company
                ->getBrand()
                ->getLanguage();
        }

        if ($notificationTemplate
            && $notificationTemplate->getContentsByLanguage($language)
        ) {
            return $notificationTemplate;
        }

        /** @var NotificationTemplateInterface $response */
        $response = $this->findOneBy([
            'brand' => null,
            'type' => 'maxDailyUsage'
        ]);

        return $response;
    }

    /**
     * @return null | NotificationTemplateInterface
     */
    public function findGenericVoicemailTemplate()
    {
        /** @var NotificationTemplateInterface $response */
        $response = $this->findOneBy([
            'brand' => null,
            'type' => 'voicemail'
        ]);

        return $response;
    }

    /**
     * @inheritdoc
     * @see NotificationTemplateRepository::findTemplateByBalanceNotification
     */
    public function findTemplateByBalanceNotification(
        BalanceNotificationInterface $balanceNotification,
        LanguageInterface $language
    ) {
        $notificationTemplate = $balanceNotification->getNotificationTemplate();
        if ($notificationTemplate) {
            //make sure we've contents for required language,
            // use default notification template otherwise
            if ($notificationTemplate->getContentsByLanguage($language)) {
                return $notificationTemplate;
            }
        }

        return $this->findOneBy([
            'brand' => null,
            'type' => 'lowbalance'
        ]);
    }
}
