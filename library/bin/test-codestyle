#!/bin/bash

if [ "$1" == "--full" ]; then
    CHANGED_FILES="."
elif [ "$1" == "--branch" ]; then
    # Check if origin/bleeding is available
    git branch -a --list origin/bleeding | grep origin/bleeding >/dev/null
    if [ $? -eq 0 ]; then
        CHANGED_FILES=$(git diff --name-only origin/bleeding --diff-filter=d -- '*.php')
    else
        echo "Can not compare with origin/bleeding. Forcing full check of all files..."
        CHANGED_FILES="."
    fi
else
    CHANGED_FILES=$(git diff --cached --name-only --diff-filter=d -- '*.php')
fi

if [ -z "$CHANGED_FILES" ]; then
    echo "No php files were changed in these commits."
    exit 0
fi

cd /opt/irontec/ivozprovider/
library/vendor/bin/phpcbf -p --standard=PSR12 --extensions=php \
    --ignore='vendor,coverage,var,DoctrineMigrations,config.php' \
    $CHANGED_FILES

