% Generated by Sphinx.
\def\sphinxdocclass{report}
\newif\ifsphinxKeepOldNames \sphinxKeepOldNamestrue
\documentclass[letterpaper,10pt,english]{sphinxmanual}
\usepackage{iftex}

\ifPDFTeX
  \usepackage[utf8]{inputenc}
\fi
\ifdefined\DeclareUnicodeCharacter
  \DeclareUnicodeCharacter{00A0}{\nobreakspace}
\fi
\usepackage{cmap}
\usepackage[T1]{fontenc}
\usepackage{amsmath,amssymb,amstext}
\usepackage{babel}
\usepackage{times}
\usepackage[Sonny]{fncychap}
\usepackage{longtable}
\usepackage{sphinx}
\usepackage{multirow}
\usepackage{eqparbox}

\addto\captionsenglish{\renewcommand{\contentsname}{Basic Concepts}}

\addto\captionsenglish{\renewcommand{\figurename}{Fig.\@ }}
\addto\captionsenglish{\renewcommand{\tablename}{Table }}
\SetupFloatingEnvironment{literal-block}{name=Listing }

\addto\extrasenglish{\def\pageautorefname{page}}




\title{IvozProvider 3.4 Documentation}
\date{May 27, 2025}
\release{halliday}
\author{Irontec}
\newcommand{\sphinxlogo}{}
\renewcommand{\releasename}{Release}
\makeindex

\makeatletter
\def\PYG@reset{\let\PYG@it=\relax \let\PYG@bf=\relax%
    \let\PYG@ul=\relax \let\PYG@tc=\relax%
    \let\PYG@bc=\relax \let\PYG@ff=\relax}
\def\PYG@tok#1{\csname PYG@tok@#1\endcsname}
\def\PYG@toks#1+{\ifx\relax#1\empty\else%
    \PYG@tok{#1}\expandafter\PYG@toks\fi}
\def\PYG@do#1{\PYG@bc{\PYG@tc{\PYG@ul{%
    \PYG@it{\PYG@bf{\PYG@ff{#1}}}}}}}
\def\PYG#1#2{\PYG@reset\PYG@toks#1+\relax+\PYG@do{#2}}

\expandafter\def\csname PYG@tok@gd\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.63,0.00,0.00}{##1}}}
\expandafter\def\csname PYG@tok@gu\endcsname{\let\PYG@bf=\textbf\def\PYG@tc##1{\textcolor[rgb]{0.50,0.00,0.50}{##1}}}
\expandafter\def\csname PYG@tok@gt\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.00,0.27,0.87}{##1}}}
\expandafter\def\csname PYG@tok@gs\endcsname{\let\PYG@bf=\textbf}
\expandafter\def\csname PYG@tok@gr\endcsname{\def\PYG@tc##1{\textcolor[rgb]{1.00,0.00,0.00}{##1}}}
\expandafter\def\csname PYG@tok@cm\endcsname{\let\PYG@it=\textit\def\PYG@tc##1{\textcolor[rgb]{0.25,0.50,0.56}{##1}}}
\expandafter\def\csname PYG@tok@vg\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.73,0.38,0.84}{##1}}}
\expandafter\def\csname PYG@tok@vi\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.73,0.38,0.84}{##1}}}
\expandafter\def\csname PYG@tok@vm\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.73,0.38,0.84}{##1}}}
\expandafter\def\csname PYG@tok@mh\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.13,0.50,0.31}{##1}}}
\expandafter\def\csname PYG@tok@cs\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.25,0.50,0.56}{##1}}\def\PYG@bc##1{\setlength{\fboxsep}{0pt}\colorbox[rgb]{1.00,0.94,0.94}{\strut ##1}}}
\expandafter\def\csname PYG@tok@ge\endcsname{\let\PYG@it=\textit}
\expandafter\def\csname PYG@tok@vc\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.73,0.38,0.84}{##1}}}
\expandafter\def\csname PYG@tok@il\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.13,0.50,0.31}{##1}}}
\expandafter\def\csname PYG@tok@go\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.20,0.20,0.20}{##1}}}
\expandafter\def\csname PYG@tok@cp\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.00,0.44,0.13}{##1}}}
\expandafter\def\csname PYG@tok@gi\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.00,0.63,0.00}{##1}}}
\expandafter\def\csname PYG@tok@gh\endcsname{\let\PYG@bf=\textbf\def\PYG@tc##1{\textcolor[rgb]{0.00,0.00,0.50}{##1}}}
\expandafter\def\csname PYG@tok@ni\endcsname{\let\PYG@bf=\textbf\def\PYG@tc##1{\textcolor[rgb]{0.84,0.33,0.22}{##1}}}
\expandafter\def\csname PYG@tok@nl\endcsname{\let\PYG@bf=\textbf\def\PYG@tc##1{\textcolor[rgb]{0.00,0.13,0.44}{##1}}}
\expandafter\def\csname PYG@tok@nn\endcsname{\let\PYG@bf=\textbf\def\PYG@tc##1{\textcolor[rgb]{0.05,0.52,0.71}{##1}}}
\expandafter\def\csname PYG@tok@no\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.38,0.68,0.84}{##1}}}
\expandafter\def\csname PYG@tok@na\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.25,0.44,0.63}{##1}}}
\expandafter\def\csname PYG@tok@nb\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.00,0.44,0.13}{##1}}}
\expandafter\def\csname PYG@tok@nc\endcsname{\let\PYG@bf=\textbf\def\PYG@tc##1{\textcolor[rgb]{0.05,0.52,0.71}{##1}}}
\expandafter\def\csname PYG@tok@nd\endcsname{\let\PYG@bf=\textbf\def\PYG@tc##1{\textcolor[rgb]{0.33,0.33,0.33}{##1}}}
\expandafter\def\csname PYG@tok@ne\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.00,0.44,0.13}{##1}}}
\expandafter\def\csname PYG@tok@nf\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.02,0.16,0.49}{##1}}}
\expandafter\def\csname PYG@tok@si\endcsname{\let\PYG@it=\textit\def\PYG@tc##1{\textcolor[rgb]{0.44,0.63,0.82}{##1}}}
\expandafter\def\csname PYG@tok@s2\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.25,0.44,0.63}{##1}}}
\expandafter\def\csname PYG@tok@nt\endcsname{\let\PYG@bf=\textbf\def\PYG@tc##1{\textcolor[rgb]{0.02,0.16,0.45}{##1}}}
\expandafter\def\csname PYG@tok@nv\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.73,0.38,0.84}{##1}}}
\expandafter\def\csname PYG@tok@s1\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.25,0.44,0.63}{##1}}}
\expandafter\def\csname PYG@tok@dl\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.25,0.44,0.63}{##1}}}
\expandafter\def\csname PYG@tok@ch\endcsname{\let\PYG@it=\textit\def\PYG@tc##1{\textcolor[rgb]{0.25,0.50,0.56}{##1}}}
\expandafter\def\csname PYG@tok@m\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.13,0.50,0.31}{##1}}}
\expandafter\def\csname PYG@tok@gp\endcsname{\let\PYG@bf=\textbf\def\PYG@tc##1{\textcolor[rgb]{0.78,0.36,0.04}{##1}}}
\expandafter\def\csname PYG@tok@sh\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.25,0.44,0.63}{##1}}}
\expandafter\def\csname PYG@tok@ow\endcsname{\let\PYG@bf=\textbf\def\PYG@tc##1{\textcolor[rgb]{0.00,0.44,0.13}{##1}}}
\expandafter\def\csname PYG@tok@sx\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.78,0.36,0.04}{##1}}}
\expandafter\def\csname PYG@tok@bp\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.00,0.44,0.13}{##1}}}
\expandafter\def\csname PYG@tok@c1\endcsname{\let\PYG@it=\textit\def\PYG@tc##1{\textcolor[rgb]{0.25,0.50,0.56}{##1}}}
\expandafter\def\csname PYG@tok@fm\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.02,0.16,0.49}{##1}}}
\expandafter\def\csname PYG@tok@o\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PYG@tok@kc\endcsname{\let\PYG@bf=\textbf\def\PYG@tc##1{\textcolor[rgb]{0.00,0.44,0.13}{##1}}}
\expandafter\def\csname PYG@tok@c\endcsname{\let\PYG@it=\textit\def\PYG@tc##1{\textcolor[rgb]{0.25,0.50,0.56}{##1}}}
\expandafter\def\csname PYG@tok@mf\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.13,0.50,0.31}{##1}}}
\expandafter\def\csname PYG@tok@err\endcsname{\def\PYG@bc##1{\setlength{\fboxsep}{0pt}\fcolorbox[rgb]{1.00,0.00,0.00}{1,1,1}{\strut ##1}}}
\expandafter\def\csname PYG@tok@mb\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.13,0.50,0.31}{##1}}}
\expandafter\def\csname PYG@tok@ss\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.32,0.47,0.09}{##1}}}
\expandafter\def\csname PYG@tok@sr\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.14,0.33,0.53}{##1}}}
\expandafter\def\csname PYG@tok@mo\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.13,0.50,0.31}{##1}}}
\expandafter\def\csname PYG@tok@kd\endcsname{\let\PYG@bf=\textbf\def\PYG@tc##1{\textcolor[rgb]{0.00,0.44,0.13}{##1}}}
\expandafter\def\csname PYG@tok@mi\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.13,0.50,0.31}{##1}}}
\expandafter\def\csname PYG@tok@kn\endcsname{\let\PYG@bf=\textbf\def\PYG@tc##1{\textcolor[rgb]{0.00,0.44,0.13}{##1}}}
\expandafter\def\csname PYG@tok@cpf\endcsname{\let\PYG@it=\textit\def\PYG@tc##1{\textcolor[rgb]{0.25,0.50,0.56}{##1}}}
\expandafter\def\csname PYG@tok@kr\endcsname{\let\PYG@bf=\textbf\def\PYG@tc##1{\textcolor[rgb]{0.00,0.44,0.13}{##1}}}
\expandafter\def\csname PYG@tok@s\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.25,0.44,0.63}{##1}}}
\expandafter\def\csname PYG@tok@kp\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.00,0.44,0.13}{##1}}}
\expandafter\def\csname PYG@tok@w\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.73,0.73,0.73}{##1}}}
\expandafter\def\csname PYG@tok@kt\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.56,0.13,0.00}{##1}}}
\expandafter\def\csname PYG@tok@sc\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.25,0.44,0.63}{##1}}}
\expandafter\def\csname PYG@tok@sb\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.25,0.44,0.63}{##1}}}
\expandafter\def\csname PYG@tok@sa\endcsname{\def\PYG@tc##1{\textcolor[rgb]{0.25,0.44,0.63}{##1}}}
\expandafter\def\csname PYG@tok@k\endcsname{\let\PYG@bf=\textbf\def\PYG@tc##1{\textcolor[rgb]{0.00,0.44,0.13}{##1}}}
\expandafter\def\csname PYG@tok@se\endcsname{\let\PYG@bf=\textbf\def\PYG@tc##1{\textcolor[rgb]{0.25,0.44,0.63}{##1}}}
\expandafter\def\csname PYG@tok@sd\endcsname{\let\PYG@it=\textit\def\PYG@tc##1{\textcolor[rgb]{0.25,0.44,0.63}{##1}}}

\def\PYGZbs{\char`\\}
\def\PYGZus{\char`\_}
\def\PYGZob{\char`\{}
\def\PYGZcb{\char`\}}
\def\PYGZca{\char`\^}
\def\PYGZam{\char`\&}
\def\PYGZlt{\char`\<}
\def\PYGZgt{\char`\>}
\def\PYGZsh{\char`\#}
\def\PYGZpc{\char`\%}
\def\PYGZdl{\char`\$}
\def\PYGZhy{\char`\-}
\def\PYGZsq{\char`\'}
\def\PYGZdq{\char`\"}
\def\PYGZti{\char`\~}
% for compatibility with earlier versions
\def\PYGZat{@}
\def\PYGZlb{[}
\def\PYGZrb{]}
\makeatother

\renewcommand\PYGZsq{\textquotesingle}

\begin{document}

\maketitle
\tableofcontents
\phantomsection\label{index::doc}



\chapter{Introduction to IvozProvider}
\label{basic_concepts/intro/index::doc}\label{basic_concepts/intro/index:introduction-to-ivozprovider}\label{basic_concepts/intro/index:ivozprovider-official-documentation}
The following sections will serve as general introduction to IvozProvider:


\section{About this documentation}
\label{basic_concepts/intro/about::doc}\label{basic_concepts/intro/about:about-this-documentation}
This documentation describes the process of installation and usage of
IvozProvider, the multi-tenant telephony platform for providers developed
by \href{http://irontec.com}{Irontec}.

This should be the starting point for anyone interested in this solution,
both from the technical point of view and the user one and it's divided
in multiple sections from the basic infrastructure information and configuration
to the final user settings.


\section{Getting help}
\label{basic_concepts/intro/getting_help:getting-help}\label{basic_concepts/intro/getting_help::doc}\label{basic_concepts/intro/getting_help:id1}
IvozProvider is an alive and highly developed project. There are
multiple channels to get information or report bugs.

In order of preference:
\begin{itemize}
\item {} 
GitHub: \url{https://github.com/irontec/ivozprovider}

\item {} 
IRC Channel \href{https://kiwiirc.com/nextclient/irc.libera.chat/\#ivozprovider}{\#ivozprovider} at irc.libera.chat

\item {} 
email: \href{mailto:vozip+ivozprovider@irontec.com}{vozip+ivozprovider@irontec.com}

\item {} 
Twitter: \href{https://twitter.com/irontec}{@irontec}

\end{itemize}

Don't hesitate to contact us for any kind of feedback :)


\section{What is IvozProvider?}
\label{basic_concepts/intro/what_is_ivozprovider::doc}\label{basic_concepts/intro/what_is_ivozprovider:what-is-ivozprovider}
IvozProvider is a {\hyperref[basic_concepts/intro/what_is_ivozprovider:operator\string-oriented]{\sphinxcrossref{\DUrole{std,std-ref}{provider oriented}}}}
{\hyperref[basic_concepts/intro/what_is_ivozprovider:multilevel]{\sphinxcrossref{\DUrole{std,std-ref}{multilevel}}}} {\hyperref[basic_concepts/intro/what_is_ivozprovider:voip]{\sphinxcrossref{\DUrole{std,std-ref}{IP telephony}}}} solution
{\hyperref[basic_concepts/intro/what_is_ivozprovider:exposed]{\sphinxcrossref{\DUrole{std,std-ref}{exposed to the public network}}}}.


\subsection{IP Telephony}
\label{basic_concepts/intro/what_is_ivozprovider:ip-telephony}\label{basic_concepts/intro/what_is_ivozprovider:voip}
IvozProvider supports telephony systems that use \emph{Session Initiation
Protocol}, \textbf{SIP}, described in \href{https://tools.ietf.org/html/rfc3261}{RFC 3261} and any \href{https://www.packetizer.com/ipmc/sip/standards.html}{related RFCs} independent of
manufacturers.

This allows total freedom to choose \emph{softphones}, \emph{hardphones} and the
rest of elements that interact with IvozProvider, without any kind of
binding with a manufacturer.

Right now, IvozProvider supports the following \textbf{transport protocols}
for SIP:
\begin{itemize}
\item {} 
UDP

\item {} 
TCP

\item {} 
TLS

\item {} 
Websockets

\end{itemize}

This last transport protocol described in \href{https://tools.ietf.org/html/rfc7118}{RFC 7118} supports web integrated
softphones, using the \href{https://webrtc.org/}{WebRTC} standard allowing
browsers to establish real-time \emph{peer-to-peer} connections.

The \textbf{supported audio codec} list is:
\begin{itemize}
\item {} 
PCMA (\emph{alaw})

\item {} 
PCMU (\emph{ulaw})

\item {} 
GSM

\item {} 
SpeeX

\item {} 
G.722

\item {} 
G.726

\item {} 
G.729 (manual installation required)

\item {} 
iLBC

\item {} 
\href{http://opus-codec.org/}{OPUS}

\end{itemize}


\subsection{Multilevel}
\label{basic_concepts/intro/what_is_ivozprovider:multilevel}\label{basic_concepts/intro/what_is_ivozprovider:id1}
The web portal design of IvozProvider allows \textbf{multiple actors within the
same infrastructure}:

\noindent\sphinxincludegraphics{{operator_levels}.png}

In {\hyperref[basic_concepts/operation_roles/index:operation\string-roles]{\sphinxcrossref{\DUrole{std,std-ref}{Platform roles}}}} section, the different roles are deeply
described, but to sum up:
\begin{itemize}
\item {} 
\textbf{God Admin}: The administrator and maintainer of the solution. Provides
access to multiple brand operators.

\item {} 
\textbf{Brand Operator}: Responsible of configuring carrier routing, billing and invoicing to
multiple clients.

\item {} 
\textbf{Client Operator}: Responsible of its own configuration and to manage the final platform users.

\item {} 
\textbf{Users}: The last link of the chain, has SIP credentials and can access
its own portal for custom configurations. This level is only available for vPBX client types.

\end{itemize}

\textbf{Each one} of this roles \textbf{has its own portal} that allows them to
fulfill their tasks. Each portal can be customized in the following
ways:
\begin{itemize}
\item {} 
Themes and \emph{skins} for corporate colours.

\item {} 
Client Logos.

\item {} 
Customized URLs with the Brand or Client domain.

\end{itemize}


\subsection{Provider oriented}
\label{basic_concepts/intro/what_is_ivozprovider:operator-oriented}\label{basic_concepts/intro/what_is_ivozprovider:provider-oriented}
IvozProvider is a telephony solution \textbf{designed with horizontal scaling
in mind}. This allows handling a great amount of \textbf{traffic and users}
only by increasing the machines and resources of them.

This are the main ideas that makes this product provider oriented:
\begin{itemize}
\item {} 
Despite the fact that all machine profiles can run in the same host,
what makes it easier for the initial testing, each profile of IvozProvider
can be separated from the rest to make it run in its own machine.

\item {} 
A \textbf{distributed installation} allows to distribute the correct amount of
resources to each task, but also:
\begin{itemize}
\item {} 
Geographic distribution of elements to warranty high availability in
case of CPD failure.

\item {} 
Setup of key elements near the final users, to minimize the communication
latencies.

\item {} 
Horizontal scaling of key profiles to handle hundred of thousands
concurrent calls.

\end{itemize}

\end{itemize}

The resource consuming elements that limit the service of VoIP solutions
use to be:
\begin{itemize}
\item {} 
Already established calls audio management.

\item {} 
Managing configuration for each client administrator (IVRs, conference
rooms, external call filters, etc.)

\item {} 
Databases of configuration and records.

\end{itemize}

IvozProvider was designed always keeping in mind the \textbf{horizontal
scaling} of each of its elements, so it \textbf{can handle thousands concurrent calls}
and what is more important, \textbf{adapt the platform resources to the expected service quality}:
\begin{itemize}
\item {} 
\textbf{Media-relay} servers handle audio frames for the already established
calls:
\begin{itemize}
\item {} 
You can use as many media-relays as you need.

\item {} 
You can join media-relay in groups, and force some clients to use a
group if you want.

\item {} 
You can setup media-relays near the final users, to minimize network
latencies in the calls.

\end{itemize}

\item {} 
\textbf{Application servers} are in charge of processing the configured logic:
\begin{itemize}
\item {} 
They scale horizontally: new Application Serves can be installed and
added to the pool if you feel the need.

\item {} 
Every call is handled by the least busy Application Server

\item {} 
By default, there is no static assignment * between Clients and
Application Servers. This way failure of any Application Server is not
critical: the platform will ignore the faulty Application Server while
distributing calls.

\end{itemize}

\end{itemize}


\subsection{Exposed to the public network}
\label{basic_concepts/intro/what_is_ivozprovider:exposed-to-the-public-network}\label{basic_concepts/intro/what_is_ivozprovider:exposed}
As showed in the installation process, \textbf{IvozProvider is designed to serve
users directly from Internet}. Although it can be used in local
environments, IvozProvider is designed to use public IP addresses for its
services, removing the need of VPN or IPSec tunnels that connect the
infrastructure with the final users

Highlights:
\begin{itemize}
\item {} 
Only the required services will be exposed to Internet.

\item {} 
The untrusted origins access can be filtered out by integrated firewall

\item {} 
Access from IP addresses or networks can be filtered to avoid any kind of
phishing.

\item {} 
There is also an anti-flood mechanism to avoid short-life Denial of
Service attacks.

\item {} 
Each client concurrent calls can be limited to a fixed amount.

\item {} 
IvozProvider supports connection from terminals behind
\href{https://en.wikipedia.org/wiki/Network\_address\_translation}{NAT}.

\item {} 
IvozProvider keep track of those NAT windows and keep them alive with
\emph{nat-piercing} mechanisms.

\end{itemize}


\section{What is inside IvozProvider?}
\label{basic_concepts/intro/what_is_inside::doc}\label{basic_concepts/intro/what_is_inside:what-is-inside-ivozprovider}
IvozProvider uses well-known and stable \href{https://www.gnu.org/philosophy/free-sw.en.html}{Free Software} projects to fulfill
the different required task of the platform.

Nothing better than an image to show all the software that its integrated
into IvozProvider:

\noindent{\hspace*{\fill}\sphinxincludegraphics{{ivozprovider_logos}.png}\hspace*{\fill}}

\begin{notice}{note}{Note:}
We can not stress enough our gratitude to the developers and communities
of this projects.
\end{notice}

The task of each of this software will be deeply detailed in the block
{\hyperref[basic_concepts/architecture/index:architecture]{\sphinxcrossref{\DUrole{std,std-ref}{Platform general architecture}}}}.


\section{Who should use IvozProvider?}
\label{basic_concepts/intro/use_cases::doc}\label{basic_concepts/intro/use_cases:who-should-use-ivozprovider}
IvozProvider is a good option for those interested in having a telephony
platform that can provide service to \textbf{thousands concurrent calls}.

The greatest strengths of IvozProvide can help to decide if the solution
meets your needs:
\begin{itemize}
\item {} 
VoIP: SIP

\item {} 
Multilevel, multitenant

\item {} 
Horizontal scaling

\item {} 
PseudoSBC: open to Internet

\item {} 
Billing and Invoicing engines integrated

\item {} 
PBX Features

\end{itemize}

The installation process is so simple, that the best way to test if
IvozProvider fulfills your needs is to test it!


\chapter{Platform general architecture}
\label{basic_concepts/architecture/index:platform-general-architecture}\label{basic_concepts/architecture/index::doc}\label{basic_concepts/architecture/index:architecture}

\section{General diagram}
\label{basic_concepts/architecture/index:general-diagram}
Following diagram shows the global architecture of IvozProvider solution,
with all its components:

\noindent\sphinxincludegraphics{{flows}.png}

This is a more conceptual diagram:

\noindent\sphinxincludegraphics{{conceptual}.png}


\section{SIP signalling flow}
\label{basic_concepts/architecture/index:sip-signalling-flow}\label{basic_concepts/architecture/index:signallingflow}
The first diagram shows the SIP signalling traffic involved in the
establishment, modification and termination of sessions following the SIP
\href{https://tools.ietf.org/html/rfc3261}{RFC 3261} and any \href{https://www.packetizer.com/ipmc/sip/standards.html}{related RFCs}.

These are the \textbf{external SIP entities} involved:
\begin{itemize}
\item {} 
UACs: users hardphones, softphones, SIP-capable gadget.

\item {} 
SIP carriers/DDI Providers: carriers used to interconnect IvozProvider with external SIP
networks (and, probably, with PSTN).

\end{itemize}

All the SIP traffic (in any of the supported transports: TCP, UDP, TLS, WSS)
they send/receive is to/from this two \textbf{internal SIP entities} of IvozProvider:
\begin{itemize}
\item {} 
Users SIP Proxy (running \href{https://www.kamailio.org}{Kamailio}).

\item {} 
Trunks SIP Proxy (running \href{https://www.kamailio.org}{Kamailio}).

\end{itemize}
\begin{description}
\item[{In fact, users UACs only talk to \emph{Users SIP Proxy} and `SIP carriers' and `DDI}] \leavevmode
Providers' only talk to \emph{Trunks SIP Proxy}.

\end{description}

Inside IvozProvider these two proxies may talk to \emph{Application Servers} running
\href{http://www.asterisk.org/}{Asterisk} for some client types but \textbf{no external
element is allowed to talk to Application Servers directly}.


\section{RTP audio flow}
\label{basic_concepts/architecture/index:rtp-audio-flow}\label{basic_concepts/architecture/index:audioflow}
Sessions initiated by SIP signalling protocol imply media streams shared by
involved entities.

This media streams use \href{https://tools.ietf.org/html/rfc3550}{RTP} to send and
receive the media itself, usually using UDP as a transport protocol.

\textbf{External entities} involved in RTP sessions can be divided in:
\begin{itemize}
\item {} 
Clients endpoints.

\item {} 
Carriers/DDI Providers.

\end{itemize}

Both entities exchanges RTP with the same IvozProvider entity: \emph{media-relays}.

IvozProvider implements \emph{media-relays} using \href{https://github.com/sipwise/rtpengine}{RTPengine}.

Similar to SIP, these \emph{media-relays} exchanges RTP when is needed with
\emph{Application Servers}, but \textbf{external entities never talk directly to them}.


\section{HTTPS traffic}
\label{basic_concepts/architecture/index:https-traffic}
HTTPS is the third traffic type exchanged between IvozProvider and \emph{external
world}.

HTTPS traffic is used for:
\begin{itemize}
\item {} 
\textbf{Terminal provisioning}: several hardphones ask for their configuration when
they wake up and this configuration files can be served through HTTPS.

\item {} 
\textbf{Web portals}: IvozProvider has 4-level web portals for all the
{\hyperref[basic_concepts/operation_roles/index:operation\string-roles]{\sphinxcrossref{\DUrole{std,std-ref}{platform roles}}}}.

Both of these traffics are handled by \emph{Web portals} IvozProvider entity.

\end{itemize}


\section{Additional elements}
\label{basic_concepts/architecture/index:additional-elements}
IvozProvider has multiple elements that are not exposed to the \emph{external world}
but play a crucial task.

The most remarkable profile is \textbf{database profile} that gathers all the
information of the platform and shares it between the majority of software packaged.
IvozProvider uses \href{https://www.mysql.com/}{MySQL database engine} for this task.

Another remarkable task is \textbf{asynchronous tasks handler} in charge of encoding recordings,
generating invoices, reloading services, importing data, etc.


\section{Auxiliary elements}
\label{basic_concepts/architecture/index:auxiliary-elements}
\textbf{Aux profile} runs software that, even though is not vital for calls placing,
makes IvozProvider maintainer's life much easier.

In fact, without them, debugging problems would be much harder and the quality
of given service would be damaged.

Although IvozProvider does not include any of the tools mentioned here, we consider them crucial for dealing with
production environments.

We list here tools configured in all production IvozProvider installations maintained by
\href{https://www.irontec.com}{Irontec}:
\begin{itemize}
\item {} 
\textbf{Homer SIP capture}: This amazing software lets us capture all the SIP traffic
for later analysis, for obtaining statistics, call quality measuring, etc.
Visit \href{http://sipcapture.org/}{SIP Capture website} for more information.

\item {} 
\textbf{Kibana log viewer}: Showing logs collected by remaining \href{https://www.elastic.co/elk-stack}{ELK stack components}.

\item {} 
\textbf{Chronograf metric viewer}: Showing metrics collected by remaining \href{https://www.influxdata.com/time-series-platform/}{TICK stack components}.

\end{itemize}


\chapter{Initial Installation}
\label{basic_concepts/installation/index::doc}\label{basic_concepts/installation/index:initial-installation}

\section{Installation Types}
\label{basic_concepts/installation/install_types::doc}\label{basic_concepts/installation/install_types:installation-types}\phantomsection\label{basic_concepts/installation/install_types:distributed-install}

\subsection{Distributed Install}
\label{basic_concepts/installation/install_types:distributed-install}\label{basic_concepts/installation/install_types:instalacion-distribuida}\label{basic_concepts/installation/install_types:id1}
IvozProvider software is designed to run distributed between multiple systems
in what we call profiles:

Each profile is in charge of performing one of the platform functions:
\begin{itemize}
\item {} 
Data storage

\item {} 
SIP Proxy

\item {} 
Application Server

\item {} 
Web portal

\end{itemize}

For each of this profiles, there's a virtual package that will install all the
required dependencies (see {\hyperref[basic_concepts/installation/debian_install:installing\string-profile\string-package]{\sphinxcrossref{\DUrole{std,std-ref}{Installing profile package}}}}).

You can install as many instances as you want for each profile, but take into
account, that while some of them are designed to scale horizontally (for
example: asterisk or media-relays) others will require additional software so the
systems that have the same profile are synchronized (for example: database
replication or http request balancing).
\phantomsection\label{basic_concepts/installation/install_types:standalone-install}

\subsection{StandAlone Install}
\label{basic_concepts/installation/install_types:instalacion-standalone}\label{basic_concepts/installation/install_types:id2}\label{basic_concepts/installation/install_types:standalone-install}
If you want a small installation to make a couple of tests or give a basic
service, we have designed all this configuration so they can work in a single
machine.

We have called this kind of installations \textbf{StandAlone} and we have also
created {\hyperref[basic_concepts/installation/cd_install:automatic\string-iso\string-cd\string-image]{\sphinxcrossref{\DUrole{std,std-ref}{Automatic ISO CD image}}}} so you can install in a couple of minutes.
\phantomsection\label{basic_concepts/installation/requirements:minimum-requirements}

\section{Minimum requirements}
\label{basic_concepts/installation/requirements:requisitos-minimos}\label{basic_concepts/installation/requirements:id1}\label{basic_concepts/installation/requirements::doc}\label{basic_concepts/installation/requirements:minimum-requirements}

\subsection{System requirements}
\label{basic_concepts/installation/requirements:system-requirements}
IvozProvider is designed to be installed using Debian GNU/Linux APT package
system.

\begin{notice}{important}{Important:}
It's recommended to install IvozProvider in a dedicated server
for the platform. Many of the installed software may not work properly with
other pre-installed services (like MySQL or DNS servers).
\end{notice}

For a StandAlone installation, we recommend at least:
\begin{itemize}
\item {} 
4 CPUs (x86\_64 or i386)

\item {} 
4 Gb memory

\item {} 
30GB HDD

\item {} 
1/2 public IP Addresses (read note behind)

\end{itemize}

\begin{notice}{note}{Note:}
It is possible to make both KamUsers and KamTrunks
share a unique public IP address. If so, \textbf{KamTrunks ports will be changed
from 5060 (TCP/UDP) to 7060 (TCP/UDP) and from 5061 (TCP) to 7061 (TCP)}.
\end{notice}

If you're not using a {\hyperref[basic_concepts/installation/cd_install:automatic\string-iso\string-cd\string-image]{\sphinxcrossref{\DUrole{std,std-ref}{Automatic ISO CD image}}}} you will also need:
\begin{itemize}
\item {} 
Debian Bullseye 11.0 base install

\item {} 
Internet access

\end{itemize}


\section{Debian packages install}
\label{basic_concepts/installation/debian_install::doc}\label{basic_concepts/installation/debian_install:debian-packages-install}
IvozProvider is designed to be installed and updated using Debian packages.
More exactly, the current release is ready to be installed on
\href{https://www.debian.org/releases/bullseye}{Debian Bullseye 11}.

It's recommended to use one of the \href{https://www.debian.org/releases/bullseye/installmanual}{official installation guides} to install the minimum
base system. The rest of required  dependencies will be installed automatically
with IvozProvider meta packages.

No matter if you are installing a {\hyperref[basic_concepts/installation/install_types:standalone\string-install]{\sphinxcrossref{\DUrole{std,std-ref}{StandAlone Install}}}} or a
{\hyperref[basic_concepts/installation/install_types:distributed\string-install]{\sphinxcrossref{\DUrole{std,std-ref}{Distributed Install}}}}, it's required to configure Irontec debian
repositories.


\subsection{APT Repository configuration}
\label{basic_concepts/installation/debian_install:apt-repository-configuration}
Right now, two different repositories are used for the latest IvozProvider
release (called halliday) and it's frontend Klear release (called tayler).

\begin{Verbatim}[commandchars=\\\{\}]
\PYG{g+go}{cd /etc/apt/sources.list.d}
\PYG{g+go}{echo deb http://packages.irontec.com/debian halliday main extra \PYGZgt{} ivozprovider.list}
\PYG{g+go}{echo deb http://packages.irontec.com/debian tayler main \PYGZgt{} klear.list}
\end{Verbatim}

Optionally, we can add the repository key to check signed packages:

\begin{Verbatim}[commandchars=\\\{\}]
\PYG{g+go}{wget http://packages.irontec.com/public.key \PYGZhy{}q \PYGZhy{}O \PYGZhy{} \textbar{} apt\PYGZhy{}key add \PYGZhy{}}
\end{Verbatim}
\phantomsection\label{basic_concepts/installation/debian_install:installing-profile-package}

\subsection{Installing profile package}
\label{basic_concepts/installation/debian_install:instalar-el-paquete-del-rol}\label{basic_concepts/installation/debian_install:installing-profile-package}\label{basic_concepts/installation/debian_install:id1}
Once the repositories are configured, it will be required to select the proper
metapackage depending on the type of installation.
\begin{itemize}
\item {} \begin{description}
\item[{For a {\hyperref[basic_concepts/installation/install_types:standalone\string-install]{\sphinxcrossref{\DUrole{std,std-ref}{StandAlone Install}}}}:}] \leavevmode\begin{itemize}
\item {} 
ivozprovider

\end{itemize}

\end{description}

\end{itemize}

\begin{Verbatim}[commandchars=\\\{\}]
\PYG{g+go}{apt\PYGZhy{}get update}
\PYG{g+go}{apt\PYGZhy{}get install ivozprovider}
\end{Verbatim}
\begin{itemize}
\item {} 
For a {\hyperref[basic_concepts/installation/install_types:distributed\string-install]{\sphinxcrossref{\DUrole{std,std-ref}{Distributed Install}}}}: one of the profile packages depending on the
role the machine will perform.
\begin{itemize}
\item {} 
ivozprovider-profile-data

\item {} 
ivozprovider-profile-proxy

\item {} 
ivozprovider-profile-portal

\item {} 
ivozprovider-profile-as

\end{itemize}

\end{itemize}

\begin{notice}{attention}{Attention:}
Distributed installation require a couple manual configuration based on the
roles that are performing. Take into account that distributed installation process
is not documented yet. You can refer to \href{https://github.com/irontec/ivozprovider/issues/271}{documentation request} for more information.
\end{notice}


\subsection{Finish the installation}
\label{basic_concepts/installation/debian_install:finish-the-installation}
Standalone installation have a menu that can be used to configure the basic
services used in IvozProvider. Most of the services are automatically configured
to work in the same machine with the default values.

This menu allows:
\begin{itemize}
\item {} 
Configure IP address(es) for SIP proxies

\item {} 
Default platform language

\item {} 
Administrator MySQL database password

\end{itemize}

It's possible to change any of this values anytime by running:

\begin{Verbatim}[commandchars=\\\{\}]
\PYG{g+go}{dpkg\PYGZhy{}reconfigure ivozprovider}
\end{Verbatim}

\begin{notice}{important}{Important:}
Any of the public IP addresses configured during the
installation will work to access the web portal. Default credentials are
\textbf{admin / changeme}.
\end{notice}

\begin{notice}{important}{Important:}
You must reboot your machine after a package installation in order to start
all required services.
\end{notice}
\phantomsection\label{basic_concepts/installation/cd_install:automatic-iso-cd-image}

\section{Automatic ISO CD image}
\label{basic_concepts/installation/cd_install::doc}\label{basic_concepts/installation/cd_install:automatic-iso-cd-image}\label{basic_concepts/installation/cd_install:cds-automaticos-de-instalacion}\label{basic_concepts/installation/cd_install:id1}
You can download one of the \href{https://github.com/irontec/ivozprovider}{IvozProvider Automatic ISO CD images} (generated using
\href{https://wiki.debian.org/Simple-CDD}{simplecdd}) in stable or nightly versions:

\begin{notice}{important}{Important:}
IMPORTANT: Automatic install CDs will format target machine disk!
\end{notice}
\begin{itemize}
\item {} 
Configure the target machine to boot from CD. It will display the Debian
GNU/Linux installation menu.

\end{itemize}

\begin{notice}{note}{Note:}
You can use graphic installation if you prefer, but the following
screenshots show the standard installation.
\end{notice}

\noindent\sphinxincludegraphics{{installcd-intro}.png}
\begin{itemize}
\item {} 
Choose installation language:

\end{itemize}

\noindent\sphinxincludegraphics{{installcd-language}.png}
\begin{itemize}
\item {} 
Choose location:

\end{itemize}

\noindent\sphinxincludegraphics{{installcd-location}.png}
\begin{itemize}
\item {} 
Set root password

\end{itemize}

\noindent\sphinxincludegraphics{{installcd-rootpass}.png}
\begin{itemize}
\item {} 
Choose date and time configuration:

\end{itemize}

\noindent\sphinxincludegraphics{{installcd-clock}.png}

\begin{notice}{note}{Note:}
At this point, a generic network configuration and disk partitioning
will be performed, and also a installation of base system.
\end{notice}
\begin{itemize}
\item {} 
Setup MySQL Server root password

\end{itemize}

\noindent\sphinxincludegraphics{{installcd-mysqlpass}.png}

\begin{notice}{important}{Important:}
MySQL password must be set in this screen and again in the following
Ivozprovider configuration menu. If you leave this field empty, the default password
will be used (see below).
\end{notice}
\begin{itemize}
\item {} 
Configure IvozProvider:

\end{itemize}

\noindent\sphinxincludegraphics{{installcd-ivozmenu}.png}

As mentioned in {\hyperref[basic_concepts/installation/requirements:minimum\string-requirements]{\sphinxcrossref{\DUrole{std,std-ref}{Minimum requirements}}}} is required at least one public IP
address for User and Trunk SIP proxies. Remember that if you use only one,
KamTrunks will use different SIP ports to avoid collision.

You can set its addresses right now and configure the interfaces properly when
the system is fully installed. This menu can be displayed anytime after the
installation.

\noindent\sphinxincludegraphics{{installcd-proxyaddr}.png}

You can also configure default root MySQL password right now.

\begin{notice}{note}{Note:}
If you don't configure MySQL password, default password will be used
(changeme). You can still change it later.
\end{notice}

\noindent\sphinxincludegraphics{{installcd-mysql}.png}

And default language for portals:

\noindent\sphinxincludegraphics{{installcd-portallang}.png}

\begin{notice}{note}{Note:}
It is not require to configure all settings during initial
installation. In case any setting has been left without configuration a
warning dialog will be displayed.
\end{notice}

\noindent\sphinxincludegraphics{{installcd-warning}.png}

At last, select where the GRUB boot loader will be installed.

\noindent\sphinxincludegraphics{{installcd-grub}.png}

After the reboot, you are ready to access using the web portals!

\begin{notice}{important}{Important:}
Any of the public IP addresses configured during the
installation will work to access the web portal. Default credentials are
\textbf{admin / changeme}.
\end{notice}


\section{Extra components}
\label{basic_concepts/installation/extra_components::doc}\label{basic_concepts/installation/extra_components:extra-components}

\subsection{G.729}
\label{basic_concepts/installation/extra_components:g-729}
\begin{notice}{attention}{Attention:}
G.729 codec is offered by default for outgoing external calls. If you
don't install it using following instructions, it must be removed from pjsip.conf
configuration file. Otherwise, application servers will be offering a not available codec.
\end{notice}

\begin{notice}{important}{Important:}
In some countries, you might have to pay royalty fees in order to
use G.729 codec to their patent holders. We're not legal advisers regarding
active or withdrawn world patents.
\end{notice}

You can use G.729 with IvozProvider, but installation must be done manually.
G.729 codec is optimized for each CPU type and version of asterisk, so each
installation may require a different codec module.

You can download codec from \href{http://asterisk.hosting.lv/}{here} under the
section Asterisk 18.

Once downloaded, move the \sphinxtitleref{.so} file to \textbf{/usr/lib/asterisk/modules/} and rename
it to \textbf{codec\_g729.so}

You can check the codec is valid by loading the module in asterisk and printing the
available codec translations using:

\begin{Verbatim}[commandchars=\\\{\}]
\PYG{g+go}{asterisk \PYGZhy{}rx \PYGZsq{}module load codec\PYGZus{}g729.so\PYGZsq{}}
\PYG{g+go}{asterisk \PYGZhy{}rx \PYGZsq{}core show translation\PYGZsq{} \textbar{} grep 729}
\end{Verbatim}


\chapter{Platform roles}
\label{basic_concepts/operation_roles/index:operation-roles}\label{basic_concepts/operation_roles/index::doc}\label{basic_concepts/operation_roles/index:platform-roles}
IvozProvider is a multilevel role provider solution.

The following images shows the different available levels and the
relation between them:

\noindent\sphinxincludegraphics{{operator_levels2}.png}

This section will explain each of the available roles, describing their
responsibilities and more important tasks.


\section{Global administrator role}
\label{basic_concepts/operation_roles/index:global-administrator-role}
The global administrator role (operator in the image) is usually done by
the installation responsible.

All options and platform features are visible to this role and usually is
in charge of its maintenance.

Their most important task is to \textbf{create Brands} and configure them so
they have the enough autonomy to properly use the platform:
\begin{itemize}
\item {} 
Configure their web access.

\item {} 
Configure their brand portal look and feel: themes, colors, etc.

\end{itemize}

Apart from their main task, their global visibility and total access
makes them responsible of:
\begin{itemize}
\item {} 
Monitor the platform so it keeps always UP \& RUNNING

\item {} 
Analyze platform logs to track possible errors.

\item {} 
Polish the security mechanisms to avoid external attacks.

\item {} 
Obtain global statistics of calls audio quality.

\item {} 
Increase the available resources of the platform as long as is needed:
\begin{itemize}
\item {} 
Increasing resources available in a standalone installation

\item {} 
Migrating, whenever required, to a distributed installation with multiple
AS, media relays, etc.

\end{itemize}

\end{itemize}

To sum up, \textbf{this role is the only one that has no limits within the
platform}, that's why \emph{God} is a term used in multiple places along this
documentation.

\begin{notice}{important}{Important:}
\emph{This role is responsible of maintaining the platform*}, configuring
it for the correct behaviour. This role \textbf{doesn't have any kind
of limit} and \textbf{grants access} to the \textbf{brand operators}.
\end{notice}


\section{Brand administrator role}
\label{basic_concepts/operation_roles/index:brand-administrator-role}
Brand operator can access a portal with less sections available compared
to the previous role. The general (God) administrator is in charge of
providing an URL with credentials for its brand portal.

The most important task for brand operator is to \textbf{create and configure
clients so they can work properly}.

Due to brand operators are also responsible of billing their clients and
make sure the external calls are properly setup, it must also manage:
\begin{itemize}
\item {} 
Peering contracts with other IP providers for PSTN interconnection.

\item {} 
Include all required client information for the billing process.

\item {} 
Pricing plans that will offer to their clients, that will determine how
match they pay for each call.

\item {} 
Setup the routes for each outgoing call types based on their final
destination

\item {} 
Create the invoices for each billing period and send them to their
clients.

\end{itemize}

As you can see, the task of brand operator has little in common with the
global operator, but their importance is vital so the final users can use
all the features includes in IvozProvider
\phantomsection\label{basic_concepts/operation_roles/index:brand-responsibilities}
\begin{notice}{important}{Important:}
\textbf{To sum up}, brand operators \textbf{grant access} to their
\textbf{clients} administrators and \textbf{configure the platform
to route and rate their calls}.
\end{notice}


\section{Client administrator role}
\label{basic_concepts/operation_roles/index:client-administrator-role}
The client administrator has access to the portal supplied by the brand
operator.

From its point of view, it has a virtual pbx in the cloud that must
configure for its users.

To accomplish that, it's required:
\begin{itemize}
\item {} 
Configure terminals, extensions and users.

\item {} 
Configure the DDI incoming process with the proper logic:
\begin{itemize}
\item {} 
Directly to an user

\item {} 
IVRs

\item {} 
Hunt groups

\item {} 
Faxes

\end{itemize}

\item {} 
Give access to the final users to their web portal, so they can configure
their profile options:
\begin{itemize}
\item {} 
Call forward

\item {} 
Do not disturb

\item {} 
Call waiting

\end{itemize}

\end{itemize}

\begin{notice}{important}{Important:}
To sum up, the client administrators are responsible for
\textbf{configuring the telephony system and make use of all the
features available in IvozProvider}.
\end{notice}


\section{Final user role}
\label{basic_concepts/operation_roles/index:final-user-role}
The final user has two different kinds of credentials, both supplied by
its client administrator:
\begin{itemize}
\item {} 
User portal access credentials

\item {} 
SIP credentials used to register terminals to IvozProvider

\end{itemize}

Through the user portal, it can browse their call registry and configure:
\begin{itemize}
\item {} 
Call forward

\item {} 
Do not disturb

\item {} 
Call waiting

\item {} 
Displayed data when calling

\item {} 
Geographical configuration

\end{itemize}

On the other hand, the SIP credentials allow users to configure their terminals to place and receive calls.

\begin{notice}{note}{Note:}
The same SIP credentials can be used in multiple devices at the same
time,generating what is known as \emph{parallel-forking}: whenever a call is
placed to an user, all the active devices will ring so the user can
answer the call from any of them.
\end{notice}


\chapter{Making internal calls}
\label{getting_started/internal_calls/index:making-internal-calls}\label{getting_started/internal_calls/index::doc}
The goal of this block will be to configure IvozProvider in order to make
internal calls, using as the starting point the base installation described
in the previous step.

In order to achieve making a call between Alice and Bob, we have to fulfill some tasks in
the three configuration levels described in {\hyperref[basic_concepts/operation_roles/index:operation\string-roles]{\sphinxcrossref{\DUrole{std,std-ref}{Platform roles}}}}.

That's why we have ordered the index in these 3 blocks:


\section{Global Configuration}
\label{getting_started/internal_calls/god_portal:global-configuration}\label{getting_started/internal_calls/god_portal::doc}
\begin{notice}{important}{Important:}
Any of the 2 Public IP addresses configured during the
installation will work to access the web portal. Default credentials are
\textbf{admin / changeme}.
\end{notice}

In this section will reference global administrator configuration options,
available in the menu (\textbf{Main management}) of the web portal (only visible to
God Admins):


\subsection{Emulate the Demo brand}
\label{getting_started/internal_calls/god_portal:emulate-the-demo-brand}
As mentioned above, the initial installation will have an already created brand
called DemoBrand, that will be used for our goal: to have 2 telephones registered
that can call each other.

Before going to the next section, is quite important to understand how the
\textbf{emulation} works.
\begin{itemize}
\item {} 
As global operator, you have access to the menu \textbf{Global Configuration} only
visible to \emph{God} administrators.

\item {} 
Apart from that menu, you will also have access to the \textbf{Brand Configuration}
and \textbf{Client configuration} blocks.

\item {} 
Last two blocks have a red button in the right side.

\item {} 
When pressed, a popup will be displayed that lists all existing brands / clients.

\item {} 
After selecting the DemoBrand brand, the icon will change.

\item {} 
The upper right corner of the portal will also display the brand that is being
emulated.

\end{itemize}


\subsection{What emulation means}
\label{getting_started/internal_calls/god_portal:what-emulation-means}
Basically, that \textbf{everything in the menu `Brand configuration' will be relative
to the chosen brand} and is \textbf{exactly} the same menu entries that the brand
operator will see using its brand portal.

\begin{notice}{tip}{Tip:}
Ok, ok, maybe exactly is not totally accurate. The global operator is
able to see some fields in some screens that other admins can't (i.e. On
Client edit screen, fields like `Media relays' or `Application server' are
only configurable by the global operator.
\end{notice}


\section{Brand Configuration}
\label{getting_started/internal_calls/brand_portal::doc}\label{getting_started/internal_calls/brand_portal:brand-configuration}\label{getting_started/internal_calls/brand_portal:id1}
We need that the default DemoBrand has a client with at least 2 users. In
order to achieve this we will require a little configuration in this section.

In fact, if we check \textbf{Virtual PBXs} in the brand menu, we'll discover that there
is already an existing \emph{DemoCompany} that we can use to fulfill our desired
goal :)

Only a thing is required to configure for this client, pressing \textbf{Edit client} option.
\phantomsection\label{getting_started/internal_calls/brand_portal:domain-per-client}

\subsection{Client SIP Domain}
\label{getting_started/internal_calls/brand_portal:domain-per-client}\label{getting_started/internal_calls/brand_portal:id2}\label{getting_started/internal_calls/brand_portal:client-sip-domain}
As mentioned in the previous section, is \textbf{required} that each of the vPBX clients
has a public domain that resolves to the configured IP address for
{\hyperref[administration_portal/platform/infrastructure/proxy_users:proxyusers]{\sphinxcrossref{\DUrole{std,std-ref}{Proxy Users}}}}.

\begin{notice}{note}{Note:}
DNS register can be type A (supported by all the hardphones/softphones
) or even NAPTR+SRV.
\end{notice}

Once the domain has been configured (by means that are out of scope of this
document), it will be enough to write it in our client configuration \textbf{SIP Domain} field.

Once the client has been saved, the domain will be also displayed in the list in the column \textbf{SIP domain}.

\begin{notice}{attention}{Attention:}
It's important to understand this block. {\hyperref[getting_started/internal_calls/brand_portal:dnshack]{\sphinxcrossref{\DUrole{std,std-ref}{Unless we've a
single client registered}}}}, without a DNS domain pointing to our
users proxy IP address, everything will fail.
\end{notice}

\begin{notice}{danger}{Danger:}
Have we repeated enough that without a properly configured DNS
pointing to the Users proxy IP address nothing will work?
\end{notice}


\subsubsection{I have no time for a DNS registry}
\label{getting_started/internal_calls/brand_portal:dnshack}\label{getting_started/internal_calls/brand_portal:i-have-no-time-for-a-dns-registry}
Everything we have said is true: as we create new brands and brands create new
clients, each of them will need a DNS registry.

But the first client of the platform is quite special and can take over the IP
address of the proxy to use it as a domain.

Although it is not a domain, but being used like it was, it will be displayed
in {\hyperref[administration_portal/platform/sip_domains:sip\string-domains]{\sphinxcrossref{\DUrole{std,std-ref}{SIP domains}}}} section.

\begin{notice}{tip}{Tip:}
It’s important to understand the this trick is only valid for the first
client of the platform ;)
\end{notice}


\subsection{Emulate Demo client}
\label{getting_started/internal_calls/brand_portal:emulate-client}\label{getting_started/internal_calls/brand_portal:emulate-demo-client}
The client emulation process is the same as the brand emulation, with the
difference that it filters the block ‘Client Configuration’ instead of
‘Brand Configuration’.

Once the client has been emulated, the top right corner of the portal will
show that we are in the right path :)


\section{Client Configuration}
\label{getting_started/internal_calls/client_portal:client-configuration}\label{getting_started/internal_calls/client_portal::doc}\label{getting_started/internal_calls/client_portal:id1}
We're close to make our fist call in our fresh installed IvozProvider, there
are only 6 steps to configure in our DemoClient virtual pbx.
\begin{itemize}
\item {} 
2 terminals

\item {} 
2 extensions

\item {} 
2 users

\end{itemize}


\subsection{Creating Terminals}
\label{getting_started/internal_calls/client_portal:creating-terminals}
Go to the terminal section and... voilà! We already have 2 terminals created.


\subsection{Creating Extensions}
\label{getting_started/internal_calls/client_portal:creating-extensions}
Then we go to extensions, just to check that we have 2 extensions already
created for us.

Nothing more to do in this section, let's go the next one!


\subsection{Creating Users}
\label{getting_started/internal_calls/client_portal:creating-users}
As expected, we also have 2 created users with previous extensions and terminals assigned.

At this point, we have everything ready make a call between this two users: Alice and Bob.


\section{SIP Terminal configuration}
\label{getting_started/internal_calls/configure_sipuacs:sip-terminal-configuration}\label{getting_started/internal_calls/configure_sipuacs::doc}
The last thing we need is 2 SIP terminals (hardphones, softphones or even
mobile applications) and configure them as follows:

\textbf{ALICE}
\begin{itemize}
\item {} 
\textbf{User}: alice

\item {} 
\textbf{Password}: alice

\item {} 
\textbf{Domain}: users.democlient.com (or the IP if we are using {\hyperref[getting_started/internal_calls/brand_portal:dnshack]{\sphinxcrossref{\DUrole{std,std-ref}{the DNS
trick}}}})

\end{itemize}

\textbf{BOB}
\begin{itemize}
\item {} 
\textbf{User}: bob

\item {} 
\textbf{Password}: bob

\item {} 
\textbf{Domain}: users.democlient.com (or the IP if we are using {\hyperref[getting_started/internal_calls/brand_portal:dnshack]{\sphinxcrossref{\DUrole{std,std-ref}{the DNS
trick}}}})

\end{itemize}

\begin{notice}{tip}{Tip:}
Sometimes the user and domain is configured in a single option. In this
case we should enter \href{mailto:alice@users.democlient.com}{alice@users.democlient.com} and \href{mailto:bob@users.democlient.com}{bob@users.democlient.com}
(or the IP if we are using {\hyperref[getting_started/internal_calls/brand_portal:dnshack]{\sphinxcrossref{\DUrole{std,std-ref}{the DNS trick}}}})
\end{notice}

After configuring the terminals, Alice should be able to call Bob only by
dialing 102 in her terminal.


\chapter{Receiving external calls}
\label{getting_started/external_incoming_calls/index::doc}\label{getting_started/external_incoming_calls/index:receiving-external-calls}
The goal of this block will be configure IvozProvider to receive incoming
external calls.

In order to achieve this, this steps will be followed:


\section{Transformations configuration}
\label{getting_started/external_incoming_calls/transformations:transformations-configuration}\label{getting_started/external_incoming_calls/transformations::doc}
\textbf{IvozProvider} is designed to provide service \textbf{anywhere in the planet}, not
only the original country where the platform is installed.

A very important concept to achieve this goal are the numeric transformations,
that \textbf{adapts the different number format systems of the countries of the world}
defined in \href{https://www.itu.int/rec/T-REC-E.164/es}{E.164} \textbf{to a neutral
format}.

The section that allows the brand operator to configure all the \textbf{numeric
transformations} is \textbf{Brand Configuration / Providers / Numeric transformations}.

You can find more information about transformations in {\hyperref[administration_portal/brand/settings/numeric_transformations:numeric\string-transformations]{\sphinxcrossref{\DUrole{std,std-ref}{Numeric transformations}}}} section.

\begin{notice}{tip}{Tip:}
We already have a pre-created set for most of the countries of the world, so hopefully nothing needs to be done here.
\end{notice}


\section{Peering configuration}
\label{getting_started/external_incoming_calls/peering:peering-configuration}\label{getting_started/external_incoming_calls/peering::doc}
We understand a \textbf{Peering contract} the agreement between a \textbf{Brand Operator}
and a VoIP Provider to make and receive calls.

We divide Peerings in two types:
\begin{itemize}
\item {} 
\textbf{Carriers} for outgoing calls (see {\hyperref[administration_portal/brand/providers/carriers:carriers]{\sphinxcrossref{\DUrole{std,std-ref}{Carriers}}}}).

\item {} 
\textbf{DDI Providers} for incoming calls (see {\hyperref[administration_portal/brand/providers/ddi_providers:ddi\string-providers]{\sphinxcrossref{\DUrole{std,std-ref}{DDI Providers}}}}).

\end{itemize}

In order to achieve our goal, we will need to create a new (an valid) DDI Provider assign our country's
numeric transformation. See {\hyperref[administration_portal/brand/providers/ddi_providers:ddi\string-providers]{\sphinxcrossref{\DUrole{std,std-ref}{DDI Providers}}}} for further reference.

Once we have an agreement with a DDI provider and we have configured it in
the previous section, only two task are pending:


\section{Configuring an external DDI}
\label{getting_started/external_incoming_calls/configure_ddi:settingup-ddi}\label{getting_started/external_incoming_calls/configure_ddi:configuring-an-external-ddi}\label{getting_started/external_incoming_calls/configure_ddi::doc}
The brand operator, responsible of these \emph{peering} agreements with VoIP providers,
has the task to create the DDIs for each client.

Notice that in order to access this section, the brand operator (or \emph{god})
must have emulated the proper client and access the menu section \textbf{Client
Configuration}.

\begin{notice}{attention}{Attention:}
Section \textbf{Client configuration \textgreater{} DDIs} is different when the
client administrator access than the displayed data when a global or brand
administrator does. Client administrator are unable to create or delete
DDIs, just edit the one created by the brand or god administrator.
\end{notice}

Taking into account these concepts, we create a new DDI and fill the required
fields.

For detailed information about configuration fields, check {\hyperref[administration_portal/client/vpbx/ddis:pbx\string-ddis]{\sphinxcrossref{\DUrole{std,std-ref}{DDIs}}}} section.
\paragraph{Configure incoming routes}

In the previous section, we have created the DDI and configure it (pointing it to user Alice),
but \textbf{the most common procedure} is that the brand operator just creates the DDI while the
\textbf{client administrator}, using the same section, \textbf{configures} it choosing
the correct route (user, hunt group, etc.), calendars filters and so on.

\begin{notice}{note}{Note:}
At this point, calling the number of the configured DDI will make the
\emph{Alice} phone ring.
\end{notice}


\chapter{Making external calls}
\label{getting_started/external_outgoing_calls/index:making-external-calls}\label{getting_started/external_outgoing_calls/index::doc}
The goal of this section is configuring IvozProvider to make external outgoing
calls, taking previous section configuration as a starting point.

We will follow these steps:


\section{Create a new carrier}
\label{getting_started/external_outgoing_calls/create_carrier:create-a-new-carrier}\label{getting_started/external_outgoing_calls/create_carrier::doc}
At this point of the configuration, we have to configure IvozProvider to receive
calls using a DDI Provider, but we have not configured a Carrier to make external call.

\begin{notice}{tip}{Tip:}
VoIP Providers will usually provide both services: making and receiving calls.
\end{notice}

Configure a Carrier in a similar way we configured the DDI Provider (further instructions {\hyperref[administration_portal/brand/providers/carriers:carriers]{\sphinxcrossref{\DUrole{std,std-ref}{here}}}}),
assigning it the same numeric transformation set.


\section{Where do I call?}
\label{getting_started/external_outgoing_calls/where_do_i_call::doc}\label{getting_started/external_outgoing_calls/where_do_i_call:where-do-i-call}
At this point of the configuration, we have to configure IvozProvider to use the
already configured \emph{Carrier} to place the external calls we are making.

To achieve this, in first place, we need that the dialed external numbers fall
in an existing \textbf{target pattern}:
\begin{itemize}
\item {} 
{\hyperref[administration_portal/brand/routing/routing_patterns:id1]{\sphinxcrossref{\DUrole{std,std-ref}{Routing patterns}}}}

\item {} 
{\hyperref[administration_portal/brand/routing/routing_patterns_groups:routing\string-pattern\string-groups]{\sphinxcrossref{\DUrole{std,std-ref}{Routing pattern groups}}}}

\end{itemize}

\begin{notice}{tip}{Tip:}
To achieve our goal of making an external call to a spanish number, we didn't have
to modify the initial contents of this two sections as Spain pattern already exists :)
\end{notice}


\section{Outgoing Routing configuration}
\label{getting_started/external_outgoing_calls/call_routing:outgoing-routing-configuration}\label{getting_started/external_outgoing_calls/call_routing::doc}
We already have our test call categorized as a call within the \textbf{Routing pattern}
`Spain'. In addition, we also have a \textbf{Routing pattern group} including `Spain',
called `Europe'.

Now we have to tell IvozProvider that calls to `Spain' or `Europe' should be
established through our new \textbf{Carrier}.

To make this assignment, we use the section \textbf{Brand Configuration \textgreater{} Routing \textgreater{} Outgoing routings}:
\begin{itemize}
\item {} 
Client: ``Apply to all clients'' (or just \emph{democompany}).

\item {} 
Type: pattern.

\item {} 
Destination pattern: Spain.

\item {} 
Route type: static.

\item {} 
Carriers: our new carrier.

\item {} 
Priority: 1

\item {} 
Priority: 1

\end{itemize}

For more information about routing and load balancing check {\hyperref[administration_portal/brand/routing/outgoing_routings:outgoing\string-routings]{\sphinxcrossref{\DUrole{std,std-ref}{Outgoing Routings}}}} section.


\section{Outgoing DDI configuration}
\label{getting_started/external_outgoing_calls/outgoing_ddi:external-ddi}\label{getting_started/external_outgoing_calls/outgoing_ddi::doc}\label{getting_started/external_outgoing_calls/outgoing_ddi:outgoing-ddi-configuration}
Before placing our first outgoing call, it would be desirable to choose the
number that the callee will see when the phone rings, so that he can return the
call easily.

To achieve this goal, we have to configure our DDI as \emph{Alice's} \textbf{outbound DDI},
because she will be the chosen one to place our first outgoing call.

We can set this up editing \emph{Alice} in \textbf{Client Configuration} \textgreater{} \textbf{Users}. If
this change is made by brand operator or global operator, he must {\hyperref[getting_started/internal_calls/brand_portal:emulate\string-client]{\sphinxcrossref{\DUrole{std,std-ref}{emulate
the corresponding client}}}} previously.

\begin{notice}{tip}{Tip:}
We could have set the same DDI as Default Outgoing DDI at client level, editing \emph{democompany} client.
\end{notice}

\begin{notice}{error}{Error:}
Calls from users without an outgoing DDI will be rejected by IvozProvider.
\end{notice}

At this point, we are looking forward to make our first outgoing call with our
new IvozProvider, we may have even tried to call with current configuration but...


\section{No rating plan, no call}
\label{getting_started/external_outgoing_calls/noplan_nocall:no-rating-plan-no-call}\label{getting_started/external_outgoing_calls/noplan_nocall:noplan-nocall}\label{getting_started/external_outgoing_calls/noplan_nocall::doc}
Just the way we warned {\hyperref[basic_concepts/operation_roles/index:brand\string-responsibilities]{\sphinxcrossref{\DUrole{std,std-ref}{when we described the duties of the brand operator}}}}, the brand operator is \textbf{responsible for making all the
needed setup so that IvozProvider is able to bill all external calls}.

\begin{notice}{note}{Note:}
\textbf{Billing a call} is the action of \textbf{assigning price} to a call that implies
cost.
\end{notice}

\textbf{IvozProvider checks live that a call can be billed when it is established} to avoid
placing calls that imply cost but won't be billed because Brand Operator, due to
a mistake, hasn't assigned a price.

\begin{notice}{error}{Error:}
If a call can't be billed, IvozProvider won't allow its establishment.
\end{notice}


\subsection{Creating a rating plan}
\label{getting_started/external_outgoing_calls/noplan_nocall:creating-a-rating-plan}
\textbf{Brand Configuration \textgreater{} Billing \textgreater{} Destination} section is empty by default, as opposed to routing patterns section,
that has all the 254 countries of the world. The reason is that one destination rate
will usually imply lots of pattern per country (GSM networks, especial numbers,
mobile numbers, fixed lines, etc.).

In most of the cases, this section data will be imported from CSV provided by your
VoIP provider, but for our test we will create it manually:
\begin{itemize}
\item {} 
Create a \textbf{destination} with `+34' for Spain.

\item {} 
Create a \textbf{destination rate} and insert a price for Spain destination.

\item {} 
Create a \textbf{rating plan} that includes that destination rate.

\end{itemize}


\subsection{Assign rating plan to client}
\label{getting_started/external_outgoing_calls/noplan_nocall:assign-rating-plan-to-client}
The last step is \textbf{assigning that rating plan} to \emph{democompany} following the indication
{\hyperref[administration_portal/brand/billing/rating_plans:assigning\string-rating\string-plans\string-to\string-clients]{\sphinxcrossref{\DUrole{std,std-ref}{here}}}}.


\section{Outgoing configuration complete!}
\label{getting_started/external_outgoing_calls/finish:outgoing-configuration-complete}\label{getting_started/external_outgoing_calls/finish::doc}
That's it!

At this point, \emph{Alice} should be able to make outgoing calls to
spanish destinations and this calls should be routed and billed accordingly.


\chapter{Platform Configuration}
\label{administration_portal/platform/index::doc}\label{administration_portal/platform/index:platform-configuration}
This section is only shown to \emph{God administrator} and allows modifying global configurations:


\section{Brands}
\label{administration_portal/platform/brands:brands}\label{administration_portal/platform/brands::doc}\label{administration_portal/platform/brands:id1}
\emph{God operator} is responsible for creating and managing platform brands through this section.

This are the fields shown when a new brand is created:
\begin{quote}
\begin{description}
\item[{Name}] \leavevmode
Sets the name for this brand.

\item[{TIN}] \leavevmode
Number used in this brand's invoices.

\item[{Logo}] \leavevmode
Used as default logo in invoices and in portals (if they don't specify
another logo).

\item[{Invoice data}] \leavevmode
Data included in invoices created by this brand.

\item[{SIP domain}] \leavevmode
Introduced in 1.4. Domain pointing to Users SIP proxy used by all the
Retail Accounts and Residential Devices of this brand.

\item[{Recordings}] \leavevmode
Configures a limit for the size of recordings of this brand. A
notification is sent to configured address when 80\% is reached and
older recordings are rotated when configured size is reached.

\item[{Features}] \leavevmode
Introduced in 1.3, lets god operator choose the features of the created
brand. An equivalent configuration is available in Clients, to choose
between the ones that god operator gave to your Brand. Related sections
are hidden consequently.

\item[{Max calls}] \leavevmode
Limits both user generated and \textbf{external} received calls to this value
(0 for unlimited).

\item[{Locales}] \leavevmode
Define default Timezone, Language and Currency for clients of this brand.

\item[{Notifications}] \leavevmode
Configure the email {\hyperref[administration_portal/brand/settings/notification_templates:id1]{\sphinxcrossref{\DUrole{std,std-ref}{Notification Templates}}}} to use for this brand.
Clients configured to use generic notifications will use configured
brand notifications. If brand has no notification configured
{\hyperref[administration_portal/platform/default_notification_templates:id1]{\sphinxcrossref{\DUrole{std,std-ref}{Default Notification Templates}}}} will be used.

\item[{ProxyTrunks}] \leavevmode
Select which ProxyTrunks addresses can be used by this brand. Read {\hyperref[administration_portal/platform/infrastructure/proxy_trunks:proxy\string-trunks]{\sphinxcrossref{\DUrole{std,std-ref}{Proxy Trunks}}}}
for further details. It is not possible to unassign an address used in any {\hyperref[administration_portal/brand/providers/carriers:carriers]{\sphinxcrossref{\DUrole{std,std-ref}{carrier}}}} or
{\hyperref[administration_portal/brand/providers/ddi_providers:ddi\string-providers]{\sphinxcrossref{\DUrole{std,std-ref}{DDI provider}}}}.

\end{description}
\end{quote}

\begin{notice}{hint}{Hint:}
Some features are related to brand and cannot be assigned to clients.
Other ones are also related to clients and lets the brand operator to
assign them to its clients.
\end{notice}

\begin{notice}{warning}{Warning:}
Disabling billing hides all related sections and assumes that an
external element will set a price for calls (external tarification
module is needed, ask for it!).
\end{notice}

\begin{notice}{note}{Note:}
Disabling invoices hides related sections, assuming you will use an
external tool to generate them.
\end{notice}

\begin{notice}{note}{Note:}
SIP domain is only visible for Brands with Retail or Residential features
enabled.
\end{notice}


\subsection{Brand operators}
\label{administration_portal/platform/brands:id2}\label{administration_portal/platform/brands:brand-operators}
\textbf{List of brand operators} subsection allows adding/editing/deleting credentials for brand portal access.

Read {\hyperref[api_rest/acls:acls]{\sphinxcrossref{\DUrole{std,std-ref}{ACLs}}}} for further explanation about restricted brand administrators.


\subsection{Brand Portals}
\label{administration_portal/platform/brands:brand-portals}\label{administration_portal/platform/brands:id3}
\textbf{List of brand portals} subsection allows managing URLs to access to the different web portals available for a given brand.

See {\hyperref[administration_portal/brand/settings/client_portals:id1]{\sphinxcrossref{\DUrole{std,std-ref}{Client Portals}}}} for further reference.

\begin{notice}{warning}{Warning:}
URLs are assigned to brands. This means that through a given URL the brand can be guessed, but not the client.
As a result, username collision domain will be at brand level (there cannot exist to client administrators
with the same username within a brand).
\end{notice}


\section{Main operators}
\label{administration_portal/platform/main_operators::doc}\label{administration_portal/platform/main_operators:main-operators}\label{administration_portal/platform/main_operators:id1}
This section lists the credentials to log into the god administration portal. You can edit or delete existing credentials,
and create new ones.

These are the required fields of each entry:
\begin{quote}
\begin{description}
\item[{Username}] \leavevmode
User for login process.

\item[{Password}] \leavevmode
Password for login process.

\item[{Timezone}] \leavevmode
Used for showing dates in External Calls and similar sections.

\item[{Restricted}] \leavevmode
Allows creating limited credentials (read {\hyperref[api_rest/acls:acls]{\sphinxcrossref{\DUrole{std,std-ref}{ACLs}}}} for further explanation).

\end{description}
\end{quote}

Remaining fields are not required nor used anywhere, they just allow storing additional information of a given user
(name, lastname and email).


\section{Antiflood banned IPs}
\label{administration_portal/platform/antiflood_banned_ips:antiflood-banned-ips}\label{administration_portal/platform/antiflood_banned_ips::doc}\label{administration_portal/platform/antiflood_banned_ips:id1}
Addresses listed here have been banned at least once by \emph{Antiflooding} mechanism.

\begin{notice}{warning}{Warning:}
\textbf{IPs are only blocked during 5 minutes}. Entries with \emph{Last time banned} older than 5 minutes are not
currently banned.
\end{notice}

See {\hyperref[security_and_maintenance/security/antiflooding:sip\string-antiflooding]{\sphinxcrossref{\DUrole{std,std-ref}{SIP Antiflooding}}}} for further information.


\section{Terminal manufacturers}
\label{administration_portal/platform/terminal_manufacturers:terminal-manufacturers}\label{administration_portal/platform/terminal_manufacturers::doc}\label{administration_portal/platform/terminal_manufacturers:provisioning}

\subsection{Overview}
\label{administration_portal/platform/terminal_manufacturers:overview}
IvozProvider supports provisioning of terminals via HTTP/HTTPS that fulfill the
following requirements:
\begin{itemize}
\item {} 
Assuming a just unboxed terminal, just plugged and connected to the network:
\begin{itemize}
\item {} 
Ask IP address via DHCP.

\item {} 
DCHP has enabled the option 66 that points to the platform portal

\item {} 
The first requested provisioning file is a static file (different for each
model) prefixed with the previous step URL.

\item {} 
The served file can redefine the URL for further requests

\end{itemize}

\end{itemize}

Any terminal model that can adapt to this provisioning way can be added into
the section \textbf{Platform Configuration \textgreater{} Terminal manufacturers}.
\paragraph{Example Cisco SPA504G}
\begin{itemize}
\item {} 
Cisco SPA504G is turned on and requests an IP address to DHCP

\item {} 
Receives “\url{http://provision.example.com/provision}” as DHCP option 66

\item {} 
Request HTTP configuration from \url{http://provision.example.com/provision/spa504g.cfg}

\item {} 
All 504G request the same file (spa504.cfg), prefixed with the given URL

\item {} 
This file only contain basic configuration settings for the model and the URL
for the next request (p.e. \url{https://provision.example.com/provision/\$MAC.cfg})

\item {} 
This way, each terminal (MAC should be unique) request a specific file
(and different) after the generic one has been served.

\item {} 
This file will contain the specific configuration for the terminal:
\begin{itemize}
\item {} 
User

\item {} 
Password

\item {} 
SIP Domain

\end{itemize}

\end{itemize}

\begin{notice}{note}{Note:}
IvozProvider provisioning system, right now, only has one goal:
provide credentials and language settings for the terminals.
\end{notice}


\subsection{Configuration of supported models}
\label{administration_portal/platform/terminal_manufacturers:configuration-of-supported-models}
IvozProvider uses a template system that allows global operator (God) to
define new models and configure what files will be served.

The help section of \textbf{Terminal manufacturers} has examples for some models
that work (in the moment of writting this) with IvozProvider provisioning system.

\begin{notice}{hint}{Hint:}
These models will be available after the initial installation, but
you must edit them and load the default configuration before
you can use the provisioning system (option \textbf{Restore default template}).
\end{notice}

\begin{notice}{error}{Error:}
UACs firmware changes may cause that given examples stop working. We
will try to keep templates updated, but we can't guarantee this point.
\end{notice}

Analyzing the suggested templates you can have a basic idea of the flexibility of
the system to configure any existing terminal model in the market and to adapt
them to eventual changes in given examples.


\subsection{Getting technical}
\label{administration_portal/platform/terminal_manufacturers:getting-technical}
Imagine an environment with this configuration:
\begin{itemize}
\item {} 
Provisioning URLs:
\begin{itemize}
\item {} 
Generic file: \url{http://PROV\_IP/provision}

\item {} 
Specific file: \url{https://PROV\_IP:PROV\_PORT/provision}

\end{itemize}

\item {} 
TerminalModels.genericUrlPattern: y000000000044.cfg

\end{itemize}

Which requested URLs will be valid?

For generic file, just one: \url{http://PROV\_IP/provision/y000000000044.cfg}

For specific file, requests are right as long as this rules are fulfilled:
\begin{itemize}
\item {} 
All HTTP requests are wrong.

\item {} 
HTTPS requests to 443 are wrong (PROV\_PORT must be used).

\item {} 
Subpaths after provisioning URL are ignored, both in request and in
specificUrlPattern.

\item {} 
On specific file request, extension must match as long as extension is used
in specificUrlPattern.

\item {} 
On specific file request, the filename must match exactly once \{mac\} is replaced.

\item {} 
MAC address is case insensitive and can contain colons or not (`:').

\end{itemize}

Let's analyze the examples below to understand this rules better:
\paragraph{Example 1 - TerminalModels.specificUrlPattern: \{mac\}.cfg}

Working requests:

\begin{Verbatim}[commandchars=\\\{\}]
\PYG{g+go}{https://PROV\PYGZus{}IP:PROV\PYGZus{}PORT/provision/aabbccddeeff.cfg}
\PYG{g+go}{https://PROV\PYGZus{}IP:PROV\PYGZus{}PORT/provision/aa:bb:cc:dd:ee:ff.cfg}
\PYG{g+go}{https://PROV\PYGZus{}IP:PROV\PYGZus{}PORT/provision/aabbccdd:ee:ff.cfg}
\PYG{g+go}{https://PROV\PYGZus{}IP:PROV\PYGZus{}PORT/provision/aabbccddeeff.cfg}
\PYG{g+go}{https://PROV\PYGZus{}IP:PROV\PYGZus{}PORT/provision/AABBCCDDEEFF.cfg}
\PYG{g+go}{https://PROV\PYGZus{}IP:PROV\PYGZus{}PORT/provision/subpath1/aabbccddeeff.cfg}
\PYG{g+go}{https://PROV\PYGZus{}IP:PROV\PYGZus{}PORT/provision/subpath1/subpath2/aabbccddeeff.cfg}
\end{Verbatim}

Wrong requests:

\begin{Verbatim}[commandchars=\\\{\}]
\PYG{g+go}{https://PROV\PYGZus{}IP:PROV\PYGZus{}PORT/provision/aabbccddeeff.boot}
\PYG{g+go}{https://PROV\PYGZus{}IP:PROV\PYGZus{}PORT/provision/subpath1/subpath2/aabbccddeeff.boot}
\end{Verbatim}

This example is identical to `t23/\{mac\}.cfg', as subpaths are ignored.
\paragraph{Example 2 - TerminalModels.specificUrlPattern: \{mac\}}

All previous examples are ok, as extension is ignored if no extension is found
in specificUrlPattern.

This example is identical to `t23/\{mac\}', as subpaths are ignored.
\paragraph{Example 3 - TerminalModels.specificUrlPattern: yea-\{mac\}.cfg}

All previous examples are wrong, as no `yea-` is found (`yea' match is case
sensitive).

Working requests:

\begin{Verbatim}[commandchars=\\\{\}]
\PYG{g+go}{https://PROV\PYGZus{}IP:PROV\PYGZus{}PORT/provision/subpath1/yea\PYGZhy{}aabbccdd:ee:ff.cfg}
\end{Verbatim}

Wrong requests:

\begin{Verbatim}[commandchars=\\\{\}]
\PYG{g+go}{https://PROV\PYGZus{}IP:PROV\PYGZus{}PORT/provision/subpath1/yea\PYGZhy{}aabbccdd:ee:ff.boot}
\PYG{g+go}{https://PROV\PYGZus{}IP:PROV\PYGZus{}PORT/provision/subpath1/YEA\PYGZhy{}aabbccdd:ee:ff.cfg}
\end{Verbatim}

This example is identical to `t23/yea-\{mac\}.cfg', as subpaths are ignored.
\paragraph{Example 4 - TerminalModels.specificUrlPattern: yea-\{mac\}}

As no extension is given:

\begin{Verbatim}[commandchars=\\\{\}]
\PYG{g+go}{https://PROV\PYGZus{}IP:PROV\PYGZus{}PORT/provision/subpath1/yea\PYGZhy{}aabbccdd:ee:ff.cfg}
\PYG{g+go}{https://PROV\PYGZus{}IP:PROV\PYGZus{}PORT/provision/subpath1/yea\PYGZhy{}aabbccdd:ee:ff.boot}
\end{Verbatim}

Wrong requests:

\begin{Verbatim}[commandchars=\\\{\}]
\PYG{g+go}{https://PROV\PYGZus{}IP:PROV\PYGZus{}PORT/provision/subpath1/YEA\PYGZhy{}aabbccdd:ee:ff.cfg}
\end{Verbatim}

This example is identical to `t23/yea-\{mac\}', as subpaths are ignored.


\section{Services}
\label{administration_portal/platform/services:services}\label{administration_portal/platform/services::doc}\label{administration_portal/platform/services:god-services}
There are \textbf{special services} that can be accessed by calling to some codes
\textbf{from the terminal}.

\begin{notice}{danger}{Danger:}
Services defined in this section \textbf{are not accessible during a
conversation}. They are activated by \textbf{calling the codes}, not using
DTMF codes while talking.
\end{notice}

There are the following \textbf{special services} available in the section \textbf{Global
configuration} \textgreater{} \textbf{Services}:
\begin{quote}
\begin{description}
\item[{Direct pickup}] \leavevmode
This service allows capturing a ringing call from another terminal by
calling the code followed by the extension from the target user.

\item[{Group pickup}] \leavevmode
This service allows capturing a ringing call for any terminal whose user
is part of one of the capturer pickup groups.

\item[{Check voicemail}] \leavevmode
This service allows checking the user's voicemail using an interactive
menu from which new voicemails can be listen, deleted, etc. This is an
active alternative to receive voicemails via the email. Since 1.4, this
service allows optional extension after the service code to check
another users voicemails. Users can protect their voicemail using the
internal menu options.

\item[{Record locution}] \leavevmode
This service allows any user to record their client's locutions by
dialing an special code. Voice instructions will be provided in the
user's language.

\item[{Open Lock}] \leavevmode
Calling this service code will set route lock status to `Opened' (see {\hyperref[administration_portal/client/vpbx/routing_tools/route_locks:route\string-locks]{\sphinxcrossref{\DUrole{std,std-ref}{Route locks}}}}).

\item[{Close Lock}] \leavevmode
Calling this service code will set route lock status to `Closed' (see {\hyperref[administration_portal/client/vpbx/routing_tools/route_locks:route\string-locks]{\sphinxcrossref{\DUrole{std,std-ref}{Route locks}}}}).

\item[{Toggle Lock}] \leavevmode
Calling this service code will change the current status of the lock (see {\hyperref[administration_portal/client/vpbx/routing_tools/route_locks:route\string-locks]{\sphinxcrossref{\DUrole{std,std-ref}{Route locks}}}}).

\item[{Inconditional call forward}] \leavevmode
Calling this service code will change the current status of inconditional call forward (only available for
residential clients, see {\hyperref[administration_portal/client/residential/residential_devices:residential\string-devices\string-cfw]{\sphinxcrossref{\DUrole{std,std-ref}{Residential device call forward settings}}}}).

\item[{Busy call forward}] \leavevmode
Calling this service code will change the current status of busy call forward (only available for
residential clients, see {\hyperref[administration_portal/client/residential/residential_devices:residential\string-devices\string-cfw]{\sphinxcrossref{\DUrole{std,std-ref}{Residential device call forward settings}}}}).

\item[{No answer call forward}] \leavevmode
Calling this service code will change the current status of no answer call forward (only available for
residential clients, see {\hyperref[administration_portal/client/residential/residential_devices:residential\string-devices\string-cfw]{\sphinxcrossref{\DUrole{std,std-ref}{Residential device call forward settings}}}}).

\item[{Unreachable call forward}] \leavevmode
Calling this service code will change the current status of no answer call forward (only available for
residential clients, see {\hyperref[administration_portal/client/residential/residential_devices:residential\string-devices\string-cfw]{\sphinxcrossref{\DUrole{std,std-ref}{Residential device call forward settings}}}}).it di

\end{description}
\end{quote}

As soon as new services are implemented into IvozProvider, they will be listed
in this section.

\begin{notice}{attention}{Attention:}
This section lists the available services and the default codes
when a \textbf{new brand} is created.
\end{notice}

\begin{notice}{hint}{Hint:}
Changing the default code in this section will only affect new
created brands.
\end{notice}


\section{Currencies}
\label{administration_portal/platform/currencies:currencies}\label{administration_portal/platform/currencies::doc}
This section allows adding as many currencies as wanted. It is a multilanguage field with a symbol that will be used
in invoices, balance movements, etc.

These IvozProvider elements have an assigned currency:
\begin{quote}
\begin{description}
\item[{Brand}] \leavevmode
Used as default currency for all underlying items that have currency.

\item[{Client}] \leavevmode
Chosen currency will be used in price calculation, invoices, invoice's fixed costs, balance movements and
remaining money operations of this client.

\item[{Carrier}] \leavevmode
Chosen currency will be used in cost calculation, balance movements and
remaining money operations of this carrier.

\item[{Destination rate}] \leavevmode
All rates within a destination rate will assume this currency.

\item[{Rating plan}] \leavevmode
All destination rates grouped in a rating plan \textbf{must} use this currency.

\end{description}
\end{quote}

It is important to take into account notes below before using this feature:
\begin{itemize}
\item {} 
Rating plans \textbf{must} only group destination rates using its currency.

\item {} 
Clients and carriers \textbf{must} only use rating plans using its currency.

\end{itemize}

\begin{notice}{note}{Note:}
Some backend checks avoid some of previous misconfigurations, but not all of them: \textbf{use this feature carefully}.
\end{notice}

\begin{notice}{important}{Important:}
\textbf{There is no currency conversion involved}: call cost will be calculated in carrier's currency, call price
will be calculated in client's currency.
\end{notice}

\begin{notice}{caution}{Caution:}
LCR routes involving carriers with different currencies are not supported.
\end{notice}
\phantomsection\label{administration_portal/platform/default_notification_templates:default-notification-templates}

\section{Default Notification Templates}
\label{administration_portal/platform/default_notification_templates:id2}\label{administration_portal/platform/default_notification_templates::doc}\label{administration_portal/platform/default_notification_templates:default-notification-templates}\label{administration_portal/platform/default_notification_templates:id1}
Brand administrators can configure the notifications sent by IvozProvider:
\begin{itemize}
\item {} 
Email sent when a new voicemail is received

\item {} 
Email sent when a new fax is received

\item {} 
Email sent when a balance is below configured threshold

\item {} 
Email sent when an automatic invoice is generated

\item {} 
Email sent when scheduled CDR CSVs are generated

\item {} 
Email sent when max daily usage is reached

\end{itemize}

This section allows \textbf{modifying default templates} that will be \textbf{used when no custom notification is configured}.

See {\hyperref[administration_portal/brand/settings/notification_templates:notification\string-templates]{\sphinxcrossref{\DUrole{std,std-ref}{Notification Templates}}}} for further reference.


\section{Default Invoice Templates}
\label{administration_portal/platform/default_invoice_templates::doc}\label{administration_portal/platform/default_invoice_templates:default-invoice-templates}\label{administration_portal/platform/default_invoice_templates:id1}
Platform administators can create Invoice templates that can be used by all brands in the platform.

Although brand administrators won't be able to edit them, they will be available for {\hyperref[administration_portal/brand/invoicing/invoices:invoices]{\sphinxcrossref{\DUrole{std,std-ref}{Invoices}}}}
and {\hyperref[administration_portal/brand/invoicing/invoice_schedulers:invoice\string-schedulers]{\sphinxcrossref{\DUrole{std,std-ref}{Invoice schedulers}}}}.


\section{Global Special Numbers}
\label{administration_portal/platform/global_special_numbers:global-special-numbers}\label{administration_portal/platform/global_special_numbers::doc}\label{administration_portal/platform/global_special_numbers:id1}
This section allows adding external numbers that will be handled in a different way by IvozProvider when a client
calls to those destinations (\textbf{only for external outgoing calls}).

\begin{notice}{note}{Note:}
Numbers listed here will apply in every brand. Brand operator may add numbers too using {\hyperref[administration_portal/brand/settings/special_numbers:special\string-numbers]{\sphinxcrossref{\DUrole{std,std-ref}{Special Numbers}}}}.
\end{notice}


\subsection{Disable CDR}
\label{administration_portal/platform/global_special_numbers:disable-cdr}
Currently there is only one special treatment: \textbf{Disable CDR}. Setting this to \emph{Yes} for a number will:
\begin{itemize}
\item {} 
Prevent outgoing external calls from being listed in following sections:
\begin{itemize}
\item {} 
\emph{Active Calls}

\item {} 
\emph{External Calls}

\item {} 
\emph{Call Registry} (both client portal and user portal)

\end{itemize}

\item {} 
As a consequence, calls won't be included in any:
\begin{itemize}
\item {} 
{\hyperref[administration_portal/brand/invoicing/invoices:invoices]{\sphinxcrossref{\DUrole{std,std-ref}{Invoices}}}}

\item {} 
CSV defined by {\hyperref[administration_portal/brand/calls/call_csv_schedulers:call\string-csv\string-schedulers]{\sphinxcrossref{\DUrole{std,std-ref}{Call CSV schedulers}}}}

\item {} 
API response of related endpoints

\end{itemize}

\item {} 
Do not call CGRateS for these calls: call will be allowed no matter if active pricing plan allows it.
\begin{itemize}
\item {} 
As a consequence, no price/cost will be decreased from carrier/client account.

\end{itemize}

\item {} 
Prevent recording these calls. As a consequence, \emph{Recordings} section won't list them.

\end{itemize}

\begin{notice}{warning}{Warning:}
Adding a number will cause this special handling \textbf{only for future outgoing external calls}.
No change is made in previous calls.
\end{notice}
\phantomsection\label{administration_portal/platform/sip_domains:god-sipdomains}

\section{SIP domains}
\label{administration_portal/platform/sip_domains:sip-domains}\label{administration_portal/platform/sip_domains::doc}\label{administration_portal/platform/sip_domains:god-sipdomains}\label{administration_portal/platform/sip_domains:id1}
The section \textbf{Domains} will display the SIP domains that point to {\hyperref[administration_portal/platform/infrastructure/proxy_users:proxyusers]{\sphinxcrossref{\DUrole{std,std-ref}{Proxy Users}}}} public address.

\begin{notice}{note}{Note:}
DNS register can be type A (supported by all the hardphones/softphones
) or even NAPTR+SRV.
\end{notice}

There are two type of SIP domains:
\begin{quote}
\begin{description}
\item[{vPBX client SIP domain}] \leavevmode
Each vPBX client has a unique SIP domain.

\item[{Brand SIP domain}] \leavevmode
Shared by all retail and residential clients in the brand.

\end{description}
\end{quote}

All these SIP domains will be displayed in this list so that global administrator can check
what domains are registered for each client/brand:
\begin{quote}
\begin{description}
\item[{Domain}] \leavevmode
DNS pointing to {\hyperref[administration_portal/platform/infrastructure/proxy_users:proxyusers]{\sphinxcrossref{\DUrole{std,std-ref}{Proxy Users}}}} public address

\item[{Brand}] \leavevmode
Brand of specific brand domain or vPBX client.

\item[{Client}] \leavevmode
vPBX client of specific vPBX client domain. Empty for brand domains.

\end{description}
\end{quote}
\phantomsection\label{administration_portal/platform/portals:portals}

\section{Platform Portals}
\label{administration_portal/platform/portals:portals}\label{administration_portal/platform/portals:platform-portals}\label{administration_portal/platform/portals::doc}\label{administration_portal/platform/portals:id1}
This section allows configuration of platform portals that will be used by {\hyperref[administration_portal/platform/main_operators:main\string-operators]{\sphinxcrossref{\DUrole{std,std-ref}{Main operators}}}}.

\begin{notice}{warning}{Warning:}\begin{itemize}
\item {} 
URLs MUST be HTTPS

\item {} 
URLs MUST not end with slash /

\end{itemize}
\end{notice}

Each URL can also configure a logo and a theme per URL.
\phantomsection\label{administration_portal/platform/active_calls:active-calls}

\section{Active calls}
\label{administration_portal/platform/active_calls:call-state}\label{administration_portal/platform/active_calls::doc}\label{administration_portal/platform/active_calls:active-calls}\label{administration_portal/platform/active_calls:id1}
This section allows main operator and brand operator view \textbf{current active external calls}.

\begin{notice}{warning}{Warning:}
Internal calls won't be listed.
\end{notice}

These are columns shown:
\begin{quote}
\begin{description}
\item[{Duration}] \leavevmode
Show call establishment duration during establishment and call duration during ongoing call. It also shows
direction (inbound/outbound) and call state information, as explained below.

\item[{Brand}] \leavevmode
Brand making a given call (only shown at god level).

\item[{Client}] \leavevmode
Client making a given call.

\item[{Caller}] \leavevmode
Call source number in E.164.

\item[{Callee}] \leavevmode
Call destination number in E.164.

\item[{Carrier}] \leavevmode
Carrier/DDI Provider used in given call.

\end{description}
\end{quote}


\subsection{Call state}
\label{administration_portal/platform/active_calls:id2}
Call state follows \href{https://tools.ietf.org/html/rfc4235\#section-3.7.1}{Dialog State Machine proposed in RFC4235}:
\begin{itemize}
\item {} 
\textbf{Trying}
\begin{itemize}
\item {} 
INVITE sent, someone is trying to make a new call.

\item {} 
Shown as \emph{Call Setup} in this section.

\end{itemize}

\item {} 
\textbf{Proceeding}
\begin{itemize}
\item {} 
Provisional response from middle proxies received (usually 100 Trying).

\item {} 
This state is ignored in this section.

\end{itemize}

\item {} 
\textbf{Early}
\begin{itemize}
\item {} 
Provisional response from final party received (usually 180 Ringing).

\item {} 
Shown as \emph{Ringing} in this section.

\end{itemize}

\item {} 
\textbf{Confirmed}
\begin{itemize}
\item {} 
200 OK received, call confirmed, parties talking.

\item {} 
Shown as \emph{In call} in this section.

\end{itemize}

\item {} 
\textbf{Terminated}
\begin{itemize}
\item {} 
BYE/CANCEL/error-response (\textgreater{}300) received, call finished.

\item {} 
Call vanishes to show this status.

\end{itemize}

\end{itemize}
\paragraph{Example 1: Successful call}

A successful call traverses this states:
\begin{itemize}
\item {} 
Trying -\textgreater{} Proceeding (optional) -\textgreater{} Early (optional) -\textgreater{} Confirmed -\textgreater{} Terminated

\end{itemize}

That will be coded in this section as:
\begin{itemize}
\item {} 
Call Setup -\textgreater{} Ringing (optional) -\textgreater{} In call -\textgreater{} Call vanishes

\end{itemize}
\paragraph{Example 2: Unsuccessful call}

An unsuccessful call traverses this states:
\begin{itemize}
\item {} 
Trying -\textgreater{} Proceeding (optional) -\textgreater{} Early (optional) -\textgreater{} Terminated

\end{itemize}

That will be show in this section as:
\begin{itemize}
\item {} 
Call Setup -\textgreater{} Ringing (optional) -\textgreater{} Call vanishes

\end{itemize}
\phantomsection\label{administration_portal/platform/external_calls:external-calls}

\section{External calls}
\label{administration_portal/platform/external_calls:id2}\label{administration_portal/platform/external_calls:external-calls}\label{administration_portal/platform/external_calls::doc}\label{administration_portal/platform/external_calls:id1}
\textbf{External calls} section lists \textbf{both inbound and outbound external calls}.

This section is shown at different levels:
\begin{itemize}
\item {} 
Main level (god level)

\item {} 
Brand level (filtered for emulated/logged brand).

\item {} 
Client level (filtered for emulated/logged client).

\end{itemize}

Each entry shows this information:
\begin{quote}
\begin{description}
\item[{Start time}] \leavevmode
Date and time of the call establishment.

\item[{Brand}] \leavevmode
Only visible for \emph{god}, shows the brand of each call.

\item[{Client}] \leavevmode
Visible for \emph{god} and \emph{brand operator}, shows the client of each call.

\item[{Caller}] \leavevmode
DDI presented for the outgoing call.

\item[{Callee}] \leavevmode
External number dialed.

\item[{Duration}] \leavevmode
Shows how long the call lasted.

\item[{Price}] \leavevmode
The money amount for the client. Visible for \emph{god} and \emph{brand operator} and \emph{Client administrator} if
\emph{Display billing details to client} is enabled.

\item[{Cost}] \leavevmode
Visible for \emph{god} and \emph{brand operator}, the money amount for the brand (the money that the carrier will bill for the call).

\item[{Rating Plan}] \leavevmode
Rating plan used to set price for the call. Visible for \emph{god} and \emph{brand operator} and \emph{Client administrator} if
\emph{Display billing details to client} is enabled.

\item[{Destination}] \leavevmode
Destination that matched the call for billing. Visible for \emph{god} and \emph{brand operator} and \emph{Client administrator} if
\emph{Display billing details to client} is enabled.

\item[{Carrier}] \leavevmode
Visible for \emph{god} and \emph{brand operator}, shows which {\hyperref[administration_portal/brand/providers/carriers:carriers]{\sphinxcrossref{\DUrole{std,std-ref}{Carrier}}}} was used for each outbound call.

\item[{DDI Provider}] \leavevmode
Visible for \emph{god} and \emph{brand operator}, shows which {\hyperref[administration_portal/brand/providers/ddi_providers:ddi\string-providers]{\sphinxcrossref{\DUrole{std,std-ref}{DDI Provider}}}} was used for each inbound call.

\item[{Invoice}] \leavevmode
Visible for \emph{god} and \emph{brand operator}, shows if a call is already included in any {\hyperref[administration_portal/brand/invoicing/invoices:invoices]{\sphinxcrossref{\DUrole{std,std-ref}{Invoice}}}}.

\item[{Call ID}] \leavevmode
Shows the call ID of the call for troubleshooting and CSV export.

\item[{Endpoint Type}] \leavevmode
Possible values: RetailAccount, ResidentialDevice, User, Fax, Friend.

\item[{Endpoint Id}] \leavevmode
Internal ID of specific endpoint (only when \emph{endpointType} is non-empty).

\item[{Endpoint Name}] \leavevmode
User extension, friend name, fax name, retail account name or residential device name (only when \emph{endpointId} is non-empty).

\end{description}
\end{quote}

\begin{notice}{note}{Note:}
An asynchronous process parses each external call and adds it to this list a few minutes after call hangup. Billing related fields, such as cost and price, will be empty for external incoming calls.
\end{notice}


\subsection{Call rerating}
\label{administration_portal/platform/external_calls:call-rerating}
At \textbf{brand level}, there is an additional available operation for outbound calls: \textbf{Rerate call}. This option allows calling rating engine again for a call or a bunch of calls.

Notes about this rerating process:
\begin{itemize}
\item {} 
If a call is in an invoice, it cannot be rerated. Invoice must be deleted first.

\item {} 
Call will be rerated with the \emph{Start time} of the call (no with current active rating plans, but with active rating plans
on the moment of the call).

\item {} 
Both \emph{Price} and \emph{Cost} will be recalculated. This may imply updating \emph{rating plan} and \emph{destination} too.

\end{itemize}

\begin{notice}{tip}{Tip:}
When a call is rerated, cost and price are emptied until the next iteration of the asynchronous task.
\end{notice}


\section{Infrastructure}
\label{administration_portal/platform/infrastructure/index:infrastructure}\label{administration_portal/platform/infrastructure/index::doc}
Sections in this group list the components of the platform and are not meant to be modified without a deep knowledge:


\subsection{Proxy Users}
\label{administration_portal/platform/infrastructure/proxy_users:proxy-users}\label{administration_portal/platform/infrastructure/proxy_users:proxyusers}\label{administration_portal/platform/infrastructure/proxy_users::doc}
This is the SIP proxy exposed to the external world where users register their
terminals.

The value displayed in the section \textbf{Proxy users} will show the IP address
entered during the installation process.

\begin{notice}{tip}{Tip:}
All domains in \sphinxtitleref{SIP domains} section (except from trunks.ivozprovider.local) should point to this IP address.
\end{notice}


\subsection{Proxy Trunks}
\label{administration_portal/platform/infrastructure/proxy_trunks:proxy-trunks}\label{administration_portal/platform/infrastructure/proxy_trunks::doc}\label{administration_portal/platform/infrastructure/proxy_trunks:id1}
This is the SIP proxy exposed to external world and is in charge of connecting
with providers (carriers / DDI providers) brand administrators will configure for \emph{SIP peering}.

\begin{notice}{note}{Note:}
Only the IP addresses will be listed, as the port will be always 5060
(5061 for SIP over TLS).
\end{notice}


\subsubsection{Main address}
\label{administration_portal/platform/infrastructure/proxy_trunks:main-address}
The value displayed in the entry \textbf{proxytrunks} will show the IP address
entered during the installation process.

\begin{notice}{danger}{Danger:}
This entry cannot be removed.
\end{notice}

This IP address:
\begin{itemize}
\item {} 
Will be used for internal signalling:
\begin{itemize}
\item {} 
KamTrunks \textless{}-\textgreater{} KamUsers

\item {} 
KamTrunks \textless{}-\textgreater{} Application Servers

\end{itemize}

\item {} 
Will be used to reload Kamailio modules when needed (XMLRPC).

\end{itemize}

This value can be changed from the portal, but Kamailio make sure that KamTrunks is binded to given IP.


\subsubsection{Additional addresses}
\label{administration_portal/platform/infrastructure/proxy_trunks:additional-addresses}
Apart from unremovable \textbf{proxytrunks} entry, additional addresses can be added here. These additional addresses can be
removed as long as they are not assigned to any Carrier / DDI Provider.

\begin{notice}{warning}{Warning:}
Apart from adding here, addresses must be configured in \emph{/etc/kamailio/proxytrunks/additional\_addresses.cfg}
(\emph{additional\_addresses.cfg.in} is given as an example). Make sure Kamailio can bind to given addresses,
otherwise it won't boot.
\end{notice}

The purpose of these additional addresses is to talk to different Providers using different addresses:
\begin{itemize}
\item {} 
Main operator (\emph{God}) will assign IP addresses listed in this section to Brands (read {\hyperref[administration_portal/platform/brands:brands]{\sphinxcrossref{\DUrole{std,std-ref}{Brands}}}}).
\begin{itemize}
\item {} 
Each brand must have at least one address.

\item {} 
Each address can be assigned in several brands.

\end{itemize}

\item {} 
Brand operator will assign these addresses to Carriers (read {\hyperref[administration_portal/brand/providers/carriers:carriers]{\sphinxcrossref{\DUrole{std,std-ref}{Carriers}}}}) and DDI Providers (read {\hyperref[administration_portal/brand/providers/ddi_providers:ddi\string-providers]{\sphinxcrossref{\DUrole{std,std-ref}{DDI Providers}}}}).
\begin{itemize}
\item {} 
Each Provider (both Carriers and DDI Providers) must have one address.

\end{itemize}

\item {} 
IvozProvider will use assigned addresses in SIP signalling with those Carriers / DDI Providers.

\end{itemize}

\begin{notice}{note}{Note:}
Be aware that it only applies to SIP signalling, no changes are made in RTP media handling.
\end{notice}


\subsection{Media relay sets}
\label{administration_portal/platform/infrastructure/media_relay_sets::doc}\label{administration_portal/platform/infrastructure/media_relay_sets:media-relay-sets}
Media relays are in charge of bridging RTP traffic of established calls. Like
the Application Servers, they can scale horizontally as much as required.

Media relays are organized in groups so they can be assigned to a client/provider. Each
element of the group has a \textbf{metric} that allows non-equal load balancing
within the same group (i.e. media-relay1 metric 1; media-relay2 metric 2:
the second media relay will handle two times the calls than the first one).

\begin{notice}{hint}{Hint:}
The static assignment of media relay groups is not the common practice
but allow us to assign strategic resources to clients that need a warranted
service. The most common usage of this \textbf{groups of media relays} is to
place them near the geographic area of the client (usually far from the
rest of the platform systems) in order to reduce \textbf{latencies} in their
conversations.
\end{notice}

In a standalone installation, only one media relay group will exist. By default this group only has a media server.

\begin{notice}{note}{Note:}
The address displayed is the control socket, not the SDP address that
will be included during SIP negotiation. By default this alone media-relay
will share the same IP address that the User's SIP proxy.
\end{notice}


\subsection{Application Servers}
\label{administration_portal/platform/infrastructure/application_servers::doc}\label{administration_portal/platform/infrastructure/application_servers:application-servers}
The section \textbf{Application Servers} will list the IP address where the existing
Asterisk processes will listen for request, and like previously mentioned,
can scale horizontally to adapt the platform for the required load.

Contrary to the Proxies, Asterisk is not exposed to the external world, so
for a standalone installation there will only be one listening at 127.0.0.1.

\begin{notice}{note}{Note:}
The listening port will not be displayed in the field because it will
always be 6060 (UDP).
\end{notice}

\begin{notice}{important}{Important:}
As soon as another Application Server is added, the proxies will
try to balance load using it. If no response is received from added
Application server, it will be disabled automatically.
\end{notice}


\chapter{Brand Configuration}
\label{administration_portal/brand/index::doc}\label{administration_portal/brand/index:brand-configuration}
This module will describe all the sections shown to brand operators:


\section{Clients}
\label{administration_portal/brand/clients/index:clients}\label{administration_portal/brand/clients/index::doc}
This group will show all available client types for a given (emulated/logged in) brand:


\subsection{Virtual PBX}
\label{administration_portal/brand/clients/virtual_pbx:id1}\label{administration_portal/brand/clients/virtual_pbx::doc}\label{administration_portal/brand/clients/virtual_pbx:virtual-pbx}
Virtual PBX clients are designed to provide service to clients with multiple terminals
that require feature-full call flows.

\begin{notice}{hint}{Hint:}
Some fields described below may not be visible depending on enabled features.
\begin{description}
\item[{Name}] \leavevmode
Sets the name for this client.

\item[{SIP domain}] \leavevmode
DNS for this client. See {\hyperref[getting_started/internal_calls/brand_portal:client\string-sip\string-domain]{\sphinxcrossref{\DUrole{std,std-ref}{Client SIP Domain}}}} section.

\item[{Features}] \leavevmode
Allow configuration of available features for this client.
Related sections are hidden consequently and the client cannot use them.

\item[{Billing method}] \leavevmode
When billing feature is enabled determines when calls will be priced. `none' disables billing.
See {\hyperref[administration_portal/brand/billing/index:billing]{\sphinxcrossref{\DUrole{std,std-ref}{Billing}}}} section.

\item[{Corporation}] \leavevmode
Select which corporation this client belongs to. Enables using {\hyperref[administration_portal/client/vpbx/routing_endpoints/friends/internal_friends:internal\string-friends]{\sphinxcrossref{\DUrole{std,std-ref}{Inter VPBX friends}}}} to
dial other client extensions.

\item[{Geographic Configuration}] \leavevmode
General client configuration for language and timezones. Most of the settings in the section can be
configured per user if required.

\item[{Currency}] \leavevmode
Chosen currency will be used in price calculation, invoices, balance movements and
remaining money operations of this client.

\item[{Max calls}] \leavevmode
Limits both incoming and outgoing external calls (0 for unlimited).

\item[{Filter by IP address}] \leavevmode
If set, the platform will only allow calls coming from allowed IP/ranges or countries.

\item[{GeoIP allowed countries}] \leavevmode
If \emph{Filter by IP address} is enabled, traffic from selected countries will be allowed.

\item[{Max daily usage}] \leavevmode
Limits external outbound calls when this limit is reached within a day. At midnight counters are reset and
accounts are re-enabled.

\item[{Email}] \leavevmode
A notification email will be sent to given address when configured max daily usage is reached. Leave empty to
avoid notification.

\item[{Invoice data}] \leavevmode
Data included in invoices created by this brand. This section also allows showing/hiding billing details to
client's portal, such as Invoices, Rating Profiles and Price of external calls.

\item[{Notifications}] \leavevmode
Configure the email {\hyperref[administration_portal/brand/settings/notification_templates:id1]{\sphinxcrossref{\DUrole{std,std-ref}{Notification Templates}}}} to use for this client.

\item[{Outgoing DDI}] \leavevmode
Selects a DDI for outgoing calls of this client, if it is no overridden in
a lower level.

\item[{Media relay set}] \leavevmode
As mentioned above, media-relay can be grouped in sets to reserve capacities
or on a geographical purpose. This section lets you assign them to clients.

\item[{Distribute Method}] \leavevmode
`Hash based' distributes calls hashing a parameter that is unique per
client, `Round robin' distributes calls equally between AS-es and
`static' is used for debugging purposes.

\item[{Application Server}] \leavevmode
If `static' \emph{distribute method} is used, select an application server here.

\item[{On-demand call recording}] \leavevmode
Shown only if \emph{Recording} feature is enabled for client, allows enabling and
disabling on-demand call recording. If enabled, you can choose how to invoke
and service code if needed.

\item[{Allow Client to remove recordings}] \leavevmode
Shown only if \emph{Recording} feature is enabled for client, shows/hides recording
removal button on client \emph{Call Recordings} section.

\end{description}
\end{notice}

Most of the features are self-explanatory, but \textbf{voice notification} deserves
an explanation: if you enable them, when a call fails, the user will listen a
locution explaining what occurred (``you have no permissions to place this call'',
``the call cannot be billed'', etc.)

Both \textbf{Distribute method} and \textbf{Application Server} are only visible for God
Administrator.

\begin{notice}{warning}{Warning:}
`Round-robin' distribute method is reserved for huge clients
whose calls cannot be handled in a single AS. \textbf{Use `Hash based'
for remaining ones}, as `Round-robin' imposes some limitations
to client features (no queues, no conferences).
\end{notice}


\subsubsection{Additional subsections}
\label{administration_portal/brand/clients/virtual_pbx:additional-subsections}
Each entry in this table has these additional options:
\begin{itemize}
\item {} 
\textbf{List of authorized sources}: if \emph{Filter by IP address} is enabled, this subsection allows adding addresses or network ranges.

\end{itemize}

\begin{notice}{error}{Error:}
No outgoing call will be allowed if \emph{Filter by IP address} is enabled and the corresponding list is empty.
\end{notice}
\begin{itemize}
\item {} 
\textbf{List of client admins}: this subsection allows managing portal credentials for this specific client. Read {\hyperref[api_rest/acls:acls]{\sphinxcrossref{\DUrole{std,std-ref}{ACLs}}}}
for further explanation about restricted client administrators.

\item {} 
\textbf{List of Rating profiles}: this subsection allows managing the rating profiles that will be used to bill its outgoing calls.

\end{itemize}

\begin{notice}{warning}{Warning:}
No outgoing call will be allowed for this client unless an active rating profiles that can
bill the specific call.
\end{notice}


\subsection{Residential}
\label{administration_portal/brand/clients/residential:residential}\label{administration_portal/brand/clients/residential::doc}
Residential clients are a more lightweight client type than \emph{vPBX clients}.

Their target is to provide these services to residential environments:
\begin{itemize}
\item {} 
Configure one or more residential devices (SIP devices).

\item {} 
Setup one or more DDIs.

\item {} 
\textbf{Place external calls} showing one of those DDIs.

\item {} 
\textbf{Receive external calls} to their DDIs.

\item {} 
Send/Receive virtual faxes.

\item {} 
Record calls.

\end{itemize}

\begin{notice}{warning}{Warning:}
No users, no extensions, no internal calls, no hunt groups, no IVRs... just \textbf{incoming and outgoing external
calls (and a few voice services)}.
\end{notice}

\begin{notice}{error}{Error:}
Residential clients and their devices \textbf{MUST use Brand's SIP domain in their SIP messages}.
\end{notice}


\subsubsection{Adding/Editing residential clients}
\label{administration_portal/brand/clients/residential:adding-editing-residential-clients}
\begin{notice}{hint}{Hint:}
Some fields described below may not be visible depending on enabled features.
\end{notice}

These are the fields shown when \textbf{adding} a new residential client:
\begin{quote}
\begin{description}
\item[{Name}] \leavevmode
Used to reference this particular client.

\item[{Billing method}] \leavevmode
To choose among postpaid, prepaid and pseudo-prepaid. `none' disables billing.

\item[{Features}] \leavevmode
Enable/Disable faxing and call recording for this particular client.

\item[{Language}] \leavevmode
Used to choose the language of played locutions.

\item[{Country code}] \leavevmode
Default country code for DDIs.

\item[{Default timezone}] \leavevmode
Used for showing call registries dates.

\item[{Currency}] \leavevmode
Chosen currency will be used in price calculation, invoices, balance movements and
remaining money operations of this client.

\item[{Numeric transformation}] \leavevmode
Describes the way the client will ``talk'' and the way the client wants to be ``talked''.

\item[{Max calls}] \leavevmode
Limits both incoming and outgoing external calls (0 for unlimited).

\item[{Filter by IP address}] \leavevmode
If set, the platform will only allow calls coming from allowed IP/ranges or countries.

\item[{GeoIP allowed countries}] \leavevmode
If \emph{Filter by IP address} is enabled, traffic from selected countries will be allowed.

\item[{Max daily usage}] \leavevmode
Limits external outbound calls when this limit is reached within a day. At midnight counters are reset and
accounts are re-enabled.

\item[{Email}] \leavevmode
A notification email will be sent to given address when configured max daily usage is reached. Leave empty to
avoid notification.

\end{description}
\end{quote}

When \textbf{editing} a client, these additional fields can be configured:
\begin{quote}
\begin{description}
\item[{Invoice data}] \leavevmode
All the fields in this group will be included in invoices generated for this client. This section also allows
showing/hiding billing details to client's portal, such as Invoices, Rating Profiles and Price of external calls.

\item[{Outgoing DDI}] \leavevmode
Fallback DDI for external outgoing calls (can be overridden at residential device level).

\item[{Notification options}] \leavevmode
This group allows choosing a notification template for both faxes and voicemail notifications.

\item[{Allow Client to remove recordings}] \leavevmode
Shown only if \emph{Recording} feature is enabled for client, shows/hides recording
removal button on client \emph{Call Recordings} section.

\end{description}
\end{quote}

\begin{notice}{note}{Note:}
Apart from these fields, main operator (\emph{aka} God) will also see a \textbf{Platform data} group that allows:
\begin{itemize}
\item {} 
Choosing an specific media relay set for the client.

\item {} 
Choose the way that calls of this client will be distributed among existing application servers (\textbf{hash based} is recommended).

\end{itemize}
\end{notice}

\begin{notice}{tip}{Tip:}
For outgoing calls, platform will use the CLID provided by the client as long as it is considered valid, otherwise fallback DDI
will be used. The platform will consider as valid any CLID that matches one of the client's DDIs.
\end{notice}


\subsubsection{Additional subsections}
\label{administration_portal/brand/clients/residential:additional-subsections}
Each entry in this table has these additional options:
\begin{itemize}
\item {} 
\textbf{List of authorized sources}: if \emph{Filter by IP address} is enabled, this subsection allows adding addresses or network ranges.

\end{itemize}

\begin{notice}{error}{Error:}
No outgoing call will be allowed if \emph{Filter by IP address} is enabled and the corresponding list is empty.
\end{notice}
\begin{itemize}
\item {} 
\textbf{List of client admins}: this subsection allows managing portal credentials for this specific client. Read {\hyperref[api_rest/acls:acls]{\sphinxcrossref{\DUrole{std,std-ref}{ACLs}}}}
for further explanation about restricted client administrators.

\item {} 
\textbf{List of rating profiles}: this subsection allows managing the rating profiles that will be used to bill its outgoing calls.

\end{itemize}

\begin{notice}{warning}{Warning:}
No outgoing call will be allowed for this client unless an active rating profiles that can
bill the specific call.
\end{notice}


\subsection{Retail}
\label{administration_portal/brand/clients/retail:retail-clients}\label{administration_portal/brand/clients/retail:retail}\label{administration_portal/brand/clients/retail::doc}
Retail clients are even a more lightweight client type than \emph{Residential clients}.

They just provide a SIP trunking service that include these features:
\begin{itemize}
\item {} 
Configure one or more retail accounts (SIP devices).

\item {} 
Setup one or more DDIs.

\item {} 
\textbf{Place external calls} showing one of those DDIs.

\item {} 
\textbf{Receive external calls} to their DDIs.

\item {} 
Record calls.

\end{itemize}

\begin{notice}{warning}{Warning:}
No users, no extensions, no internal calls, no hunt groups, no IVRs, no voicemail...
just \textbf{incoming and outgoing external calls}.
\end{notice}

\begin{notice}{error}{Error:}
Retail clients and their accounts \textbf{MUST use Brand's SIP domain in their SIP messages}.
\end{notice}


\subsubsection{Differences between retail and residential clients}
\label{administration_portal/brand/clients/retail:differences-between-retail-and-residential-clients}\label{administration_portal/brand/clients/retail:id1}
There is an important key difference between these two clients: \textbf{retail client calls do not traverse
any application server}.

As a result:
\begin{itemize}
\item {} 
No virtual faxing service for retail clients.

\item {} 
No voicemail service for retail clients.

\end{itemize}

But they also have benefits that make them ideal for some situations:
\begin{itemize}
\item {} 
No application server traverse, much less load for the platform.

\item {} 
Call transcoding as a feature.

\item {} 
Routing tags for different call routing for same destinations.

\end{itemize}

\begin{notice}{warning}{Warning:}
Residential devices are force to talk the codec selected in their configuration (just one).
Retail clients, on the other hand, can talk in the codecs they offer in their SDP and in the
codecs selected in IvozProvider: IvozProvider will make transcoding when necessary.
\end{notice}

\begin{notice}{tip}{Tip:}
Use retail client type unless you need any of the services provided by application servers (fax or voicemails).
\end{notice}


\subsubsection{Adding/Editing retail clients}
\label{administration_portal/brand/clients/retail:adding-editing-retail-clients}
\begin{notice}{hint}{Hint:}
Some fields described below may not be visible depending on enabled features.
\end{notice}

These are the fields shown when \textbf{adding} a new retail client:
\begin{quote}
\begin{description}
\item[{Name}] \leavevmode
Used to reference this particular client.

\item[{Billing method}] \leavevmode
To choose among postpaid, prepaid and pseudo-prepaid. `none' disables billing.

\item[{Language}] \leavevmode
Used to choose the language of played locutions.

\item[{Country code}] \leavevmode
Default country code for DDIs.

\item[{Default timezone}] \leavevmode
Used for showing call registries dates.

\item[{Currency}] \leavevmode
Chosen currency will be used in price calculation, invoices, balance movements and
remaining money operations of this client.

\item[{Numeric transformation}] \leavevmode
Describes the way the client will ``talk'' and the way the client wants to be ``talked''.

\item[{Max calls}] \leavevmode
Limits both incoming and outgoing external calls (0 for unlimited).

\item[{Filter by IP address}] \leavevmode
If set, the platform will only allow calls coming from allowed IP/ranges or countries.

\item[{GeoIP allowed countries}] \leavevmode
If \emph{Filter by IP address} is enabled, traffic from selected countries will be allowed.

\item[{Max daily usage}] \leavevmode
Limits external outbound calls when this limit is reached within a day. At midnight counters are reset and
accounts are re-enabled.

\item[{Email}] \leavevmode
A notification email will be sent to given address when configured max daily usage is reached. Leave empty to
avoid notification.

\end{description}
\end{quote}

When \textbf{editing} a client, these additional fields can be configured:
\begin{quote}
\begin{description}
\item[{Invoice data}] \leavevmode
All the fields in this group will be included in invoices generated for this client. This section also allows
showing/hiding billing details to client's portal, such as Invoices, Rating Profiles and Price of external calls.

\item[{Outgoing DDI}] \leavevmode
Fallback DDI for external outgoing calls (can be overridden at residential device level).

\item[{Routing tags}] \leavevmode
This field allows enabling routing tags for this specific client. Call preceded with this
routing tags will be rated and routed differently.

\item[{Audio transcoding}] \leavevmode
This field allows enabling codecs for this specific client. This codecs will be added to
the ones offered by the client in its SDP.

\item[{Allow Client to remove recordings}] \leavevmode
Shown only if \emph{Recording} feature is enabled for client, shows/hides recording
removal button on client \emph{Call Recordings} section.

\end{description}
\end{quote}

\begin{notice}{error}{Error:}
Selecting codecs in \textbf{Audio transcoding} may lead to uneeded transcoding. Selecting ALL codecs is
always a horrible idea. Do not select any codec unless this client does not support an specific codec
that is compulsory for a needed destination/carrier.
\end{notice}

\begin{notice}{note}{Note:}
Apart from these fields, main operator (\emph{aka} God) will also see a \textbf{Platform data} group that allows:
\begin{itemize}
\item {} 
Choosing an specific media relay set for the client.

\end{itemize}
\end{notice}

\begin{notice}{tip}{Tip:}
For outgoing calls, platform will use the CLID provided by the client as long as it is considered valid, otherwise fallback DDI
will be used. The platform will consider as valid any CLID that matches one of the client's DDIs.
\end{notice}


\subsubsection{Additional subsections}
\label{administration_portal/brand/clients/retail:additional-subsections}
Each entry in this table has these additional options:
\begin{itemize}
\item {} 
\textbf{List of authorized sources}: if \emph{Filter by IP address} is enabled, this subsection allows adding addresses or network ranges.

\end{itemize}

\begin{notice}{error}{Error:}
No outgoing call will be allowed if \emph{Filter by IP address} is enabled and the corresponding list is empty.
\end{notice}
\begin{itemize}
\item {} 
\textbf{List of client admins}: this subsection allows managing portal credentials for this specific client. Read {\hyperref[api_rest/acls:acls]{\sphinxcrossref{\DUrole{std,std-ref}{ACLs}}}}
for further explanation about restricted client administrators.

\item {} 
\textbf{List of Rating profiles}: this subsection allows managing the rating profiles that will be used to bill its outgoing calls.

\end{itemize}

\begin{notice}{warning}{Warning:}
No outgoing call will be allowed for this client unless an active rating profiles that can
bill the specific call.
\end{notice}


\subsection{Wholesale}
\label{administration_portal/brand/clients/wholesale:wholesale}\label{administration_portal/brand/clients/wholesale:wholesale-clients}\label{administration_portal/brand/clients/wholesale::doc}
Wholesale clients are the simplest client type in IvozProvider.

It allows trunking services with Carriers without any application server features,
focusing on concurrency and quality rather on having lots of services.
\begin{itemize}
\item {} 
Just make outgoing calls.

\item {} 
IP authentication only (no register, no SIP auth).

\item {} 
Calls go directly from users to trunks, without any application server involved.

\item {} 
Support for routing tags (client can choose the outgoing route to use)

\item {} 
Support for audio transcoding.

\end{itemize}

\begin{notice}{warning}{Warning:}
No users, no extensions, no internal calls, no DDIs, no voicemail, no call forwards...
just \textbf{outgoing external calls}.
\end{notice}

\begin{notice}{error}{Error:}
Wholesale clients \textbf{do not need to use Brand's SIP domain in their SIP messages}.
\end{notice}


\subsubsection{Adding/Editing clients}
\label{administration_portal/brand/clients/wholesale:adding-editing-clients}
\begin{notice}{hint}{Hint:}
Some fields described below may not be visible depending on enabled features.
\end{notice}

These are the fields shown when \textbf{adding} a new wholesale client:
\begin{quote}
\begin{description}
\item[{Name}] \leavevmode
Used to reference this particular client.

\item[{Billing method}] \leavevmode
To choose among postpaid, prepaid and pseudo-prepaid. `none' disables billing.

\item[{Language}] \leavevmode
Used to choose the language of played locutions.

\item[{Default timezone}] \leavevmode
Used for showing call registries dates.

\item[{Currency}] \leavevmode
Chosen currency will be used in price calculation, invoices, balance movements and
remaining money operations of this client.

\item[{Numeric transformation}] \leavevmode
Describes the way the client will ``talk'' and the way the client wants to be ``talked''.

\item[{Max calls}] \leavevmode
Limits outgoing external calls (0 for unlimited).

\item[{Max daily usage}] \leavevmode
Limits external outbound calls when this limit is reached within a day. At midnight counters are reset and
accounts are re-enabled.

\item[{Email}] \leavevmode
A notification email will be sent to given address when configured max daily usage is reached. Leave empty to
avoid notification.

\end{description}
\end{quote}

When \textbf{editing} a client, these additional fields can be configured:
\begin{quote}
\begin{description}
\item[{Invoice data}] \leavevmode
All the fields in this group will be included in invoices generated for this client. This section also allows
showing/hiding billing details to client's portal, such as Invoices, Rating Profiles and Price of external calls.

\item[{Routing tags}] \leavevmode
This field allows enabling routing tags for this specific client. Call preceded with this
routing tags will be rated and routed differently.

\item[{Audio transcoding}] \leavevmode
This field allows enabling codecs for this specific client. This codecs will be added to
the ones offered by the client in its SDP.

\end{description}
\end{quote}

\begin{notice}{error}{Error:}
Selecting codecs in \textbf{Audio transcoding} may lead to uneeded transcoding. Selecting ALL codecs is
always a horrible idea. Do not select any codec unless this client does not support an specific codec
that is compulsory for a needed destination/carrier.
\end{notice}

\begin{notice}{note}{Note:}
Apart from these fields, main operator (\emph{aka} God) will also see a \textbf{Platform data} group that allows:
\begin{itemize}
\item {} 
Choosing an specific media relay set for the client.

\end{itemize}
\end{notice}


\subsubsection{Additional subsections}
\label{administration_portal/brand/clients/wholesale:additional-subsections}
Each entry in this table has these additional options:
\begin{itemize}
\item {} 
\textbf{List of authorized sources}: client identification will be made looking up the source IP address in this table.

\item {} 
\textbf{List of client admins}: this subsection allows managing portal credentials for this specific client. Read {\hyperref[api_rest/acls:acls]{\sphinxcrossref{\DUrole{std,std-ref}{ACLs}}}}
for further explanation about restricted client administrators.

\item {} 
\textbf{List of rating profiles}: this subsection allows managing the rating profiles that will be used to bill its outgoing calls.

\end{itemize}

\begin{notice}{warning}{Warning:}
No outgoing call will be allowed for this client unless an active rating profiles that can
bill the specific call.
\end{notice}


\subsection{Client Operators}
\label{administration_portal/brand/clients/operators::doc}\label{administration_portal/brand/clients/operators:client-operators}\label{administration_portal/brand/clients/operators:id1}
\textbf{List of client operators} subsection allows adding/editing/deleting credentials for client portal access.

Read {\hyperref[api_rest/acls:acls]{\sphinxcrossref{\DUrole{std,std-ref}{ACLs}}}} for further explanation about restricted administrators.

\begin{notice}{tip}{Tip:}
Available client types can be configured through \emph{Brand Features}.
\end{notice}


\section{Providers}
\label{administration_portal/brand/providers/index::doc}\label{administration_portal/brand/providers/index:providers}
Brand operator must reach agreements with VoIP providers to place calls of its clients and to receive calls to the
DDIs of its clients.

Depending the call direction, they can be divided into:


\subsection{Carriers}
\label{administration_portal/brand/providers/carriers:id1}\label{administration_portal/brand/providers/carriers::doc}\label{administration_portal/brand/providers/carriers:carriers}
Carriers are used for placing external outgoing calls.

This are the fields that define a carrier:

\begin{notice}{hint}{Hint:}
Some fields described below may not be visible depending on enabled features.
\begin{description}
\item[{Name}] \leavevmode
Used to reference this Carrier.

\item[{Description}] \leavevmode
Optional field with any required extra information.

\item[{Numeric Transformation}] \leavevmode
Transformation that will be applied to the origin and destination of the
outgoing numbers that use this Carrier
(see {\hyperref[administration_portal/brand/settings/numeric_transformations:numeric\string-transformations]{\sphinxcrossref{\DUrole{std,std-ref}{Numeric transformations}}}}).

\item[{Calculate cost}] \leavevmode
If set, IvozProvider will calculate the cost of the call using the carrier's active rating profile.

\item[{Currency}] \leavevmode
Chosen currency will be used in cost calculation, balance movements and
remaining money operations of this carrier.

\item[{Local socket}] \leavevmode
Selected address will be used as source address for signalling with this carrier. Brand operator can choose among
addresses assigned by main operator via {\hyperref[administration_portal/platform/brands:brands]{\sphinxcrossref{\DUrole{std,std-ref}{Brands}}}}. Read {\hyperref[administration_portal/platform/infrastructure/proxy_trunks:proxy\string-trunks]{\sphinxcrossref{\DUrole{std,std-ref}{Proxy Trunks}}}} for further details.

\item[{Media relay set}] \leavevmode
Media-relays can be grouped in sets to reserve capacities or on a geographical purpose. Selected set will be used
in calls through this specific carrier. This field in only seen by Global administrator (aka God).

\item[{Status}] \leavevmode
Non-responding carrier servers are inactivated until they respond to OPTIONS ping request. This icon is green if
every carrier server of given carrier is active, red if they are all inactive and yellow if just some of them are inactive.

\end{description}
\end{notice}

\begin{notice}{hint}{Hint:}
If you want carrier-side media handled by the same mediarelay set than client-side, select ``Client's default''.
\end{notice}


\subsubsection{Cost calculation}
\label{administration_portal/brand/providers/carriers:cost-calculation}\label{administration_portal/brand/providers/carriers:id2}
If \emph{Calculate cost} is enabled, \emph{Rating plans} can be linked to carriers for cost calculation (see
{\hyperref[administration_portal/brand/billing/rating_plans:assigning\string-rating\string-plans\string-to\string-carriers]{\sphinxcrossref{\DUrole{std,std-ref}{Assigning rating plans to carriers}}}}) and a balance is attached to each carrier. Whenever a carrier is used for
placing a call, this balance will be decreased using carrier's active rating profile.

Besides:
\begin{itemize}
\item {} 
Carrier balance can be increased/decreased with \emph{Balance operations}.

\item {} 
These operations are listed in \emph{List of Balances movements}.

\item {} 
\emph{Balance notifications} can be configured to be notified when balance reaches a given threshold.

\end{itemize}

\begin{notice}{important}{Important:}
Contrary to clients' balances, \textbf{carriers' (negative/zero) balances won't disable the carrier}.
\end{notice}


\subsubsection{Carrier Servers}
\label{administration_portal/brand/providers/carriers:carrier-servers}
A \textbf{Carrier Server} is a SIP server associated to an IP Provider. Carrier servers
are used for placing outgoing calls by using {\hyperref[administration_portal/brand/routing/outgoing_routings:outgoing\string-routings]{\sphinxcrossref{\DUrole{std,std-ref}{Outgoing Routings}}}}.
\begin{quote}
\begin{description}
\item[{SIP Proxy}] \leavevmode
IP address (or DNS registry) of the Carrier Server. You can also specify
a port if it's different from 5060.

\item[{Outbound Proxy}] \leavevmode
Usually this is left empty. It can be filled with the IP address of the
\textbf{SIP Proxy} domain (to avoid DNS resolution, but keeping the domain
in the SIP messages). It works like a web proxy: instead of sending the
SIP messages to destination \textbf{SIP Proxy}, they will be sent to the
IP:PORT of this field.

\item[{URI Scheme}] \leavevmode
Supported schemes are sip and sips. Use `sip' in case of doubt.

\item[{Transport}] \leavevmode
Supported transport protocols. Use `udp' in case of doubt.

\item[{Requires Authentication}] \leavevmode
Some Carriers validate our platform by IP, others require
each session that we want to establish. For this last case, this section
allows to configure user and password for this authentication.

\item[{Call Origin Header}] \leavevmode
Some Providers get origin from SIP From header. Others use the From
header for accounting and need extra headers to identify the origin.
In case of doubt leave \textbf{PAI} checked.

\item[{From header customization}] \leavevmode
For those providers that show origin in other headers (PAI/RPID), it is
possible that request that From User have the account code being used
and from domain their SIP domain. In case of doubt, leave empty.

\item[{Status}] \leavevmode
Non-responding carrier servers are inactivated until they respond to a OPTIONS ping request. This icon shows
if carrier server is active or inactive (and being pinged via OPTIONS message until gets back).

\end{description}
\end{quote}

\begin{notice}{tip}{Tip:}
There are many fields to establish \emph{peering} with multiple kind of
carriers, but usually with the name and SIP Proxy will be enough (for
those that validate our platform by IP) and Authentication (for those that
won't).
\end{notice}

\begin{notice}{warning}{Warning:}
In case of defining multiple Carrier Servers for a single
Carrier, IvozProvider will balance and failover using all of them.
Like with Application Servers, it will disable those who doesn't respond to
our requests.
\end{notice}


\subsubsection{List of external calls}
\label{administration_portal/brand/providers/carriers:list-of-external-calls}
You can see external calls placed through a given carrier using this option. You will see the same fields as in
{\hyperref[administration_portal/platform/external_calls:external\string-calls]{\sphinxcrossref{\DUrole{std,std-ref}{External calls}}}} but filtered for the chosen carrier.

\begin{notice}{error}{Error:}
It is compulsory to have \textbf{a valid brand URL} in order to use \emph{Export to CSV} feature in this subsection.
\end{notice}


\subsection{DDI Providers}
\label{administration_portal/brand/providers/ddi_providers:ddi-providers}\label{administration_portal/brand/providers/ddi_providers::doc}\label{administration_portal/brand/providers/ddi_providers:id1}
DDI Providers are the SIP entities that will contact the platform when someone calls to one of our client's DDIs.

This are the fields that define a carrier:

\begin{notice}{hint}{Hint:}
Some fields described below may not be visible depending on enabled features.
\begin{description}
\item[{Name}] \leavevmode
Used to reference this Carrier.

\item[{Description}] \leavevmode
Optional field with any required extra information.

\item[{Numeric Transformation}] \leavevmode
Transformation that will be applied to the origin and destination of the
outgoing numbers that use this Carrier
(see {\hyperref[administration_portal/brand/settings/numeric_transformations:numeric\string-transformations]{\sphinxcrossref{\DUrole{std,std-ref}{Numeric transformations}}}}).

\item[{Local socket}] \leavevmode
Selected address will be used as source address for signalling with this DDI provider. Brand operator can choose among
addresses assigned by main operator via {\hyperref[administration_portal/platform/brands:brands]{\sphinxcrossref{\DUrole{std,std-ref}{Brands}}}}. Read {\hyperref[administration_portal/platform/infrastructure/proxy_trunks:proxy\string-trunks]{\sphinxcrossref{\DUrole{std,std-ref}{Proxy Trunks}}}} for further details.

\item[{Media relay set}] \leavevmode
Media-relays can be grouped in sets to reserve capacities or on a geographical purpose. Selected set will be used
in calls through this specific DDI Provider. This field in only seen by Global administrator (aka God).

\end{description}
\end{notice}

\begin{notice}{hint}{Hint:}
If you want carrier-side media handled by the same mediarelay set than client-side, select ``Client's default''.
\end{notice}


\subsubsection{DDI Provider Addresses}
\label{administration_portal/brand/providers/ddi_providers:ddi-provider-addresses}
The platform will recognize a DDI provider comparing SIP message's source address with the addresses in this list:
\begin{quote}
\begin{description}
\item[{IP address}] \leavevmode
Used to reference this Carrier.

\item[{Description}] \leavevmode
Optional field with any required extra information.

\end{description}
\end{quote}

\begin{notice}{tip}{Tip:}
Once the DDI provider is recognized, its numeric transformations will be applied and the DDI will be searched.
\end{notice}


\subsubsection{DDI Provider Registrations}
\label{administration_portal/brand/providers/ddi_providers:ddi-provider-registrations}
Some DDI providers require a \href{https://tools.ietf.org/html/rfc3261\#section-10}{SIP Register} active in order to receive
incoming calls to our DDIs. Some of them, even require this register in order
to process our outgoing calls through their services.

\begin{notice}{note}{Note:}
IvozProvider supports any kind of \emph{peering}, but we highly recommend
\emph{peer to peer peerings}: without authentication, without registry and
validated by IP. This will avoid unnecessary traffic (authentication in each
session and periodic registers) and simplifies its configuration, leaving this list empty.
\end{notice}

To define a registration, these fields are shown:
\begin{quote}
\begin{description}
\item[{Username}] \leavevmode
Account number or similar provider by the provider that requires SIP
register.

\item[{Domain}] \leavevmode
Domain or IP of the registrar server. Usually the same as the SIP proxy
of the Peer server.

\item[{Password}] \leavevmode
Password used in auth process.

\item[{Random contact Username}] \leavevmode
If set, no contact username will be needed as a random string will be used. The
DDI Provider is supposed to use the called DDI in the R-URI instead of this random string.

\item[{Contact username}] \leavevmode
This will be used in REGISTER message Contact header, making DDI provider to
contact us with this in the R-URI.

\item[{Auth username}] \leavevmode
Authentication user. Most of the time it's the same as username, so
it's recommended to leave empty.

\item[{Register server URI}] \leavevmode
Usually this can be left empty, as it can be obtained from the
Domain. If it is not the case, enter the IP address with the `sip:'
prefix.

\item[{Realm}] \leavevmode
Leave empty to accept the authentication realm proposed by the provider.
Define only if you are familiar to the authentication mechanism used
in SIP.

\item[{Expire}] \leavevmode
Default suggested register expire time.

\end{description}
\end{quote}

\begin{notice}{tip}{Tip:}
Similar to the Carrier Servers, there are lots of fields in the screen.
You must have into account that most of the providers don't require register,
and those who do, will only use user, domain and password.
\end{notice}


\section{Routing}
\label{administration_portal/brand/routing/index::doc}\label{administration_portal/brand/routing/index:routing}
Routing is the process in which a carrier is chosen to place an external outgoing call.

All these concepts are taken into account:
\phantomsection\label{administration_portal/brand/routing/outgoing_routings:routes-weights}

\subsection{Outgoing Routings}
\label{administration_portal/brand/routing/outgoing_routings:routes-weights}\label{administration_portal/brand/routing/outgoing_routings:id1}\label{administration_portal/brand/routing/outgoing_routings::doc}\label{administration_portal/brand/routing/outgoing_routings:outgoing-routings}
This is the main section in which routing policies are defined.

These are the fields that define an outgoing routing:
\begin{quote}
\begin{description}
\item[{Client}] \leavevmode
Should this route apply to all clients or just to one specific client?

\item[{Routing Tag}] \leavevmode
Routing tags allow clients to call to the same destination through different carriers. This field makes the
route valid for just one routing tag (or for none).

\item[{Call destination}] \leavevmode
This groups allows selecting if this route applies for just one destination pattern, a group or faxes.

\item[{Route type}] \leavevmode
There are three kind of routes: static, LCR and block. In \emph{static}, only one carrier is selected. In \emph{LCR}, multiple carriers
may be selected. In \emph{block}, no carrier is selected as call will be dropped.

\item[{Priority}] \leavevmode
If a call matches several routes, it will be placed using the outgoing
route with lower priority, as long as it is available.

\item[{Weight}] \leavevmode
If a call matches several routes with equal priority, weight will determine
the proportion of calls that will use one route or another.

\item[{Stopper}] \leavevmode
If a call matches a route marked as stopper, matching routes with higher priority
will be ignored. \textbf{Matching routes with SAME priority route WILL apply}.

\end{description}
\end{quote}


\subsubsection{Routing selection logic}
\label{administration_portal/brand/routing/outgoing_routings:routing-selection-logic}
When a client A calls to a destination B:
\begin{enumerate}
\item {} 
\emph{Apply to all clients} routes with B destination pattern are selected.

\item {} 
\emph{Apply to all clients} routes with group containing B destination are selected.

\item {} 
\emph{Client A specific routes} routes with B destination pattern are selected.

\item {} 
\emph{Client A specific routes} routes with group containing B destination are selected.

\item {} 
All these routes are ordered using \emph{Priority} (lower priority apply first).

\item {} 
If any Blocking route has been selected, call is dropped.

\item {} 
The route with lower priority (e.g. prio Y) marked as \emph{Stopper} (if any), will cause discarding routes with priority greater than Y+1.

\item {} 
Call will be routed using routes that remain after this process, priority will determine failover process, with will determine load balance (see below).

\end{enumerate}

\begin{notice}{note}{Note:}
As described above \textbf{All clients routes apply to all clients}, even if they have specific matching routes:
\begin{itemize}
\item {} 
Use priority and stopper routes to achieve \emph{Clients with specific routes don't use All clients routes} routing strategy.

\item {} 
If you want to achieve \emph{Fallback for all clients} routing strategy, make sure you use high priority values.

\end{itemize}
\end{notice}

\begin{notice}{tip}{Tip:}
Fax specific routes will apply first for both faxes sent via virtual faxing (see {\hyperref[administration_portal/client/vpbx/faxes:faxes]{\sphinxcrossref{\DUrole{std,std-ref}{Faxes}}}}) or T.38 capable devices.
If no fax specific route is found for a given fax, routes will apply as for a normal voice call to that destination.
\end{notice}


\paragraph{Load balancing}
\label{administration_portal/brand/routing/outgoing_routings:load-balancing}
Priority and weight, are key parameters to achieve two interesting features too: \textbf{load-balancing} and \textbf{failover-routes}.

\emph{Load-balancing} lets us distribute calls matching the same pattern using
several valid outgoing routes.
\begin{itemize}
\item {} 
Example 1
\begin{itemize}
\item {} 
Route A: priority 1, weight 1

\item {} 
Route B: priority 1, weight 1

\end{itemize}

\end{itemize}

Call matching these routes will use route A for \%50 of the calls and route B for
\%50 of the calls.
\begin{itemize}
\item {} 
Example 2
\begin{itemize}
\item {} 
Route A: priority 1, weight 1

\item {} 
Route B: priority 1, weight 2

\end{itemize}

\end{itemize}

Call matching these routes will use route A for \%33 of the calls and route B for
\%66 of the calls.


\paragraph{Failover routes}
\label{administration_portal/brand/routing/outgoing_routings:failover-routes}
Failover route lets us use another route whenever the main route fails.
\begin{itemize}
\item {} 
Example
\begin{itemize}
\item {} 
Route A: priority 1, weight 1

\item {} 
Route B: priority 2, weight 1

\end{itemize}

\end{itemize}

All calls matching these routes will try to use route A. In case the call fails,
the call will be placed using route B.

\begin{notice}{tip}{Tip:}
Although given examples use two routes, more routes can be chained and
failover and load-balancing strategies can be combined.
\end{notice}


\subsubsection{LCR routes}
\label{administration_portal/brand/routing/outgoing_routings:lcr-routes}
LCR (\emph{Least Cost Routing}) routes may select more than one carrier. Whenever a LCR route is used, the platform will compute the call cost for that
given destination (for a 5 minutes duration) and will order them in increasing order.

\begin{notice}{note}{Note:}
Carriers that cannot compute cost for a given destination are silently ignored (they are not used).
\end{notice}


\paragraph{LCR and static routes combined}
\label{administration_portal/brand/routing/outgoing_routings:lcr-and-static-routes-combined}
Carrier election process can combine static and LCR routes:
\begin{enumerate}
\item {} 
Static routes result in one carrier with the priority and the weight of the route.

\item {} 
LCR routes result in \emph{n} carriers, ordered by call cost, all of them with the priority and the weight of the route.

\item {} 
Carriers are ordered using priority (ascending order).

\item {} 
Carrier's weight is used for load-balancing between carriers with same priority.

\end{enumerate}


\subsubsection{Blocking routes}
\label{administration_portal/brand/routing/outgoing_routings:blocking-routes}
Blocking routes are \emph{Stopper} routes as whenever they apply, call is dropped and no further route is evaluated.

\begin{notice}{tip}{Tip:}
Using these routes, it is easy to make a group with unwanted call prefixes and reject all calls to those
destinations for every client (or for one particular client).
\end{notice}
\phantomsection\label{administration_portal/brand/routing/routing_patterns:routing-patterns}

\subsection{Routing patterns}
\label{administration_portal/brand/routing/routing_patterns:id2}\label{administration_portal/brand/routing/routing_patterns::doc}\label{administration_portal/brand/routing/routing_patterns:routing-patterns}\label{administration_portal/brand/routing/routing_patterns:id1}
When a user dials an external phone number, IvozProvider tries to categorize
this call into one of the routing patterns defined in this section. Once categorized,
the pattern will be used in routing process described in {\hyperref[administration_portal/brand/routing/outgoing_routings:outgoing\string-routings]{\sphinxcrossref{\DUrole{std,std-ref}{Outgoing Routings}}}}.

Usually, it will we useful to have one routing pattern for the countries
defined in the \href{https://en.wikipedia.org/wiki/ISO\_3166}{ISO 3166}. That's why IvozProvider automatically
includes all this countries and their prefixes.

\begin{notice}{tip}{Tip:}
Brand operator can choose between keeping this routing pattern if
finds them useful or deleting them an creating the ones that meet his needs.
\end{notice}


\subsection{Routing pattern groups}
\label{administration_portal/brand/routing/routing_patterns_groups::doc}\label{administration_portal/brand/routing/routing_patterns_groups:routing-pattern-groups}\label{administration_portal/brand/routing/routing_patterns_groups:id1}
As we will see in {\hyperref[administration_portal/brand/routing/outgoing_routings:outgoing\string-routings]{\sphinxcrossref{\DUrole{std,std-ref}{Outgoing Routings}}}} section, every routing
pattern will be linked to a Carrier.

That's why it can be useful to group the {\hyperref[administration_portal/brand/routing/routing_patterns:id1]{\sphinxcrossref{\DUrole{std,std-ref}{Routing patterns}}}} in \textbf{routing pattern groups}
so that we can use a whole group in a routing rule.

By default we can see the countries grouped in the continents defined in
\href{https://en.wikipedia.org/wiki/ISO\_3166}{ISO 3166}.

\begin{notice}{tip}{Tip:}
Brand operator can choose between keeping this routing pattern groups if
finds them useful or deleting them an creating the ones that meet his needs.
\end{notice}


\subsection{Routing tags}
\label{administration_portal/brand/routing/routing_tags:routing-tags}\label{administration_portal/brand/routing/routing_tags::doc}
In most scenarios, Brands administrators are responsible for configuring
{\hyperref[administration_portal/brand/providers/carriers:carriers]{\sphinxcrossref{\DUrole{std,std-ref}{Carriers}}}} and {\hyperref[administration_portal/brand/routing/outgoing_routings:outgoing\string-routings]{\sphinxcrossref{\DUrole{std,std-ref}{Outgoing Routings}}}} to provide connectivity for
their clients. But in some cases, clients want to choose the outgoing routing to
use per call.

A Routing tag is \textbf{a code that will prefix the destination number when placing calls to IvozProvider} and allow clients
to choose different routes for same destinations.


\subsubsection{Add/Edit/Delete a routing tag}
\label{administration_portal/brand/routing/routing_tags:add-edit-delete-a-routing-tag}
Routing tag definition only implies these two fields:
\begin{quote}
\begin{description}
\item[{Name}] \leavevmode
Name used for referencing (e.g. ``Premium'')

\item[{Tag}] \leavevmode
Prefix itself

\end{description}
\end{quote}

\begin{notice}{important}{Important:}
Tag \textbf{must} have this format: from 1 to 3 digits ended by \# symbol.
\end{notice}


\subsubsection{Using routing tags}
\label{administration_portal/brand/routing/routing_tags:using-routing-tags}
Once created, routing tags can be used in three different sections:
\begin{itemize}
\item {} 
In \textbf{client edit screen}, to allow a client to use a routing tag.

\end{itemize}

\begin{notice}{error}{Error:}
Using a non enabled routing tag will cause the call to be declined.
\end{notice}
\begin{itemize}
\item {} 
In \textbf{Outgoing routings} to modify the way those calls are routed.

\item {} 
In \textbf{client - rating profiles association}, so that different routes imply different billing.

\end{itemize}

\begin{notice}{important}{Important:}
Route tags are only available to wholesale and retail clients at the moment.
\end{notice}


\section{Billing}
\label{administration_portal/brand/billing/index::doc}\label{administration_portal/brand/billing/index:billing}\label{administration_portal/brand/billing/index:id1}
Billing a call is the \textbf{action of setting a price} to a call that implies cost.

Billing calls depends upon an automatic process:
\begin{itemize}
\item {} 
When a call is about to be established, IvozProvider verifies that it will be able to bill it.

\end{itemize}

\begin{notice}{error}{Error:}
If with the current configuration (active and applicable rating plans for
a given client and for the specific destination) it won't be possible to
bill the call, IvozProvider will prevent its establishment.
\end{notice}
\begin{itemize}
\item {} 
Once a call that implies cost is hung up and is parsed by an asynchronous process, it is listed in {\hyperref[administration_portal/platform/external_calls:id1]{\sphinxcrossref{\DUrole{std,std-ref}{External calls}}}}.

\end{itemize}


\subsection{Billing methods}
\label{administration_portal/brand/billing/index:billing-methods}
IvozProvider supports 3 different billing methods. Billing method is configured at client level via \emph{Billing method} parameter.


\subsubsection{Postpaid billing}
\label{administration_portal/brand/billing/index:postpaid-billing}\label{administration_portal/brand/billing/index:id2}\begin{itemize}
\item {} 
Call rating is done after the call ends.

\item {} 
No configurable limit or balances involved.

\end{itemize}


\subsubsection{Prepaid billing}
\label{administration_portal/brand/billing/index:prepaid-billing}\label{administration_portal/brand/billing/index:id3}\begin{itemize}
\item {} 
Call rating is done during the call.

\item {} 
Clients with prepaid billing method have a preconfigured balance that will be decrement during the call.

\item {} 
When the balance reaches zero, all established calls for the client will hang up.

\item {} 
Clients cannot place new calls with zero or negative balance.

\item {} 
Low balance email notifications can be configured.

\end{itemize}


\subsubsection{Pseudo-prepaid billing}
\label{administration_portal/brand/billing/index:id4}\label{administration_portal/brand/billing/index:pseudo-prepaid-billing}\begin{itemize}
\item {} 
Call rating is done after the call ends.

\item {} 
Clients with pseudo-prepaid billing method have a preconfigured balance that will be decrement after the call ends.

\item {} 
Clients cannot place new calls with zero or below balance.

\item {} 
Low balance email notifications can be configured.

\end{itemize}

\begin{notice}{warning}{Warning:}
Call duration is limited to the maximum duration possible with available balance at the moment of call establishment.
\end{notice}


\subsection{Price and cost}
\label{administration_portal/brand/billing/index:price-and-cost}\begin{itemize}
\item {} 
Call \textbf{price} is the amount of money the brand operator will charge to its \textbf{client} for every call.

\item {} 
Call \textbf{cost} is the amount of money the brand operator will be charged by the \textbf{carrier} for every call.

\end{itemize}

\textbf{Call cost calculation is optional}, as no every carrier has \emph{Calculate Cost?} setting enabled. On the other hand, \textbf{call
price calculation is mandatory} for every outgoing call.

\begin{notice}{note}{Note:}
Carrier call cost calculation, if enabled, is always done postpaid. Carriers with negative balance are allowed and
no call will be hung up when carrier balance reaches 0.
\end{notice}


\subsection{Concepts}
\label{administration_portal/brand/billing/index:concepts}
This topic will cover every topic involved in the billing process:


\subsubsection{Rating plans}
\label{administration_portal/brand/billing/rating_plans:rating-plans}\label{administration_portal/brand/billing/rating_plans::doc}\label{administration_portal/brand/billing/rating_plans:id1}
Rating plans describe how calls are rated for different destinations at different times of the day.


\paragraph{Rating plan definition}
\label{administration_portal/brand/billing/rating_plans:rating-plan-definition}
{\hyperref[administration_portal/brand/billing/destination_rates:destination\string-rates]{\sphinxcrossref{\DUrole{std,std-ref}{Destination Rates}}}} are grouped using Rating plans. This offers the possibility to have base pricing data and customize
some destinations with different prices at different times of the day.

This are the fields that define a Rating plan:
\begin{quote}
\begin{description}
\item[{Name}] \leavevmode
Name that will be use to reference this rating plan.

\item[{Description}] \leavevmode
A field to enter additional information. Not used anywhere.

\item[{Currency}] \leavevmode
All destination rates grouped must use this currency.

\end{description}
\end{quote}

\begin{notice}{tip}{Tip:}
Rating plan names appear on final clients' invoices, choose something with commercial sense.
\end{notice}


\paragraph{Adding Destination rates to Rating Plan}
\label{administration_portal/brand/billing/rating_plans:adding-destination-rates-to-rating-plan}
Rating plans group several {\hyperref[administration_portal/brand/billing/destination_rates:destination\string-rates]{\sphinxcrossref{\DUrole{std,std-ref}{Destination Rates}}}} to allow flexible configuration that rate destinations differently
at different times of the day (\textbf{List of destination rates} subsection).
\begin{quote}
\begin{description}
\item[{Destination rate}] \leavevmode
Adds selected destination rate to rating plan

\item[{Weight}] \leavevmode
If a given call can be billed with more than one destination rate within the rating plan,
it will be billed using the one with highest weight.

\item[{Timing type}] \leavevmode
Should this association apply always or just at given times of the week?

\end{description}
\end{quote}

\begin{notice}{tip}{Tip:}
Weight allows having a general \emph{Destination rate} and concrete the price of
a specific destination in another \emph{destination rate} with higher weight (free cell
phone calls, for example).
\end{notice}

\begin{notice}{warning}{Warning:}
A rating plan MUST be capable of rating calls 24x7. Adding the timings of all destination rates in a rating
plan MUST cover every moment of the week.
\end{notice}
\paragraph{Checking Rating plans}

To check the configuration so far we can \textbf{Simulate a call} from the rating plans list.

We introduce the destination number in {\hyperref[administration_portal/brand/settings/numeric_transformations:e164]{\sphinxcrossref{\DUrole{std,std-ref}{E.164 format}}}}, and we can check the price every rating plan on the
list will charge for that call.

\begin{notice}{tip}{Tip:}
Rating plans can be linked to both Clients (for price calculation) and Carriers (for cost calculation).
\end{notice}


\paragraph{Assigning rating plans to clients}
\label{administration_portal/brand/billing/rating_plans:id2}\label{administration_portal/brand/billing/rating_plans:assigning-rating-plans-to-clients}
An specific \textbf{rating plan} can be linked to multiple clients.

In the section \textbf{Brand configuration} \textgreater{} \textbf{Virtual PBXs} (\textbf{Residential}, \textbf{Retail} and \textbf{Wholesale}) we select
\textbf{List of Rating Plans} subsection.

\begin{notice}{note}{Note:}
Every \textbf{Rating plan} has an activation time and only one can be active for each
client at a specific moment (the one whose activation time is nearer in the past).
\end{notice}
\paragraph{Simulating a call of a specific client}

In this list we can also simulate a call for a given client like we did previously
in the rating plan list and check the price it will imply. This way, we can be sure
that the configuration is ok.

\begin{notice}{tip}{Tip:}
Active rating plan of a given client will be used to set Price for its calls.
\end{notice}


\paragraph{Assigning rating plans to carriers}
\label{administration_portal/brand/billing/rating_plans:assigning-rating-plans-to-carriers}\label{administration_portal/brand/billing/rating_plans:id3}
An specific \textbf{rating plan} can be linked to multiple carriers to calculate cost of calls (see {\hyperref[administration_portal/brand/providers/carriers:cost\string-calculation]{\sphinxcrossref{\DUrole{std,std-ref}{Cost calculation}}}}).

In the section \textbf{Brand configuration} \textgreater{} \textbf{Providers} \textgreater{} \textbf{Carriers} we select \textbf{List of Rating Plans} subsection.

\begin{notice}{note}{Note:}
Every \textbf{Rating plan} has an activation time and only one can be active for each
client at a specific moment (the one whose activation time is nearer in the past).
\end{notice}
\paragraph{Simulating a call of a specific carrier}

In this list we can also simulate a call for a given carrier like we did previously
in the rating plan list and check the price it will imply. This way, we can be sure
that the configuration is ok.

\begin{notice}{tip}{Tip:}
Active rating plan of a given carrier will be used to set Cost for calls established using it.
\end{notice}


\subsubsection{Destination Rates}
\label{administration_portal/brand/billing/destination_rates:id1}\label{administration_portal/brand/billing/destination_rates::doc}\label{administration_portal/brand/billing/destination_rates:destination-rates}
A \emph{Destination rate} groups some prefixes with their cost details.

They only have two fields:
\begin{quote}
\begin{description}
\item[{Name}] \leavevmode
Name to reference the destination rate

\item[{Description}] \leavevmode
Additional details

\item[{Currency}] \leavevmode
All rates imported/added will use this currency

\item[{Deductible Connection Fee}] \leavevmode
Set to `No' for typical fee charged at call establishment. Set to `Yes' to enable
minimal-cost-alike behaviour (read below).

\end{description}
\end{quote}

\begin{notice}{tip}{Tip:}
Destination rate names are not shown to the final client, you can use whatever makes sense to you.
\end{notice}


\paragraph{Deductible Connection Fee (Minimal Cost)}
\label{administration_portal/brand/billing/destination_rates:deductible-connection-fee-minimal-cost}
When Destination Rate has \emph{Deductible Connection Fee} set to yes, all rates' Connection Fee will behave like Minimal Cost.

This is underlying logic:
\begin{itemize}
\item {} 
When call is established, Connection Fee of matched prefix is charged.

\item {} 
When call is hung up:
\begin{itemize}
\item {} 
Total cost without connection fee is calculated (CostWithoutConnectionFee):
\begin{itemize}
\item {} 
If is greater than connection fee, connection fee is subtracted from total cost.
\begin{itemize}
\item {} 
Final connection fee: 0

\item {} 
Final cost: CostWithoutConnectionFee

\end{itemize}

\item {} 
If is lower than connection fee, connection fee is adjusted so that total cost is equal to connection fee.
\begin{itemize}
\item {} 
Final connection fee: ConnectionFee - CostWithoutConnectionFee

\item {} 
Final cost: ConnectionFee

\end{itemize}

\end{itemize}

\item {} 
In both cases, cost difference is refunded to affected balances.

\end{itemize}

\end{itemize}
\paragraph{Connection fee 0.01 - Total cost 0.21}
\begin{itemize}
\item {} 
Cost without connection fee: 0.20

\item {} 
As 0.20 \textgreater{} 0.01:
\begin{itemize}
\item {} 
Call cost is reduced to 0.20

\item {} 
0.01 is refunded to affected balances

\end{itemize}

\end{itemize}
\paragraph{Connection fee 0.01 - Total cost 0.013}
\begin{itemize}
\item {} 
Cost without connection fee: 0.003

\item {} 
As 0.003 \textless{} 0.01:
\begin{itemize}
\item {} 
Call cost is reduced to 0.01

\item {} 
0.003 is refunded to affected balances

\end{itemize}

\end{itemize}

This setting guarantees a minimal cost of 0.01.


\paragraph{Add rates manually}
\label{administration_portal/brand/billing/destination_rates:add-rates-manually}\label{administration_portal/brand/billing/destination_rates:id2}
Brand operator can add rates by hand, filling these fields (\textbf{List of rates} subsection):
\begin{quote}
\begin{description}
\item[{Destination}] \leavevmode
Pre-created destination that specifies a concrete prefix.

\item[{Connection charge}] \leavevmode
The amount that is charged just for call establishment.

\item[{Interval start}] \leavevmode
When should the billing engine start rating the calls. If you set it to 10, first 10 seconds will be for free.

\item[{Per minute rate}] \leavevmode
Price per minute of conversation.

\item[{Charge period}] \leavevmode
Increase cost every seconds? Or in 10 second intervals? Or every minute?

\end{description}
\end{quote}

\begin{notice}{note}{Note:}
A call with less duration that the one defined in interval start will have the price of the \textbf{Connection fee}.
\end{notice}

\begin{notice}{warning}{Warning:}
All decimals must use point as decimal delimiter. 4 decimals precision is used.
\end{notice}
\paragraph{How it works}

Call cost/price is increased by (\emph{Per minute rate} / 60 ) * \emph{charge period} every \emph{charge period} seconds:
\begin{itemize}
\item {} 
If \emph{billing period} is set to 1, every second the price will be increased
\emph{price per minute} divided by 60 (bill by seconds).

\item {} 
If \emph{billing period} is set to 60, every minute the price will be increased
\emph{price per minute} (bill by minutes).

\end{itemize}


\paragraph{Importing a CSV file}
\label{administration_portal/brand/billing/destination_rates:importing-a-csv-file}\label{administration_portal/brand/billing/destination_rates:id3}
At this point, the brand operator may have noticed that adding thousands
of rates would be a really annoying and time consuming task, as there
are 254 countries, each of them with their mobile networks, landline networks,
special service numbers, etc.

That's why the creation of destination rates is done using a
\href{https://es.wikipedia.org/wiki/CSV}{CSV} file.

The first step is creating an empty \emph{Destination rate} to import the prices in and using \textbf{Import rates} option.

We can select which column contains which field, in case we want to import a
\href{https://es.wikipedia.org/wiki/CSV}{CSV} file in a non-recommended format. We
can also decide whether to import the first line or discard it as it may have
titles instead of data.

\begin{notice}{hint}{Hint:}
The importing process is done in background, letting the brand operator
continue doing other stuff while it is finished.
\end{notice}


\subparagraph{CSV format}
\label{administration_portal/brand/billing/destination_rates:csv-format}
Although the import window allows importing non-recommended format CSV files,
we encourage you to import a file in the proposed format, as it will make
this process much easier:

\begin{notice}{error}{Error:}
Comma is the only allowed separator character.
\end{notice}

\begin{notice}{error}{Error:}
Single quotes are not supported.
\end{notice}

You can find a sample CSV for importing \href{https://raw.githubusercontent.com/irontec/ivozprovider/artemis/web/admin/samples/pricesSample.csv}{here}.

The order of the columns should be:
\begin{itemize}
\item {} 
Destination name

\end{itemize}

\begin{notice}{warning}{Warning:}
If they contain any comma, they MUST be quoted with double quotes. Otherwise, double quotes are optional.
\end{notice}
\begin{itemize}
\item {} 
Destination prefix

\end{itemize}

\begin{notice}{warning}{Warning:}
MUST start with + sign.
\end{notice}

\begin{notice}{error}{Error:}
If same prefix is used in multiple times in CSV file, import process will fail.
\end{notice}
\begin{itemize}
\item {} 
Per minute rate

\item {} 
Connection charge

\end{itemize}

\begin{notice}{warning}{Warning:}
MUST use point as decimal separator.
\end{notice}
\begin{itemize}
\item {} 
Charge period

\end{itemize}

\begin{notice}{tip}{Tip:}
Given in seconds, only integers greater or equal 1 are supported.
\end{notice}

Once the import process is over, we only have to include this destination rate into some
rating plan and bind it to the clients/carriers we want following the procedure explained in
{\hyperref[administration_portal/brand/billing/rating_plans:rating\string-plans]{\sphinxcrossref{\DUrole{std,std-ref}{Rating plans}}}}.


\paragraph{Re-importing a CSV file}
\label{administration_portal/brand/billing/destination_rates:re-importing-a-csv-file}
Once a CSV (first.csv) is imported into an empty destination-rates row, you can \textbf{import another CSV} (second.csv).

However, it is \textbf{important to understand what happens} when you do so:
\begin{itemize}
\item {} 
Prefixes in both CSV will get its rate \textbf{updated} with second's CSV one.

\item {} 
Prefixes existing only in the first CSV file will be \textbf{kept}.

\item {} 
Prefixes existing only in the second CSV file will be \textbf{added}.

\end{itemize}

\begin{notice}{error}{Error:}
Downloading CSV using \emph{Imported file} option will always download \textbf{last imported CSV file} (no the
combination of both as described above).
\end{notice}

Note that if both \emph{first.csv} and \emph{second.csv} contain exactly the same prefixes, resulting destination-rate will be as
we had only imported \emph{second.csv}. And downloading \emph{Imported file} will download \emph{second.csv}, that is exactly the current
state of destination-rate.


\subsubsection{Destinations}
\label{administration_portal/brand/billing/destinations::doc}\label{administration_portal/brand/billing/destinations:destinations}
\emph{Destinations} section binds prefixes (always starting with +) with names.

\begin{notice}{tip}{Tip:}
These names will be used in invoices to identify matching destinations.
\end{notice}

Adding destination by hand is only needed is you want to add \emph{destination rates} by hand as explained in {\hyperref[administration_portal/brand/billing/destination_rates:add\string-rates\string-manually]{\sphinxcrossref{\DUrole{std,std-ref}{Add rates manually}}}}.

All non-existent prefixes found in CSV importing process described in {\hyperref[administration_portal/brand/billing/destination_rates:importing\string-a\string-csv\string-file]{\sphinxcrossref{\DUrole{std,std-ref}{Importing a CSV file}}}} will added to this list
automatically.


\subsubsection{Prepaid balances}
\label{administration_portal/brand/billing/prepaid_balances::doc}\label{administration_portal/brand/billing/prepaid_balances:prepaid-balances}
This section displays the balance status for {\hyperref[administration_portal/brand/billing/index:prepaid\string-billing]{\sphinxcrossref{\DUrole{std,std-ref}{Prepaid billing}}}} and {\hyperref[administration_portal/brand/billing/index:pseudo\string-prepaid\string-billing]{\sphinxcrossref{\DUrole{std,std-ref}{Pseudo-prepaid billing}}}} clients.

Following options are available for each client:


\paragraph{Balance Operations}
\label{administration_portal/brand/billing/prepaid_balances:balance-operations}
Brand administrators increase/decrease the balance of a given client using this option.


\paragraph{Balance Movements List}
\label{administration_portal/brand/billing/prepaid_balances:balance-movements-list}
Brand administrators can keep track the balance movements (increase or decrease) on this account and their status
after the movement.


\paragraph{Balance Notifications}
\label{administration_portal/brand/billing/prepaid_balances:balance-notifications}
Brand administrators can configure email notifications when the balance is below a given threshold. See
{\hyperref[administration_portal/brand/settings/notification_templates:id1]{\sphinxcrossref{\DUrole{std,std-ref}{Notification Templates}}}} to customize the sent email.


\subsubsection{Current day usages}
\label{administration_portal/brand/billing/current_day_usages:current-day-usages}\label{administration_portal/brand/billing/current_day_usages::doc}\label{administration_portal/brand/billing/current_day_usages:id1}
This section lists current day usage for each client in the brand:
\begin{quote}
\begin{description}
\item[{Type}] \leavevmode
Type of client (vPBX, retail, residential or wholesale).

\item[{Name}] \leavevmode
Client name.

\item[{Today usage}] \leavevmode
Amount of spent money in today's external calls.

\item[{Max daily usage}] \leavevmode
When this threshold is reached, account is disabled. At midnight, it will be re-enabled.

\item[{Status}] \leavevmode
Whether account has been disabled or not.

\end{description}
\end{quote}

\begin{notice}{note}{Note:}
Client max daily usage is configured in \textbf{Clients configuration} with \textbf{Max daily usage} parameter.
\end{notice}

\begin{notice}{tip}{Tip:}
If an account is disabled, increasing its counter above current day usages re-enables it. Otherwise, it will be
re-enabled at midnight.
\end{notice}

\begin{notice}{error}{Error:}
This is one of main {\hyperref[security_and_maintenance/security/index:security]{\sphinxcrossref{\DUrole{std,std-ref}{Security}}}} mechanisms available in IvozProvider. Use it to avoid toll fraud calls
(see {\hyperref[security_and_maintenance/security/current_day_max_usage:current\string-day\string-max\string-usage]{\sphinxcrossref{\DUrole{std,std-ref}{Current day max usage}}}}).
\end{notice}

This section shows runtime value obtained asking to CGRateS (value actually applying) that should be equal to the one
set editing the client itself. If data is shown in red, these values differ.


\section{Invoicing}
\label{administration_portal/brand/invoicing/index::doc}\label{administration_portal/brand/invoicing/index:invoicing}
The final goal of this section is to generate invoices with the calls that imply
cost of a given client.

These topics will be covered:


\subsection{Invoices}
\label{administration_portal/brand/invoicing/invoices:invoices}\label{administration_portal/brand/invoicing/invoices::doc}\label{administration_portal/brand/invoicing/invoices:id1}
\textbf{Invoices} section lets \textbf{brand operator} generate invoices to issue to its clients and lists all invoices of all
clients, no matter if they were generated automatically or manually.

\begin{notice}{tip}{Tip:}
Brand administrators can also enable view mode on this section to their clients. Check Client's Invoice data
configuration section for more information.
\end{notice}


\subsubsection{Generating a new invoice}
\label{administration_portal/brand/invoicing/invoices:generating-a-new-invoice}
These are the fields shown when \emph{Add Invoice} options is used:
\begin{quote}
\begin{description}
\item[{Invoice number sequence}] \leavevmode
Use next number of a predefined sequence or use custom number

\item[{Number}] \leavevmode
Only shown if no sequence number is used, lets brand operator to introduce a custom number

\item[{Client}] \leavevmode
The client whose calls will be invoiced

\item[{Template}] \leavevmode
Invoice template that will be used to generate the PDF invoice file

\item[{In/Out date}] \leavevmode
The time period of the calls that will be invoiced

\item[{Call discount}] \leavevmode
Percentage to discount calls, prior to tax rate calculation. No effect on fixed concepts.

\item[{Tax rate}] \leavevmode
Taxes to add to the final cost (e.g. VAT)

\end{description}
\end{quote}

Once saved, some {\hyperref[administration_portal/brand/invoicing/fixed_costs:fixed\string-costs]{\sphinxcrossref{\DUrole{std,std-ref}{Fixed costs}}}} can be added before generating the final invoice. This is achieved with \textbf{Fixed costs}
subsection, that allows adding several positive concepts to the invoice:
\begin{quote}
\begin{description}
\item[{Fixed cost}] \leavevmode
Choose a predefined cost

\item[{Quantity}] \leavevmode
How many of this must be included

\end{description}
\end{quote}

The last step is pressing \textbf{Generate invoice} suboption to create the final PDF. Afterwards, we can see which calls have been
included in a particular invoice with \textbf{List of External Calls} option or download the PDF file.

\begin{notice}{warning}{Warning:}
Only outbound external calls are included into invoices
\end{notice}

\begin{notice}{tip}{Tip:}
\textbf{Status} column shows if the PDF generation task is waiting for async worker (\emph{waiting}), in process (\emph{processing}),
ended with errors (\emph{failed}) or ended successfully (\emph{created}). On blank, \emph{Generate invoice} needs to be pressed.
\end{notice}


\paragraph{Rules}
\label{administration_portal/brand/invoicing/invoices:rules}
Invoice subsystem enforces several rules before generating a new invoice:
\begin{itemize}
\item {} 
\textbf{Proper date interval}: \emph{out date} must be bigger (after) than \emph{in date}.

\item {} 
\textbf{Out date must be previous than today}: Future dates or today's calls cannot be invoiced.

\item {} 
\textbf{One call, one invoice:} All calls in time interval cannot be included in any other invoice.

\item {} 
\textbf{All calls in interval must be billed}.

\end{itemize}

\begin{notice}{warning}{Warning:}
If any of these rules is not fulfilled, the invoice won't be created and the system will warn.
\end{notice}


\paragraph{Timezones}
\label{administration_portal/brand/invoicing/invoices:timezones}
\emph{In date} and \emph{Out date} will be interpreted using brand timezone. On the other hand, call times in invoices are converted
to client timezone, leading to situations like this:
\begin{itemize}
\item {} 
\emph{In date}: 01/10/2018 00:00:00

\item {} 
\emph{Out date}: 31/10/2018 23:59:59

\item {} 
Brand timezone: UTC + 1

\item {} 
Client timezone: UTC - 1

\item {} 
Time interval in brand timezone: 01/10/2018 00:00 - 31/10/2018 23:59:59

\item {} 
Time interval in client timezone: 30/09/2018 22:00 - 31/10/2018 21:59:59

\end{itemize}

Invoice generated for the client will have calls from 30nd of september at 22:00 to 31st of october at 21:59:59, which
may seem awkward to the client.


\subsubsection{Regenerating an existing invoice}
\label{administration_portal/brand/invoicing/invoices:regenerating-an-existing-invoice}
Brand operator can edit any invoice parameter (as long as rules above are fulfilled), add/remove fixed concepts, etc. and
press \textbf{Generate invoice} again.

\begin{notice}{tip}{Tip:}
Whenever a change is made, \emph{Status} column will change to blank to show that \emph{Generate invoice} must be pressed.
\end{notice}


\paragraph{Generate invoice for rerated calls}
\label{administration_portal/brand/invoicing/invoices:generate-invoice-for-rerated-calls}
If rating of any call included in an invoice is wrong, {\hyperref[administration_portal/platform/external_calls:external\string-calls]{\sphinxcrossref{\DUrole{std,std-ref}{External calls}}}} section allows rerating it, as long as the
invoice that includes the call is previously deleted.

Once deleted and rerated, a new row can be added in \emph{Invoices} section to include rerated calls.


\subsubsection{List of external calls}
\label{administration_portal/brand/invoicing/invoices:list-of-external-calls}
You can see calls of a given invoice using this option. You will see the same fields as in {\hyperref[administration_portal/platform/external_calls:external\string-calls]{\sphinxcrossref{\DUrole{std,std-ref}{External calls}}}}.

\begin{notice}{error}{Error:}
It is compulsory to have \textbf{a valid brand URL} in order to use \emph{Export to CSV} feature in this subsection.
\end{notice}


\subsection{Invoice schedulers}
\label{administration_portal/brand/invoicing/invoice_schedulers::doc}\label{administration_portal/brand/invoicing/invoice_schedulers:invoice-schedulers}\label{administration_portal/brand/invoicing/invoice_schedulers:id1}
This section allows programming the automatic periodical creation of invoices.

When adding a new definition, these fields are shown:
\begin{quote}
\begin{description}
\item[{Name}] \leavevmode
Name of the scheduled invoice

\item[{Client}] \leavevmode
Which client calls should be included

\item[{Email}] \leavevmode
Send generated invoices via email. Empty if no automatic mail is wanted.

\item[{Frequency/Unit}] \leavevmode
Defines the frequency (once a month, every 7 days, etc.) of the programmed task

\item[{Invoice number sequence}] \leavevmode
Scheduled invoices will use the next invoice number available in a given predefined sequence

\item[{Call discount}] \leavevmode
Percentage to discount calls, prior to tax rate calculation. No effect on fixed concepts.

\item[{Tax rate}] \leavevmode
Taxes to add to the final cost (e.g. VAT)

\end{description}
\end{quote}

Invoices generated due to a schedule can be seen in two ways:
\begin{itemize}
\item {} 
In each row of \emph{Invoice schedulers} section, \textbf{List of Invoices} option.

\item {} 
In \emph{Invoices} section, indistinguishable to manually generated invoices.

\end{itemize}


\subsubsection{Fixed costs}
\label{administration_portal/brand/invoicing/invoice_schedulers:fixed-costs}
When defining a scheduled invoice, you can add fixed costs in a static or dynamic way:
\begin{itemize}
\item {} 
Type \textbf{`static'} is used for fixed quantities.

\item {} 
Type \textbf{`Max calls'} sets the quantity in the moment of the creation of the invoice to
``Max calls'' value of the client in that specific moment.

\item {} 
Type \textbf{`DDIs'} sets the quantity in the moment of the creation of the invoice to
the number of DDIS matching criteria (all, national, international or belonging to specific country)
in the client in that specific moment.

\end{itemize}

\begin{notice}{tip}{Tip:}
Non-static values are retrieved from client configuration in the date specified in ``Next execution''.
Regenerating the invoice later will not modify assigned value, but you can adapt it manually to
the desired value editing the fixed cost in Invoice section and regenerating the invoice.
\end{notice}


\subsubsection{Frequency definition}
\label{administration_portal/brand/invoicing/invoice_schedulers:frequency-definition}
It is interesting to understand how \emph{Frequency} and \emph{Unit} fields define the periodical task:
\begin{itemize}
\item {} 
Invoices are programmed at 08:00:00 by default on mondays, 1st of month or 1st of January (depending on Unit value).

\item {} 
Once created a new schedule, \textbf{Next execution} shows when will happen next invoice generation.

\end{itemize}

\textbf{Next execution} value can be mangled, but generated invoice always will:
\begin{itemize}
\item {} 
Discard current day (2018/11/01 08:00:00 will set 2018/10/31 23:59:59 as \emph{Out date}).

\item {} 
\emph{In date} will be \emph{out date} minus X week(s), X month(s) or X year(s) (X equals to \emph{Frequency} value) + 1 second.

\end{itemize}
\paragraph{Example 1: Unit: week - Frequency 2}

Next execution will be set to next monday at 08:00 and invoices will include calls of last 2 weeks.
\paragraph{Example 1: Unit: month - Frequency 3}

Next execution will be set to next 1st of month at 08:00 and invoices will include calls of last 3 months.
\paragraph{Example 1: Unit: month - Frequency 1 - Next execution mangling}

Next execution will be set to next 1st of month at 08:00 but we mangle it to 3rd of month at 10:00:00.

Invoice will include calls from 3nd of previous month at 00:00:00 to 2nd to current month at 23:59:59.

\begin{notice}{tip}{Tip:}
\emph{Last execution} shows the date of last execution and its result (success/error).
\end{notice}

\begin{notice}{note}{Note:}
Both \emph{next execution} and \emph{last execution} are shown using brand timezone.
\end{notice}


\subsection{Invoice number sequences}
\label{administration_portal/brand/invoicing/invoice_number_sequences:invoice-number-sequences}\label{administration_portal/brand/invoicing/invoice_number_sequences::doc}
In order to allow programming automatic invoice generation using {\hyperref[administration_portal/brand/invoicing/invoice_schedulers:invoice\string-schedulers]{\sphinxcrossref{\DUrole{std,std-ref}{Invoice schedulers}}}} section, invoice
numbers must be created using a defined sequence number.

This section allows brand operator to create as many sequences as needed filling these fields:
\begin{quote}
\begin{description}
\item[{Name}] \leavevmode
Used for referencing this sequence in Invoice generation window.

\item[{Prefix}] \leavevmode
Prepended in any number generated by this sequence.

\item[{Sequence length}] \leavevmode
Zeroes will be prepended to enforce this length.

\item[{Increment}] \leavevmode
Units between subsequent invoice numbers.

\end{description}
\end{quote}

\begin{notice}{note}{Note:}
Invoice number sequences are mandatory for scheduled invoices and optional for manual invoices.
\end{notice}
\paragraph{Example (prefix: TEST, sequence length: 4, increment: 1)}

Generated sequence numbers will be: TEST0001, TEST0002, TEST0003 and so on.

\begin{notice}{tip}{Tip:}
\textbf{Latest value} field shows the value of last invoice number that used a given sequence.
\end{notice}


\subsection{Fixed costs}
\label{administration_portal/brand/invoicing/fixed_costs:fixed-costs}\label{administration_portal/brand/invoicing/fixed_costs::doc}\label{administration_portal/brand/invoicing/fixed_costs:id1}
Fixed costs are a positive concepts that can be added to invoices prior to generating the final PDF.

It may be useful for services with fixed cost (e.g. FTTH 100 Mbps) of certain clients.

\begin{notice}{tip}{Tip:}
Use invoice templates that show a custom table for these concepts if your invoice will have any fixed cost.
\end{notice}


\subsection{Invoice templates}
\label{administration_portal/brand/invoicing/invoice_templates::doc}\label{administration_portal/brand/invoicing/invoice_templates:invoice-templates}
Before generating an example invoice, it is important to understand that invoice
creation process uses templates.

\begin{notice}{note}{Note:}
This way, every \textbf{brand operator} can adapt which information
is shown and how this information is shown, add logos, graphs, etc..
\end{notice}

Templates are parsed by \href{https://github.com/XaminProject/handlebars.php}{handlebars} and rendered
using \href{https://wkhtmltopdf.org/}{wkhtmltopdf} library.

The helper in the section \textbf{Brand configuration} \textgreater{} \textbf{Invoice templates} include
a summarized explanation of the creation of templates. In the \href{https://wkhtmltopdf.org/usage/wkhtmltopdf.txt}{official site of wkhtmltopdf} there is plenty additional information.
You can delve into template expressions \href{http://handlebarsjs.com/expressions.html}{here} as well.

\begin{notice}{tip}{Tip:}
Use \emph{Template testing} option to see a demo invoice for each template.
\end{notice}


\section{Calls}
\label{administration_portal/brand/calls/index::doc}\label{administration_portal/brand/calls/index:calls}
This group shows call lists and allows brand operator a few operations on them:


\subsection{Active calls}
\label{administration_portal/brand/calls/active_calls::doc}\label{administration_portal/brand/calls/active_calls:active-calls}
This section allows main operator and brand operator view \textbf{current active external calls}.

\begin{notice}{warning}{Warning:}
Internal calls won't be listed.
\end{notice}

These are columns shown:
\begin{quote}
\begin{description}
\item[{Duration}] \leavevmode
Show call establishment duration during establishment and call duration during ongoing call. It also shows
direction (inbound/outbound) and call state information, as explained below.

\item[{Brand}] \leavevmode
Brand making a given call (only shown at god level).

\item[{Client}] \leavevmode
Client making a given call.

\item[{Caller}] \leavevmode
Call source number in E.164.

\item[{Callee}] \leavevmode
Call destination number in E.164.

\item[{Carrier}] \leavevmode
Carrier/DDI Provider used in given call.

\end{description}
\end{quote}


\subsubsection{Call state}
\label{administration_portal/brand/calls/active_calls:call-state}
Call state follows \href{https://tools.ietf.org/html/rfc4235\#section-3.7.1}{Dialog State Machine proposed in RFC4235}:
\begin{itemize}
\item {} 
\textbf{Trying}
\begin{itemize}
\item {} 
INVITE sent, someone is trying to make a new call.

\item {} 
Shown as \emph{Call Setup} in this section.

\end{itemize}

\item {} 
\textbf{Proceeding}
\begin{itemize}
\item {} 
Provisional response from middle proxies received (usually 100 Trying).

\item {} 
This state is ignored in this section.

\end{itemize}

\item {} 
\textbf{Early}
\begin{itemize}
\item {} 
Provisional response from final party received (usually 180 Ringing).

\item {} 
Shown as \emph{Ringing} in this section.

\end{itemize}

\item {} 
\textbf{Confirmed}
\begin{itemize}
\item {} 
200 OK received, call confirmed, parties talking.

\item {} 
Shown as \emph{In call} in this section.

\end{itemize}

\item {} 
\textbf{Terminated}
\begin{itemize}
\item {} 
BYE/CANCEL/error-response (\textgreater{}300) received, call finished.

\item {} 
Call vanishes to show this status.

\end{itemize}

\end{itemize}
\paragraph{Example 1: Successful call}

A successful call traverses this states:
\begin{itemize}
\item {} 
Trying -\textgreater{} Proceeding (optional) -\textgreater{} Early (optional) -\textgreater{} Confirmed -\textgreater{} Terminated

\end{itemize}

That will be coded in this section as:
\begin{itemize}
\item {} 
Call Setup -\textgreater{} Ringing (optional) -\textgreater{} In call -\textgreater{} Call vanishes

\end{itemize}
\paragraph{Example 2: Unsuccessful call}

An unsuccessful call traverses this states:
\begin{itemize}
\item {} 
Trying -\textgreater{} Proceeding (optional) -\textgreater{} Early (optional) -\textgreater{} Terminated

\end{itemize}

That will be show in this section as:
\begin{itemize}
\item {} 
Call Setup -\textgreater{} Ringing (optional) -\textgreater{} Call vanishes

\end{itemize}


\subsection{External calls}
\label{administration_portal/brand/calls/external_calls::doc}\label{administration_portal/brand/calls/external_calls:external-calls}
\textbf{External calls} section lists \textbf{both inbound and outbound external calls}.

This section is shown at different levels:
\begin{itemize}
\item {} 
Main level (god level)

\item {} 
Brand level (filtered for emulated/logged brand).

\item {} 
Client level (filtered for emulated/logged client).

\end{itemize}

Each entry shows this information:
\begin{quote}
\begin{description}
\item[{Start time}] \leavevmode
Date and time of the call establishment.

\item[{Brand}] \leavevmode
Only visible for \emph{god}, shows the brand of each call.

\item[{Client}] \leavevmode
Visible for \emph{god} and \emph{brand operator}, shows the client of each call.

\item[{Caller}] \leavevmode
DDI presented for the outgoing call.

\item[{Callee}] \leavevmode
External number dialed.

\item[{Duration}] \leavevmode
Shows how long the call lasted.

\item[{Price}] \leavevmode
The money amount for the client. Visible for \emph{god} and \emph{brand operator} and \emph{Client administrator} if
\emph{Display billing details to client} is enabled.

\item[{Cost}] \leavevmode
Visible for \emph{god} and \emph{brand operator}, the money amount for the brand (the money that the carrier will bill for the call).

\item[{Rating Plan}] \leavevmode
Rating plan used to set price for the call. Visible for \emph{god} and \emph{brand operator} and \emph{Client administrator} if
\emph{Display billing details to client} is enabled.

\item[{Destination}] \leavevmode
Destination that matched the call for billing. Visible for \emph{god} and \emph{brand operator} and \emph{Client administrator} if
\emph{Display billing details to client} is enabled.

\item[{Carrier}] \leavevmode
Visible for \emph{god} and \emph{brand operator}, shows which {\hyperref[administration_portal/brand/providers/carriers:carriers]{\sphinxcrossref{\DUrole{std,std-ref}{Carrier}}}} was used for each outbound call.

\item[{DDI Provider}] \leavevmode
Visible for \emph{god} and \emph{brand operator}, shows which {\hyperref[administration_portal/brand/providers/ddi_providers:ddi\string-providers]{\sphinxcrossref{\DUrole{std,std-ref}{DDI Provider}}}} was used for each inbound call.

\item[{Invoice}] \leavevmode
Visible for \emph{god} and \emph{brand operator}, shows if a call is already included in any {\hyperref[administration_portal/brand/invoicing/invoices:invoices]{\sphinxcrossref{\DUrole{std,std-ref}{Invoice}}}}.

\item[{Call ID}] \leavevmode
Shows the call ID of the call for troubleshooting and CSV export.

\item[{Endpoint Type}] \leavevmode
Possible values: RetailAccount, ResidentialDevice, User, Fax, Friend.

\item[{Endpoint Id}] \leavevmode
Internal ID of specific endpoint (only when \emph{endpointType} is non-empty).

\item[{Endpoint Name}] \leavevmode
User extension, friend name, fax name, retail account name or residential device name (only when \emph{endpointId} is non-empty).

\end{description}
\end{quote}

\begin{notice}{note}{Note:}
An asynchronous process parses each external call and adds it to this list a few minutes after call hangup. Billing related fields, such as cost and price, will be empty for external incoming calls.
\end{notice}


\subsubsection{Call rerating}
\label{administration_portal/brand/calls/external_calls:call-rerating}
At \textbf{brand level}, there is an additional available operation for outbound calls: \textbf{Rerate call}. This option allows calling rating engine again for a call or a bunch of calls.

Notes about this rerating process:
\begin{itemize}
\item {} 
If a call is in an invoice, it cannot be rerated. Invoice must be deleted first.

\item {} 
Call will be rerated with the \emph{Start time} of the call (no with current active rating plans, but with active rating plans
on the moment of the call).

\item {} 
Both \emph{Price} and \emph{Cost} will be recalculated. This may imply updating \emph{rating plan} and \emph{destination} too.

\end{itemize}

\begin{notice}{tip}{Tip:}
When a call is rerated, cost and price are emptied until the next iteration of the asynchronous task.
\end{notice}


\subsection{Call CSV schedulers}
\label{administration_portal/brand/calls/call_csv_schedulers:call-csv-schedulers}\label{administration_portal/brand/calls/call_csv_schedulers::doc}\label{administration_portal/brand/calls/call_csv_schedulers:id1}
This section allows programming automatic periodical CSV reports to brand operators.

\begin{notice}{note}{Note:}
This section is almost identical to {\hyperref[administration_portal/brand/invoicing/invoice_schedulers:invoice\string-schedulers]{\sphinxcrossref{\DUrole{std,std-ref}{Invoice schedulers}}}} except to the
fields that do not apply to CSVs (Invoice number sequence, Tax rate...)
\end{notice}

When adding a new definition, these fields are shown:
\begin{quote}
\begin{description}
\item[{Name}] \leavevmode
Name of the scheduled Call CSV

\item[{Email}] \leavevmode
Send generated Call CSV via email. Empty if no automatic mail is wanted.

\item[{Client type}] \leavevmode
Selecting \emph{All} will generate a CSV containing calls of all clients. Selecting one client type
will allow selecting one specific client of that type.

\item[{Notification template}] \leavevmode
Used on email notifications for schedulers containing calls of all clients. In client specific
schedulers, the notification template assigned to the specific client will be used.

\item[{Frequency/Unit}] \leavevmode
Defines the frequency (once a month, every 7 days, etc.) of the programmed task

\item[{Direction}] \leavevmode
Defines which calls should be included attending to its direction (inbound, outbound, both).

\item[{Carrier}] \leavevmode
Only for \emph{Direction: outbound} reports, allows filtering calls of one specific carrier.

\item[{Client}] \leavevmode
Only for \emph{Client type} different from \emph{All}, allows selecting one specific client of chosen type.

\item[{DDI}] \leavevmode
Lists all DDIs of chosen client to get only calls from/to that specific DDI.

\item[{Endpoint type}] \leavevmode
Allows selecting one specific endpoint type of chosen client. Depending on client type, different values will
be listed.

\item[{Residential device}] \leavevmode
Only for \emph{Client type: residential} and \emph{Endpoint type: residential device}, allows selecting one specific residential device of chosen client.

\item[{Retail account}] \leavevmode
Only for \emph{Client type: retail}, allows selecting one specific retail account of chosen client.

\item[{User}] \leavevmode
Only for \emph{Client type: vpbx} and \emph{Endpoint type: user}, allows selecting one specific user of chosen client.

\item[{Fax}] \leavevmode
Only for \emph{Client type: vpbx/residential} and \emph{Endpoint type: fax}, allows selecting one specific fax of chosen client.

\item[{Friend}] \leavevmode
Only for \emph{Client type: vpbx} and \emph{Endpoint type: friend}, allows selecting one specific friend of chosen client.

\end{description}
\end{quote}

Once created, some new fields and subsections are accesible:
\begin{quote}
\begin{description}
\item[{Next execution}] \leavevmode
Shows next execution date

\item[{Last execution}] \leavevmode
Shows last execution and its result.

\end{description}
\end{quote}

\begin{notice}{tip}{Tip:}
Modifying \emph{Next execution} value allows forcing specific runs. For example, setting \emph{Next execution} to
current month's first day will create again last month's CSV report (for a monthly scheduler).
\end{notice}

Generated CSVs of each scheduler can be accessed in \textbf{List of Call CSV reports} subsection.


\subsubsection{CSV fields}
\label{administration_portal/brand/calls/call_csv_schedulers:csv-fields}
These are the fields of the generated CSV files:
\begin{quote}
\begin{description}
\item[{callid}] \leavevmode
Call-ID of the SIP dialog

\item[{startTime}] \leavevmode
Time and date of the call establishment

\item[{duration}] \leavevmode
Call duration in seconds

\item[{caller}] \leavevmode
Caller number in E.164 format (with `+')

\item[{callee}] \leavevmode
Callee number in E.164 format (with `+')

\item[{cost}] \leavevmode
Calculated cost for the given call

\item[{price}] \leavevmode
Calculated price for the given call

\item[{endpointType}] \leavevmode
Possible values: RetailAccount, ResidentialDevice, User, Fax, Friend.

\item[{endpointId}] \leavevmode
Internal ID of specific endpoint (only when \emph{endpointType} is non-empty).

\item[{endpointName}] \leavevmode
User extension, friend name, fax name, retail account name or residential device name (only when \emph{endpointId} is non-empty).

\item[{direction}] \leavevmode
Possible values: inbound, outbound.

\item[{companyId}] \leavevmode
Client ID

\item[{carrierId}] \leavevmode
Only for outbound calls, internal ID of used carrier

\item[{ddiProviderId}] \leavevmode
Only for inbound calls, internal ID of used DDI Provider

\item[{ddiId}] \leavevmode
Client DDI to which call will be assigned (callee for inbound calls, caller for outbound calls). Empty for
wholesale clients.

\end{description}
\end{quote}


\subsubsection{DDI Provider detection}
\label{administration_portal/brand/calls/call_csv_schedulers:ddi-provider-detection}
DDI Provider detection deserves a deeper explanation as is not as unambiguous as Carrier (carrier is the one chosen by
routing logic, no doubt here).

DDI Provider detection logic is directly related to underlying DDI detection logic.

When IvozProvider receives an INVITE to KamTrunks from an outside entity:
\begin{enumerate}
\item {} 
Source IP is compared against all DDI Providers addresses (from all brands).
\begin{itemize}
\item {} 
If none matches, call is rejected.

\end{itemize}

\item {} 
DDI is transformated in a loop using matching DDI Providers transformation rules (the lower id, the first).

\item {} 
As soon as transformated DDI matches a DDI (in E.164) within the same brand, loop ends and call is accepted.
\begin{itemize}
\item {} 
If loop ends without any match, call is rejected.

\end{itemize}

\end{enumerate}

The DDI Provider that allowed that match is saved as DDI Provider for that inbound all, except:
\begin{itemize}
\item {} 
Matched DDI is linked to another DDI Provider that also matches source IP address. If this happens, linked DDI Provider
is saved instead.

\end{itemize}


\subsubsection{Using CSV scheduler as a one-shot CSV generator}
\label{administration_portal/brand/calls/call_csv_schedulers:using-csv-scheduler-as-a-one-shot-csv-generator}
\emph{External Calls} section can filter list and export resulting rows to CSV, but filter criteria are much powerful in
\emph{Call CSV schedulers} section.

That's why \textbf{it could be useful to use this section even if we are not interested in scheduling any recurring CSV}.

\begin{notice}{note}{Note:}
Scheduling a CSV to generate just a CSV could be useful as \emph{Call CSV Schedulers} have more filtering criteria
than \emph{External Calls} section.
\end{notice}

Imagine you need:
\begin{itemize}
\item {} 
Start date: 2020/06/02 (included)

\item {} 
End date: 2020/06/14 (included)

\item {} 
Client: XXX (vpbx)

\item {} 
Inbound calls to YYY DDI answered by user ZZZ

\end{itemize}

To achieve such a CSV using schedules section we would \textbf{create a scheduler} with these inputs:
\begin{itemize}
\item {} 
Client Type: vpbx

\item {} 
Client: XXX

\item {} 
DDI: YYY

\item {} 
Endpoint Type: user

\item {} 
User: ZZZ

\item {} 
Direction: inbound.

\item {} 
Unit: days.

\item {} 
Frequency: 13

\end{itemize}

\begin{notice}{tip}{Tip:}
Get sure you set \emph{Unit} to days and \emph{Frequency} to the amount of days wanted in resulting CSV. In the example,
from 2nd of June to 14th, both included, we have 13 days.
\end{notice}

Once generated, we would \textbf{edit Next execution time} from tomorrow's date to 2020/06/15, leaving time unchanged.

\begin{notice}{tip}{Tip:}
Get sure you modify \emph{Next execution} to the first day not wanted in resulting CSV.
\end{notice}

Then we will \textbf{wait a few minutes} until scheduler generates our CSV, \textbf{download} it and \textbf{delete the row to avoid recurrent
CSV generation}.


\section{Settings}
\label{administration_portal/brand/settings/index::doc}\label{administration_portal/brand/settings/index:settings}
This group contains two kind of sections:
\begin{itemize}
\item {} 
Brand global configuration

\item {} 
Brand defaults for new clients

\end{itemize}

These will be covered topics:
\phantomsection\label{administration_portal/brand/settings/client_portals:client-portals}

\subsection{Client Portals}
\label{administration_portal/brand/settings/client_portals:client-portals}\label{administration_portal/brand/settings/client_portals:id2}\label{administration_portal/brand/settings/client_portals::doc}\label{administration_portal/brand/settings/client_portals:id1}
This section allows configuration of client portals:
\begin{itemize}
\item {} 
\textbf{Client}: Administration portal for all client types

\item {} 
\textbf{User}: Special portal for Virtual PBXs users

\end{itemize}

\begin{notice}{warning}{Warning:}\begin{itemize}
\item {} 
URLs MUST be HTTPS

\item {} 
URLs MUST not end with slash /

\end{itemize}
\end{notice}

Each URL can also configure a logo per URL, a theme and a phrase to use as
the title of the portal allowing creation of corporate portals per client.


\subsection{Special Numbers}
\label{administration_portal/brand/settings/special_numbers:special-numbers}\label{administration_portal/brand/settings/special_numbers::doc}\label{administration_portal/brand/settings/special_numbers:id1}
This sections allows adding specials number at brand level. Numbers added here will be handled as explained in
{\hyperref[administration_portal/platform/global_special_numbers:global\string-special\string-numbers]{\sphinxcrossref{\DUrole{std,std-ref}{Global Special Numbers}}}} just for that brand.

\begin{notice}{tip}{Tip:}
Numbers listed in {\hyperref[administration_portal/platform/global_special_numbers:global\string-special\string-numbers]{\sphinxcrossref{\DUrole{std,std-ref}{Global Special Numbers}}}} will be handled differently too.
\end{notice}
\phantomsection\label{administration_portal/brand/settings/numeric_transformations:transformations}\phantomsection\label{administration_portal/brand/settings/numeric_transformations:numeric-transformations}

\subsection{Numeric transformations}
\label{administration_portal/brand/settings/numeric_transformations:transformaciones-numericas}\label{administration_portal/brand/settings/numeric_transformations:id1}\label{administration_portal/brand/settings/numeric_transformations::doc}\label{administration_portal/brand/settings/numeric_transformations:transformations}\label{administration_portal/brand/settings/numeric_transformations:numeric-transformations}
\textbf{IvozProvider} is designed to provide service \textbf{anywhere in the planet}, not
only the original country where the platform is installed.

A very important concept to achieve this goal is the numeric transformation,
that \textbf{adapts the different number format systems of the countries of the world}
defined in \href{https://www.itu.int/rec/T-REC-E.164/es}{E.164} \textbf{to a neutral format}.

\begin{notice}{note}{Note:}
Numeric transformation \emph{sets} must be assigned to {\hyperref[administration_portal/brand/providers/carriers:carriers]{\sphinxcrossref{\DUrole{std,std-ref}{Carriers}}}}, {\hyperref[administration_portal/brand/providers/ddi_providers:ddi\string-providers]{\sphinxcrossref{\DUrole{std,std-ref}{DDI Providers}}}}, \textbf{Clients} and \textbf{User
endpoints} (Users, Friends, retail accounts, residential devices, etc.) to define the way every entity talks
with IvozProvider.
\end{notice}

There are two different transformation scenarios:


\subsubsection{Incoming transformations}
\label{administration_portal/brand/settings/numeric_transformations:incoming-transformations}
When a new call is received in IvozProvider matching a provider that has been
configured for \emph{peering}, we must adapt the numbers that make reference to:
\begin{itemize}
\item {} 
Origin of the call

\item {} 
Destination of the call

\end{itemize}

Depending on the country of the provider, the international numbers will have
a format or another. In this case, the spanish provider will use, for example:
\begin{itemize}
\item {} 
00 + 33 + number belonging to France

\item {} 
It's possible that the international numbers came without the 00 code.

\item {} 
It's possible that, if the call comes from the same country that the provider,
the number comes without the calling code (911234567 instead of 00 + 34 +
911234567 for Spain).

\end{itemize}

For an Ukranian provider, that doesn't use the 00 as international code:
\begin{itemize}
\item {} 
It will use 810 + 33 + number belonging to France.

\item {} 
It's possible that even part of the international code (00 in most of the
countries of the world) the provider use specific codes as prefix.

\end{itemize}

The goal of the incoming transformation is that, no matter what numeric system
the provider uses, the number will end in a general and common format.
\phantomsection\label{administration_portal/brand/settings/numeric_transformations:e164}
\begin{notice}{important}{Important:}
This common format is usually called E.164 and shows the numbers
without international code, but with country calling code: i.e. +34911234567
\end{notice}


\subsubsection{Outgoing transformations}
\label{administration_portal/brand/settings/numeric_transformations:outgoing-transformations}
In the same way the origin and destination must adapt incoming numbers, it
will be required to adapt outgoing dialed numbers to properly work with each
of the providers that will route our call.

For example, for a number with spanish number system:
\begin{itemize}
\item {} 
\emph{Spanish provider}: Destination will come in E164 (+34911234567) and for this
provider, we can remove the calling code (will understand it belongs to
its country), so the number sent to them will be 911234567.

\item {} 
\emph{French provider}: The destination will come in E164 (+34911234567) and we must
add the international code for France, so the number sent to them will be
0034911234567.

\end{itemize}

\begin{notice}{note}{Note:}
To sum up, we aim to send the origin and destination in the format the
provider is expecting.
\end{notice}

\begin{notice}{tip}{Tip:}
Numeric transformation uses \href{https://es.wikipedia.org/wiki/Expresi\%C3\%B3n\_regular}{simple regular expressions} to describe the
changes done to the numbers. You can find multiple tutorials on net with the
basic regular expression format.
\end{notice}


\paragraph{Add a new transformation set}
\label{administration_portal/brand/settings/numeric_transformations:add-a-new-transformation-set}
IvozProvider comes with an automatic transformation rules generator that fits
with most of the countries.

In order to create a new set of transformations use \textbf{Add Numeric transformations}:
\begin{quote}
\begin{description}
\item[{Name}] \leavevmode
Use to reference this numeric transformation set

\item[{Description}] \leavevmode
Additional information for each set

\item[{Automatic creation of rules}] \leavevmode
If set, \emph{Geographic Configuration} fields will be used to automatically configure the rules of the set.

\item[{Geographic Configuration}] \leavevmode
International Code of the country, country code, trunk prefix if any, area code if any and national subscriber
number length

\end{description}
\end{quote}


\subparagraph{Example for Spain}
\label{administration_portal/brand/settings/numeric_transformations:example-for-spain}
Fulfilling Geographic Configuration with:
\begin{itemize}
\item {} 
International Code: 00

\item {} 
Country Code: +34

\item {} 
Trunk Prefix: \textless{}empty\textgreater{}

\item {} 
Area Code: \textless{}empty\textgreater{}

\item {} 
National number length: 9

\end{itemize}

Auto-created rules will transform the numbers for spanish providers that follow these rules:
\begin{itemize}
\item {} 
A spanish number: Neither international nor calling code (34).

\item {} 
Not a spanish number: International code (00) and calling code (34).

\end{itemize}

Let's check this \emph{set} to understand what transformation rule does:

\begin{notice}{attention}{Attention:}
The automatic rule generation will create 8 common rules based on
the given parameters. This rules can be edited later to match the provider
requirements.
\end{notice}


\subsubsection{Spanish incoming transformation}
\label{administration_portal/brand/settings/numeric_transformations:spanish-incoming-transformation}
Displayed in blue in the previous image:
\begin{itemize}
\item {} 
Left called/destination

\item {} 
Right callee/origin

\end{itemize}

The same rules will be applied for the origin and destination:
\begin{itemize}
\item {} 
The \textbf{metric} field will be used to order the rules (smaller first).
\begin{itemize}
\item {} 
If a rule doesn't \emph{match}, the next rule is evaluated.

\item {} 
If a rule \emph{matches}, no more rules are evaluated.

\item {} 
If no rule \emph{matches}, no change is applied.

\end{itemize}

\item {} 
The \textbf{Search} field is evaluated against the number (depending of the
transformation type it will be destination or origin).

\item {} 
The \textbf{Replace} field will use the capture groups that matched the Search
field (displayed between brackets, 1 for the first one, 2 for the second
one, and so on) to determine how the number will end.

\end{itemize}


\subsubsection{Spanish outgoing transformation}
\label{administration_portal/brand/settings/numeric_transformations:spanish-outgoing-transformation}
Following the same logic, this 2 rules make the change of the outgoing external
destination numbers.

\begin{notice}{attention}{Attention:}
\textbf{To sum up}: numeric transformation can adapt origin and
destination numbers to E.164 for the platform, and to providers expected
formats, based on regular expressions and metric that can be grouped in \emph{sets}
to be shared between multiple \textbf{Carriers}.
\end{notice}


\paragraph{Conclusion}
\label{administration_portal/brand/settings/numeric_transformations:conclusion}
This is a key section that allows creating sets that will allow IvozProvider make needed numeric translations to `talk'
with all the external entities:
\begin{itemize}
\item {} 
Providers (carriers and DDI Providers)

\item {} 
Client endpoints (Users, Friends, Retail accounts, Residential accounts, Wholesale clients)

\end{itemize}

Those sets will:
\begin{itemize}
\item {} 
Convert custom external format to E.164 for internal usage.

\item {} 
Convert E.164 to custom external format for external usage.

\end{itemize}

Converted SIP headers:
\begin{itemize}
\item {} 
Destination headers (R-URI/To/Refer-To)

\item {} 
Source headers (From/RPID/PAI/Diversion)

\end{itemize}

For all these transformations \href{http://php.net/manual/en/reference.pcre.pattern.syntax.php}{Regular Expressions} knowledge
is needed, unless automatic created rules work out of the box.
\phantomsection\label{administration_portal/brand/settings/notification_templates:notification-templates}

\subsection{Notification Templates}
\label{administration_portal/brand/settings/notification_templates:id2}\label{administration_portal/brand/settings/notification_templates::doc}\label{administration_portal/brand/settings/notification_templates:notification-templates}\label{administration_portal/brand/settings/notification_templates:id1}
Brand administrators can configure the notifications sent by IvozProvider:
\begin{itemize}
\item {} 
Email sent when a new voicemail is received

\item {} 
Email sent when a new fax is received

\item {} 
Email sent when a balance is below configured threshold

\item {} 
Email sent when an automatic invoice is generated

\item {} 
Email sent when scheduled CDR CSVs are generated

\item {} 
Email sent when max daily usage is reached

\end{itemize}

\begin{notice}{hint}{Hint:}
When no custom notification is configured, default ones will be used
\end{notice}

Notifications are created in two steps: Create a notification type and add contents to the notification for each
required language.


\subsubsection{Creating a new notification}
\label{administration_portal/brand/settings/notification_templates:creating-a-new-notification}
Brand administrators can create new notification templates in \textbf{Brand configuration} \textgreater{} \textbf{Notification templates}:

Fields are nearly self-explanatory:
\begin{quote}
\begin{description}
\item[{Name}] \leavevmode
Used to identify this notification template

\item[{Type}] \leavevmode
Determine the notification type. Each notification type has its own substitution variables available to replace
the contents of the subject and body.

\end{description}
\end{quote}


\subsubsection{Adding Notification contents}
\label{administration_portal/brand/settings/notification_templates:adding-notification-contents}
Once the notification has been created, you can add different language contents. IvozProvider will automatically use
the proper language based on the destination:
\begin{itemize}
\item {} 
For Voicemails, the user language will be used

\item {} 
For Faxes, the client language will be used.

\end{itemize}

Configurable fields of each content:
\begin{quote}
\begin{description}
\item[{Language}] \leavevmode
Language of the contents.

\item[{From Name}] \leavevmode
The from name used while sending emails (p.e. IvozProvider Voicemail Notifications)

\item[{From Address}] \leavevmode
The from address used while sending emails (p.e. \href{mailto:no-reply@ivozprovider.com}{no-reply@ivozprovider.com})

\item[{Substitution variables}] \leavevmode
Available variables that can be used in subject and body that will be replaced before sending the email. Each
notification type has its own variables.

\item[{Subject}] \leavevmode
Subject of the email to be sent. You can include Substitution variables here.

\item[{Body type}] \leavevmode
Body of the mail can be both plaintext or html.

\item[{Body}] \leavevmode
Body of the email to be sent. You can include Substitution variables here.

\end{description}
\end{quote}

\begin{notice}{hint}{Hint:}
There is no need to create all content languages. If custom notification has some languages not defined the
default contents will be used for that notification type.
\end{notice}


\subsubsection{Assigning templates to clients}
\label{administration_portal/brand/settings/notification_templates:assigning-templates-to-clients}
Once the notification has been configured for the desired languages, Brand administrator can assign it to the
client that will use it. This can be done in the Notification configuration section of each client.
If client has no notification configured, brand notifications will be used for that client instead. If brand has no
notification configured, default notifications will be used.


\subsection{Generic Music on Hold}
\label{administration_portal/brand/settings/generic_music_on_hold:generic-music-on-hold}\label{administration_portal/brand/settings/generic_music_on_hold::doc}
{\hyperref[administration_portal/client/vpbx/multimedia/music_on_hold:music\string-on\string-hold]{\sphinxcrossref{\DUrole{std,std-ref}{Music on Hold}}}} will be played when the user holds the call and the other
member waits until the call is resumed.

If a vPBX client has defined a music on hold, it will be played. Otherwise, the
one defined by the brand administrator in this section. If none of this is configured,
a global music will be played.

Multiple files can be added to be played as Music on Hold. The system will choose them randomly for each call.

\begin{notice}{warning}{Warning:}
IvozProvider will play MOH only for vPBX and Residential clients. Remaining client
types don't have MOH capabilities as their calls don't traverse any Application Server.
\end{notice}

\begin{notice}{note}{Note:}
Residential client listen the MOH defined by the brand operator in this section. If none is configured,
a global music will be played.
\end{notice}


\subsection{Generic Services}
\label{administration_portal/brand/settings/generic_services:generic-services}\label{administration_portal/brand/settings/generic_services::doc}\label{administration_portal/brand/settings/generic_services:brand-services}
This section allows the brand operator to change the default services and default service codes for new clients.

By default this list has all the services and codes from the god level \textbf{Service} section.

\begin{notice}{warning}{Warning:}
Changing/deleting the default code in this section will only affect new created clients. Existing clients codes won't
be modified.
\end{notice}


\subsubsection{Call forward services}
\label{administration_portal/brand/settings/generic_services:call-forward-services}\label{administration_portal/brand/settings/generic_services:id1}
Call forward services (unconditional, no answer, busy and unreachable) are \textbf{only available for residential clients}
and allow adding \textbf{call forward to national phone numbers and to voicemail}.

All residential \textbf{clients within a brand use the same codes} to access to this feature, those defined in this section.

\begin{notice}{note}{Note:}
Call forward to numbers outside company's country is not supported using services codes.
Use web portal instead.
\end{notice}
\paragraph{Enabling a call forward setting}

To enable a call forward of a given type to forward calls to a national number, residential device must call to defined
service code followed by destination number. This will create and enable (or modify if already exists one) a call
forward of given type to that national number.

To enable a call forward of a given type to forward calls to voicemail, residential device must call to defined
service code followed by `*'. This will create and enable (or modify if already exists one) a call
forward of given type to voicemail.
\paragraph{Disabling a call forward setting}

Calling to the code without any additional number will delete all active call forward settings of that type.


\subsection{Generic Match Lists}
\label{administration_portal/brand/settings/generic_match_lists:generic-match-lists}\label{administration_portal/brand/settings/generic_match_lists::doc}\label{administration_portal/brand/settings/generic_match_lists:brand-match-lists}
{\hyperref[administration_portal/client/vpbx/routing_tools/match_lists:id1]{\sphinxcrossref{\DUrole{std,std-ref}{Match Lists}}}} are designed to group well known numbers or patterns in order to use them in specific treatments.

Brand administrators can create generic Match lists to have it available for new clients.

\begin{notice}{tip}{Tip:}
Existing matchlists will be copied for new vPBX clients. Already existing clients won't be affected at all by
by changes made here.
\end{notice}


\subsection{Corporations}
\label{administration_portal/brand/settings/corporations:corporations}\label{administration_portal/brand/settings/corporations::doc}\label{administration_portal/brand/settings/corporations:id1}
Corporations allows clients to be grouped into a single entity:
\begin{itemize}
\item {} 
Enables {\hyperref[administration_portal/client/vpbx/routing_endpoints/friends/internal_friends:internal\string-friends]{\sphinxcrossref{\DUrole{std,std-ref}{Inter VPBX friends}}}} to call the extension of another vPBX of the same Corporation

\end{itemize}

These are the fields shown for new corporations:
\begin{quote}
\begin{description}
\item[{Name}] \leavevmode
Used to reference this corporation

\item[{Description}] \leavevmode
Additional information

\end{description}
\end{quote}

Corporation can be assigned in the client edit screen.


\section{Views}
\label{administration_portal/brand/views/index::doc}\label{administration_portal/brand/views/index:views}
Sections in this group list read-only handy information for brand operators:


\subsection{DDIs}
\label{administration_portal/brand/views/ddis:ddis}\label{administration_portal/brand/views/ddis::doc}\label{administration_portal/brand/views/ddis:id1}
This section lists \textbf{all configured DDIs} in all the clients of the brand.

It makes easy to answer to these questions:
\begin{itemize}
\item {} 
Is this DDI of one of my clients? If so, whose?

\item {} 
Who DDI Provider provides it?

\item {} 
How many DDIs of country X does client Y have?

\item {} 
Etc.

\end{itemize}


\subsection{Retail accounts}
\label{administration_portal/brand/views/retail_accounts::doc}\label{administration_portal/brand/views/retail_accounts:retail-accounts}
This section lists \textbf{all existing retail accounts} of every retail client of the brand.

As all retail accounts of all retail clients use the same SIP domain (brand's SIP domain), collision has to be
avoided using some kind of numeric sequence. This section may be handy for this purpose.


\subsection{Residential devices}
\label{administration_portal/brand/views/residential_devices::doc}\label{administration_portal/brand/views/residential_devices:residential-devices}
This section lists \textbf{all existing residential devices} of every residential client of the brand.

As all residential devices of all residential clients use the same SIP domain (brand's SIP domain), collision has to be
avoided using some kind of numeric sequence. This section may be handy for this purpose.


\subsection{Users}
\label{administration_portal/brand/views/users::doc}\label{administration_portal/brand/views/users:users}
This section lists \textbf{all vpbx Users} in all the clients of the brand.

It makes easy to answer to these questions:
\begin{itemize}
\item {} 
Which user has this email?

\item {} 
Is terminal X registered?

\item {} 
Etc.

\end{itemize}


\subsection{IP filter blocked addresses}
\label{administration_portal/brand/views/ipfilter_blocked_addresses:ip-filter-blocked-addresses}\label{administration_portal/brand/views/ipfilter_blocked_addresses::doc}\label{administration_portal/brand/views/ipfilter_blocked_addresses:id1}
Addresses listed here have been banned at least once by \emph{IP filter} security mechanism.

\begin{notice}{warning}{Warning:}
\textbf{IPs are blocked per request, not permanently}. See \emph{Last time banned} to search for recently blocked
addresses and add them to {\hyperref[security_and_maintenance/security/authorized_ip_ranges:authorized\string-ip\string-ranges]{\sphinxcrossref{\DUrole{std,std-ref}{Authorized IP ranges}}}} if they are legitimate sources.
\end{notice}


\subsection{Brute-force attacks}
\label{administration_portal/brand/views/bruteforce_attacks::doc}\label{administration_portal/brand/views/bruteforce_attacks:brute-force-attacks}\label{administration_portal/brand/views/bruteforce_attacks:id1}
\emph{SIP address + IP address} combinations listed here have been blocked (for 12 hours) by \emph{Anti brute-force} mechanism.
User-Agent may be shown in \emph{Description} column.

\begin{notice}{tip}{Tip:}
You can unblock any source using green flag button of each row.
\end{notice}

See {\hyperref[security_and_maintenance/security/antibruteforce:anti\string-brute\string-force\string-attacks]{\sphinxcrossref{\DUrole{std,std-ref}{Anti brute-force attacks}}}} for further information.


\chapter{Client Configuration}
\label{administration_portal/client/index:client-configuration}\label{administration_portal/client/index::doc}
Currently, there are 4 different types of client in IvozProvider.

Each of them is thoroughly described in the following sections:
\phantomsection\label{administration_portal/client/vpbx/index:vpbx-clients}

\section{vPBX Clients}
\label{administration_portal/client/vpbx/index:vpbx-clients}\label{administration_portal/client/vpbx/index:clientes-vpbx}\label{administration_portal/client/vpbx/index::doc}\label{administration_portal/client/vpbx/index:id1}
This section will explain all these topics related to the most feature-full type of client in IvozProvider:


\subsection{Users}
\label{administration_portal/client/vpbx/users::doc}\label{administration_portal/client/vpbx/users:users}\label{administration_portal/client/vpbx/users:id1}
The installation process creates \emph{Alice} and \emph{Bob} users, allowing us
to test internals calls between them without too much effort.

We skipped most of the settings in \textbf{Users} configuration that we will described
in this section.


\subsubsection{Personal data}
\label{administration_portal/client/vpbx/users:personal-data}\begin{quote}
\begin{description}
\item[{Name}] \leavevmode
Used to identify this user in most of the screens. This is also the
name that will be displayed in internal calls made from this user.

\item[{Lastname}] \leavevmode
Most of the times this is used to complete the previous field.

\item[{Email}] \leavevmode
Email used to send the user's received voicemails. This is also used to
identify the user in their portal.

\end{description}
\end{quote}


\subsubsection{Geographic Configuration}
\label{administration_portal/client/vpbx/users:geographic-configuration}\begin{description}
\item[{Language\index{Language|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/users:term-language}
When a locution is played to this user, this language is used.

\item[{Timezone\index{Timezone|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/users:term-timezone}
User portal call list times will use this timezone.

\item[{Numeric transformation\index{Numeric transformation|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/users:term-numeric-transformation}
Defines how numbers are converted from user format to E.164 and
the other way around.

\item[{Location\index{Location|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/users:term-location}
User geographical location where the user is working at.

\end{description}


\subsubsection{Login Info}
\label{administration_portal/client/vpbx/users:login-info}\begin{quote}
\begin{description}
\item[{Active}] \leavevmode
Allows administrators to grant or disable user's acces to the
{\hyperref[user_portal/index:userportal]{\sphinxcrossref{\DUrole{std,std-ref}{user's portal}}}}.

\item[{Password}] \leavevmode
Password used to access the {\hyperref[user_portal/index:userportal]{\sphinxcrossref{\DUrole{std,std-ref}{user's portal}}}}.

\item[{QR Code}] \leavevmode
If enabled, a QR code for Grandstream Wave softphone configuration
will be shown.

\end{description}
\end{quote}


\subsubsection{Basic Configuration}
\label{administration_portal/client/vpbx/users:basic-configuration}\begin{quote}
\begin{description}
\item[{Terminal}] \leavevmode
The available terminals created in {\hyperref[administration_portal/client/vpbx/terminals:terminals]{\sphinxcrossref{\DUrole{std,std-ref}{Terminals}}}} are listed here
for assignment.

\item[{Screen Extension}] \leavevmode
One of the available {\hyperref[administration_portal/client/vpbx/extensions:extensions]{\sphinxcrossref{\DUrole{std,std-ref}{Extensions}}}} that this user will display when
placing internal calls. While multiple extensions can be routed to the
user, only one of them will be presented when the user calls.

\item[{Outgoing DDI}] \leavevmode
As described in {\hyperref[getting_started/external_outgoing_calls/outgoing_ddi:external\string-ddi]{\sphinxcrossref{\DUrole{std,std-ref}{Outgoing DDI configuration}}}}, determines the number that will
present when placing external outgoing calls.

\item[{Outgoing DDI Rules}] \leavevmode
Manages exceptions to previous setting. Read {\hyperref[administration_portal/client/vpbx/user_configuration/outgoing_ddi_rules:outgoingddi\string-rules]{\sphinxcrossref{\DUrole{std,std-ref}{Outgoing DDI Rules}}}}
for further reference.

\item[{Call ACL}] \leavevmode
One of the created {\hyperref[administration_portal/client/vpbx/user_configuration/call_acls:call\string-permissions]{\sphinxcrossref{\DUrole{std,std-ref}{Call ACL}}}} groups, described
it the previous sections.

\item[{Do not disturb}] \leavevmode
When this setting is enabled, the user won't receive any call but can
still place calls.

\item[{Call waiting}] \leavevmode
Limits received calls when already handling this number of calls. Set 0 for unlimited.

\item[{Calls from non-granted IPs}] \leavevmode
Enable calling from non-granted IP addresses for this user.
It limits the number of outgoing calls to avoid toll-fraud.
`None' value makes outgoing calls unlimited as long as client IP
policy is fulfilled. Read {\hyperref[security_and_maintenance/security/authorized_ip_ranges:roadwarrior\string-users]{\sphinxcrossref{\DUrole{std,std-ref}{Roadwarrior users}}}} for further reference.

\item[{Multi Contact}] \leavevmode
Same SIP credentials can be configured in multiple SIP devices. In that case, all devices ring
simultaneously when receiving a call. Setting this toggle to `No' limits this behaviour so that
only latest registered SIP device rings.

\item[{Call Rejection Method}] \leavevmode
This setting allows configuring a behaviour on call rejection for users with several
SIP devices (Multi Contact: yes). In such scenarios, all devices ring simultaneously and call rejection must
choose whether rejecting call just in the device that declined or in all ringing devices.
Default behaviour is to cancel call in all devices for 600/603 response codes and only in
current device for 480/486. Choose whether you want to force one behaviour or another no
matter which response code your SIP device sends on call rejection.

\end{description}
\end{quote}


\subsubsection{Boss-Assistant}
\label{administration_portal/client/vpbx/users:boss-assistant}
This feature will turn the user into a boss that can only be directly call by:
\begin{itemize}
\item {} 
The selected assistant.

\item {} 
Any origin that matches the white list.

\end{itemize}

The rest of the calls to \emph{a boss} will be redirected to the assistant.
\begin{quote}
\begin{description}
\item[{Is boss}] \leavevmode
Determines if this user is a boss.

\item[{Assistant}] \leavevmode
Who will receive the redirected calls of this boss.

\item[{Whitelist}] \leavevmode
{\hyperref[administration_portal/client/vpbx/routing_tools/match_lists:match\string-lists]{\sphinxcrossref{\DUrole{std,std-ref}{Match Lists}}}} with origins that are allowed to call directly to
the boss.

\end{description}
\end{quote}

With the setup in the image, every call to \emph{Alice} will be redirected to \emph{Bob},
except the ones placed by \emph{Bob} itself and those coming from any origin that matches
\emph{Alice's friends} matchlist.


\subsubsection{Group Configuration}
\label{administration_portal/client/vpbx/users:group-configuration}
As described in the sections {\hyperref[administration_portal/client/vpbx/routing_endpoints/hunt_groups:huntgroups]{\sphinxcrossref{\DUrole{std,std-ref}{Hunt groups}}}} and {\hyperref[administration_portal/client/vpbx/user_configuration/pick_up_groups:capture\string-groups]{\sphinxcrossref{\DUrole{std,std-ref}{Pick up groups}}}}, the
user can be part of one or more hunt groups and pickup groups.

Those groups can be configured from the sections {\hyperref[administration_portal/client/vpbx/routing_endpoints/hunt_groups:huntgroups]{\sphinxcrossref{\DUrole{std,std-ref}{Hunt groups}}}} and
{\hyperref[administration_portal/client/vpbx/user_configuration/pick_up_groups:capture\string-groups]{\sphinxcrossref{\DUrole{std,std-ref}{Pick up groups}}}} or the user's screen if the groups already exists.

You can also configure the user's \textbf{hunt groups} from the icon in each user
line of the users list.


\subsubsection{User Call Forward}
\label{administration_portal/client/vpbx/users:user-call-forward}
The user's call forward can be configured with the \textbf{List of call forward settings}  button.

These are the fields and available values:
\begin{quote}
\begin{description}
\item[{Call Type}] \leavevmode
Determines if the forward must be applied to external, internal or any
type of call.

\item[{Forward type}] \leavevmode\begin{description}
\item[{When this forward must be applied:}] \leavevmode\begin{itemize}
\item {} 
Unconditional: always

\item {} 
No answer: when the call is not answered in X seconds

\item {} 
Busy: When the user is talking to someone (and call waiting is
disabled), when \emph{Do not disturb} is enabled or when the user
rejects an incoming call.

\item {} 
Not registered: when the user SIP terminal is not registered
against IvozProvider.

\end{itemize}

\end{description}

\item[{Target type}] \leavevmode\begin{description}
\item[{What route will use the forwarded call.}] \leavevmode\begin{itemize}
\item {} 
VoiceMail

\item {} 
Number (external)

\item {} 
Extension (internal)

\end{itemize}

\end{description}

\end{description}
\end{quote}

\begin{notice}{hint}{Hint:}
If we want to forward to other process, we can create an extension
routed to that object and use the target type \emph{Extension}.
\end{notice}


\subsection{Terminals}
\label{administration_portal/client/vpbx/terminals:terminals}\label{administration_portal/client/vpbx/terminals::doc}\label{administration_portal/client/vpbx/terminals:id1}
The section \textbf{Client configuration} \textgreater{} \textbf{Terminals} allows creating new
SIP credentials that can be used by multiple SIP devices to place and receive
calls from IvozProvider.

The best way to understand this section is creating a new item and see the
fields that must be filled.
\begin{quote}
\begin{description}
\item[{Name}] \leavevmode
Username that will use the terminal during the SIP authentication phase
with IvozProvider.

\item[{Password}] \leavevmode
Password that will use the terminal to answer the SIP authentication
challenge. You can use the automatic password generator to fulfill the
secure password requirements.

\item[{Allowed/Disallowed codecs}] \leavevmode
Determines what audio and video codecs will be used with the terminal.

\item[{CallerID update method}] \leavevmode
Choose the SIP method the terminal prefers to received the session
update information: INVITE or UPDATE. The help hint can be used as
guide to configure different terminal manufacturers. Use \emph{INVITE} in
case of doubt.

\item[{Terminal model}] \leavevmode
Determines the provisioning type that will receive this terminal.
The section {\hyperref[administration_portal/platform/terminal_manufacturers:provisioning]{\sphinxcrossref{\DUrole{std,std-ref}{terminal provisioning}}}} will explain
in depth the different models for automatic provision. If your device
does not require provisioning, just select \emph{Generic}.

\item[{MAC}] \leavevmode
Optional field that is only required if you plan to use IvozProvider
{\hyperref[administration_portal/platform/terminal_manufacturers:provisioning]{\sphinxcrossref{\DUrole{std,std-ref}{terminal provisioning}}}}. This is the \href{https://wikipedia.org/wiki/MAC\_Address}{physical
address} of the network
adapter of the SIP device.

\item[{Enable T.38 passthrough}] \leavevmode
If set to `yes', this SIP endpoint must be a \textbf{T.38 capable fax sender/receiver}. IvozProvider
will act as a T.38 gateway, bridging fax-calls of a T.38 capable carrier and a T.38 capable device.

\item[{RTP Encryption}] \leavevmode
If set to `yes', call won't be established unless it's possible to encryption its audio. If set to `no',
audio won't be encrypted.

\end{description}
\end{quote}

\begin{notice}{note}{Note:}
For \textbf{most of devices} that doesn't require provisioning just
filling \textbf{username} and \textbf{password} will be enough.
\end{notice}

\begin{notice}{hint}{Hint:}
Once the terminal has been created, most devices will only
require the name, password and {\hyperref[getting_started/internal_calls/brand_portal:domain\string-per\string-client]{\sphinxcrossref{\DUrole{std,std-ref}{Client SIP domain}}}}
in order to place calls.
\end{notice}


\subsection{Extensions}
\label{administration_portal/client/vpbx/extensions:extensions}\label{administration_portal/client/vpbx/extensions::doc}\label{administration_portal/client/vpbx/extensions:id1}
\textbf{An extensions is}, by definition, \textbf{an internal number with an assigned
logic}. Internal users' calls to numbers listed in this section do not traverse
call ACL logics: \textbf{every user/friend is allowed to call to any number listed here}.
\paragraph{Create a new extension}
\begin{description}
\item[{Number}] \leavevmode
The number that must be dialed by the internal user that will trigger
the configured logic. It must have a minimum length of 2 and must be
a number.

\item[{Route}] \leavevmode
This select will allow us to choose the logic that will use this
extension when is dialed from an internal user. Depending on the selected
route, and additional select or input will be shown to select the
hunt group, conference room, user, etc.

\end{description}

\begin{notice}{warning}{Warning:}
If an extension has a number that conflicts with an external
number, this external number will be masked and, in practice, will be
unavailable for the whole client.
\end{notice}


\subsubsection{Route options}
\label{administration_portal/client/vpbx/extensions:route-options}\begin{quote}
\begin{description}
\item[{Unassigned}] \leavevmode
Calls to this extension will be hung up.

\item[{User}] \leavevmode
Selected {\hyperref[administration_portal/client/vpbx/users:users]{\sphinxcrossref{\DUrole{std,std-ref}{user}}}} will be called.

\item[{IVR}] \leavevmode
Selected {\hyperref[administration_portal/client/vpbx/routing_endpoints/ivrs:ivrs]{\sphinxcrossref{\DUrole{std,std-ref}{IVR}}}} logic will be called.

\item[{Huntgroup}] \leavevmode
Selected {\hyperref[administration_portal/client/vpbx/routing_endpoints/hunt_groups:huntgroups]{\sphinxcrossref{\DUrole{std,std-ref}{huntgroup}}}} will be called.

\item[{Friend}] \leavevmode
Calls to this extension will evaluate {\hyperref[administration_portal/client/vpbx/routing_endpoints/friends/index:friends]{\sphinxcrossref{\DUrole{std,std-ref}{friends}}}} logic.

\item[{Queue}] \leavevmode
Call will be delivered to selected {\hyperref[administration_portal/client/vpbx/routing_endpoints/queues:queues]{\sphinxcrossref{\DUrole{std,std-ref}{queue}}}}.

\item[{Conditional route}] \leavevmode
Call will be delivered to selected {\hyperref[administration_portal/client/vpbx/routing_endpoints/conditional_routes:id1]{\sphinxcrossref{\DUrole{std,std-ref}{conditional route}}}}.

\item[{Number}] \leavevmode
Calling to this extension will generate an external outbound call
to introduced number.

\end{description}
\end{quote}

\begin{notice}{note}{Note:}
Any internal user can generate an external outbound call via an \textbf{Extension
routed to Number} even if its \emph{Call permissions} does not allow to
call to that destination directly.
\end{notice}


\subsubsection{Import aliases}
\label{administration_portal/client/vpbx/extensions:import-aliases}
\emph{Extensions to numbers} are useful to call to most dialed numbers easily. As each
client usually has a list with frequent numbers, \textbf{Import aliases} button allows
importing them through a CSV file.
\paragraph{Example import file}

\begin{Verbatim}[commandchars=\\\{\}]
Extension,CountryPrefix,Number,CountryCode
200,+34,944048184,ES
201,+34,944048185,ES
202,+34,944048186
203,+1,944048187
204,+1,944048188,US
\end{Verbatim}

Numbers will be imported synchronously following these rules:
\begin{itemize}
\item {} 
If given extension already exists and points to a number: number is updated.

\item {} 
If given extension already exists and does not point to a number: error.

\item {} 
If given country prefix does not exist: error.

\item {} 
If given country code does not exist: error.

\item {} 
If given country prefix and country code combination does not exist: error.

\item {} 
CountryCode is optional: if given country prefix is used in multiple countries
and country code is not given, first country is selected.

\end{itemize}


\subsection{DDIs}
\label{administration_portal/client/vpbx/ddis:ddis}\label{administration_portal/client/vpbx/ddis::doc}\label{administration_portal/client/vpbx/ddis:pbx-ddis}\begin{quote}
\begin{description}
\item[{Country}] \leavevmode
The country of the new created DDI. Used for E164 standardization.

\item[{DDI}] \leavevmode
The number, without country code.

\item[{Type}] \leavevmode
Choose `Inbound \& outbound' for a normal DDI that can be used both as outgoing DDI and as incoming DDI
from a {\hyperref[administration_portal/brand/providers/ddi_providers:ddi\string-providers]{\sphinxcrossref{\DUrole{std,std-ref}{DDI Provider}}}}. Choose `Outbound only' for a DDI that won't reach us from a
{\hyperref[administration_portal/brand/providers/ddi_providers:ddi\string-providers]{\sphinxcrossref{\DUrole{std,std-ref}{DDI Provider}}}} and will only be used as an outgoing DDI.

\item[{DDI Provider}] \leavevmode
The {\hyperref[administration_portal/brand/providers/ddi_providers:ddi\string-providers]{\sphinxcrossref{\DUrole{std,std-ref}{DDI Provider}}}} that provides this number. This relation has no functional purpose, it
is just for DDI Provider \textless{}-\textgreater{} DDI navigation in some brand level sections.

\item[{External Call Filter}] \leavevmode
Allows configuration based on Calendars and Schedulers as shown in
{\hyperref[administration_portal/client/vpbx/routing_tools/external_call_filters:external\string-call\string-filters]{\sphinxcrossref{\DUrole{std,std-ref}{External call filters}}}}. Leave empty if you don't need to apply any
kind of filter.

\item[{Route}] \leavevmode
A DDI can have different {\hyperref[administration_portal/client/vpbx/ddis:routing\string-logics]{\sphinxcrossref{\DUrole{std,std-ref}{treatments}}}}. For our
current goal, set route to user and select \emph{Alice}.

\item[{Record calls}] \leavevmode
Can be used to record external calls (see {\hyperref[administration_portal/client/vpbx/calls/call_recordings:call\string-recordings]{\sphinxcrossref{\DUrole{std,std-ref}{Call recordings}}}}).

\item[{Tarificate incoming calls}] \leavevmode
This setting requires the external tarification module and allows
tarification on special numbers. This module is not standard so don't
hesitate in {\hyperref[basic_concepts/intro/getting_help:getting\string-help]{\sphinxcrossref{\DUrole{std,std-ref}{contact us}}}} if you are interested.

\end{description}
\end{quote}

\begin{notice}{hint}{Hint:}
Calls received from a {\hyperref[administration_portal/brand/providers/ddi_providers:ddi\string-providers]{\sphinxcrossref{\DUrole{std,std-ref}{DDI Provider}}}} to an `Outbound only'
DDI will be rejected.
\end{notice}

\begin{notice}{hint}{Hint:}
Calls from within the platform to `Inbound \& outbound' DDIs won't reach
any carrier, they will be routed internally.
\end{notice}


\subsubsection{DDI external filters}
\label{administration_portal/client/vpbx/ddis:ddi-external-filters}
We can assign a \textbf{external call filter} configured in {\hyperref[administration_portal/client/vpbx/routing_tools/external_call_filters:external\string-call\string-filters]{\sphinxcrossref{\DUrole{std,std-ref}{External call filters}}}}.


\subsubsection{DDI routes}
\label{administration_portal/client/vpbx/ddis:routing-logics}\label{administration_portal/client/vpbx/ddis:ddi-routes}
Once the call has passed all the checks in the filter (schedules and calendars)
and after the welcome locution has been played (if there is any configured),
we can route the call to the following processes:
\begin{itemize}
\item {} 
{\hyperref[administration_portal/client/vpbx/users:users]{\sphinxcrossref{\DUrole{std,std-ref}{Users}}}}

\item {} 
{\hyperref[administration_portal/client/vpbx/routing_endpoints/hunt_groups:huntgroups]{\sphinxcrossref{\DUrole{std,std-ref}{Hunt groups}}}}

\item {} 
{\hyperref[administration_portal/client/vpbx/routing_endpoints/ivrs:ivrs]{\sphinxcrossref{\DUrole{std,std-ref}{IVRs}}}}

\item {} 
{\hyperref[administration_portal/client/vpbx/routing_endpoints/conference_rooms:conference\string-rooms]{\sphinxcrossref{\DUrole{std,std-ref}{Conference rooms}}}}

\item {} 
{\hyperref[administration_portal/client/vpbx/routing_endpoints/conditional_routes:conditional\string-routes]{\sphinxcrossref{\DUrole{std,std-ref}{Conditional routes}}}}

\item {} 
{\hyperref[administration_portal/client/vpbx/routing_endpoints/queues:queues]{\sphinxcrossref{\DUrole{std,std-ref}{Queues}}}}

\item {} 
{\hyperref[administration_portal/client/vpbx/routing_endpoints/friends/index:friends]{\sphinxcrossref{\DUrole{std,std-ref}{Friends}}}}

\end{itemize}

\begin{notice}{hint}{Hint:}
We can also route the DDI to a {\hyperref[administration_portal/client/vpbx/faxes:faxing\string-system]{\sphinxcrossref{\DUrole{std,std-ref}{Virtual Fax}}}}, but
this is something we will explain in the following block.
\end{notice}


\subsection{Routing endpoints}
\label{administration_portal/client/vpbx/routing_endpoints/index:routing-endpoints}\label{administration_portal/client/vpbx/routing_endpoints/index::doc}
Sections in this group can be selected as a Route option for external DDIs and internal extensions:


\subsubsection{Interactive Voice Responses (IVRs)}
\label{administration_portal/client/vpbx/routing_endpoints/ivrs:interactive-voice-responses-ivrs}\label{administration_portal/client/vpbx/routing_endpoints/ivrs::doc}
IVRs are the most common way to make \textbf{audio menus} where the caller must
choose the destination of the call by \textbf{pressing codes} based on the locutions
instructions that will be played.


\paragraph{IVRs}
\label{administration_portal/client/vpbx/routing_endpoints/ivrs:ivrs}\label{administration_portal/client/vpbx/routing_endpoints/ivrs:id1}
IVRs support specifying actions for dialed digits, but also they can be also be used
to route any existing client extension.

IVRs have the following fields:
\begin{quote}
\begin{description}
\item[{Name}] \leavevmode
Descriptive name of the IVR that will be used in other sections.

\item[{Timeout}] \leavevmode
Time that caller has to enter the digits of the target extension.

\item[{Max digits}] \leavevmode
Maximum number of digits allowed in this IVR.

\item[{Welcome locution}] \leavevmode
This locution will be played as soon as the caller enters the IVR.

\item[{Success locution}] \leavevmode
In case the dialed number matches one of the IVR entries or extension
exists in the client (and allow extensions is enabled), this locution
will be played (usually something like `Connecting, please wait...').

\item[{Allow dialing extensions}] \leavevmode
When this setting is enabled, the caller can directly press the extension
that must previously know (or the welcome locution suggests) and the system
will automatically connect with that extension.

\item[{Excluded Extensions}] \leavevmode
When Allow extensions is enabled, you can exclude some extensions to be
directly dialed adding them to the exclusion list.

\item[{No input process}] \leavevmode
If the caller does not input any digit in the timeout value, the
no input process will trigger, playing the configured locution and
redirecting the call to another number, extension or voicemail.

\item[{Error process}] \leavevmode
If the dialed extension does not match any IVR entry, any client extensions
(when allow extensions is enabled), or it matches one of the extensions in the
excluded Extensions list, the error process will trigger, playing the configured
locution and redirecting the call to another number, extension or voicemail.

\end{description}
\end{quote}


\paragraph{IVR Entries}
\label{administration_portal/client/vpbx/routing_endpoints/ivrs:ivr-entries}
\begin{notice}{hint}{Hint:}
The most common usage for IVR is combining them with a welcome
locution that says something like `Press 1 to contact XXX, Press 2 to
contact YYY, ...''
\end{notice}

The process of each entry of the IVR can be defined in the following button:

In this example, the caller can dial 1, 2 or 3 (the rest will be considered as
an error and will trigger the \textbf{Error process}):
\begin{itemize}
\item {} 
1: Call to the internal extension 200, created in {\hyperref[administration_portal/client/vpbx/routing_endpoints/hunt_groups:huntgroups]{\sphinxcrossref{\DUrole{std,std-ref}{previous section}}}} that routes to hunt group \emph{Reception}.

\item {} 
2: Call to the internal extension 101.

\item {} 
3: Route this call to the external number 676 676 676.

\end{itemize}

\begin{notice}{note}{Note:}
Each of the IVR entries supports a locution that, if set,
will be played instead of the IVR \textbf{success locution}. This way, you can
configure a generic locution (like `Connecting....') or a custom one for
a given entry (like `Connecting reception department, please wait...').
\end{notice}
\paragraph{Entries are regular expressions}

You can specify IVR entries as Regular Expressions. If entry is just
a numeric value, it will be handled as a sequence of digits, otherwise it
will be handled a regular expression. This can be handy if you have the
same behaviour for a group of dialed numbers.


\subsubsection{Hunt groups}
\label{administration_portal/client/vpbx/routing_endpoints/hunt_groups:hunt-groups}\label{administration_portal/client/vpbx/routing_endpoints/hunt_groups::doc}\label{administration_portal/client/vpbx/routing_endpoints/hunt_groups:huntgroups}
The hunt groups allows configuring more complex \emph{ringing} process that the
traditional \textbf{call to a user}.

These are the fields shown for new hunt groups:
\begin{quote}
\begin{description}
\item[{Name}] \leavevmode
Used to reference this hunt group

\item[{Description}] \leavevmode
Additional information

\item[{Strategy}] \leavevmode
Describes how will the calls be delivered. See details in glossary below.

\item[{Ring all timeout}] \leavevmode
For \emph{Ringall} strategy, defines for how long will the members be called.

\item[{Prevent missed calls}] \leavevmode
When `Yes', calls will never generate a missed call. When `No', missed calls will be prevented only for RingAll
hunt groups if someone answers.

\item[{Allow Call Forwards}] \leavevmode
When `No', user's call forward settings (including DND and boss/assistant) and 3XX responses will be ignored. Otherwise, they will be followed.

\item[{No answer configuration}] \leavevmode
Policy when hunt group members do not answer the call after defined timeouts.

\end{description}
\end{quote}

\begin{notice}{tip}{Tip:}
When configuring a hunt group, you can prevent missed calls on called members with \textbf{Prevent missed calls} setting:
\begin{itemize}
\item {} 
\textbf{Yes}: calls generated by the hunt group will never generate missed calls on called members.

\item {} 
\textbf{No}: The behaviour of this setting depends on the hunt group type:

\item {} 
\textbf{RingAll}: calls generated by the hunt group will generate missed calls on called members only if none of them answers the call.

\item {} 
\textbf{Remaining types}: calls generated by the hunt group will generate missed calls on every called member that does not answer the call.

\end{itemize}
\end{notice}

\begin{notice}{warning}{Warning:}
Enabling \textbf{Allow Call Forwards} may cause undesired behaviours:
\begin{itemize}
\item {} 
Member not being called as has DND enabled.

\item {} 
Member marked as boss not being called (assistant will be called instead).

\item {} 
Huntgroup's \emph{No answer configuration} never applying (e.g. no answer timeout on called user that applies sooner than Ringall timeout).

\item {} 
Huntgroup's members not being called (e.g. sequential huntgroup, first member forwards call to its cell phone).

\end{itemize}

\textbf{Use this feature wisely}.
\end{notice}

There are 4 strategies available:
\begin{quote}
\begin{description}
\item[{Ringall}] \leavevmode
The call will make all the terminals of the group during a predefined
time.

\item[{Linear}] \leavevmode
The call will \emph{jump} from one user to another in a predefined order
ringing during the configured time. If the call is not answered by any
user of the group, it will be hung up (or will trigger the no answer logic).

\item[{Round robin}] \leavevmode
The call will \emph{jump} from one user to another in a predefined order
ringing during the configured time. If the call is not answered by any
user of the group, the call will \emph{jump} again to the first member of the
group and keep looping.

\item[{Random}] \leavevmode
The call will \emph{jump} from one user to another in a random order,
ringing during the configured time.  If the call is not answered by any
user of the group, it will be hung up (or will trigger the no answer logic).

\end{description}
\end{quote}


\paragraph{Adding members to hunt group}
\label{administration_portal/client/vpbx/routing_endpoints/hunt_groups:adding-members-to-hunt-group}
\textbf{List of members} subsection allows adding users or external numbers to each group:
\begin{itemize}
\item {} 
For \emph{RingAll hunt groups}, members will be added without any additional parameters.

\item {} 
For remaining groups, priority and timeout will be specified for each member. Priority determines the order, timeout ring
duration for each member.

\end{itemize}

Section {\hyperref[administration_portal/client/vpbx/users:users]{\sphinxcrossref{\DUrole{std,std-ref}{Users}}}} also allows adding member to existing hunt groups using \textbf{List of hunt groups} option.


\subsubsection{Queues}
\label{administration_portal/client/vpbx/routing_endpoints/queues:queues}\label{administration_portal/client/vpbx/routing_endpoints/queues::doc}\label{administration_portal/client/vpbx/routing_endpoints/queues:id1}
Easy queue behaviour was included in IvozProvider in 1.3 version. It is a simple
approach with \textbf{the unique goal to provide the capability to handle more calls
than users attending them}.

\begin{notice}{warning}{Warning:}
Queues and callcenter are close terms but different. \textbf{IvozProvider
is not a suitable product for callcenters}, as it does not provide
advanced features that are crucial to them (reports, RT visualization,
queue related stat, etc.).
\end{notice}

\textbf{In distributed installations} using Queues is only compatible with an static
assignment or `hash based' distribution (see \textbf{Distribute method} {\hyperref[administration_portal/brand/clients/virtual_pbx:virtual\string-pbx]{\sphinxcrossref{\DUrole{std,std-ref}{here}}}}).

\begin{notice}{hint}{Hint:}
Brand operators can choose which Clients have queues (see \textbf{Features}
in {\hyperref[getting_started/internal_calls/brand_portal:brand\string-configuration]{\sphinxcrossref{\DUrole{std,std-ref}{Brand Configuration}}}} and {\hyperref[getting_started/internal_calls/client_portal:client\string-configuration]{\sphinxcrossref{\DUrole{std,std-ref}{Client Configuration}}}}).
\end{notice}


\paragraph{Queue configuration}
\label{administration_portal/client/vpbx/routing_endpoints/queues:queue-configuration}
This are the settings related to a queue:
\begin{quote}
\begin{description}
\item[{Name}] \leavevmode
Use to reference this queue

\item[{Weight}] \leavevmode
Prioritizes calls to an agent that attends calls in two (or more) calls. The
higher, the more prioritized.

\item[{Strategy}] \leavevmode
How will the queue deliver the calls? Calling to all agents, calling to a
random one?

\item[{Member call seconds}] \leavevmode
Defines how long will a call to an agent last.

\item[{Member rest seconds}] \leavevmode
Seconds between calls for an agent.

\item[{Prevent missed calls}] \leavevmode
When `Yes', calls will never generate a missed call. When `No', missed calls will be prevented only for RingAll
queues if someone answers.

\item[{Announce}] \leavevmode
Select a locution and its frequency. Caller waiting in the call will listen
to this locution.

\item[{Announce Position}] \leavevmode
Announce position when a caller enters a queue and after a fixed frequency.

\item[{Timeout configuration}] \leavevmode
Limits the time that a call can wait in a queue and the following behaviour.

\item[{Full Queue configuration}] \leavevmode
Limits the amount of people waiting in a call and the behaviour when this limit
it reached.

\end{description}
\end{quote}

Apart from creating a queue, you have to assign users to it. This users will have
a \textbf{penalty: a user will not be selected to deliver a call if any user with lower
penalty is available}.

\begin{notice}{hint}{Hint:}
A call can be sent to a queue selecting it in the ``Route type'' selectors
available in multiple sections of IvozProvider (extension to queue, DDI
to queue, etc.)
\end{notice}

\begin{notice}{tip}{Tip:}
When configuring a queue, you can prevent missed calls on called members with \textbf{Prevent missed calls} setting:
\begin{itemize}
\item {} 
\textbf{Yes}: calls generated by the queue will never generate missed calls on called members.

\item {} 
\textbf{No}: The behaviour of this setting depends on the queue strategy:

\item {} 
\textbf{RingAll}: calls generated by the queue will generate missed calls on called members only if none of them answers the call.

\item {} 
\textbf{Remaining types}: calls generated by the queue will generate missed calls on every called member that does not answer the call.

\end{itemize}
\end{notice}


\paragraph{Queue strategy}
\label{administration_portal/client/vpbx/routing_endpoints/queues:queue-strategy}
The queue strategy \textbf{always applies to current penalty members} starting with
the smallest penalty value and only going to the next penalty if all members of
current one are busy or unavailable.
\begin{quote}
\begin{description}
\item[{Ring all}] \leavevmode
The call will make all the members of the current priority during a
predefined time.

\item[{Least recent}] \leavevmode
The call will \emph{jump} from one member to another in a predefined order
based on the last time the member attended a call. Members whose latest
call is older will be called first.

\item[{Fewer calls}] \leavevmode
The call will \emph{jump} from one member to another in a predefined order
based on the number of attended calls. Members that have attended less
calls will be called first.

\item[{Random}] \leavevmode
The call will \emph{jump} from one member to another in a random order,
ringing during the configured time.

\item[{Round Robin memory}] \leavevmode
The call will \emph{jump} from one member to another in a predefined order
starting past the last member that attended a call.

\item[{Linear}] \leavevmode
The call will \emph{jump} from one member to another in a predefined order
based on the creation time of the member.

\end{description}
\end{quote}

\begin{notice}{warning}{Warning:}
A given penalty will never the called until all users with lower priority are on call.
\end{notice}

\begin{notice}{error}{Error:}
\emph{Linear} queues are special: a non-linear queue cannot be converted to linear.
\end{notice}
\phantomsection\label{administration_portal/client/vpbx/routing_endpoints/conditional_routes:conditional-routes}

\subsubsection{Conditional routes}
\label{administration_portal/client/vpbx/routing_endpoints/conditional_routes:id2}\label{administration_portal/client/vpbx/routing_endpoints/conditional_routes::doc}\label{administration_portal/client/vpbx/routing_endpoints/conditional_routes:conditional-routes}\label{administration_portal/client/vpbx/routing_endpoints/conditional_routes:id1}
Conditional routes allows changing a call logic depending on:
\begin{itemize}
\item {} 
Who is calling.

\item {} 
What time is calling.

\item {} 
What day is calling.

\item {} 
Status of selected route locks.

\end{itemize}

These routes are electable in three sections:
\begin{itemize}
\item {} 
DDIs

\item {} 
Extensions

\item {} 
IVR custom options

\end{itemize}

\begin{notice}{tip}{Tip:}
Remaining sections could use conditional routes creating an extension
that point to a conditional route first, and routing to this extension.
\end{notice}


\paragraph{Creating a conditional route}
\label{administration_portal/client/vpbx/routing_endpoints/conditional_routes:creating-a-conditional-route}
First of all we create a conditional route in \textbf{Conditional routes} section.

On creation we define what should be done with a call that does not satisfy any
of the rules added bellow.


\paragraph{Adding rules}
\label{administration_portal/client/vpbx/routing_endpoints/conditional_routes:adding-rules}
Once created, we need to add rules, for example:
\begin{itemize}
\item {} 
Calls from Japan and Germany received in the morning to an specific user

\item {} 
Calls from Japan and Germany received in the afternoon to another user

\item {} 
Override the reception IVR for summer days

\end{itemize}


\paragraph{Evaluating conditional routes}
\label{administration_portal/client/vpbx/routing_endpoints/conditional_routes:evaluating-conditional-routes}\begin{itemize}
\item {} 
Rules are evaluated following the metric parameter. Once a rule matches, its
logic is applied.

\item {} 
Rules may have from 1 to 4 criteria:
\begin{itemize}
\item {} 
None, one or more matchlist (pre-created, see {\hyperref[administration_portal/client/vpbx/routing_tools/match_lists:match\string-lists]{\sphinxcrossref{\DUrole{std,std-ref}{Match Lists}}}})

\item {} 
None, one or more schedules (pre-created, see {\hyperref[administration_portal/client/vpbx/routing_tools/schedules:schedules]{\sphinxcrossref{\DUrole{std,std-ref}{Schedules}}}})

\item {} 
None, one or more calendar (pre-created, see {\hyperref[administration_portal/client/vpbx/routing_tools/calendars:calendars]{\sphinxcrossref{\DUrole{std,std-ref}{Calendars}}}})

\item {} 
None, one or more route locks (pre-created, see {\hyperref[administration_portal/client/vpbx/routing_tools/route_locks:id1]{\sphinxcrossref{\DUrole{std,std-ref}{Route locks}}}})

\end{itemize}

\item {} 
These 4 criteria are combined (applying an AND logic).

\item {} 
If all used criterias in a rule are fulfilled, its logic is applied.

\end{itemize}

This is how each criteria is evaluated:
\begin{quote}
\begin{description}
\item[{Matchlist criteria}] \leavevmode
If caller number matches any of selected matchlist(s), this criteria is considered fulfilled.

\item[{Schedule criteria}] \leavevmode
If current time is included in any of selected schedules, this criteria is considered fulfilled.

\item[{Calendar criteria}] \leavevmode\begin{itemize}
\item {} 
If current day is marked as holiday in any of selected calendars, this criteria is considered fulfilled.

\item {} 
If current day is marked as non-wholeday holiday in any of selected calendars and current time is included
in its interval, this criteria is considered fulfilled.

\end{itemize}

\item[{Lock criteria}] \leavevmode
If one of selected route locks is open, this criteria is considered fulfilled.

\end{description}
\end{quote}

\begin{notice}{warning}{Warning:}
{\hyperref[administration_portal/client/vpbx/routing_tools/calendars:calendar\string-periods]{\sphinxcrossref{\DUrole{std,std-ref}{Calendar Periods}}}} linked to selected calendars are not taken into account.
\end{notice}


\paragraph{DDI routed to a conditional route}
\label{administration_portal/client/vpbx/routing_endpoints/conditional_routes:ddi-routed-to-a-conditional-route}
Imagine this scenario: DDI has an external call filter and is routed to the new conditional route.

When a call is received:
\begin{itemize}
\item {} 
External call filter is evaluated:
\begin{itemize}
\item {} 
If current day is marked in any calendar, the holiday logic applies.

\item {} 
If current time is not inside any time-gap, out-of-schedule logic applies.

\end{itemize}

\item {} 
If external call filter logics have not applied, conditional route is evaluated.

\end{itemize}

\begin{notice}{attention}{Attention:}
Conditional route is not intended as an external call filter
replacement. Filter is evaluated first, conditional route afterwards.
\end{notice}


\subsubsection{Friends}
\label{administration_portal/client/vpbx/routing_endpoints/friends/index:friends}\label{administration_portal/client/vpbx/routing_endpoints/friends/index::doc}\label{administration_portal/client/vpbx/routing_endpoints/friends/index:id1}
\textbf{Friends} section in the \textbf{Client configuration} allows interconnection of
IvozProvider with other SIP PBX systems through a SIP \emph{trunk}. The most typical
use case is when a client have multiple PBX systems that want to integrate in
a single flow.

Since 2.10, \textbf{Friends} also lets a vPBX client to call to extensions of another
vPBX client in the same brand.

\begin{notice}{warning}{Warning:}
It's important to understand the difference between \textbf{Carrier}
defined by the \textbf{brand operator} to connect with the public network
and \textbf{Friends}, defined by \textbf{client administrators} to connect the
system with other PBXs.
\end{notice}

\begin{notice}{hint}{Hint:}
\textbf{Friends} are so similar to \textbf{Users} that both talk SIP with the
{\hyperref[administration_portal/platform/infrastructure/proxy_users:proxyusers]{\sphinxcrossref{\DUrole{std,std-ref}{Proxy Users}}}}.
\end{notice}


\paragraph{Types of friends}
\label{administration_portal/client/vpbx/routing_endpoints/friends/index:types-of-friends}
There are 2 main types of Friends:
\begin{itemize}
\item {} 
\textbf{Remote friends}: SIP trunks to external SIP PBX system.

\item {} 
\textbf{Internal friends}: connection between extensions of two vPBX client in the same brand.

\end{itemize}


\subparagraph{What kind of calls can be routed through an \emph{internal friend}?}
\label{administration_portal/client/vpbx/routing_endpoints/friends/index:what-kind-of-calls-can-be-routed-through-an-internal-friend}
IvozProvider will route a call received by a {\hyperref[administration_portal/client/vpbx/users:users]{\sphinxcrossref{\DUrole{std,std-ref}{user}}}} or a {\hyperref[administration_portal/client/vpbx/routing_endpoints/friends/index:friends]{\sphinxcrossref{\DUrole{std,std-ref}{friend}}}} following this logic:
\begin{enumerate}
\item {} 
Destination matches an existing IvozProvider extension?

\item {} 
If not: Destination matches any \emph{friend} regular expression (for remote friends) or extensions (for internal ones)? Ordered by priority (lower has precedence).

\item {} 
If not: This is an external call.

\end{enumerate}

Following sections explain both kind of friends:


\subparagraph{Remote friends}
\label{administration_portal/client/vpbx/routing_endpoints/friends/remote_friends:remote-friends}\label{administration_portal/client/vpbx/routing_endpoints/friends/remote_friends::doc}
Remote friends connect a vPBX client with an external SIP entity.


\subparagraph{Types of remote friends}
\label{administration_portal/client/vpbx/routing_endpoints/friends/remote_friends:types-of-remote-friends}
There are 2 main types of SIP PBX that can be integrate with IvozProvider:
\begin{itemize}
\item {} 
\textbf{Direct connection PBX} (Connectivity mode: direct): IvozProvider must be able to talk SIP directly with
this kind of friends by just redirecting the traffic to the proper port of
the public IP address of the PBX.

\item {} 
\textbf{PBX behind NAT} (Connectivity mode: register): Not directly accessible. This kind of PBX must register at
IvozProvider (just like all the {\hyperref[administration_portal/client/vpbx/terminals:terminals]{\sphinxcrossref{\DUrole{std,std-ref}{Terminals}}}} do).

\end{itemize}


\subparagraph{What do remote friends allow?}
\label{administration_portal/client/vpbx/routing_endpoints/friends/remote_friends:what-do-remote-friends-allow}
This section allows not just communication between users at boths ends of the
SIP \emph{trunk}, but also:
\begin{itemize}
\item {} 
Users ``from the other side'' can call to the public network just like native
Ivozprovider {\hyperref[administration_portal/client/vpbx/users:users]{\sphinxcrossref{\DUrole{std,std-ref}{Users}}}}.

\item {} 
Public network calls can be routed to the other SIP \emph{trunk} end.

\end{itemize}


\subparagraph{What kind of calls can be routed through a \emph{remote friend}?}
\label{administration_portal/client/vpbx/routing_endpoints/friends/remote_friends:what-kind-of-calls-can-be-routed-through-a-remote-friend}
IvozProvider must know what calls must be routed to the different defined \emph{remote friends}.
For that, \textbf{client administrator} will configure regular expressions that
describe the numbers that \emph{can be reached} through the \textbf{friend}.

\begin{notice}{note}{Note:}
Internal {\hyperref[administration_portal/client/vpbx/extensions:extensions]{\sphinxcrossref{\DUrole{std,std-ref}{extensions}}}} have priority over any expression
defined in the \emph{friends}.
\end{notice}

\begin{notice}{important}{Important:}
Avoid PCRE regular expressions in friend configuration: use {[}0-9{]} instead of \textbackslash{}d.
\end{notice}


\subparagraph{Configuration of remote friends}
\label{administration_portal/client/vpbx/routing_endpoints/friends/remote_friends:configuration-of-remote-friends}
The \textbf{Friend} configuration is a merge between a \textbf{User} and a \textbf{Terminal}

These are the configurable settings of \emph{friends}:
\begin{quote}
\begin{description}
\item[{Name}] \leavevmode
Name of the \textbf{friend}, like in \textbf{Terminals}. This will also be used
in SIP messages (sent \textbf{From User}).

\item[{Description}] \leavevmode
Optional. Extra information for this \textbf{friend}.

\item[{Priority}] \leavevmode
Used to solve conflicts while routing calls through \textbf{friends}.
If a call destination \textbf{matches} more than one friend regular expression
the call will be routed through the friend with \textbf{less priority value}.

\item[{Password}] \leavevmode
When the \emph{friend} send requests, IvozProvider will authenticate it using
this password. \textbf{Using password IS A MUST in ``Register'' mode}. In ``Direct'' mode,
leaving it blank disables SIP authentication and enables IP source check.

\item[{Connectivity mode}] \leavevmode
Choose between ``Direct'' and ``Register'' for a remote friend.

\item[{Call ACL}] \leavevmode
Similar to {\hyperref[administration_portal/client/vpbx/users:users]{\sphinxcrossref{\DUrole{std,std-ref}{internal users}}}}, friends can place internal
client calls without restriction (including Extension or other Friends).
When calling to external numbers, this ACL will be checked if set.

\item[{Fallback Outgoing DDI}] \leavevmode
External calls from this \emph{friend} will be presented with this DDI, \textbf{unless
the source presented by friend is a DDI that exists in DDIs section}.

\item[{Country and Area code}] \leavevmode
Used for number transformation from and to this friend.

\item[{Allowed codecs}] \leavevmode
Like a terminal, \emph{friends} will talk the selected codec.

\item[{From user}] \leavevmode
Request from IvozProvider to this friend will include this user in
the From header.

\item[{From domain}] \leavevmode
Request from IvozProvider to this friend will include this domain in
the From header.

\item[{DDI In}] \leavevmode
If set to `Yes', set destination (R-URI and To) to called DDI/number when calling to this endpoint. If set `No', username
used in Contact header of registration will be used, as specified in SIP RFC (friend name will be used for
endpoints with direct connectivity). Defaults to `Yes'.

\item[{Enable T.38 passthrough}] \leavevmode
If set to `yes', this SIP endpoint must be a \textbf{T.38 capable fax sender/receiver}. IvozProvider
will act as a T.38 gateway, bridging fax-calls of a T.38 capable carrier and a T.38 capable device.

\item[{Always apply transformations}] \leavevmode
Both numbers listed in Extensions section and numbers matching any friend regexp will be considered as internal and
won't traverse numeric transformation rules.  Enable this setting to force Numeric Transformation rules even on these numbers.

\item[{RTP Encryption}] \leavevmode
If set to `yes', call won't be established unless it's possible to encryption its audio. If set to `no',
audio won't be encrypted.

\item[{Multi Contact}] \leavevmode
Same SIP credentials can be configured in multiple SIP devices. In that case, all devices ring
simultaneously when receiving a call. Setting this toggle to `No' limits this behaviour so that
only latest registered SIP device rings.

\end{description}
\end{quote}

\begin{notice}{note}{Note:}
Calls to \emph{friends} are considered internal. That means that ACLs won't
be checked when calling a friend, no matter if the origin of the call
is a user or another friend.
\end{notice}

\begin{notice}{tip}{Tip:}
Friend can be contacted due to calls to several extensions/DDIs. \emph{DDI In} setting allows remote SIP endpoint to
know which number caused each call, setting that number as destination (R-URI and To headers). This way, friend
can handle calls differently.
\end{notice}


\subparagraph{Asterisk as a remote friend}
\label{administration_portal/client/vpbx/routing_endpoints/friends/remote_friends:asterisk-as-a-remote-friend}
At the other end of a friend can be any kind of SIP entity. This section takes
as example an Asterisk PBX system using SIP channel driver that wants to connect
to IvozProvider.
\paragraph{register}

If the system can not be directly access, Asterisk will have to register in the
platform (like a terminal will do).

Configuration will be something like this:

\begin{Verbatim}[commandchars=\\\{\}]
register =\PYGZgt{} friendName:friendPassword@ivozprovider\PYGZhy{}client.sip\PYGZhy{}domain.com
\end{Verbatim}
\paragraph{peer}

\begin{Verbatim}[commandchars=\\\{\}]
[friendName]
type=peer
host=ivozprovider\PYGZhy{}client.sip\PYGZhy{}domain.com
context=XXXXXX
disallow=all
allow=alaw
defaultuser=friendName
secret=friendPassword
fromuser=friendName
fromdomain=ivozprovider\PYGZhy{}brand.sip\PYGZhy{}domain.com
insecure=port,invite
sendrpid=pai
directmedia=no
\end{Verbatim}

\begin{notice}{warning}{Warning:}
\emph{Friends}, like terminals, MUST NOT challenge IvozProvider. That's
why the \emph{insecure} setting is used here.
\end{notice}

\begin{notice}{note}{Note:}
As From username is used to identify the friend, P-Asserted-Identity (or P-Preferred-Identity or Remote-Party-Id) must be used to specify caller number.
Prevalence among these source headers is: PAI \textgreater{} PPI \textgreater{} RPID.
\end{notice}


\subparagraph{Summary of remote friends}
\label{administration_portal/client/vpbx/routing_endpoints/friends/remote_friends:summary-of-remote-friends}
The key point is understanding that a \emph{remote friend} has a direct relation with the
extension-user-terminal trio:
\begin{itemize}
\item {} 
Can place calls to all internal extensions and other friends.

\item {} 
Can place external calls that its ACL allows

\item {} 
Display their configured outgoing DDI when calling to external entities

\item {} 
Never challenge IvozProvider requests (don't request authentication on received requests)

\item {} 
Answers IvozProvider authentication challenges (All request from them to
IvozProvider must be authenticated for security reasons)

\item {} 
Only connects with \emph{Users SIP Proxy}, like terminals. In fact, SIP traffic from
friends are identical to any other user terminal traffic in format.

\end{itemize}


\subparagraph{Internal friends}
\label{administration_portal/client/vpbx/routing_endpoints/friends/internal_friends:id1}\label{administration_portal/client/vpbx/routing_endpoints/friends/internal_friends::doc}\label{administration_portal/client/vpbx/routing_endpoints/friends/internal_friends:internal-friends}
Internal friends allows a vPBX client to call to \textbf{Extensions} of another vPBX client in the same {\hyperref[administration_portal/brand/settings/corporations:corporations]{\sphinxcrossref{\DUrole{std,std-ref}{Corporation}}}}.

\begin{notice}{important}{Important:}
Only extensions in {\hyperref[administration_portal/client/vpbx/extensions:extensions]{\sphinxcrossref{\DUrole{std,std-ref}{Extensions}}}} section.
\end{notice}

If calling to an extension in another vPBX causes an external call, it is allowed:
\begin{itemize}
\item {} 
Calling to a user with an external call forwarding settings.

\item {} 
Calling to an extension routed to an external number.

\item {} 
Calling to an extension routed to a IVR with an option pointing an external number.

\item {} 
Etc.

\end{itemize}


\subparagraph{What kind of calls can be routed through an \emph{internal friend}?}
\label{administration_portal/client/vpbx/routing_endpoints/friends/internal_friends:what-kind-of-calls-can-be-routed-through-an-internal-friend}
IvozProvider will route any call matching an Extension in vpbx client connected by the internal friend.


\subparagraph{Configuration of internal friends}
\label{administration_portal/client/vpbx/routing_endpoints/friends/internal_friends:configuration-of-internal-friends}
These are the configurable settings of \emph{internal friends}:
\begin{quote}
\begin{description}
\item[{Description}] \leavevmode
Optional. Extra information for this \textbf{friend}.

\item[{Priority}] \leavevmode
Used to solve conflicts while routing calls through \textbf{friends}.
If a call destination \textbf{matches} more than one friend regular expression
the call will be routed through the friend with \textbf{less priority value}.

\item[{Connectivity mode}] \leavevmode
Choose ``IntervPBX'' for internal friends.

\item[{Target Client}] \leavevmode
vPBX client inside the same {\hyperref[administration_portal/brand/settings/corporations:corporations]{\sphinxcrossref{\DUrole{std,std-ref}{corporation}}}} you want to connect.

\item[{Fallback Outgoing DDI}] \leavevmode
If called extension causes an external call, this DDI will be used as source number.

\item[{Always apply transformations}] \leavevmode
Numbers listed in Extensions section of both source and destination client will be considered as internal and
won't traverse numeric transformation rules. Enable this setting to force Numeric Transformation rules even on these numbers.

\end{description}
\end{quote}

\begin{notice}{note}{Note:}
Calls to \emph{friends} are considered internal. That means that ACLs won't
be checked when calling a friend, no matter if the origin of the call
is a user or another friend.
\end{notice}


\subparagraph{Summary of internal friends}
\label{administration_portal/client/vpbx/routing_endpoints/friends/internal_friends:summary-of-internal-friends}
These are key points to understand \emph{internal friends}:
\begin{itemize}
\item {} 
They have been designed to allow users from a vPBX to call to extensions (normally users)
of another vPBX of the same {\hyperref[administration_portal/brand/settings/corporations:corporations]{\sphinxcrossref{\DUrole{std,std-ref}{corporation}}}}.

\item {} 
Usually they will allow user-user calls.

\item {} 
You cannot use an internal friend to generate external calls paid by the other client.

\item {} 
But external calls may happen if extensions are pointed to external numbers (controlled external calls).

\end{itemize}


\subsubsection{Friend Call Forward}
\label{administration_portal/client/vpbx/routing_endpoints/friends/index:friend-call-forward}
The friend's call forward can be configured with the \textbf{List of call forward settings}  button.

These are the fields and available values:
\begin{description}
\item[{Call Type\index{Call Type|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_endpoints/friends/index:term-call-type}
Determines if the forward must be applied to external, internal or any
type of call.

\item[{Forward type\index{Forward type|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_endpoints/friends/index:term-forward-type}\begin{description}
\item[{When this forward must be applied:}] \leavevmode\begin{itemize}
\item {} 
Unconditional: always

\item {} 
No answer: when the call is not answered in X seconds

\item {} 
Busy: When the friend rejects an incoming call.

\item {} 
Not registered: when the friend is not registered against IvozProvider.

\end{itemize}

\end{description}

\item[{Target type\index{Target type|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/routing_endpoints/friends/index:term-target-type}\begin{description}
\item[{What route will use the forwarded call.}] \leavevmode\begin{itemize}
\item {} 
VoiceMail

\item {} 
Number (external)

\item {} 
Extension (internal)

\end{itemize}

\end{description}

\end{description}

\begin{notice}{hint}{Hint:}
If we want to forward to other process, we can create an extension
routed to that object and use the target type \emph{Extension}.
\end{notice}


\subsubsection{Conference rooms}
\label{administration_portal/client/vpbx/routing_endpoints/conference_rooms::doc}\label{administration_portal/client/vpbx/routing_endpoints/conference_rooms:conference-rooms}\label{administration_portal/client/vpbx/routing_endpoints/conference_rooms:id1}
IvozProvider supports Conference rooms that can be configured in the section
\textbf{Client configuration} \textgreater{} \textbf{Conference rooms}.

\textbf{In distributed installations} using Conferences is only compatible with an static
assignment or `hash based' distribution (see \textbf{Distribute method} {\hyperref[administration_portal/brand/clients/virtual_pbx:virtual\string-pbx]{\sphinxcrossref{\DUrole{std,std-ref}{here}}}}).

\begin{notice}{hint}{Hint:}
Brand operators can choose which Clients have conferences (see \textbf{Features}
in {\hyperref[getting_started/internal_calls/brand_portal:brand\string-configuration]{\sphinxcrossref{\DUrole{std,std-ref}{Brand Configuration}}}} and {\hyperref[getting_started/internal_calls/client_portal:client\string-configuration]{\sphinxcrossref{\DUrole{std,std-ref}{Client Configuration}}}}).
\end{notice}
\paragraph{Create a new audio conference}

The following image shows the process of creating a new conference room:
\begin{quote}
\begin{description}
\item[{Name}] \leavevmode
Name that will used to identify this conference room in other sections

\item[{Max members}] \leavevmode
Maximum number of participants in the conference. When this limit is
reached, join requests will be rejected.

\item[{Pin protected}] \leavevmode
Conference rooms can be pin protected. The pin will be requested before
entering and must be numeric.

\end{description}
\end{quote}

\begin{notice}{note}{Note:}
Member limit can be disabled by setting it to 0.
\end{notice}
\paragraph{Route an extension or DDI to the conference}

In order to enter a conference there must be a number that is route to them:

In the following section we will see how to configure a {\hyperref[administration_portal/brand/views/ddis:ddis]{\sphinxcrossref{\DUrole{std,std-ref}{external DDI}}}} to a conference room so it can be used by external callers.

\begin{notice}{hint}{Hint:}
There are other ways to make external callers join a conference room
without using a DDI: it can be assigned to an Extension. This way, any user
can transfer the call to the conference extension, or can be routed, for
example using an IVR entry.
\end{notice}


\subsection{Routing tools}
\label{administration_portal/client/vpbx/routing_tools/index::doc}\label{administration_portal/client/vpbx/routing_tools/index:routing-tools}
Sections in this group are used to modify the routing policy of calls:
\phantomsection\label{administration_portal/client/vpbx/routing_tools/external_call_filters:external-filters}

\subsubsection{External call filters}
\label{administration_portal/client/vpbx/routing_tools/external_call_filters:external-call-filters}\label{administration_portal/client/vpbx/routing_tools/external_call_filters:external-filters}\label{administration_portal/client/vpbx/routing_tools/external_call_filters::doc}\label{administration_portal/client/vpbx/routing_tools/external_call_filters:id1}
One of the most common task a client's administrator will do is to
configure schedules and calendars to apply to existing {\hyperref[administration_portal/brand/views/ddis:ddis]{\sphinxcrossref{\DUrole{std,std-ref}{DDIs}}}}.

Once we have our new created {\hyperref[administration_portal/client/vpbx/routing_tools/schedules:schedules]{\sphinxcrossref{\DUrole{std,std-ref}{Schedules}}}} and {\hyperref[administration_portal/client/vpbx/routing_tools/calendars:calendars]{\sphinxcrossref{\DUrole{std,std-ref}{Calendars}}}}, it's time to apply them
in what we call \textbf{External call filter}.

The client admin can configure them in the following screen:
\begin{quote}
\begin{description}
\item[{Name}] \leavevmode
Descriptive name that will reference this filter in DDIs configuration.

\item[{Welcome locution}] \leavevmode
This locution will be played if the call is not going to be
forwarded by out of schedule or holiday filtering (in other words if
the normal routing of the DDI is going to be applied).

\item[{Black list}] \leavevmode
External origin will be checked against the associated {\hyperref[administration_portal/client/vpbx/routing_tools/match_lists:match\string-lists]{\sphinxcrossref{\DUrole{std,std-ref}{Match Lists}}}},
if a coincidence is found, the call will be rejected immediately.

\item[{White list}] \leavevmode
External origin will be checked against the associated {\hyperref[administration_portal/client/vpbx/routing_tools/match_lists:match\string-lists]{\sphinxcrossref{\DUrole{std,std-ref}{Match Lists}}}},
if a coincidence is found, the call will be directly routed to the DDI
destination, skipping the filter process. Take into account that black
listed are checked before white lists.

\item[{Holiday enabled}] \leavevmode
Set this to no to totally ignore holidays filtering.

\item[{Holiday locution}] \leavevmode
The locution will be  played when the day is marked as holiday in any
of the calendars associated with the filter \textbf{if the calendar entry has
no locution} for that day.

\item[{Holiday forward type}] \leavevmode
After playing the above locution (if configured), call can be forwarded
to a voicemail, external number or internal extension. For example, the
filter of the image will redirect calls during holidays to the external
number 676 676 676.

\item[{Out of schedule enabled}] \leavevmode
Set this to no to totally ignore out of schedule filtering.

\item[{Out of schedule locution}] \leavevmode
The locution will be played when, not being holiday, the current time
is not in any of the time gaps defined in the schedules assigned to the
filter.

\item[{Out of schedule forward type}] \leavevmode
Like in the holidays forward, but for out of schedule. The image above
won't apply any forward (and the call will be hung up).

\item[{Calendars}] \leavevmode
One or more calendars can be associated with the filter. The combination
of all the calendars will be applied.

\item[{Schedules}] \leavevmode
One or more schedules can be applied. The combination of all the time
gaps defined in the schedules will be applied.

\end{description}
\end{quote}

\begin{notice}{attention}{Attention:}
Holidays are processed \textbf{before} out of schedule events.
\end{notice}

In the next section we will use this new created filter with
{\hyperref[administration_portal/brand/views/ddis:ddis]{\sphinxcrossref{\DUrole{std,std-ref}{DDIs}}}} so we can configure a welcome locution for normal days,
and especial behaviours for holidays and out of schedule events.


\subsubsection{Calendars}
\label{administration_portal/client/vpbx/routing_tools/calendars:calendars}\label{administration_portal/client/vpbx/routing_tools/calendars::doc}\label{administration_portal/client/vpbx/routing_tools/calendars:id1}
Calenders are used to define what days are considered as holiday. Like
schedules, multiples calendars can be combined.


\paragraph{Calendar Holidays}
\label{administration_portal/client/vpbx/routing_tools/calendars:calendar-holidays}
Calendar creation process only requires a name. Once created, we can add what
days will be holidays using the buttons in its row:
\begin{quote}
\begin{description}
\item[{Name}] \leavevmode
Unique name to identify this holiday date

\item[{Locution}] \leavevmode
Override default External call filter holiday locution

\item[{Event Date}] \leavevmode
Day of the calendar to be marked as holiday

\item[{Whole day event}] \leavevmode
Enable this to create an event that lasts all the day

\item[{Time In/Time out}] \leavevmode
For not whole day events, specify the time interval the event will be active

\item[{Routing options}] \leavevmode
Override default External call filter holiday routing

\end{description}
\end{quote}

\begin{notice}{warning}{Warning:}
Calendars logic is opposite to Schedulers: If a day is not defined
as holiday in any of the calendars, it will considered a normal day and no
filtering will be applied.
\end{notice}

\begin{notice}{hint}{Hint:}
Holidays without special locutions will apply the external call filter
holiday locution.
\end{notice}

\begin{notice}{hint}{Hint:}
Holidays without special routing will apply the external call filter
holiday routing.
\end{notice}


\paragraph{Calendar Periods}
\label{administration_portal/client/vpbx/routing_tools/calendars:calendar-periods}\label{administration_portal/client/vpbx/routing_tools/calendars:id2}
Calendars can also be used to override some time periods with a different schedule.
This can be handy if vPBX has a summer schedule or other types of schedule based events.

Calendar periods can define a custom Scheduler and override External Call filters configurations:
\begin{quote}
\begin{description}
\item[{Start Date}] \leavevmode
Since when the schedules will override the filters configuration

\item[{End Date}] \leavevmode
Last day of the period (included)

\item[{Schedules}] \leavevmode
Schedules that will be used in the defined period

\item[{Locution}] \leavevmode
In case of Out of schedule, this locution that will be played. Leave empty to use External
call filter's locution.

\item[{Route options}] \leavevmode
Override default external call filter Out of schedule options

\end{description}
\end{quote}


\paragraph{Difference between non-whole day event and calendar period}
\label{administration_portal/client/vpbx/routing_tools/calendars:difference-between-non-whole-day-event-and-calendar-period}
In order to understand the difference between these two features it is important to know the order of call filter logic:

\textbf{1. Is current day marked as holiday?}

This is where non-whole day event applies, making the answer to the question above possitive during defined period.
\begin{itemize}
\item {} 
Yes: apply holiday logic defined in the calendar event or in External Call Filter.

\item {} 
No: proceed to question 2.

\end{itemize}

\textbf{2. Is current time marked as out-of-schedule?}

This is where calendar period applies, overriding schedules of External Call Filter with the one defined in calendar
period.
\begin{itemize}
\item {} 
Yes: apply out-of-schedule logic defined in the calendar period or in External Call Filter.

\item {} 
No: proceed with standard logic.

\end{itemize}
\paragraph{Example}

Configuration of a given day:
\begin{itemize}
\item {} 
Non-whole day event: 8:00-15:00

\item {} 
Calendar period: 13:00-17:00

\end{itemize}

Cases:
\begin{itemize}
\item {} 
Call at 7:00: out of schedule due to calendar period.

\item {} 
Call at 9:00: holiday logic due to non-whole day event.

\item {} 
Call at 14:00: holiday logic due to non-whole day event.

\item {} 
Call at 16:00: normal logic.

\item {} 
Call at 18:00: out of schedule due to calendar period.

\end{itemize}


\subsubsection{Schedules}
\label{administration_portal/client/vpbx/routing_tools/schedules:id1}\label{administration_portal/client/vpbx/routing_tools/schedules::doc}\label{administration_portal/client/vpbx/routing_tools/schedules:schedules}
The section \textbf{Client configuration} \textgreater{} \textbf{Schedule} allows to configure
different time gaps when an {\hyperref[administration_portal/brand/views/ddis:ddis]{\sphinxcrossref{\DUrole{std,std-ref}{external DDI}}}} will be available.

The screen displayed to the client administrator looks like this:

With the above configuration, we have defined a morning schedule that will be
applied from Monday to Thursday.

We can also define an afternoon schedule for Monday to Thursday too:

And apply a different time gap for the Fridays:

We have the following time gaps that combined will determine our client
office schedule.

\begin{notice}{warning}{Warning:}
The schedule will be defined by combining the active time gaps:
Any time outside this grouped gaps will be considered out-of-schedule.
\end{notice}
\phantomsection\label{administration_portal/client/vpbx/routing_tools/match_lists:match-lists}

\subsubsection{Match Lists}
\label{administration_portal/client/vpbx/routing_tools/match_lists:match-lists}\label{administration_portal/client/vpbx/routing_tools/match_lists:id2}\label{administration_portal/client/vpbx/routing_tools/match_lists::doc}\label{administration_portal/client/vpbx/routing_tools/match_lists:id1}
Mach Lists are designed to group well known numbers or patterns in order to use
them in specific treatments.

Depending on the section used, this numbers can be matched with the origin or
the destination of the call, so be sure to use distinctive names for your match
lists.

For example, like mentioned in the previous section {\hyperref[administration_portal/client/vpbx/routing_tools/external_call_filters:external\string-filters]{\sphinxcrossref{\DUrole{std,std-ref}{External call filters}}}},
white and black lists contain one or more match lists. In this case, the
\textbf{origin} of the call will be matched against the list entries to determine if
the treatment of \textbf{skipping} the filter or \textbf{rejecting} the call will be applied.

\begin{notice}{note}{Note:}
Match lists themselves have no behaviour associated, they only provide
a common way for all process to determine if a number has a treatment.
\end{notice}

\begin{notice}{attention}{Attention:}
Beware that numbers of a Match list are checked against origins
or destinations depending on the configuration section that use them.
\end{notice}

The section \textbf{Client configuration} \textgreater{} \textbf{Match Lists} allows to configure
different items that will group the numbers and patterns.

As shown in \textbf{List of Match List Patterns}, a match list can contain specific numbers or groups using
\href{http://php.net/manual/en/reference.pcre.pattern.syntax.php}{Regular Expressions}

\begin{notice}{error}{Error:}
\textbf{Regular expressions} of Match List patterns must be \textbf{in E.164} format and \textbf{plus symbol must be
escaped} (e.g. \textasciicircum{}\textbackslash{}+34 for all spanish numbers).
\end{notice}
\phantomsection\label{administration_portal/client/vpbx/routing_tools/route_locks:route-locks}

\subsubsection{Route locks}
\label{administration_portal/client/vpbx/routing_tools/route_locks:id2}\label{administration_portal/client/vpbx/routing_tools/route_locks:route-locks}\label{administration_portal/client/vpbx/routing_tools/route_locks::doc}\label{administration_portal/client/vpbx/routing_tools/route_locks:id1}
Route locks are a simple but powerful way to fork route logics when delivering calls. This fork is done depending on the
state of the lock on a particular moment:
\begin{itemize}
\item {} 
\textbf{Opened}: green light, go ahead.

\item {} 
\textbf{Closed}: red light, no trespassing allowed.

\end{itemize}

They are used as conditional route rule criteria (see how in {\hyperref[administration_portal/client/vpbx/routing_endpoints/conditional_routes:conditional\string-routes]{\sphinxcrossref{\DUrole{std,std-ref}{Conditional routes}}}}).


\paragraph{Route lock creation}
\label{administration_portal/client/vpbx/routing_tools/route_locks:route-lock-creation}
When you add a new route lock in \textbf{Route Locks} section, you are asked for the following fields:
\begin{quote}
\begin{description}
\item[{Name}] \leavevmode
This name will be used in conditional routes to identify the lock.

\item[{Description}] \leavevmode
Just a description.

\item[{Status}] \leavevmode
Set the initial status of the lock: opened or closed.

\end{description}
\end{quote}


\paragraph{Route locks service codes}
\label{administration_portal/client/vpbx/routing_tools/route_locks:route-locks-service-codes}
Although you can set the initial lock status on creation and change it using the admin portal too, the usual way to
handle the status changes of a lock is to use the service codes listed in \textbf{Route locks} section.

These services codes have two parts:
\begin{itemize}
\item {} 
\textbf{Service code}: configured in \textbf{Services} section per brand/client.

\item {} 
\textbf{Lock id}: immutable numeric id assigned to each lock.

\end{itemize}

\begin{notice}{tip}{Tip:}
There are 3 service codes available for most common operations on locks:
\begin{itemize}
\item {} 
Open Lock

\item {} 
Close Lock

\item {} 
Toggle Lock.

\end{itemize}

Read {\hyperref[administration_portal/client/vpbx/services:services]{\sphinxcrossref{\DUrole{std,std-ref}{Services}}}} for further details.
\end{notice}


\subsection{User configuration}
\label{administration_portal/client/vpbx/user_configuration/index:user-configuration}\label{administration_portal/client/vpbx/user_configuration/index::doc}
This section groups features that may be assigned to users/friends:


\subsubsection{Outgoing DDI Rules}
\label{administration_portal/client/vpbx/user_configuration/outgoing_ddi_rules:outgoing-ddi-rules}\label{administration_portal/client/vpbx/user_configuration/outgoing_ddi_rules:outgoingddi-rules}\label{administration_portal/client/vpbx/user_configuration/outgoing_ddi_rules::doc}
Most calling entities in IvozProvider require an outgoing DDI when placing calls
to external numbers. This includes: Users, Friends, Faxes, Retail Accounts, and
so on..

But there are some cases when a single outgoing DDI is not enough, and the
presented DDI depends on the called number or a given prefix. To archive this
dynamic outgoing DDI selection you can use Outgoing DDI rules.


\paragraph{Outgoing DDI based on destination}
\label{administration_portal/client/vpbx/user_configuration/outgoing_ddi_rules:outgoing-ddi-based-on-destination}
For destination based rules, you would require first group the destination
numbers in {\hyperref[administration_portal/client/vpbx/routing_tools/match_lists:match\string-lists]{\sphinxcrossref{\DUrole{std,std-ref}{Match Lists}}}}.

For this example, we will create a match list of corporate mobiles with all
the mobile numbers of our client workers. When we call to those numbers, we
will keep the original outgoing DDI assigned to the user, and for the rest of
the cases we will force the DDI to the main client outgoing DDI.
\paragraph{Create a new Outgoing DDI Rule}

The main creation screen defines the action that will take place when no rule
matches the dialed destination, so we define to force the main client DDI here.
\paragraph{Assign rule lists actions}

Now we add a new rule that will match our mobiles to make the user's outgoing
DDI be kept untouched.
\paragraph{Assign rule to callers}

At last, we have to configure who will use this rule to dynamically change it's
presentation number. We can do this in the \textbf{Client's edit screen} or the
\textbf{Users's edit screen}.

In this case, the User will present 777777777 DDI when calling corporate mobiles
and 666666666 when calling the rest of the external numbers.


\paragraph{Outgoing DDI based on prefix}
\label{administration_portal/client/vpbx/user_configuration/outgoing_ddi_rules:outgoing-ddi-based-on-prefix}
Outgoing DDI Rules can be also used to change the default Outgoing DDI based on
a call prefix.
\paragraph{Create a new Outgoing DDI Rule}

The main creation screen defines the action that will take place when no rule
matches the dialed destination, we will keep original DDI if no prefix is used.
\paragraph{Assign a prefix pattern}

Now we add a new rule that with prefix (let's say 111) and action to force
the DDI to 666666666.

In this case, the User will present 666666666 DDI when calling any destination
with 111 prefix and 777777777 when not using any prefix.

\begin{notice}{important}{Important:}
Prefix \textbf{must} have this format: from 1 to 3 digits ended by * symbol.
\end{notice}


\subsubsection{Pick up groups}
\label{administration_portal/client/vpbx/user_configuration/pick_up_groups:capture-groups}\label{administration_portal/client/vpbx/user_configuration/pick_up_groups:pick-up-groups}\label{administration_portal/client/vpbx/user_configuration/pick_up_groups::doc}
Call pickup is the process where a user can answer a call that is being ringing
in another terminal. No need to say that, somehow (sound, flashing lights,
notification, etc) the users must know that the call is ringing elsewhere.

IvozProvider supports two kind of call pickups:
\begin{quote}
\begin{description}
\item[{Direct pickup}] \leavevmode
In this type of pickup, the user that is trying to capture the ringing
call must include the extension of the target phone after the service
code. For example, if the direct pickup code is *95, the user must
dial *95101 to capture a call that is ringing in the extension 101.

\item[{Group pickup}] \leavevmode
In this type of pickup, the user that is trying to capture the ringing
call will just dial the service code. If anyone in any of the pickup
groups of the user has a ringing call, it will be answered by the
capturer.

\end{description}
\end{quote}


\paragraph{Call pickup groups}
\label{administration_portal/client/vpbx/user_configuration/pick_up_groups:call-pickup-groups}
In order to make \textbf{call group pickups}, the capturer user must be part of the
same group that the target user that wants to capture.

The section \textbf{Pickup groups} allows the client administrator to configure
what users will be in each group:

As shown in the section {\hyperref[administration_portal/client/vpbx/users:users]{\sphinxcrossref{\DUrole{std,std-ref}{Users}}}}, we can add or edit the groups of a user
in the user's edit screen.

\begin{notice}{note}{Note:}
A user can be part of multiple pickup groups. The system will take
all of them into account when using the group pickup service.
\end{notice}


\paragraph{Group pickup service code}
\label{administration_portal/client/vpbx/user_configuration/pick_up_groups:group-pickup-service-code}
IvozProvider supports 2 different configuration levels for defining the service
codes for pickup:
\begin{itemize}
\item {} 
At brand level: \textbf{Brand configuration} \textgreater{} \textbf{Services}.

\item {} 
At client level: \textbf{Client configuration} \textgreater{} \textbf{Services}.

\end{itemize}

The brand administrator can configure generic codes that all the clients will
use. Clients can customize this codes if they are used to another ones.

The {\hyperref[administration_portal/client/vpbx/services:services]{\sphinxcrossref{\DUrole{std,std-ref}{following section}}}} explains the services in depth, with
all the additional services that can be accessed by dialing codes starting with
*.


\subsubsection{Call ACLs}
\label{administration_portal/client/vpbx/user_configuration/call_acls:call-permissions}\label{administration_portal/client/vpbx/user_configuration/call_acls::doc}\label{administration_portal/client/vpbx/user_configuration/call_acls:call-acls}
The \textbf{Call ACLs} determines what users can call to external numbers.

\begin{notice}{attention}{Attention:}
The internal extensions (the ones listed in {\hyperref[administration_portal/client/vpbx/extensions:extensions]{\sphinxcrossref{\DUrole{std,std-ref}{Extensions}}}}) are allowed to all users, the \textbf{Call
ACLs only apply to external numbers}. Calls to friends extensions are considered internal too, no call ACL is needed.
\end{notice}

The \textbf{Call ACL} setup has two different parts:
\begin{itemize}
\item {} 
Classify the call in different types based on \textbf{match lists}:
\begin{itemize}
\item {} 
Brand level: \textbf{Brand Configuration} \textgreater{} \textbf{Generic Match Lists}

\item {} 
Client level: \textbf{Client Configuration} \textgreater{} \textbf{Match Lists}

\end{itemize}

\item {} 
Choose policies for groups of patterns: \textbf{Client Configuration} \textgreater{} \textbf{Call
ACLs}

\end{itemize}


\paragraph{Call ACL Matchlists}
\label{administration_portal/client/vpbx/user_configuration/call_acls:call-acl-matchlists}
The destination number is matched against the \textbf{ACL MatchLists} to determine
the call permission.

\begin{notice}{note}{Note:}
Brand matchlists can be used by any of its clients, so most common
ACL Patterns (p.e. country prefixes) can be reused easily.
\end{notice}

For more information of how MatchLists patterns are created, please refer to section
{\hyperref[administration_portal/client/vpbx/routing_tools/match_lists:match\string-lists]{\sphinxcrossref{\DUrole{std,std-ref}{Match Lists}}}}.

\begin{notice}{error}{Error:}
\textbf{Regular expressions} of Match List patterns must be \textbf{in E.164} format and \textbf{plus symbol must be
escaped} (e.g. \textasciicircum{}\textbackslash{}+34 for all spanish numbers).
\end{notice}


\paragraph{Call ACL}
\label{administration_portal/client/vpbx/user_configuration/call_acls:call-acl}
When a new \textbf{Call ACL} is created, these two fields turn up:
\begin{quote}
\begin{description}
\item[{Name}] \leavevmode
Used to reference this Call ACL.

\item[{Default policy}] \leavevmode
If no rule matches, this ACL will deny the call or allow it?

\end{description}
\end{quote}

After creating the \textbf{Call ACL} we can edit it to add the required rules:
\begin{itemize}
\item {} 
Rules to deny some specific destinations.

\item {} 
Rules to allow some specific destinations.

\end{itemize}

\begin{notice}{note}{Note:}
The \textbf{metric} determines the evaluation order of the rules.
\end{notice}


\subparagraph{Assign Call ACLs}
\label{administration_portal/client/vpbx/user_configuration/call_acls:assign-call-acls}
Created \emph{Call ACLs} can be assigned to:
\begin{itemize}
\item {} 
Friends through \emph{Call ACL} parameter.

\item {} 
Users through \emph{Call ACL} parameter.

\end{itemize}


\subsubsection{Locations}
\label{administration_portal/client/vpbx/user_configuration/locations::doc}\label{administration_portal/client/vpbx/user_configuration/locations:locations}
Locations provide an easy way to group users by the place they are working at.
\paragraph{Create a new location}
\begin{description}
\item[{Name\index{Name|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/user_configuration/locations:term-name}
Name of the Location where users are working

\item[{Description\index{Description|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/user_configuration/locations:term-description}
Long description with additional location information

\end{description}

\begin{notice}{note}{Note:}
There is currently no internal usage for Locations in the
platform, but it's a prerequisite for future developments.
\end{notice}


\subsection{Multimedia}
\label{administration_portal/client/vpbx/multimedia/index:multimedia}\label{administration_portal/client/vpbx/multimedia/index::doc}
This two sections involve media files:


\subsubsection{Locutions}
\label{administration_portal/client/vpbx/multimedia/locutions:locutions}\label{administration_portal/client/vpbx/multimedia/locutions::doc}
The locutions of the platform are created and uploaded just like the files of
{\hyperref[administration_portal/client/vpbx/multimedia/music_on_hold:musiconhold]{\sphinxcrossref{\DUrole{std,std-ref}{Music on Hold}}}}.

The section \textbf{Client configuration} \textgreater{} \textbf{Locutions}  allows the client admin
to choose the sounds that will be played in many configuration places (IVR, etc)
accross the platform.

\begin{notice}{attention}{Attention:}
Locutions can be recorded from any terminal by dialing the
Recording extension displayed in their edit screen.
\end{notice}

\begin{notice}{hint}{Hint:}
The main difference between a \textbf{locution} and \textbf{music on hold} is
that the administrator chooses when the first one will be played (out of
schedule, IVRs, and so on) and the second one will be played when a call is
held by an user.
\end{notice}
\phantomsection\label{administration_portal/client/vpbx/multimedia/music_on_hold:musiconhold}

\subsubsection{Music on Hold}
\label{administration_portal/client/vpbx/multimedia/music_on_hold:music-on-hold}\label{administration_portal/client/vpbx/multimedia/music_on_hold::doc}\label{administration_portal/client/vpbx/multimedia/music_on_hold:musiconhold}\label{administration_portal/client/vpbx/multimedia/music_on_hold:id1}
The music on hold will be played when the user holds the call and the other
member waits until the call is resumed.

If a client has defined a music on hold, it will be played. Otherwise, the
one defined by the brand administrator. If none of this is configured, a global
music will be played.

\begin{notice}{note}{Note:}
Multiple files can be added to be played as Music on Hold. The system
will choose them randomly for each call.
\end{notice}
\paragraph{Add a new music on hold}

Once the music has been \emph{encoded} the \textbf{Status} fill will display \emph{ready} and
the music will be used for the next calls.

\begin{notice}{tip}{Tip:}
IvozProvider supports most of the common audio formats and \emph{encodes}
them to the optimal format for the platform.
\end{notice}

After the \emph{encoding}, we can download both the original and the converted
version in the edit screen.
\phantomsection\label{administration_portal/client/vpbx/faxes:faxing-system}

\subsection{Faxes}
\label{administration_portal/client/vpbx/faxes:faxes}\label{administration_portal/client/vpbx/faxes::doc}\label{administration_portal/client/vpbx/faxes:faxing-system}\label{administration_portal/client/vpbx/faxes:id1}
IvozProvider includes a simple but efficient \emph{virtual faxing} solution that allows:
\begin{itemize}
\item {} 
Sending PDF files via Fax.

\item {} 
Receiving faxes through email or check them through the web portal.

\end{itemize}

\begin{notice}{error}{Error:}
IvozProvider uses
\href{http://www.voip-info.org/wiki/view/T.38}{T.38} for both sending and receiving
faxes. Brand Operator must use \emph{peering contracts} that have support for it.
\end{notice}


\subsubsection{Creating a virtual fax}
\label{administration_portal/client/vpbx/faxes:creating-a-virtual-fax}
These are the fields that turn up when we create a new fax:
\begin{quote}
\begin{description}
\item[{Name}] \leavevmode
Used by remaining section to reference a fax

\item[{Email}] \leavevmode
Email address when we want to receive incoming faxes (if we check `Send
by email')

\item[{Outbound DDI}] \leavevmode
DDI used as source number for outgoing faxes

\end{description}
\end{quote}

To receive faxes in this DDI, we need to point it to our new fax in the section
\textbf{DDIs}.

Brand Operator can choose one or more {\hyperref[administration_portal/brand/routing/outgoing_routings:outgoing\string-routings]{\sphinxcrossref{\DUrole{std,std-ref}{Outgoing Routings}}}} for sending faxes.

\begin{notice}{note}{Note:}
\emph{load-balancing} y \emph{failover} logics described in {\hyperref[administration_portal/brand/routing/outgoing_routings:outgoing\string-routings]{\sphinxcrossref{\DUrole{std,std-ref}{Outgoing Routings}}}}
apply to faxes too.
\end{notice}

\begin{notice}{important}{Important:}
If no fax-specific route is defined, faxes will be routed using
standard call routes.
\end{notice}


\subsubsection{Sending a fax}
\label{administration_portal/client/vpbx/faxes:sending-a-fax}
Sending a fax is an easy task that is done through \textbf{List of outgoing faxfiles} subsection.

First, we upload de PDF file and set the destination. When we save the entry, the list shows the fax and its status.


\subsubsection{Incoming faxes display}
\label{administration_portal/client/vpbx/faxes:incoming-faxes-display}
Apart from being received by mail, faxes can be watched and downloaded within
the web portal too in \textbf{List of incoming faxfiles} subsection.
\phantomsection\label{administration_portal/client/vpbx/services:client-services}

\subsection{Services}
\label{administration_portal/client/vpbx/services:services}\label{administration_portal/client/vpbx/services:client-services}\label{administration_portal/client/vpbx/services::doc}\label{administration_portal/client/vpbx/services:id1}
\begin{notice}{danger}{Danger:}
Services defined in this section \textbf{are not accessible during a
conversation}. They are activated by \textbf{calling the codes}, not using
DTMF codes while talking.
\end{notice}

Each client can \emph{customize} the default values assigned by the \emph{brand operator}
using the section \textbf{Client configuration} \textgreater{} \textbf{Services} and changing the codes
listed there.

\begin{notice}{hint}{Hint:}
Services deleted by the \emph{client admin} will not available to users.
\end{notice}


\subsection{Voicemails}
\label{administration_portal/client/vpbx/voicemails:voicemails}\label{administration_portal/client/vpbx/voicemails::doc}\label{administration_portal/client/vpbx/voicemails:id1}
Voicemails can be used as leaf routable endpoint in most vPBX logics.

All users start with a pre-configured voicemail with their email address that can be disabled in voicemails section.

It's also possible to create a Voicemail that is not linked to any user, so it can be used in more global routing
logics.

\begin{notice}{note}{Note:}
For these generic voicemails, an extension routed to the voicemail is required to access the check voicemail
service (using the service code followed by the extension number).
\end{notice}

Voicemail most notable fields are:
\begin{quote}
\begin{description}
\item[{Enabled}] \leavevmode
Enables or disables voicemail. This will hide this voicemail from select listboxes in routes.

\item[{Name}] \leavevmode
The name displayed in the selection listboxes. For user voicemails, this value is calculated from Firstname and
Lastname of the user.

\item[{Locution}] \leavevmode
If set, this locution is played as voicemail welcome message when a voicemail
for this voicemail is going to be recorded. This only applies for call forwards
to voicemail.

\item[{Email address}] \leavevmode
Send an email to the configured user address when a new voicemail is received. For user voicemails this value
is configured in User edit screen.

\item[{Attach sounds:}] \leavevmode
Attach the audio message to the sent email.

\end{description}
\end{quote}

\begin{notice}{note}{Note:}
If voicemail locution is not assigned, default locution will be used as long as
the owner has not recorded a custom message through the voicemail menu (calling to
voicemail service code).
\end{notice}


\subsection{Address Book}
\label{administration_portal/client/vpbx/addressbook:address-book}\label{administration_portal/client/vpbx/addressbook::doc}
Virtual PBX clients have access to a simple Address book to store contacts,
that can be used for third party integrations.

Contacts for vPBX users are automatically created and managed by the system,
but client administrators can add other external numbers to existing contacts.


\subsubsection{Personal data}
\label{administration_portal/client/vpbx/addressbook:personal-data}\begin{description}
\item[{Name\index{Name|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/addressbook:term-name}
Name of the contact.

\item[{Lastname\index{Lastname|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/addressbook:term-lastname}
Lastname of the contact.

\item[{Email\index{Email|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/addressbook:term-email}
Email of the contact.

\end{description}


\subsubsection{Phones}
\label{administration_portal/client/vpbx/addressbook:phones}\begin{description}
\item[{Work Phone\index{Work Phone|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/addressbook:term-work-phone}
Public external work number of the contact.

\item[{Mobile Phone\index{Mobile Phone|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/addressbook:term-mobile-phone}
Public external mobile number of the contact.

\item[{Other Phone\index{Other Phone|textbf}}] \leavevmode\phantomsection\label{administration_portal/client/vpbx/addressbook:term-other-phone}
Free format number of the contact (Internal Extension, Fax, etc)

\end{description}


\subsection{Rating profiles}
\label{administration_portal/client/vpbx/rating_profiles:rating-profiles}\label{administration_portal/client/vpbx/rating_profiles::doc}
This section allows the client to:
\begin{itemize}
\item {} 
See the list of rating plans and their activation time.

\item {} 
Check available routing tags (only for retail and wholesale clients) to reach different destinations.

\item {} 
Simulate a call and guess the cost of a given call.

\end{itemize}

\begin{notice}{note}{Note:}
This section is only shown to clients with \emph{Display billing details to client} set to Yes.
\end{notice}


\subsection{Calls}
\label{administration_portal/client/vpbx/calls/index::doc}\label{administration_portal/client/vpbx/calls/index:calls}
These are the call-list sections for vPBX clients:


\subsubsection{Call registry}
\label{administration_portal/client/vpbx/calls/call_registry::doc}\label{administration_portal/client/vpbx/calls/call_registry:call-registry}\label{administration_portal/client/vpbx/calls/call_registry:id1}
Lists all the calls of the client, even those that do not imply cost.

\begin{notice}{note}{Note:}
\href{https://es.wikipedia.org/wiki/CSV}{CSV} export makes possible to
download the list for its later analysis.
\end{notice}


\subsubsection{Active calls}
\label{administration_portal/client/vpbx/calls/active_calls::doc}\label{administration_portal/client/vpbx/calls/active_calls:active-calls}
This section allows client administrator view \textbf{current active calls}.

\begin{notice}{warning}{Warning:}
\textbf{Calls involving any user, friend, retail account, residential device or wholesale client will be shown},
no matter they are internal or external.
\end{notice}

These are columns shown:
\begin{quote}
\begin{description}
\item[{Duration}] \leavevmode
Show call establishment duration during establishment and call duration during ongoing call. It also shows
direction (inbound/outbound) and call state information, as explained {\hyperref[administration_portal/platform/active_calls:call\string-state]{\sphinxcrossref{\DUrole{std,std-ref}{here}}}}.

\item[{Owner}] \leavevmode
User, friend, retail account, residential device or wholesale client involved in given call.

\item[{Party}] \leavevmode
Remaining participant of given call. It gets updated to show current party (in transfers and diverted calls).

\end{description}
\end{quote}

\begin{notice}{note}{Note:}
There will be one entry per entity involved. This means that a standard internal call will be shown
in two different rows: one outbound call for calling user and one inbound call for called user.
\end{notice}


\subsubsection{External calls}
\label{administration_portal/client/vpbx/calls/external_calls::doc}\label{administration_portal/client/vpbx/calls/external_calls:external-calls}
\textbf{External calls} section lists \textbf{both inbound and outbound external calls}.

This section is shown at different levels:
\begin{itemize}
\item {} 
Main level (god level)

\item {} 
Brand level (filtered for emulated/logged brand).

\item {} 
Client level (filtered for emulated/logged client).

\end{itemize}

Each entry shows this information:
\begin{quote}
\begin{description}
\item[{Start time}] \leavevmode
Date and time of the call establishment.

\item[{Brand}] \leavevmode
Only visible for \emph{god}, shows the brand of each call.

\item[{Client}] \leavevmode
Visible for \emph{god} and \emph{brand operator}, shows the client of each call.

\item[{Caller}] \leavevmode
DDI presented for the outgoing call.

\item[{Callee}] \leavevmode
External number dialed.

\item[{Duration}] \leavevmode
Shows how long the call lasted.

\item[{Price}] \leavevmode
The money amount for the client. Visible for \emph{god} and \emph{brand operator} and \emph{Client administrator} if
\emph{Display billing details to client} is enabled.

\item[{Cost}] \leavevmode
Visible for \emph{god} and \emph{brand operator}, the money amount for the brand (the money that the carrier will bill for the call).

\item[{Rating Plan}] \leavevmode
Rating plan used to set price for the call. Visible for \emph{god} and \emph{brand operator} and \emph{Client administrator} if
\emph{Display billing details to client} is enabled.

\item[{Destination}] \leavevmode
Destination that matched the call for billing. Visible for \emph{god} and \emph{brand operator} and \emph{Client administrator} if
\emph{Display billing details to client} is enabled.

\item[{Carrier}] \leavevmode
Visible for \emph{god} and \emph{brand operator}, shows which {\hyperref[administration_portal/brand/providers/carriers:carriers]{\sphinxcrossref{\DUrole{std,std-ref}{Carrier}}}} was used for each outbound call.

\item[{DDI Provider}] \leavevmode
Visible for \emph{god} and \emph{brand operator}, shows which {\hyperref[administration_portal/brand/providers/ddi_providers:ddi\string-providers]{\sphinxcrossref{\DUrole{std,std-ref}{DDI Provider}}}} was used for each inbound call.

\item[{Invoice}] \leavevmode
Visible for \emph{god} and \emph{brand operator}, shows if a call is already included in any {\hyperref[administration_portal/brand/invoicing/invoices:invoices]{\sphinxcrossref{\DUrole{std,std-ref}{Invoice}}}}.

\item[{Call ID}] \leavevmode
Shows the call ID of the call for troubleshooting and CSV export.

\item[{Endpoint Type}] \leavevmode
Possible values: RetailAccount, ResidentialDevice, User, Fax, Friend.

\item[{Endpoint Id}] \leavevmode
Internal ID of specific endpoint (only when \emph{endpointType} is non-empty).

\item[{Endpoint Name}] \leavevmode
User extension, friend name, fax name, retail account name or residential device name (only when \emph{endpointId} is non-empty).

\end{description}
\end{quote}

\begin{notice}{note}{Note:}
An asynchronous process parses each external call and adds it to this list a few minutes after call hangup. Billing related fields, such as cost and price, will be empty for external incoming calls.
\end{notice}


\paragraph{Call rerating}
\label{administration_portal/client/vpbx/calls/external_calls:call-rerating}
At \textbf{brand level}, there is an additional available operation for outbound calls: \textbf{Rerate call}. This option allows calling rating engine again for a call or a bunch of calls.

Notes about this rerating process:
\begin{itemize}
\item {} 
If a call is in an invoice, it cannot be rerated. Invoice must be deleted first.

\item {} 
Call will be rerated with the \emph{Start time} of the call (no with current active rating plans, but with active rating plans
on the moment of the call).

\item {} 
Both \emph{Price} and \emph{Cost} will be recalculated. This may imply updating \emph{rating plan} and \emph{destination} too.

\end{itemize}

\begin{notice}{tip}{Tip:}
When a call is rerated, cost and price are emptied until the next iteration of the asynchronous task.
\end{notice}


\subsubsection{Call CSV schedulers}
\label{administration_portal/client/vpbx/calls/call_csv_schedulers:call-csv-schedulers}\label{administration_portal/client/vpbx/calls/call_csv_schedulers::doc}
This section allows programming automatic periodical CSV reports to vPBX client administrators.

\begin{notice}{note}{Note:}
This section is almost identical to {\hyperref[administration_portal/brand/invoicing/invoice_schedulers:invoice\string-schedulers]{\sphinxcrossref{\DUrole{std,std-ref}{Invoice schedulers}}}} except to the
fields that do not apply to CSVs (Invoice number sequence, Tax rate...)
\end{notice}

When adding a new definition, these fields are shown:
\begin{quote}
\begin{description}
\item[{Name}] \leavevmode
Name of the scheduled Call CSV

\item[{Email}] \leavevmode
Send generated Call CSV via email. Empty if no automatic mail is wanted.

\item[{Frequency/Unit}] \leavevmode
Defines the frequency (once a month, every 7 days, etc.) of the programmed task

\item[{Direction}] \leavevmode
Defines which calls should be included attending to its direction (inbound, outbound, both).

\item[{DDI}] \leavevmode
Allows selecting a client's specific DDI.

\item[{Endpoint type}] \leavevmode
Allows selecting one specific endpoint type between: user, friend and fax.

\item[{User}] \leavevmode
Only for \emph{Endpoint type: user}, allows selecting one specific user.

\item[{Fax}] \leavevmode
Only for \emph{Endpoint type: fax}, allows selecting one specific fax.

\item[{Friend}] \leavevmode
Only for \emph{Endpoint type: friend}, allows selecting one specific friend.

\end{description}
\end{quote}

Once created, some new fields and subsections are accesible:
\begin{quote}
\begin{description}
\item[{Next execution}] \leavevmode
Shows next execution date

\item[{Last execution}] \leavevmode
Shows last execution and its result.

\end{description}
\end{quote}

\begin{notice}{tip}{Tip:}
Modifying \emph{Next execution} value allows forcing specific runs. For example, setting \emph{Next execution} to
current month's first day will create again last month's CSV report (for a monthly scheduler).
\end{notice}

Generated CSVs of each scheduler can be accessed in \textbf{List of Call CSV reports} subsection.


\paragraph{CSV fields}
\label{administration_portal/client/vpbx/calls/call_csv_schedulers:csv-fields}
These are the fields of the generated CSV files:
\begin{quote}
\begin{description}
\item[{callid}] \leavevmode
Call-ID of the SIP dialog

\item[{startTime}] \leavevmode
Time and date of the call establishment

\item[{duration}] \leavevmode
Call duration in seconds

\item[{caller}] \leavevmode
Caller number in E.164 format (with `+')

\item[{callee}] \leavevmode
Callee number in E.164 format (with `+')

\item[{price}] \leavevmode
Calculated price for the given call (empty if \emph{Display billing details to client} is disabled)

\item[{direction}] \leavevmode
Possible values: inbound, outbound.

\item[{ddiId}] \leavevmode
Client DDI to which call will be assigned (callee for inbound calls, caller for outbound calls).

\item[{endpointType}] \leavevmode
Possible values: User, Fax, Friend.

\item[{endpointId}] \leavevmode
Internal ID of specific endpoint (only when \emph{endpointType} has a non-empty value).

\item[{endpointName}] \leavevmode
User extension, friend name or fax name

\end{description}
\end{quote}


\subsubsection{Call recordings}
\label{administration_portal/client/vpbx/calls/call_recordings::doc}\label{administration_portal/client/vpbx/calls/call_recordings:call-recordings}\label{administration_portal/client/vpbx/calls/call_recordings:id1}
\begin{notice}{attention}{Attention:}
Beware that local legislation may enforce to announce that the
call is being recorded (sometimes to both parties). You should include
a recording disclaimer in your welcome locutions for DDIs with automatic
recording enabled.
\end{notice}

IvozProvider supports two different ways of recording calls:
\begin{itemize}
\item {} 
\textbf{Automatic recordings} for the incoming/outgoing calls that use a
{\hyperref[administration_portal/brand/views/ddis:ddis]{\sphinxcrossref{\DUrole{std,std-ref}{External DDI}}}}.

\item {} 
\textbf{On demand recordings} requested by a user during a call.

\end{itemize}


\paragraph{Automatic DDI recordings}
\label{administration_portal/client/vpbx/calls/call_recordings:automatic-ddi-recordings}
In this type of recording, \textbf{the whole conversation will be recorded}: from
the start until it finishes.

Two different scenarios:
\begin{itemize}
\item {} 
\textbf{Incoming calls to a DDI}: The call will continue until the external
dialer hangups (no matter whom is talking to).

\item {} 
\textbf{Outgoing calls using a DDI} as {\hyperref[administration_portal/brand/views/ddis:ddis]{\sphinxcrossref{\DUrole{std,std-ref}{Outgoing DDI}}}}: the
recording will continue as long as the external destination keeps in the
conversation.

\end{itemize}

\begin{notice}{attention}{Attention:}
Take into account that the call will be recorded while the
external entity is present, even it the call is being transferred between
multiple users of the platform.
\end{notice}
\paragraph{Record all the calls of a DDI}

To enable this feature, edit the DDI and configure the field under the section
recording data:

There are 4 available options:
\begin{itemize}
\item {} 
Disable recordings

\item {} 
Enable incoming recordings

\item {} 
Enable outgoing recordings

\item {} 
Enable all call recordings

\end{itemize}


\paragraph{On demand recordings}
\label{administration_portal/client/vpbx/calls/call_recordings:on-demand-recordings}
The \emph{on-demand} recordings must be enabled by the \emph{brand administrator} for the
clients that request it. This can be done in the client edit screen:

\begin{notice}{warning}{Warning:}
Contrary to the {\hyperref[administration_portal/client/vpbx/services:services]{\sphinxcrossref{\DUrole{std,std-ref}{Services}}}} mentioned in the
previous section, the on demand record are activated within a conversation.
\end{notice}

Contrary to automatic ones, on demand recording can be stopped using the same
process that started them.


\subparagraph{Activated using the \emph{Record} key}
\label{administration_portal/client/vpbx/calls/call_recordings:activated-using-the-record-key}
Some terminals (for example, \emph{Yealink}) support sending a \href{https://tools.ietf.org/html/rfc6086}{SIP INFO} message during the conversation with a
special \emph{Record} header (see \href{http://www.yealink.com/Upload/document/UsingCallRecordingFeatureonYealinkPhones/UsingCallRecordingFeatureonYealinkSIPT2XPphonesRev\_610-20561729764.pdf}{reference}).
This is not a standard for the protocol, but being Yealink one of the supported
manufacturers of the solution, we include this kind of on-demand recording.

\begin{notice}{important}{Important:}
For this recording requests, the configured code doesn't matter
but the client still must have on demand records enabled.
\end{notice}

To start or stop this kind of recordings, just press the Record key in the
terminal and the system will handle the sent message.


\subparagraph{Activated using \emph{DTMF} codes}
\label{administration_portal/client/vpbx/calls/call_recordings:activated-using-dtmf-codes}
The more traditional approach for this feature is to press a combination of
keys during the call. Some notification will be played and the recording will
start or stop. This combination is sent to the system using \href{https://es.wikipedia.org/wiki/Marcaci\%C3\%B3n\_por\_tonos}{DTMF tones} using the same audio
stream that the conversation (as mentioned in \href{https://tools.ietf.org/html/rfc4733}{RFC 4733}).

IvozProvider supports this kind of on demand record activation but with an
important downside. In order to capture this codes, the pbx must process each
audio packet to detect the code, avoiding the direct flow of media between the
final endpoints.

\begin{notice}{important}{Important:}
Enabling this record mode highly affects the performance of the
platform. Use at your own risk.
\end{notice}


\paragraph{Recordings list}
\label{administration_portal/client/vpbx/calls/call_recordings:recordings-list}
The \emph{client administrator} can access to all the recordings in the section
\textbf{Client configuration} \textgreater{} \textbf{Calls} \textgreater{} \textbf{Call recordings}:
\begin{itemize}
\item {} 
Recordings can be heard from the \emph{web} or downloaded in MP3 format.

\item {} 
If the recording has been started on demand, it will also include the user
that requested it.

\end{itemize}

\begin{notice}{tip}{Tip:}
Recording removal button is shown only if \textbf{Allow Client to remove recordings} is enabled
for the client in \emph{Client configuration}.
\end{notice}
\phantomsection\label{administration_portal/client/residential/index:residential-clients}

\section{Residential Clients}
\label{administration_portal/client/residential/index:residential-clients}\label{administration_portal/client/residential/index:id1}\label{administration_portal/client/residential/index::doc}\label{administration_portal/client/residential/index:clientes-residenciales}
Residential clients are a special type of client that only provides a connectivity
service with carriers through residential devices.

\begin{notice}{attention}{Attention:}
Contrary to the Virtual PBX clients, all Residential clients use the
brand domain to unequivocally identify their devices. You'll need to configure
Brand's domain to use this feature.
\end{notice}

\begin{notice}{hint}{Hint:}
Residential clients can be enabled per Brand basis via Features.
\end{notice}

The goal of this section will be describe each of the configuration settings
associated with Residential clients included in IvozProvider:


\subsection{Residential devices}
\label{administration_portal/client/residential/residential_devices:id1}\label{administration_portal/client/residential/residential_devices::doc}\label{administration_portal/client/residential/residential_devices:residential-devices}
Residential Devices are the main routable option in Residential clients.
More or less like {\hyperref[administration_portal/client/vpbx/routing_endpoints/friends/index:friends]{\sphinxcrossref{\DUrole{std,std-ref}{Friends}}}} are to Virtual PBX Clients, devices
contain the required configurable options to provide a SIP connectivity
service with IvozProvider and an external SIP entity.

\begin{notice}{warning}{Warning:}
Although both \textbf{Carriers/DDI Providers} and \textbf{Residential Devices} are defined by the
\textbf{brand operator}, the former are designed to connect with the public switched telephony network
while the latter connects the system with our clients' SIP entities.
\end{notice}


\subsubsection{Types of residential devices}
\label{administration_portal/client/residential/residential_devices:types-of-residential-devices}
There are 2 main types of SIP endpoints that can use residential with IvozProvider:
\begin{itemize}
\item {} 
\textbf{Direct connection endpoint}: IvozProvider must be able to talk SIP directly with
this kind of devices by just forwarding the traffic to the proper port of
the public IP address of the PBX.

\item {} 
\textbf{Endpoint behind NAT}: Not directly reachable. This kind of endpoint must register at
IvozProvider (just like all the {\hyperref[administration_portal/client/vpbx/terminals:terminals]{\sphinxcrossref{\DUrole{std,std-ref}{Terminals}}}} do).

\end{itemize}


\subsubsection{What kind of calls can be routed through a \emph{Residential Device}?}
\label{administration_portal/client/residential/residential_devices:what-kind-of-calls-can-be-routed-through-a-residential-device}
Contrary to Friends, \textbf{Residential Devices} have some simplifications and limitations:
\begin{itemize}
\item {} 
Residential Devices only route their assigned DDIs

\item {} 
Residential Devices only place externals calls to Carriers

\item {} 
Residential Devices only receive external calls from DDI Providers

\end{itemize}


\subsubsection{Residential Devices Configuration}
\label{administration_portal/client/residential/residential_devices:residential-devices-configuration}
These are the configurable settings of \emph{Residential devices}:
\begin{quote}
\begin{description}
\item[{Name}] \leavevmode
Name of the \textbf{residential device}. This name must be unique in the whole brand so
it's recommended to use some kind of sequential identifier. This will also be used
in SIP messages (sent \textbf{From User}).

\item[{Description}] \leavevmode
Optional. Extra information for this \emph{residential device}.

\item[{Password}] \leavevmode
When the \emph{residential device} send requests, IvozProvider will authenticate it using
this password. \textbf{Using password IS A MUST in ``Register'' mode}. In ``Direct'' mode,
leaving it blank disables SIP authentication and enables IP source check.

\item[{Direct connectivity}] \leavevmode
If you choose `Yes' here, you'll have to fill the protocol, address and
port where this \emph{residential device} can be contacted.

\item[{Language}] \leavevmode
Locutions will be played in this language

\item[{Numeric transformation}] \leavevmode
Numeric transformation set that will be applied when communicating with this device.

\item[{Fallback Outgoing DDI}] \leavevmode
External calls from this \emph{residential device} will be presented with this DDI, \textbf{unless
the source presented matches a DDI belonging to the residential client}.

\item[{Allowed codec}] \leavevmode
Like vPBX terminals, \emph{residential devices} will talk only the selected codec.

\item[{From domain}] \leavevmode
Request from IvozProvider to this device will include this domain in
the From header.

\item[{DDI In}] \leavevmode
If set to `Yes', set destination (R-URI and To) to called DDI when calling to this endpoint. If set `No', username
used in Contact header of registration will be used, as specified in SIP RFC (residential device name will be used
for endpoints with direct connectivity). Defaults to `No'.

\item[{Call waiting}] \leavevmode
Limits received calls when already handling this number of calls. Set 0 for unlimited.

\item[{Enable T.38 passthrough}] \leavevmode
If set to `yes', this SIP endpoint must be a \textbf{T.38 capable fax sender/receiver}. IvozProvider
will act as a T.38 gateway, bridging fax-calls of a T.38 capable carrier and a T.38 capable device.

\item[{RTP Encryption}] \leavevmode
If set to `yes', call won't be established unless it's possible to encryption its audio. If set to `no',
audio won't be encrypted.

\item[{Multi Contact}] \leavevmode
Same SIP credentials can be configured in multiple SIP devices. In that case, all devices ring
simultaneously when receiving a call. Setting this toggle to `No' limits this behaviour so that
only latest registered SIP device rings.

\end{description}
\end{quote}

\begin{notice}{tip}{Tip:}
Residential device can be contacted due to calls to several DDIs. \emph{DDI In} setting allows remote SIP endpoint to
know which number caused each call, setting that number as destination (R-URI and To headers). This way, residential
device can handle calls differently.
\end{notice}


\subsubsection{Voicemail settings}
\label{administration_portal/client/residential/residential_devices:voicemail-settings}
Every residential device has a voicemail that can be accessed using voicemail service code defined at brand level.

Additionally, voicemails can be configured to send their messages to an email address in {\hyperref[administration_portal/client/residential/residential_voicemails:residential\string-voicemails]{\sphinxcrossref{\DUrole{std,std-ref}{Residential Voicemails}}}}.


\subsubsection{Call forwarding settings}
\label{administration_portal/client/residential/residential_devices:residential-devices-cfw}\label{administration_portal/client/residential/residential_devices:call-forwarding-settings}
Apart from unconditional call forwarding to external number through {\hyperref[administration_portal/client/vpbx/routing_tools/external_call_filters:external\string-call\string-filters]{\sphinxcrossref{\DUrole{std,std-ref}{External call filters}}}} applied to DDI,
residential devices may have additional call forwarding settings that allow:
\begin{itemize}
\item {} 
Forwarding to another external number.

\item {} 
Forwarding to voicemail associated to each residential device.

\item {} 
Supported forwarding types: unconditional, no-answer, non-registered, busy.

\end{itemize}

\begin{notice}{warning}{Warning:}
{\hyperref[administration_portal/client/vpbx/routing_tools/external_call_filters:external\string-call\string-filters]{\sphinxcrossref{\DUrole{std,std-ref}{External call filters}}}} have precedence over residential devices call forwarding settings.
\end{notice}

\begin{notice}{tip}{Tip:}
Forwarding to national numbers can be configured using services codes
(further information {\hyperref[administration_portal/brand/settings/generic_services:call\string-forward\string-services]{\sphinxcrossref{\DUrole{std,std-ref}{here}}}}).
\end{notice}


\subsubsection{Asterisk as a residential device}
\label{administration_portal/client/residential/residential_devices:asterisk-as-a-residential-device}
At the other end of a device can be any kind of SIP entity. This section takes
as example an Asterisk PBX system using SIP channel driver that wants to connect
to IvozProvider.


\paragraph{Device register}
\label{administration_portal/client/residential/residential_devices:device-register}
If the system can not be directly access, Asterisk will have to register in the
platform (like a terminal will do).

Configuration will be something like this:

\begin{Verbatim}[commandchars=\\\{\}]
register =\PYGZgt{} residentialDeviceName:residentialDevicePassword@ivozprovider\PYGZhy{}brand.sip\PYGZhy{}domain.com
\end{Verbatim}


\paragraph{Device peer}
\label{administration_portal/client/residential/residential_devices:device-peer}
\begin{Verbatim}[commandchars=\\\{\}]
[residentialDeviceName]
type=peer
host=ivozprovider\PYGZhy{}brand.sip\PYGZhy{}domain.com
context=XXXXXX
disallow=all
allow=alaw
defaultuser=residentialDeviceName
secret=residentialDevicePassword
fromuser=residentialDeviceName
fromdomain=ivozprovider\PYGZhy{}brand.sip\PYGZhy{}domain.com
insecure=port,invite
sendrpid=pai
directmedia=no
\end{Verbatim}

\begin{notice}{warning}{Warning:}
\emph{Residential devices} MUST NOT challenge IvozProvider. That's
why the \emph{insecure} setting is used here.
\end{notice}

\begin{notice}{note}{Note:}
As From username is used to identify the residential device, P-Asserted-Identity (or P-Preferred-Identity or Remote-Party-Id) must be used to specify caller number.
Prevalence among these source headers is: PAI \textgreater{} PPI \textgreater{} RPID.
\end{notice}


\subsection{DDIs}
\label{administration_portal/client/residential/ddis:ddis}\label{administration_portal/client/residential/ddis:residential-ddis}\label{administration_portal/client/residential/ddis::doc}
DDIs are the external entry point from DDI Providers to Residential Clients that
can be routed through Residential Devices.

We can assign an {\hyperref[administration_portal/client/vpbx/routing_tools/external_call_filters:external\string-call\string-filters]{\sphinxcrossref{\DUrole{std,std-ref}{External call filters}}}}. Contrary to vPBX External Call filters, Residential DDIs
filters only allow static redirection to another external number.


\subsubsection{Residential DDI routes}
\label{administration_portal/client/residential/ddis:residential-ddi-routes}
Residential DDIs can only be routed to a {\hyperref[administration_portal/client/residential/residential_devices:residential\string-devices]{\sphinxcrossref{\DUrole{std,std-ref}{Residential Devices}}}}
or {\hyperref[administration_portal/client/vpbx/faxes:faxing\string-system]{\sphinxcrossref{\DUrole{std,std-ref}{Virtual Fax}}}}.

\begin{notice}{hint}{Hint:}
Routing a DDI through a Residential device will allow to place external calls
from that device presenting that DDI as origin.
\end{notice}


\subsubsection{Residential Recordings}
\label{administration_portal/client/residential/ddis:residential-recordings}
If Residential Client has \emph{Recordings} feature enabled, DDIs can also record incoming and/or
outgoing calls.


\subsection{External call filters}
\label{administration_portal/client/residential/external_call_filters:external-call-filters}\label{administration_portal/client/residential/external_call_filters:residential-filters}\label{administration_portal/client/residential/external_call_filters::doc}
Residential External Filters can be assigned to DDIs to temporary
forward calls to an external number or to avoid call from undesirable sources.


\subsubsection{Filters Configuration}
\label{administration_portal/client/residential/external_call_filters:filters-configuration}
This are the configurable settings of \emph{Residential external filters}:
\begin{quote}
\begin{description}
\item[{Name}] \leavevmode
Name of the filter.

\item[{Black list}] \leavevmode
External origin will be checked against the associated {\hyperref[administration_portal/client/vpbx/routing_tools/match_lists:match\string-lists]{\sphinxcrossref{\DUrole{std,std-ref}{Match Lists}}}},
if a coincidence is found, the call will be rejected immediately.

\item[{Unconditional Call Forward}] \leavevmode
Calls to DDIs using this filter will be forwarded to given external number.

\end{description}
\end{quote}

\begin{notice}{tip}{Tip:}
Blacklisting has precedence over unconditional call forward. Calls from numbers
matching associated matchlist won't be forwarded, they will be rejected.
\end{notice}

\begin{notice}{attention}{Attention:}
Calls forwarded by a filter will keep the original
caller identification, adding the forwarding info in a SIP
\emph{Diversion} header.
\end{notice}


\subsection{Residential Voicemails}
\label{administration_portal/client/residential/residential_voicemails:residential-voicemails}\label{administration_portal/client/residential/residential_voicemails::doc}\label{administration_portal/client/residential/residential_voicemails:id1}
Voicemail most notable fields are:
\begin{quote}
\begin{description}
\item[{Enabled}] \leavevmode
Enables or disables voicemail.

\item[{Name}] \leavevmode
Residential Device name owner of this voicemail.

\item[{Locution}] \leavevmode
If set, this locution is played as voicemail welcome message when a voicemail
for this voicemail is going to be recorded. This only applies for call forwards
to voicemail.

\item[{Email address}] \leavevmode
Send an email to the configured user address when a new voicemail is received.

\item[{Attach sounds:}] \leavevmode
Attach the audio message to the sent email.

\end{description}
\end{quote}

\begin{notice}{note}{Note:}
If voicemail locution is not assigned, default locution will be used as long as
the owner has not recorded a custom message through the voicemail menu (calling to
voicemail service code).
\end{notice}


\subsection{Faxes}
\label{administration_portal/client/residential/faxes:faxes}\label{administration_portal/client/residential/faxes::doc}
IvozProvider includes a simple but efficient \emph{virtual faxing} solution that allows:
\begin{itemize}
\item {} 
Sending PDF files via Fax.

\item {} 
Receiving faxes through email or check them through the web portal.

\end{itemize}

\begin{notice}{error}{Error:}
IvozProvider uses
\href{http://www.voip-info.org/wiki/view/T.38}{T.38} for both sending and receiving
faxes. Brand Operator must use \emph{peering contracts} that have support for it.
\end{notice}


\subsubsection{Creating a virtual fax}
\label{administration_portal/client/residential/faxes:creating-a-virtual-fax}
These are the fields that turn up when we create a new fax:
\begin{quote}
\begin{description}
\item[{Name}] \leavevmode
Used by remaining section to reference a fax

\item[{Email}] \leavevmode
Email address when we want to receive incoming faxes (if we check `Send
by email')

\item[{Outbound DDI}] \leavevmode
DDI used as source number for outgoing faxes

\end{description}
\end{quote}

To receive faxes in this DDI, we need to point it to our new fax in the section
\textbf{DDIs}.

Brand Operator can choose one or more {\hyperref[administration_portal/brand/routing/outgoing_routings:outgoing\string-routings]{\sphinxcrossref{\DUrole{std,std-ref}{Outgoing Routings}}}} for sending faxes.

\begin{notice}{note}{Note:}
\emph{load-balancing} y \emph{failover} logics described in {\hyperref[administration_portal/brand/routing/outgoing_routings:outgoing\string-routings]{\sphinxcrossref{\DUrole{std,std-ref}{Outgoing Routings}}}}
apply to faxes too.
\end{notice}

\begin{notice}{important}{Important:}
If no fax-specific route is defined, faxes will be routed using
standard call routes.
\end{notice}


\subsubsection{Sending a fax}
\label{administration_portal/client/residential/faxes:sending-a-fax}
Sending a fax is an easy task that is done through \textbf{List of outgoing faxfiles} subsection.

First, we upload de PDF file and set the destination. When we save the entry, the list shows the fax and its status.


\subsubsection{Incoming faxes display}
\label{administration_portal/client/residential/faxes:incoming-faxes-display}
Apart from being received by mail, faxes can be watched and downloaded within
the web portal too in \textbf{List of incoming faxfiles} subsection.


\subsection{Rating profiles}
\label{administration_portal/client/residential/rating_profiles:rating-profiles}\label{administration_portal/client/residential/rating_profiles::doc}
This section allows the client to:
\begin{itemize}
\item {} 
See the list of rating plans and their activation time.

\item {} 
Check available routing tags (only for retail and wholesale clients) to reach different destinations.

\item {} 
Simulate a call and guess the cost of a given call.

\end{itemize}

\begin{notice}{note}{Note:}
This section is only shown to clients with \emph{Display billing details to client} set to Yes.
\end{notice}


\subsection{Calls}
\label{administration_portal/client/residential/calls/index::doc}\label{administration_portal/client/residential/calls/index:calls}
These are the call-list sections for residential clients:


\subsubsection{Active calls}
\label{administration_portal/client/residential/calls/active_calls::doc}\label{administration_portal/client/residential/calls/active_calls:active-calls}
This section allows client administrator view \textbf{current active calls}.

\begin{notice}{warning}{Warning:}
\textbf{Calls involving any user, friend, retail account, residential device or wholesale client will be shown},
no matter they are internal or external.
\end{notice}

These are columns shown:
\begin{quote}
\begin{description}
\item[{Duration}] \leavevmode
Show call establishment duration during establishment and call duration during ongoing call. It also shows
direction (inbound/outbound) and call state information, as explained {\hyperref[administration_portal/platform/active_calls:call\string-state]{\sphinxcrossref{\DUrole{std,std-ref}{here}}}}.

\item[{Owner}] \leavevmode
User, friend, retail account, residential device or wholesale client involved in given call.

\item[{Party}] \leavevmode
Remaining participant of given call. It gets updated to show current party (in transfers and diverted calls).

\end{description}
\end{quote}

\begin{notice}{note}{Note:}
There will be one entry per entity involved. This means that a standard internal call will be shown
in two different rows: one outbound call for calling user and one inbound call for called user.
\end{notice}


\subsubsection{External calls}
\label{administration_portal/client/residential/calls/external_calls::doc}\label{administration_portal/client/residential/calls/external_calls:external-calls}
\textbf{External calls} section lists \textbf{both inbound and outbound external calls}.

This section is shown at different levels:
\begin{itemize}
\item {} 
Main level (god level)

\item {} 
Brand level (filtered for emulated/logged brand).

\item {} 
Client level (filtered for emulated/logged client).

\end{itemize}

Each entry shows this information:
\begin{quote}
\begin{description}
\item[{Start time}] \leavevmode
Date and time of the call establishment.

\item[{Brand}] \leavevmode
Only visible for \emph{god}, shows the brand of each call.

\item[{Client}] \leavevmode
Visible for \emph{god} and \emph{brand operator}, shows the client of each call.

\item[{Caller}] \leavevmode
DDI presented for the outgoing call.

\item[{Callee}] \leavevmode
External number dialed.

\item[{Duration}] \leavevmode
Shows how long the call lasted.

\item[{Price}] \leavevmode
The money amount for the client. Visible for \emph{god} and \emph{brand operator} and \emph{Client administrator} if
\emph{Display billing details to client} is enabled.

\item[{Cost}] \leavevmode
Visible for \emph{god} and \emph{brand operator}, the money amount for the brand (the money that the carrier will bill for the call).

\item[{Rating Plan}] \leavevmode
Rating plan used to set price for the call. Visible for \emph{god} and \emph{brand operator} and \emph{Client administrator} if
\emph{Display billing details to client} is enabled.

\item[{Destination}] \leavevmode
Destination that matched the call for billing. Visible for \emph{god} and \emph{brand operator} and \emph{Client administrator} if
\emph{Display billing details to client} is enabled.

\item[{Carrier}] \leavevmode
Visible for \emph{god} and \emph{brand operator}, shows which {\hyperref[administration_portal/brand/providers/carriers:carriers]{\sphinxcrossref{\DUrole{std,std-ref}{Carrier}}}} was used for each outbound call.

\item[{DDI Provider}] \leavevmode
Visible for \emph{god} and \emph{brand operator}, shows which {\hyperref[administration_portal/brand/providers/ddi_providers:ddi\string-providers]{\sphinxcrossref{\DUrole{std,std-ref}{DDI Provider}}}} was used for each inbound call.

\item[{Invoice}] \leavevmode
Visible for \emph{god} and \emph{brand operator}, shows if a call is already included in any {\hyperref[administration_portal/brand/invoicing/invoices:invoices]{\sphinxcrossref{\DUrole{std,std-ref}{Invoice}}}}.

\item[{Call ID}] \leavevmode
Shows the call ID of the call for troubleshooting and CSV export.

\item[{Endpoint Type}] \leavevmode
Possible values: RetailAccount, ResidentialDevice, User, Fax, Friend.

\item[{Endpoint Id}] \leavevmode
Internal ID of specific endpoint (only when \emph{endpointType} is non-empty).

\item[{Endpoint Name}] \leavevmode
User extension, friend name, fax name, retail account name or residential device name (only when \emph{endpointId} is non-empty).

\end{description}
\end{quote}

\begin{notice}{note}{Note:}
An asynchronous process parses each external call and adds it to this list a few minutes after call hangup. Billing related fields, such as cost and price, will be empty for external incoming calls.
\end{notice}


\paragraph{Call rerating}
\label{administration_portal/client/residential/calls/external_calls:call-rerating}
At \textbf{brand level}, there is an additional available operation for outbound calls: \textbf{Rerate call}. This option allows calling rating engine again for a call or a bunch of calls.

Notes about this rerating process:
\begin{itemize}
\item {} 
If a call is in an invoice, it cannot be rerated. Invoice must be deleted first.

\item {} 
Call will be rerated with the \emph{Start time} of the call (no with current active rating plans, but with active rating plans
on the moment of the call).

\item {} 
Both \emph{Price} and \emph{Cost} will be recalculated. This may imply updating \emph{rating plan} and \emph{destination} too.

\end{itemize}

\begin{notice}{tip}{Tip:}
When a call is rerated, cost and price are emptied until the next iteration of the asynchronous task.
\end{notice}


\subsubsection{Call CSV schedulers}
\label{administration_portal/client/residential/calls/call_csv_schedulers:call-csv-schedulers}\label{administration_portal/client/residential/calls/call_csv_schedulers::doc}
This section allows programming automatic periodical CSV reports to residential client administrators.

\begin{notice}{note}{Note:}
This section is almost identical to {\hyperref[administration_portal/brand/invoicing/invoice_schedulers:invoice\string-schedulers]{\sphinxcrossref{\DUrole{std,std-ref}{Invoice schedulers}}}} except to the
fields that do not apply to CSVs (Invoice number sequence, Tax rate...)
\end{notice}

When adding a new definition, these fields are shown:
\begin{quote}
\begin{description}
\item[{Name}] \leavevmode
Name of the scheduled Call CSV

\item[{Email}] \leavevmode
Send generated Call CSV via email. Empty if no automatic mail is wanted.

\item[{Frequency/Unit}] \leavevmode
Defines the frequency (once a month, every 7 days, etc.) of the programmed task

\item[{Direction}] \leavevmode
Defines which calls should be included attending to its direction (inbound, outbound, both).

\item[{DDI}] \leavevmode
Allows selecting client's one specific DDI.

\item[{Endpoint type}] \leavevmode
Allows selecting one specific endpoint type between: residential device and fax.

\item[{Residential device}] \leavevmode
Only for \emph{Endpoint type: residential}, allows selecting one specific residential device.

\item[{Fax}] \leavevmode
Only for \emph{Endpoint type: fax}, allows selecting one specific fax.

\end{description}
\end{quote}

Once created, some new fields and subsections are accesible:
\begin{quote}
\begin{description}
\item[{Next execution}] \leavevmode
Shows next execution date

\item[{Last execution}] \leavevmode
Shows last execution and its result.

\end{description}
\end{quote}

\begin{notice}{tip}{Tip:}
Modifying \emph{Next execution} value allows forcing specific runs. For example, setting \emph{Next execution} to
current month's first day will create again last month's CSV report (for a monthly scheduler).
\end{notice}

Generated CSVs of each scheduler can be accessed in \textbf{List of Call CSV reports} subsection.


\paragraph{CSV fields}
\label{administration_portal/client/residential/calls/call_csv_schedulers:csv-fields}
These are the fields of the generated CSV files:
\begin{quote}
\begin{description}
\item[{callid}] \leavevmode
Call-ID of the SIP dialog

\item[{startTime}] \leavevmode
Time and date of the call establishment

\item[{duration}] \leavevmode
Call duration in seconds

\item[{caller}] \leavevmode
Caller number in E.164 format (with `+')

\item[{callee}] \leavevmode
Callee number in E.164 format (with `+')

\item[{price}] \leavevmode
Calculated price for the given call (empty if \emph{Display billing details to client} is disabled)

\item[{direction}] \leavevmode
Possible values: inbound, outbound.

\item[{ddiId}] \leavevmode
Client DDI to which call will be assigned (callee for inbound calls, caller for outbound calls).

\item[{endpointType}] \leavevmode
Possible values: ResidentialDevice, Fax.

\item[{endpointId}] \leavevmode
Internal ID of specific residential device

\item[{endpointName}] \leavevmode
Residential device name or fax name

\end{description}
\end{quote}


\subsubsection{Call recordings}
\label{administration_portal/client/residential/calls/call_recordings::doc}\label{administration_portal/client/residential/calls/call_recordings:call-recordings}
\begin{notice}{attention}{Attention:}
Beware that local legislation may enforce to announce that the
call is being recorded (sometimes to both parties). You should include
a recording disclaimer in your welcome locutions for DDIs with automatic
recording enabled.
\end{notice}

IvozProvider supports two different ways of recording calls:
\begin{itemize}
\item {} 
\textbf{Automatic recordings} for the incoming/outgoing calls that use a
{\hyperref[administration_portal/brand/views/ddis:ddis]{\sphinxcrossref{\DUrole{std,std-ref}{External DDI}}}}.

\item {} 
\textbf{On demand recordings} requested by a user during a call.

\end{itemize}


\paragraph{Automatic DDI recordings}
\label{administration_portal/client/residential/calls/call_recordings:automatic-ddi-recordings}
In this type of recording, \textbf{the whole conversation will be recorded}: from
the start until it finishes.

Two different scenarios:
\begin{itemize}
\item {} 
\textbf{Incoming calls to a DDI}: The call will continue until the external
dialer hangups (no matter whom is talking to).

\item {} 
\textbf{Outgoing calls using a DDI} as {\hyperref[administration_portal/brand/views/ddis:ddis]{\sphinxcrossref{\DUrole{std,std-ref}{Outgoing DDI}}}}: the
recording will continue as long as the external destination keeps in the
conversation.

\end{itemize}

\begin{notice}{attention}{Attention:}
Take into account that the call will be recorded while the
external entity is present, even it the call is being transferred between
multiple users of the platform.
\end{notice}
\paragraph{Record all the calls of a DDI}

To enable this feature, edit the DDI and configure the field under the section
recording data:

There are 4 available options:
\begin{itemize}
\item {} 
Disable recordings

\item {} 
Enable incoming recordings

\item {} 
Enable outgoing recordings

\item {} 
Enable all call recordings

\end{itemize}


\paragraph{On demand recordings}
\label{administration_portal/client/residential/calls/call_recordings:on-demand-recordings}
The \emph{on-demand} recordings must be enabled by the \emph{brand administrator} for the
clients that request it. This can be done in the client edit screen:

\begin{notice}{warning}{Warning:}
Contrary to the {\hyperref[administration_portal/client/vpbx/services:services]{\sphinxcrossref{\DUrole{std,std-ref}{Services}}}} mentioned in the
previous section, the on demand record are activated within a conversation.
\end{notice}

Contrary to automatic ones, on demand recording can be stopped using the same
process that started them.


\subparagraph{Activated using the \emph{Record} key}
\label{administration_portal/client/residential/calls/call_recordings:activated-using-the-record-key}
Some terminals (for example, \emph{Yealink}) support sending a \href{https://tools.ietf.org/html/rfc6086}{SIP INFO} message during the conversation with a
special \emph{Record} header (see \href{http://www.yealink.com/Upload/document/UsingCallRecordingFeatureonYealinkPhones/UsingCallRecordingFeatureonYealinkSIPT2XPphonesRev\_610-20561729764.pdf}{reference}).
This is not a standard for the protocol, but being Yealink one of the supported
manufacturers of the solution, we include this kind of on-demand recording.

\begin{notice}{important}{Important:}
For this recording requests, the configured code doesn't matter
but the client still must have on demand records enabled.
\end{notice}

To start or stop this kind of recordings, just press the Record key in the
terminal and the system will handle the sent message.


\subparagraph{Activated using \emph{DTMF} codes}
\label{administration_portal/client/residential/calls/call_recordings:activated-using-dtmf-codes}
The more traditional approach for this feature is to press a combination of
keys during the call. Some notification will be played and the recording will
start or stop. This combination is sent to the system using \href{https://es.wikipedia.org/wiki/Marcaci\%C3\%B3n\_por\_tonos}{DTMF tones} using the same audio
stream that the conversation (as mentioned in \href{https://tools.ietf.org/html/rfc4733}{RFC 4733}).

IvozProvider supports this kind of on demand record activation but with an
important downside. In order to capture this codes, the pbx must process each
audio packet to detect the code, avoiding the direct flow of media between the
final endpoints.

\begin{notice}{important}{Important:}
Enabling this record mode highly affects the performance of the
platform. Use at your own risk.
\end{notice}


\paragraph{Recordings list}
\label{administration_portal/client/residential/calls/call_recordings:recordings-list}
The \emph{client administrator} can access to all the recordings in the section
\textbf{Client configuration} \textgreater{} \textbf{Calls} \textgreater{} \textbf{Call recordings}:
\begin{itemize}
\item {} 
Recordings can be heard from the \emph{web} or downloaded in MP3 format.

\item {} 
If the recording has been started on demand, it will also include the user
that requested it.

\end{itemize}

\begin{notice}{tip}{Tip:}
Recording removal button is shown only if \textbf{Allow Client to remove recordings} is enabled
for the client in \emph{Client configuration}.
\end{notice}

\begin{notice}{tip}{Tip:}
Check {\hyperref[administration_portal/brand/clients/retail:differences\string-between\string-retail\string-and\string-residential\string-clients]{\sphinxcrossref{\DUrole{std,std-ref}{Differences between retail and residential clients}}}} to understand the difference between these two
client types.
\end{notice}
\phantomsection\label{administration_portal/client/retail/index:retail-clients}

\section{Retail Clients}
\label{administration_portal/client/retail/index:retail-clients}\label{administration_portal/client/retail/index:clientes-retail}\label{administration_portal/client/retail/index::doc}\label{administration_portal/client/retail/index:id1}
Retail clients are a special type of client that only provides a connectivity
service with carriers through retail accounts.

\begin{notice}{attention}{Attention:}
Contrary to the Virtual PBX clients, all Retail clients use the
brand domain to unequivocally identify their accounts. You'll need to configure
Brand's domain to use this feature.
\end{notice}

\begin{notice}{hint}{Hint:}
Retail clients can be enabled per Brand basis via Features.
\end{notice}

The goal of this section will be describe each of the configuration settings
associated with Retail clients included in IvozProvider:


\subsection{Retail Accounts}
\label{administration_portal/client/retail/retail_accounts::doc}\label{administration_portal/client/retail/retail_accounts:retail-accounts}\label{administration_portal/client/retail/retail_accounts:id1}
Retail Accounts are the main routable option in Retail clients.
More or less like {\hyperref[administration_portal/client/vpbx/routing_endpoints/friends/index:friends]{\sphinxcrossref{\DUrole{std,std-ref}{Friends}}}} are to Virtual PBX Clients, devices
contain the required configurable options to provide a SIP connectivity
service with IvozProvider and an external SIP entity.

\begin{notice}{warning}{Warning:}
Although both \textbf{Carriers/DDI Providers} and \textbf{Retail Accounts} are defined by the
\textbf{brand operator}, the former are designed to connect with the public switched telephony network
while the latter connects the system with our clients' SIP entities.
\end{notice}


\subsubsection{Types of retail accounts}
\label{administration_portal/client/retail/retail_accounts:types-of-retail-accounts}
There are 2 main types of SIP endpoints that can use retail with IvozProvider:
\begin{itemize}
\item {} 
\textbf{Direct connection endpoint}: IvozProvider must be able to talk SIP directly with
this kind of devices by just forwarding the traffic to the proper port of
the public IP address of the PBX.

\item {} 
\textbf{Endpoint behind NAT}: Not directly reachable. This kind of endpoint must register at
IvozProvider (just like all the {\hyperref[administration_portal/client/vpbx/terminals:terminals]{\sphinxcrossref{\DUrole{std,std-ref}{Terminals}}}} do).

\end{itemize}


\subsubsection{What kind of calls can be routed through a \emph{Retail Account}?}
\label{administration_portal/client/retail/retail_accounts:what-kind-of-calls-can-be-routed-through-a-retail-account}
Contrary to Friends, \textbf{Retail Accounts} have some simplifications and limitations:
\begin{itemize}
\item {} 
Retail Accounts only route their assigned DDIs

\item {} 
Retail Accounts only place externals calls to Carriers

\item {} 
Retail Accounts only receive external calls from DDI Providers

\end{itemize}


\subsubsection{Retail Accounts Configuration}
\label{administration_portal/client/retail/retail_accounts:retail-accounts-configuration}
These are the configurable settings of \emph{Retail accounts}:
\begin{quote}
\begin{description}
\item[{Name}] \leavevmode
Name of the \textbf{retail account}. This name must be unique in the whole brand so
it's recommended to use some kind of sequential identifier. This will also be used
in SIP messages (sent \textbf{From User}).

\item[{Description}] \leavevmode
Optional. Extra information for this \emph{retail account}.

\item[{Password}] \leavevmode
When the \emph{retail account} send requests, IvozProvider will authenticate it using
this password. \textbf{Using password IS A MUST in ``Register'' mode}. In ``Direct'' mode,
leaving it blank disables SIP authentication and enables IP source check.

\item[{Direct connectivity}] \leavevmode
If you choose `Yes' here, you'll have to fill the protocol, address and
port where this \emph{retail account} can be contacted.

\item[{Numeric transformation}] \leavevmode
Numeric transformation set that will be applied when communicating with this device.

\item[{Fallback Outgoing DDI}] \leavevmode
External calls from this \emph{retail account} will be presented with this DDI, \textbf{unless
the source presented matches a DDI belonging to the retail client}.

\item[{From domain}] \leavevmode
Request from IvozProvider to this account will include this domain in
the From header.

\item[{DDI In}] \leavevmode
If set to `Yes', set destination (R-URI and To) to called DDI when calling to this endpoint. If set `No', username
used in Contact header of registration will be used, as specified in SIP RFC (retail account name will be used for
endpoints with direct connectivity). Defaults to `Yes'.

\item[{Enable T.38 passthrough}] \leavevmode
If set to `yes', this SIP endpoint must be a \textbf{T.38 capable fax sender/receiver}. IvozProvider
will act as a T.38 gateway, bridging fax-calls of a T.38 capable carrier and a T.38 capable device.

\item[{RTP Encryption}] \leavevmode
If set to `yes', call won't be established unless it's possible to encryption its audio. If set to `no',
audio won't be encrypted.

\item[{Multi Contact}] \leavevmode
Same SIP credentials can be configured in multiple SIP devices. In that case, all devices ring
simultaneously when receiving a call. Setting this toggle to `No' limits this behaviour so that
only latest registered SIP device rings.

\end{description}
\end{quote}

\begin{notice}{warning}{Warning:}
All retail accounts within a retail client will have the transcoding capabilities configured at client level.
\end{notice}

\begin{notice}{tip}{Tip:}
On retail account edit screen \textbf{id} field shows internal identification number assigned to the retail account.
This id is transported to \emph{Endpoint Id} field in \emph{External Calls} section for CSV export.
\end{notice}

\begin{notice}{tip}{Tip:}
Retail account can be contacted due to calls to several DDIs. \emph{DDI In} setting allows remote SIP endpoint to
know which number caused each call, setting that number as destination (R-URI and To headers). This way, retail
account can handle calls differently.
\end{notice}


\subsubsection{Voicemail settings}
\label{administration_portal/client/retail/retail_accounts:voicemail-settings}
There is no voicemail service for retail clients.


\subsubsection{Call forwarding settings}
\label{administration_portal/client/retail/retail_accounts:call-forwarding-settings}
There are 2 types of call forward settings for retail accounts:
\begin{itemize}
\item {} 
Unconditional call forward.

\item {} 
Unreachable call forward.

\end{itemize}

You can point both types to 2 different destination:
\begin{itemize}
\item {} 
An external number.

\item {} 
Another retail account within the same retail client.

\end{itemize}

Unreachable call forward will be executed whenever the retail account cannot be reached:
\begin{itemize}
\item {} 
Direct connectivity accounts: when no answer is received from defined address.

\item {} 
Accounts using SIP register: when no answer is received from last contact address or when no active register is found.

\end{itemize}

You can also add called DDI as call-forward criteria, making it apply only when a certain DDI is called. These call-forward
settings have precedence over call-forward with no DDI selected (Any DDI).

\begin{notice}{tip}{Tip:}
Unconditional call forward has precedence over unreacheable call forward.
\end{notice}

\begin{notice}{warning}{Warning:}
Retail accounts marked as T.38 won't have any call forward settings.
\end{notice}


\subsubsection{Asterisk as a retail account}
\label{administration_portal/client/retail/retail_accounts:asterisk-as-a-retail-account}
At the other end of a account can be any kind of SIP entity. This section takes
as example an Asterisk PBX system using SIP channel driver that wants to connect
to IvozProvider.


\paragraph{Account register}
\label{administration_portal/client/retail/retail_accounts:account-register}
If the system can not be directly access, Asterisk will have to register in the
platform (like a terminal will do).

Configuration will be something like this:

\begin{Verbatim}[commandchars=\\\{\}]
register =\PYGZgt{} retailAccountName:retailAccountPassword@ivozprovider\PYGZhy{}brand.sip\PYGZhy{}domain.com
\end{Verbatim}


\paragraph{Account peer}
\label{administration_portal/client/retail/retail_accounts:account-peer}
\begin{Verbatim}[commandchars=\\\{\}]
[retailAccountName]
type=peer
host=ivozprovider\PYGZhy{}brand.sip\PYGZhy{}domain.com
context=XXXXXX
disallow=all
allow=alaw
defaultuser=retailAccountName
secret=retailAccountPassword
fromuser=retailAccountName
fromdomain=ivozprovider\PYGZhy{}brand.sip\PYGZhy{}domain.com
insecure=port,invite
sendrpid=pai
directmedia=no
\end{Verbatim}

\begin{notice}{warning}{Warning:}
\emph{Retail accounts} MUST NOT challenge IvozProvider. That's
why the \emph{insecure} setting is used here.
\end{notice}

\begin{notice}{note}{Note:}
As From username is used to identify the retail account, P-Asserted-Identity (or P-Preferred-Identity or Remote-Party-Id) must be used to specify caller number.
Prevalence among these source headers is: PAI \textgreater{} PPI \textgreater{} RPID.
\end{notice}


\subsection{DDIs}
\label{administration_portal/client/retail/ddis:ddis}\label{administration_portal/client/retail/ddis::doc}\label{administration_portal/client/retail/ddis:retail-ddis}
DDIs are the external entry point from DDI Providers to Retail Clients that
can be routed through Retail Accounts.

\begin{notice}{note}{Note:}
No call-forwarding feature with external call filters in retail clients.
\end{notice}


\subsubsection{Retail DDI routes}
\label{administration_portal/client/retail/ddis:retail-ddi-routes}
Retail DDIs can only be routed to a {\hyperref[administration_portal/client/retail/retail_accounts:retail\string-accounts]{\sphinxcrossref{\DUrole{std,std-ref}{Retail Accounts}}}}

\begin{notice}{hint}{Hint:}
Routing a DDI through a Retail account will allow to place external calls
from that account presenting that DDI as origin.
\end{notice}


\subsubsection{Retail Recordings}
\label{administration_portal/client/retail/ddis:retail-recordings}
If Retail Client has \emph{Recordings} feature enabled, DDIs can also record incoming and/or
outgoing calls.


\subsection{Rating profiles}
\label{administration_portal/client/retail/rating_profiles:rating-profiles}\label{administration_portal/client/retail/rating_profiles::doc}
This section allows the client to:
\begin{itemize}
\item {} 
See the list of rating plans and their activation time.

\item {} 
Check available routing tags (only for retail and wholesale clients) to reach different destinations.

\item {} 
Simulate a call and guess the cost of a given call.

\end{itemize}

\begin{notice}{note}{Note:}
This section is only shown to clients with \emph{Display billing details to client} set to Yes.
\end{notice}


\subsection{Calls}
\label{administration_portal/client/retail/calls/index::doc}\label{administration_portal/client/retail/calls/index:calls}
These are the call-list sections for retail clients:


\subsubsection{Active calls}
\label{administration_portal/client/retail/calls/active_calls::doc}\label{administration_portal/client/retail/calls/active_calls:active-calls}
This section allows client administrator view \textbf{current active calls}.

\begin{notice}{warning}{Warning:}
\textbf{Calls involving any user, friend, retail account, residential device or wholesale client will be shown},
no matter they are internal or external.
\end{notice}

These are columns shown:
\begin{quote}
\begin{description}
\item[{Duration}] \leavevmode
Show call establishment duration during establishment and call duration during ongoing call. It also shows
direction (inbound/outbound) and call state information, as explained {\hyperref[administration_portal/platform/active_calls:call\string-state]{\sphinxcrossref{\DUrole{std,std-ref}{here}}}}.

\item[{Owner}] \leavevmode
User, friend, retail account, residential device or wholesale client involved in given call.

\item[{Party}] \leavevmode
Remaining participant of given call. It gets updated to show current party (in transfers and diverted calls).

\end{description}
\end{quote}

\begin{notice}{note}{Note:}
There will be one entry per entity involved. This means that a standard internal call will be shown
in two different rows: one outbound call for calling user and one inbound call for called user.
\end{notice}


\subsubsection{External calls}
\label{administration_portal/client/retail/calls/external_calls::doc}\label{administration_portal/client/retail/calls/external_calls:external-calls}
\textbf{External calls} section lists \textbf{both inbound and outbound external calls}.

This section is shown at different levels:
\begin{itemize}
\item {} 
Main level (god level)

\item {} 
Brand level (filtered for emulated/logged brand).

\item {} 
Client level (filtered for emulated/logged client).

\end{itemize}

Each entry shows this information:
\begin{quote}
\begin{description}
\item[{Start time}] \leavevmode
Date and time of the call establishment.

\item[{Brand}] \leavevmode
Only visible for \emph{god}, shows the brand of each call.

\item[{Client}] \leavevmode
Visible for \emph{god} and \emph{brand operator}, shows the client of each call.

\item[{Caller}] \leavevmode
DDI presented for the outgoing call.

\item[{Callee}] \leavevmode
External number dialed.

\item[{Duration}] \leavevmode
Shows how long the call lasted.

\item[{Price}] \leavevmode
The money amount for the client. Visible for \emph{god} and \emph{brand operator} and \emph{Client administrator} if
\emph{Display billing details to client} is enabled.

\item[{Cost}] \leavevmode
Visible for \emph{god} and \emph{brand operator}, the money amount for the brand (the money that the carrier will bill for the call).

\item[{Rating Plan}] \leavevmode
Rating plan used to set price for the call. Visible for \emph{god} and \emph{brand operator} and \emph{Client administrator} if
\emph{Display billing details to client} is enabled.

\item[{Destination}] \leavevmode
Destination that matched the call for billing. Visible for \emph{god} and \emph{brand operator} and \emph{Client administrator} if
\emph{Display billing details to client} is enabled.

\item[{Carrier}] \leavevmode
Visible for \emph{god} and \emph{brand operator}, shows which {\hyperref[administration_portal/brand/providers/carriers:carriers]{\sphinxcrossref{\DUrole{std,std-ref}{Carrier}}}} was used for each outbound call.

\item[{DDI Provider}] \leavevmode
Visible for \emph{god} and \emph{brand operator}, shows which {\hyperref[administration_portal/brand/providers/ddi_providers:ddi\string-providers]{\sphinxcrossref{\DUrole{std,std-ref}{DDI Provider}}}} was used for each inbound call.

\item[{Invoice}] \leavevmode
Visible for \emph{god} and \emph{brand operator}, shows if a call is already included in any {\hyperref[administration_portal/brand/invoicing/invoices:invoices]{\sphinxcrossref{\DUrole{std,std-ref}{Invoice}}}}.

\item[{Call ID}] \leavevmode
Shows the call ID of the call for troubleshooting and CSV export.

\item[{Endpoint Type}] \leavevmode
Possible values: RetailAccount, ResidentialDevice, User, Fax, Friend.

\item[{Endpoint Id}] \leavevmode
Internal ID of specific endpoint (only when \emph{endpointType} is non-empty).

\item[{Endpoint Name}] \leavevmode
User extension, friend name, fax name, retail account name or residential device name (only when \emph{endpointId} is non-empty).

\end{description}
\end{quote}

\begin{notice}{note}{Note:}
An asynchronous process parses each external call and adds it to this list a few minutes after call hangup. Billing related fields, such as cost and price, will be empty for external incoming calls.
\end{notice}


\paragraph{Call rerating}
\label{administration_portal/client/retail/calls/external_calls:call-rerating}
At \textbf{brand level}, there is an additional available operation for outbound calls: \textbf{Rerate call}. This option allows calling rating engine again for a call or a bunch of calls.

Notes about this rerating process:
\begin{itemize}
\item {} 
If a call is in an invoice, it cannot be rerated. Invoice must be deleted first.

\item {} 
Call will be rerated with the \emph{Start time} of the call (no with current active rating plans, but with active rating plans
on the moment of the call).

\item {} 
Both \emph{Price} and \emph{Cost} will be recalculated. This may imply updating \emph{rating plan} and \emph{destination} too.

\end{itemize}

\begin{notice}{tip}{Tip:}
When a call is rerated, cost and price are emptied until the next iteration of the asynchronous task.
\end{notice}


\subsubsection{Call CSV schedulers}
\label{administration_portal/client/retail/calls/call_csv_schedulers:call-csv-schedulers}\label{administration_portal/client/retail/calls/call_csv_schedulers::doc}
This section allows programming automatic periodical CSV reports to retail client administrators.

\begin{notice}{note}{Note:}
This section is almost identical to {\hyperref[administration_portal/brand/invoicing/invoice_schedulers:invoice\string-schedulers]{\sphinxcrossref{\DUrole{std,std-ref}{Invoice schedulers}}}} except to the
fields that do not apply to CSVs (Invoice number sequence, Tax rate...)
\end{notice}

When adding a new definition, these fields are shown:
\begin{quote}
\begin{description}
\item[{Name}] \leavevmode
Name of the scheduled Call CSV

\item[{Email}] \leavevmode
Send generated Call CSV via email. Empty if no automatic mail is wanted.

\item[{Frequency/Unit}] \leavevmode
Defines the frequency (once a month, every 7 days, etc.) of the programmed task

\item[{Direction}] \leavevmode
Defines which calls should be included attending to its direction (inbound, outbound, both).

\item[{DDI}] \leavevmode
Allows selecting client's one specific DDI.

\item[{Retail account}] \leavevmode
Allows selecting client's one specific retail account.

\end{description}
\end{quote}

Once created, some new fields and subsections are accesible:
\begin{quote}
\begin{description}
\item[{Next execution}] \leavevmode
Shows next execution date

\item[{Last execution}] \leavevmode
Shows last execution and its result.

\end{description}
\end{quote}

\begin{notice}{tip}{Tip:}
Modifying \emph{Next execution} value allows forcing specific runs. For example, setting \emph{Next execution} to
current month's first day will create again last month's CSV report (for a monthly scheduler).
\end{notice}

Generated CSVs of each scheduler can be accessed in \textbf{List of Call CSV reports} subsection.


\paragraph{CSV fields}
\label{administration_portal/client/retail/calls/call_csv_schedulers:csv-fields}
These are the fields of the generated CSV files:
\begin{quote}
\begin{description}
\item[{callid}] \leavevmode
Call-ID of the SIP dialog

\item[{startTime}] \leavevmode
Time and date of the call establishment

\item[{duration}] \leavevmode
Call duration in seconds

\item[{caller}] \leavevmode
Caller number in E.164 format (with `+')

\item[{callee}] \leavevmode
Callee number in E.164 format (with `+')

\item[{price}] \leavevmode
Calculated price for the given call (empty if \emph{Display billing details to client} is disabled)

\item[{direction}] \leavevmode
Possible values: inbound, outbound.

\item[{ddiId}] \leavevmode
Client DDI to which call will be assigned (callee for inbound calls, caller for outbound calls).

\item[{endpointType}] \leavevmode
Fixed value: RetailAccount

\item[{endpointId}] \leavevmode
Internal ID of specific retail account

\item[{endpointName}] \leavevmode
Retail account name

\end{description}
\end{quote}


\subsubsection{External calls}
\label{administration_portal/client/retail/calls/call_recordings::doc}\label{administration_portal/client/retail/calls/call_recordings:external-calls}
\textbf{External calls} section lists \textbf{both inbound and outbound external calls}.

This section is shown at different levels:
\begin{itemize}
\item {} 
Main level (god level)

\item {} 
Brand level (filtered for emulated/logged brand).

\item {} 
Client level (filtered for emulated/logged client).

\end{itemize}

Each entry shows this information:
\begin{quote}
\begin{description}
\item[{Start time}] \leavevmode
Date and time of the call establishment.

\item[{Brand}] \leavevmode
Only visible for \emph{god}, shows the brand of each call.

\item[{Client}] \leavevmode
Visible for \emph{god} and \emph{brand operator}, shows the client of each call.

\item[{Caller}] \leavevmode
DDI presented for the outgoing call.

\item[{Callee}] \leavevmode
External number dialed.

\item[{Duration}] \leavevmode
Shows how long the call lasted.

\item[{Price}] \leavevmode
The money amount for the client. Visible for \emph{god} and \emph{brand operator} and \emph{Client administrator} if
\emph{Display billing details to client} is enabled.

\item[{Cost}] \leavevmode
Visible for \emph{god} and \emph{brand operator}, the money amount for the brand (the money that the carrier will bill for the call).

\item[{Rating Plan}] \leavevmode
Rating plan used to set price for the call. Visible for \emph{god} and \emph{brand operator} and \emph{Client administrator} if
\emph{Display billing details to client} is enabled.

\item[{Destination}] \leavevmode
Destination that matched the call for billing. Visible for \emph{god} and \emph{brand operator} and \emph{Client administrator} if
\emph{Display billing details to client} is enabled.

\item[{Carrier}] \leavevmode
Visible for \emph{god} and \emph{brand operator}, shows which {\hyperref[administration_portal/brand/providers/carriers:carriers]{\sphinxcrossref{\DUrole{std,std-ref}{Carrier}}}} was used for each outbound call.

\item[{DDI Provider}] \leavevmode
Visible for \emph{god} and \emph{brand operator}, shows which {\hyperref[administration_portal/brand/providers/ddi_providers:ddi\string-providers]{\sphinxcrossref{\DUrole{std,std-ref}{DDI Provider}}}} was used for each inbound call.

\item[{Invoice}] \leavevmode
Visible for \emph{god} and \emph{brand operator}, shows if a call is already included in any {\hyperref[administration_portal/brand/invoicing/invoices:invoices]{\sphinxcrossref{\DUrole{std,std-ref}{Invoice}}}}.

\item[{Call ID}] \leavevmode
Shows the call ID of the call for troubleshooting and CSV export.

\item[{Endpoint Type}] \leavevmode
Possible values: RetailAccount, ResidentialDevice, User, Fax, Friend.

\item[{Endpoint Id}] \leavevmode
Internal ID of specific endpoint (only when \emph{endpointType} is non-empty).

\item[{Endpoint Name}] \leavevmode
User extension, friend name, fax name, retail account name or residential device name (only when \emph{endpointId} is non-empty).

\end{description}
\end{quote}

\begin{notice}{note}{Note:}
An asynchronous process parses each external call and adds it to this list a few minutes after call hangup. Billing related fields, such as cost and price, will be empty for external incoming calls.
\end{notice}


\paragraph{Call rerating}
\label{administration_portal/client/retail/calls/call_recordings:call-rerating}
At \textbf{brand level}, there is an additional available operation for outbound calls: \textbf{Rerate call}. This option allows calling rating engine again for a call or a bunch of calls.

Notes about this rerating process:
\begin{itemize}
\item {} 
If a call is in an invoice, it cannot be rerated. Invoice must be deleted first.

\item {} 
Call will be rerated with the \emph{Start time} of the call (no with current active rating plans, but with active rating plans
on the moment of the call).

\item {} 
Both \emph{Price} and \emph{Cost} will be recalculated. This may imply updating \emph{rating plan} and \emph{destination} too.

\end{itemize}

\begin{notice}{tip}{Tip:}
When a call is rerated, cost and price are emptied until the next iteration of the asynchronous task.
\end{notice}

\begin{notice}{tip}{Tip:}
Check {\hyperref[administration_portal/brand/clients/retail:differences\string-between\string-retail\string-and\string-residential\string-clients]{\sphinxcrossref{\DUrole{std,std-ref}{Differences between retail and residential clients}}}} to understand the difference between these two
client types.
\end{notice}
\phantomsection\label{administration_portal/client/wholesale/index:wholesale-clients}

\section{Wholesale clients}
\label{administration_portal/client/wholesale/index:clientes-wholesale}\label{administration_portal/client/wholesale/index:wholesale-clients}\label{administration_portal/client/wholesale/index::doc}\label{administration_portal/client/wholesale/index:id1}
Wholesale clients are the most lightweight client type in IvozProvider.

\begin{notice}{tip}{Tip:}
You can read the details about this client type {\hyperref[administration_portal/brand/clients/wholesale:wholesale\string-clients]{\sphinxcrossref{\DUrole{std,std-ref}{here}}}}.
\end{notice}

These sections will be covered for this client type:


\subsection{Rating profiles}
\label{administration_portal/client/wholesale/rating_profiles:rating-profiles}\label{administration_portal/client/wholesale/rating_profiles::doc}
This section allows the client to:
\begin{itemize}
\item {} 
See the list of rating plans and their activation time.

\item {} 
Check available routing tags (only for retail and wholesale clients) to reach different destinations.

\item {} 
Simulate a call and guess the cost of a given call.

\end{itemize}

\begin{notice}{note}{Note:}
This section is only shown to clients with \emph{Display billing details to client} set to Yes.
\end{notice}


\subsection{Calls}
\label{administration_portal/client/wholesale/calls/index::doc}\label{administration_portal/client/wholesale/calls/index:calls}
These are the call-list sections for wholesale clients:


\subsubsection{Active calls}
\label{administration_portal/client/wholesale/calls/active_calls::doc}\label{administration_portal/client/wholesale/calls/active_calls:active-calls}
This section allows client administrator view \textbf{current active calls}.

\begin{notice}{warning}{Warning:}
\textbf{Calls involving any user, friend, retail account, residential device or wholesale client will be shown},
no matter they are internal or external.
\end{notice}

These are columns shown:
\begin{quote}
\begin{description}
\item[{Duration}] \leavevmode
Show call establishment duration during establishment and call duration during ongoing call. It also shows
direction (inbound/outbound) and call state information, as explained {\hyperref[administration_portal/platform/active_calls:call\string-state]{\sphinxcrossref{\DUrole{std,std-ref}{here}}}}.

\item[{Owner}] \leavevmode
User, friend, retail account, residential device or wholesale client involved in given call.

\item[{Party}] \leavevmode
Remaining participant of given call. It gets updated to show current party (in transfers and diverted calls).

\end{description}
\end{quote}

\begin{notice}{note}{Note:}
There will be one entry per entity involved. This means that a standard internal call will be shown
in two different rows: one outbound call for calling user and one inbound call for called user.
\end{notice}


\subsubsection{External calls}
\label{administration_portal/client/wholesale/calls/external_calls::doc}\label{administration_portal/client/wholesale/calls/external_calls:external-calls}
\textbf{External calls} section lists \textbf{both inbound and outbound external calls}.

This section is shown at different levels:
\begin{itemize}
\item {} 
Main level (god level)

\item {} 
Brand level (filtered for emulated/logged brand).

\item {} 
Client level (filtered for emulated/logged client).

\end{itemize}

Each entry shows this information:
\begin{quote}
\begin{description}
\item[{Start time}] \leavevmode
Date and time of the call establishment.

\item[{Brand}] \leavevmode
Only visible for \emph{god}, shows the brand of each call.

\item[{Client}] \leavevmode
Visible for \emph{god} and \emph{brand operator}, shows the client of each call.

\item[{Caller}] \leavevmode
DDI presented for the outgoing call.

\item[{Callee}] \leavevmode
External number dialed.

\item[{Duration}] \leavevmode
Shows how long the call lasted.

\item[{Price}] \leavevmode
The money amount for the client. Visible for \emph{god} and \emph{brand operator} and \emph{Client administrator} if
\emph{Display billing details to client} is enabled.

\item[{Cost}] \leavevmode
Visible for \emph{god} and \emph{brand operator}, the money amount for the brand (the money that the carrier will bill for the call).

\item[{Rating Plan}] \leavevmode
Rating plan used to set price for the call. Visible for \emph{god} and \emph{brand operator} and \emph{Client administrator} if
\emph{Display billing details to client} is enabled.

\item[{Destination}] \leavevmode
Destination that matched the call for billing. Visible for \emph{god} and \emph{brand operator} and \emph{Client administrator} if
\emph{Display billing details to client} is enabled.

\item[{Carrier}] \leavevmode
Visible for \emph{god} and \emph{brand operator}, shows which {\hyperref[administration_portal/brand/providers/carriers:carriers]{\sphinxcrossref{\DUrole{std,std-ref}{Carrier}}}} was used for each outbound call.

\item[{DDI Provider}] \leavevmode
Visible for \emph{god} and \emph{brand operator}, shows which {\hyperref[administration_portal/brand/providers/ddi_providers:ddi\string-providers]{\sphinxcrossref{\DUrole{std,std-ref}{DDI Provider}}}} was used for each inbound call.

\item[{Invoice}] \leavevmode
Visible for \emph{god} and \emph{brand operator}, shows if a call is already included in any {\hyperref[administration_portal/brand/invoicing/invoices:invoices]{\sphinxcrossref{\DUrole{std,std-ref}{Invoice}}}}.

\item[{Call ID}] \leavevmode
Shows the call ID of the call for troubleshooting and CSV export.

\item[{Endpoint Type}] \leavevmode
Possible values: RetailAccount, ResidentialDevice, User, Fax, Friend.

\item[{Endpoint Id}] \leavevmode
Internal ID of specific endpoint (only when \emph{endpointType} is non-empty).

\item[{Endpoint Name}] \leavevmode
User extension, friend name, fax name, retail account name or residential device name (only when \emph{endpointId} is non-empty).

\end{description}
\end{quote}

\begin{notice}{note}{Note:}
An asynchronous process parses each external call and adds it to this list a few minutes after call hangup. Billing related fields, such as cost and price, will be empty for external incoming calls.
\end{notice}


\paragraph{Call rerating}
\label{administration_portal/client/wholesale/calls/external_calls:call-rerating}
At \textbf{brand level}, there is an additional available operation for outbound calls: \textbf{Rerate call}. This option allows calling rating engine again for a call or a bunch of calls.

Notes about this rerating process:
\begin{itemize}
\item {} 
If a call is in an invoice, it cannot be rerated. Invoice must be deleted first.

\item {} 
Call will be rerated with the \emph{Start time} of the call (no with current active rating plans, but with active rating plans
on the moment of the call).

\item {} 
Both \emph{Price} and \emph{Cost} will be recalculated. This may imply updating \emph{rating plan} and \emph{destination} too.

\end{itemize}

\begin{notice}{tip}{Tip:}
When a call is rerated, cost and price are emptied until the next iteration of the asynchronous task.
\end{notice}


\subsubsection{Call CSV schedulers}
\label{administration_portal/client/wholesale/calls/call_csv_schedulers:call-csv-schedulers}\label{administration_portal/client/wholesale/calls/call_csv_schedulers::doc}
This section allows programming automatic periodical CSV reports to wholesale client administrators.

\begin{notice}{note}{Note:}
This section is almost identical to {\hyperref[administration_portal/brand/invoicing/invoice_schedulers:invoice\string-schedulers]{\sphinxcrossref{\DUrole{std,std-ref}{Invoice schedulers}}}} except to the
fields that do not apply to CSVs (Invoice number sequence, Tax rate...)
\end{notice}

When adding a new definition, these fields are shown:
\begin{quote}
\begin{description}
\item[{Name}] \leavevmode
Name of the scheduled Call CSV

\item[{Email}] \leavevmode
Send generated Call CSV via email. Empty if no automatic mail is wanted.

\item[{Frequency/Unit}] \leavevmode
Defines the frequency (once a month, every 7 days, etc.) of the programmed task

\item[{Direction}] \leavevmode
Defines which calls should be included attending to its direction (inbound, outbound, both).

\end{description}
\end{quote}

Once created, some new fields and subsections are accesible:
\begin{quote}
\begin{description}
\item[{Next execution}] \leavevmode
Shows next execution date

\item[{Last execution}] \leavevmode
Shows last execution and its result.

\end{description}
\end{quote}

\begin{notice}{tip}{Tip:}
Modifying \emph{Next execution} value allows forcing specific runs. For example, setting \emph{Next execution} to
current month's first day will create again last month's CSV report (for a monthly scheduler).
\end{notice}

Generated CSVs of each scheduler can be accessed in \textbf{List of Call CSV reports} subsection.


\paragraph{CSV fields}
\label{administration_portal/client/wholesale/calls/call_csv_schedulers:csv-fields}
These are the fields of the generated CSV files:
\begin{quote}
\begin{description}
\item[{callid}] \leavevmode
Call-ID of the SIP dialog

\item[{startTime}] \leavevmode
Time and date of the call establishment

\item[{duration}] \leavevmode
Call duration in seconds

\item[{caller}] \leavevmode
Caller number in E.164 format (with `+')

\item[{callee}] \leavevmode
Callee number in E.164 format (with `+')

\item[{price}] \leavevmode
Calculated price for the given call (empty if \emph{Display billing details to client} is disabled)

\item[{direction}] \leavevmode
Possible values: inbound, outbound.

\item[{ddiId}] \leavevmode
Empty for wholesale clients

\item[{endpointType}] \leavevmode
Empty for wholesale clients

\item[{endpointId}] \leavevmode
Empty for wholesale clients

\item[{endpointName}] \leavevmode
Empty for wholesale clients

\end{description}
\end{quote}

Client types are order from the most feature-full to the most lightweight one.


\chapter{User Portal}
\label{user_portal/index:userportal}\label{user_portal/index:user-portal}\label{user_portal/index::doc}
{\hyperref[administration_portal/brand/clients/virtual_pbx:virtual\string-pbx]{\sphinxcrossref{\DUrole{std,std-ref}{Virtual PBX}}}} clients have an additional role apart from god, brand and client: \textbf{user role}.

As remaining IvozProvider levels, final users have an independent web portal.

This section will cover these topics:


\section{URLs}
\label{user_portal/urls::doc}\label{user_portal/urls:urls}
Prior to accessing to user portal, the URL addresses must be configured (domains
in these URLs must point to any of the public IP addresses of the platform).

2 roles can perform this task:


\subsection{God operator}
\label{user_portal/urls:god-operator}
In the section \textbf{Platform configuration \textgreater{} Brands} you can configure as many
user URLs as you wish, using the button \textbf{Portal list} of each brand.

\begin{notice}{note}{Note:}
URLs are linked to brands and god operator may choose where to create
one shared user portal URL for all the clients of a brand or creating
one per client.
\end{notice}

\begin{notice}{warning}{Warning:}
URLs MUST be HTTPS.
\end{notice}

This section also allows setting a logo per URL, a theme and a phrase to use as
the title of user portal.

\begin{notice}{hint}{Hint:}
This allows creating corporate user portals.
\end{notice}


\subsection{Brand Operator}
\label{user_portal/urls:brand-operator}
Brand Operator can also perform this same task in order to configure the user
portal URLs of his clients.

This way, he can choose whether to configure one URL per Client (with custom
domains, logos, theme and title) or sharing a global URL for all of them.

The section to do this is \textbf{Brand configuration \textgreater{} Portal URLs}.


\section{Credentials}
\label{user_portal/credentials:credentials}\label{user_portal/credentials::doc}
Access credentials to user portal are configured in \textbf{Client configuration \textgreater{}
Users} section.

Specifically:
\begin{itemize}
\item {} 
\textbf{Login information} block, the access of each user is enabled or disabled.

\item {} 
You can set the \textbf{Password} too.

\item {} 
To log in the user portal, the user must use his/her email address.

\end{itemize}

\begin{notice}{warning}{Warning:}
The \textbf{email} of each user MUST be \textbf{globally unique}.
\end{notice}


\section{Features}
\label{user_portal/features::doc}\label{user_portal/features:features}
IvozProvider provides a web portal where final users can do the following
actions:
\begin{itemize}
\item {} 
See all calls he or she has been involved.

\item {} 
Configure call forwards:
\begin{itemize}
\item {} 
To voicemail

\item {} 
To an internal extension

\item {} 
To an external number

\end{itemize}

\item {} 
Enable functionalities:
\begin{itemize}
\item {} 
Call waiting

\item {} 
Do Not Disturb

\end{itemize}

\item {} 
See the state of his or her SIP device registration

\end{itemize}

\begin{notice}{note}{Note:}
User portal has a different look-and-feel than remaining portals and is responsive to work with mobile devices.
\end{notice}


\chapter{Security}
\label{security_and_maintenance/security/index:security}\label{security_and_maintenance/security/index::doc}\label{security_and_maintenance/security/index:id1}
IvozProvider is designed to be exposed to Internet, having public IPs on some profile's NICs.

This section talks about included and non-included (but recommended and shipped in all production IvozProvider
installations maintained by \href{https://www.irontec.com}{Irontec}) security mechanisms:


\section{Firewall}
\label{security_and_maintenance/security/firewall:firewall}\label{security_and_maintenance/security/firewall::doc}
\textbf{IvozProvider does not currently include a firewall} but...

\begin{notice}{danger}{Danger:}
We \textbf{strongly encourage any production installation to implement
a firewall} to protect the platform from the wild Internet.
\end{notice}

The protection method could be:
\begin{itemize}
\item {} 
Local firewall based on \href{https://www.netfilter.org/}{iptables}

\item {} 
External firewall

\item {} 
Both

\end{itemize}


\subsection{Exposed ports/services}
\label{security_and_maintenance/security/firewall:exposed-ports-services}
These are the \textbf{ports IvozProvider needs to expose} to work properly:

\textbf{Client side SIP signalling}:
\begin{itemize}
\item {} 
Port 5060 (TCP/UDP)

\item {} 
Port 5061 (TCP)

\item {} 
Port 10080 (TCP) for Websocket connections (WS).

\item {} 
Port 10081 (TCP) for Websocket secure connections (WSS).

\end{itemize}

\textbf{Provider side SIP signalling}:
\begin{itemize}
\item {} 
Port 5060 (TCP/UDP)

\item {} 
Port 5061 (TCP)

\end{itemize}

\begin{notice}{note}{Note:}
Port 7060 (TCP/UDP) y 7061 TCP in case both proxies share a unique IP address.
\end{notice}

\textbf{RTP audioflow}:
\begin{itemize}
\item {} 
Port range 13000-19000 UDP

\end{itemize}

\textbf{Web portal and provisioning}:
\begin{itemize}
\item {} 
Ports TCP 80, 443, 1443, 2443 and 3443

\end{itemize}

\begin{notice}{hint}{Hint:}
We recommend using any \textbf{geoIP blocking} mechanism to drop connections from
countries without clients.
\end{notice}


\section{SIP Antiflooding}
\label{security_and_maintenance/security/antiflooding::doc}\label{security_and_maintenance/security/antiflooding:sip-antiflooding}\label{security_and_maintenance/security/antiflooding:id1}
SIP Proxies included in IvozProvider installation for SIP signalling use
\href{http://kamailio.org/docs/modules/5.1.x/modules/pike.html}{PIKE module} to avoid DoS attacks.

This module keeps trace of incoming request's IP address and blocks the ones that exceed the limit on a given time
interval.

\begin{notice}{warning}{Warning:}
\textbf{IPs are not blocked permanently}, they are blocked for 5 minutes. After this time, they are allowed again
as long as their incoming request rate don't exceed the limit.
\end{notice}

\begin{notice}{tip}{Tip:}
{\hyperref[administration_portal/platform/antiflood_banned_ips:antiflood\string-banned\string-ips]{\sphinxcrossref{\DUrole{std,std-ref}{Antiflood banned IPs}}}} shows a list of addresses that have been banned at some point.
\end{notice}

Current configuration parameters are:
\begin{itemize}
\item {} 
\textbf{Sampling time interval}: 2 seconds.

\item {} 
\textbf{Threshold per time unit}: 100 requests.

\end{itemize}

This means that \emph{any IP address that sends more than 100 requests in a 2-second-time-interval will be blocked (ignored)
for 5 minutes. After this time, it will be unblocked and its request rate will be evaluated again}.

\begin{notice}{note}{Note:}
Be aware that some requests are not taken into account by antiflood, continue reading please.
\end{notice}


\subsection{Which requests are taken into account in KamUsers?}
\label{security_and_maintenance/security/antiflooding:which-requests-are-taken-into-account-in-kamusers}
Client side requests usually traverse 2 different phases:
\begin{itemize}
\item {} 
Step 0: initial checks, endpoint identification and authentication.

\item {} 
Step 1: remaining logic.

\end{itemize}

Antiflood will take into account:
\begin{itemize}
\item {} 
Requests failing during step 0:
\begin{itemize}
\item {} 
Requests not using SIP domain in KamUsers (except wholesale).

\item {} 
Requests from non-existing AoRs in KamUsers.

\item {} 
Requests failing SIP authentication with wrong passwords in KamUsers.

\end{itemize}

\item {} 
Initial INVITE requests reaching step 1 (aka: new call establishments of legitimate clients).

\end{itemize}

\begin{notice}{tip}{Tip:}
Note that antiflood will not take into account successful REGISTER/SUBSCRIBE cycles.
\end{notice}


\subsection{Which requests are taken into account in KamTrunks?}
\label{security_and_maintenance/security/antiflooding:which-requests-are-taken-into-account-in-kamtrunks}
Antiflood will take into account:
\begin{itemize}
\item {} 
SIP OPTIONS from non-DDIproviders.

\item {} 
Non-DDIproviders talking to KamTrunks.

\end{itemize}

\begin{notice}{tip}{Tip:}
Note that antiflood will not take into account DDI Provider requests to KamTrunks.
\end{notice}


\section{GeoIP filter}
\label{security_and_maintenance/security/geoip_filter:geoip-filter}\label{security_and_maintenance/security/geoip_filter::doc}\label{security_and_maintenance/security/geoip_filter:id1}
{\hyperref[administration_portal/client/vpbx/index:vpbx\string-clients]{\sphinxcrossref{\DUrole{std,std-ref}{Virtual PBX clients}}}}, {\hyperref[administration_portal/client/retail/index:retail\string-clients]{\sphinxcrossref{\DUrole{std,std-ref}{Retail Clients}}}} and {\hyperref[administration_portal/client/residential/index:residential\string-clients]{\sphinxcrossref{\DUrole{std,std-ref}{Residential Clients}}}} can allow traffic from
IPs addresses belonging to chosen countries with the combination of \textbf{Filter by IP address} field and \textbf{GeoIP countries} selector.

\begin{notice}{warning}{Warning:}
On {\hyperref[administration_portal/client/wholesale/index:wholesale\string-clients]{\sphinxcrossref{\DUrole{std,std-ref}{Wholesale clients}}}} there is no \textbf{Filter by IP address} field as this type of clients are authenticated by IP.
\end{notice}

Selecting a country will allow traffic from all addresses of that country. If you want to allow specific IPs, use
{\hyperref[security_and_maintenance/security/authorized_ip_ranges:client\string-authorized\string-ip\string-ranges]{\sphinxcrossref{\DUrole{std,std-ref}{Authorized IP ranges}}}} instead.

\begin{notice}{error}{Error:}
Enabling \textbf{Filter by IP address} and leaving blank both \textbf{GeoIP countries} and \textbf{List of authorized sources}
will prevent all calls.
\end{notice}
\phantomsection\label{security_and_maintenance/security/authorized_ip_ranges:client-authorized-ip-ranges}

\section{Authorized IP ranges}
\label{security_and_maintenance/security/authorized_ip_ranges:client-authorized-ip-ranges}\label{security_and_maintenance/security/authorized_ip_ranges::doc}\label{security_and_maintenance/security/authorized_ip_ranges:authorized-ip-ranges}\label{security_and_maintenance/security/authorized_ip_ranges:id1}
{\hyperref[administration_portal/client/vpbx/index:vpbx\string-clients]{\sphinxcrossref{\DUrole{std,std-ref}{Virtual PBX clients}}}}, {\hyperref[administration_portal/client/retail/index:retail\string-clients]{\sphinxcrossref{\DUrole{std,std-ref}{Retail Clients}}}} and {\hyperref[administration_portal/client/residential/index:residential\string-clients]{\sphinxcrossref{\DUrole{std,std-ref}{Residential Clients}}}} can add IP addresses or ranges
(in CIDR format) with the combination of \textbf{Filter by IP address} field and \textbf{List of authorized sources} subsection.

\begin{notice}{warning}{Warning:}
On {\hyperref[administration_portal/client/wholesale/index:wholesale\string-clients]{\sphinxcrossref{\DUrole{std,std-ref}{Wholesale clients}}}} there is no \textbf{Filter by IP address} field as this type of clients are authenticated by IP, making
filling \textbf{List of wholesale addresses} mandatory.
\end{notice}

When \textbf{Filter by IP address} is enabled, users won't be allowed to connect from another network, even if they have
valid SIP credentials.

\begin{notice}{error}{Error:}
Enabling \textbf{Filter by IP address} and leaving blank both \textbf{GeoIP countries} and \textbf{List of authorized sources}
will prevent all calls.
\end{notice}

\begin{notice}{tip}{Tip:}
Addresses listed in {\hyperref[administration_portal/brand/views/ipfilter_blocked_addresses:ip\string-filter\string-blocked\string-addresses]{\sphinxcrossref{\DUrole{std,std-ref}{IP filter blocked addresses}}}} gives a clue of legitimate sources that should be
added in \textbf{List of authorized sources} subsection.
\end{notice}


\subsection{Roadwarrior users}
\label{security_and_maintenance/security/authorized_ip_ranges:id2}\label{security_and_maintenance/security/authorized_ip_ranges:roadwarrior-users}
Some vPBX clients have roadwarrior users that travel often and connect from external
networks, forcing Clients to disable the IP filter security mechanism.

To solve this issue, there is a user option called \textbf{Calls from non-granted IPs}
that enables these users to call from non-granted IPs while remaining users' credentials
are still protected with IP filter mechanism.

When users like these call from non-granted IPs, their amount of concurrent
outgoing calls are limited to 1, 2 or 3 to avoid being a security breach.

\begin{notice}{note}{Note:}
Only \textbf{generated calls} (both internals and externals) are limited,
received calls are not affected by this setting.
\end{notice}

To sum up, with this feature:
\begin{itemize}
\item {} 
There are users that are allowed to make a fixed amount of calls from
non-granted IPs.

\item {} 
These calls from non-granted IPs are counted and limited.

\end{itemize}
\paragraph{Example 1 - Client without IP check}

It doesn't matter if the user is allowed to make calls from non-granted IPs,
as there are no non-granted IPs.
\paragraph{Example 2 - Client with IP check}
\begin{itemize}
\item {} 
If the user is calling from one of the allowed IPs,
it doesn't matter if the user is allowed to make calls from non-granted IPs:
this calls are not counted nor limited.

\item {} 
If the user is NOT calling from one of the allowed IPs, it is verified the
amount of calls that this user is allowed to make. If the user is allowed to
make calls from non-granted IPs and has not exceeded his limit, the call is
granted and counted.

\end{itemize}

To sum up, if \textbf{Calls from non-granted IPs} is set to \emph{None} the user must fulfill the IP policy of the client.


\section{Concurrent call limit}
\label{security_and_maintenance/security/concurrent_call_limit::doc}\label{security_and_maintenance/security/concurrent_call_limit:concurrent-call-limit}
This mechanism \textbf{limits the number of concurrent calls} of each client/brand.

\begin{notice}{note}{Note:}
Both incoming external calls and outgoing external calls will be limited.
\end{notice}

It can be configured at two levels:
\begin{itemize}
\item {} 
At Brand level with \textbf{Max calls} setting.

\item {} 
At Client level with \textbf{Max calls} setting.

\end{itemize}

A brand clients' \emph{Max calls} sum may be bigger than brand's \emph{Max calls} value, there is no control to avoid this situation.

\begin{notice}{warning}{Warning:}
These counters are independent. Whenever one of this counter reaches its limit, call will be denied. This
means that a call from a client that has not exceeded it own \emph{Max call} setting may be denied if brand's
limit has been exceeded.
\end{notice}

\begin{notice}{tip}{Tip:}
To disable this mechanism, set its value to 0.
\end{notice}


\section{Current day max usage}
\label{security_and_maintenance/security/current_day_max_usage:current-day-max-usage}\label{security_and_maintenance/security/current_day_max_usage::doc}\label{security_and_maintenance/security/current_day_max_usage:id1}
CGRateS calculates price for every external outgoing call placed through non-externally-rated Carrier (see {\hyperref[administration_portal/brand/billing/index:billing]{\sphinxcrossref{\DUrole{std,std-ref}{Billing}}}}).

Total amount of money spent within a day can be limited using this feature, avoiding call toll fraud (or at least
reducing damages).

Take into account that \textbf{depending on BillingMethod current day max usage will be updated during a call or only on call hang up}:
\begin{itemize}
\item {} 
\textbf{Postpaid}: when a call is hung up, counter is updated. If threshold is exceeded, all calls of that client will be hung up.

\item {} 
\textbf{Pseudo-prepaid}: equal to postpaid, as credit is not updated during a call.

\item {} 
\textbf{Prepaid}: credit is updated during a call, so as soon as max daily usage is reached, all calls of the client will be hung up.

\end{itemize}

\begin{notice}{tip}{Tip:}
Set a reasonable limit for every client so that abnormal money usage is automatically blocked.
\end{notice}

More information at {\hyperref[administration_portal/brand/billing/current_day_usages:current\string-day\string-usages]{\sphinxcrossref{\DUrole{std,std-ref}{Current day usages}}}}.


\section{Anti brute-force attacks}
\label{security_and_maintenance/security/antibruteforce:anti-brute-force-attacks}\label{security_and_maintenance/security/antibruteforce::doc}\label{security_and_maintenance/security/antibruteforce:id1}
IvozProvider ships a simple anti brute-force attack in KamUsers that bans sources after continuous SIP auth failures
from same IP address.

It works like this:
\begin{itemize}
\item {} 
On SIP failures (invalid user or invalid password cases only), a counter is increased:
\begin{itemize}
\item {} \begin{description}
\item[{Key: \href{mailto:fromUsername@fromDomain}{fromUsername@fromDomain}::source\_ip}] \leavevmode\begin{itemize}
\item {} 
e.g. \href{mailto:terminal@vpbx.domain.net}{terminal@vpbx.domain.net}::1.2.3.4

\end{itemize}

\end{description}

\end{itemize}

\item {} 
Counter is increased on every failure.

\item {} 
When counter reaches 100, that specific source (user + domain + ip) is banned for 12 hours.

\end{itemize}

After 12 hours, source is accepted again and:
\begin{itemize}
\item {} 
Counter starts counting again from 80.

\item {} 
If it reaches 100 again, it is banned for another 12 hours.

\end{itemize}

\begin{notice}{tip}{Tip:}
See {\hyperref[administration_portal/brand/views/bruteforce_attacks:brute\string-force\string-attacks]{\sphinxcrossref{\DUrole{std,std-ref}{Brute-force attacks}}}} for currently blocked sources.
\end{notice}


\chapter{Troubleshooting}
\label{security_and_maintenance/maintenance/index::doc}\label{security_and_maintenance/maintenance/index:troubleshooting}
This section talks about included and non-included (but recommended and shipped in all production IvozProvider
installations maintained by \href{https://www.irontec.com}{Irontec}) tools to troubleshoot any problem you may have:


\section{Analyzing SIP traffic}
\label{security_and_maintenance/maintenance/sip_captures:analyzing-sip-traffic}\label{security_and_maintenance/maintenance/sip_captures::doc}
Although all production IvozProvider installations maintained by
\href{https://www.irontec.com}{Irontec} include a \href{https://www.sipcapture.org/}{Homer SIP Capture Server}, it is not installed in the standalone version
of IvozProvider. The reason behind this is that we prefer awesome SIPCAPTURE
stack running on an additional machine.

\href{https://github.com/irontec/sngrep}{sngrep Ncurses SIP Messages flow viewer developed by Irontec} is currently
the preferred tool to inspect SIP traffic included in IvozProvider.

\noindent\sphinxincludegraphics{{sngrep_sample}.png}


\subsection{sngrep}
\label{security_and_maintenance/maintenance/sip_captures:sngrep}
See live SIP traffic (all):

\begin{Verbatim}[commandchars=\\\{\}]
\PYG{g+go}{sngrep}
\end{Verbatim}

See live SIP traffic related to calls:

\begin{Verbatim}[commandchars=\\\{\}]
\PYG{g+go}{sngrep \PYGZhy{}c}
\end{Verbatim}

See live SIP traffic and capture RTP too:

\begin{Verbatim}[commandchars=\\\{\}]
\PYG{g+go}{sngrep \PYGZhy{}c \PYGZhy{}r}
\end{Verbatim}

For more reference, visit \href{https://github.com/irontec/sngrep}{sngrep official site}.


\subsection{Other capturing tools}
\label{security_and_maintenance/maintenance/sip_captures:other-capturing-tools}
Although sngrep is our preferred capturing tool, IvozProvider ships other tools
to capture SIP/RTP traffic, such as \href{http://www.tcpdump.org}{tcpdump} and
\href{http://ngrep.sourceforge.net}{ngrep}.


\section{Log viewer}
\label{security_and_maintenance/maintenance/log_viewer::doc}\label{security_and_maintenance/maintenance/log_viewer:log-viewer}
Although all production IvozProvider installations maintained by
\href{https://www.irontec.com}{Irontec} include a \href{https://www.elastic.co/elk-stack}{ELK stack}, \href{https://www.freedesktop.org/software/systemd/man/journalctl.html}{journalctl} is currently
the unique tool shipped with IvozProvider to inspect logs generated by different elements of the solution
in the past.


\subsection{Asterisk CLI}
\label{security_and_maintenance/maintenance/log_viewer:asterisk-cli}
Asterisk CLI gives tons of realtime information too and are formatted beautifully
to detect possible configuration errors:

\noindent\sphinxincludegraphics{{asterisk_cli}.png}

You can access Asterisk CLI typing \emph{ast} in the shell.


\subsection{Kamailio realtime log viewing}
\label{security_and_maintenance/maintenance/log_viewer:kamailio-realtime-log-viewing}
You can see Kamailio logs in realtime too typing \emph{kamtail-proxyusers} and
\emph{kamtail-proxytrunks} in the shell:

\noindent\sphinxincludegraphics{{kamtail}.png}


\section{Other tools}
\label{security_and_maintenance/maintenance/other_tools::doc}\label{security_and_maintenance/maintenance/other_tools:other-tools}
Although IvozProvider does not include any of the tools mentioned here, we consider them crucial for dealing with
production environments.

We list here tools configured in all production IvozProvider installations maintained by
\href{https://www.irontec.com}{Irontec}.


\subsection{Metrics viewer}
\label{security_and_maintenance/maintenance/other_tools:metrics-viewer}
\href{https://www.influxdata.com/time-series-platform/chronograf/}{Chronograf web interface}
showing information collected by remaining \href{https://www.influxdata.com/time-series-platform/}{TICK Stack components},
allow us to show:
\begin{itemize}
\item {} 
Realtime system metrics.

\item {} 
Realtime VoIP metrics.

\item {} 
Custom dashboard per profile.

\end{itemize}

\href{https://www.influxdata.com/time-series-platform/kapacitor/}{Kapacitor component} allows setting alarms when anomalous
metrics happen or certain thresholds are exceeded.


\subsection{Active monitoring}
\label{security_and_maintenance/maintenance/other_tools:active-monitoring}
All IvozProvider installations maintained by \href{https://www.irontec.com}{Irontec} are thoroughly monitored to solve problems
as soon as possible and to prevent future problems when possible.


\chapter{Introduction to IvozProvider API}
\label{api_rest/introduction:introduction-to-ivozprovider-api}\label{api_rest/introduction::doc}
Ivoz Provider offers three \href{https://en.wikipedia.org/wiki/HATEOAS}{hypermedia}-driven REST APIs, one for each admin role. The three of them have been built over
\href{https://www.openapis.org/}{OpenAPI Specification}, a community-driven open specification within the OpenAPI
Initiative, a Linux Foundation Collaborative Project. This initiative is supported by some leading tech companies
such as Adobe, Google, IBM, Microsoft and \href{https://www.openapis.org/membership/members)}{more}.

We support the features below:
\begin{itemize}
\item {} 
Nice human-readable specification, including a sandbox

\item {} 
JSON Web Token (JWT) based authentication

\item {} 
Request and response content type negotiation

\item {} 
Result pagination

\item {} 
Response property filters

\item {} 
Result filters

\item {} 
Result ordering

\item {} 
Security layer: Resource and record access control

\end{itemize}


\chapter{Multi-level API}
\label{api_rest/multilevel::doc}\label{api_rest/multilevel:multi-level-api}
IvozProvider API is divided in same three levels as the web administration portal plus user API:
\begin{itemize}
\item {} 
God

\item {} 
Brand

\item {} 
Client

\item {} 
User

\end{itemize}

This split allows different roles with different responsibilities to be integrated against it without compromising
security (read, edit, update or delete the data they should not).

If you check out \href{https://github.com/irontec/ivozprovider/blob/bleeding/web/rest/brand/config/api/raw/provider.yml}{security policies}
(read\_access\_control and write\_access\_control attributes), you’ll see that we apply
read filters and write validations based on user information (token). One single API approach would require a complex
validations more prone to failure, introduce errors and require huge queries that would impact the performance.

\begin{notice}{note}{Note:}
That is why we split it into three APIs with \textbf{impersonate mechanism} to move between them. This mechanism is
explained in {\hyperref[api_rest/use_case:use\string-case]{\sphinxcrossref{\DUrole{std,std-ref}{Use Case}}}} section.
\end{notice}

In order to access to each level, \textbf{you will need a corresponding level URL and credentials}:
\paragraph{God API access}
\begin{itemize}
\item {} 
Credentials: God credentials defined in {\hyperref[administration_portal/platform/main_operators:main\string-operators]{\sphinxcrossref{\DUrole{std,std-ref}{Main operators}}}}.

\end{itemize}
\paragraph{Brand API access}
\begin{itemize}
\item {} 
Credentials: Brand credentials defined in {\hyperref[administration_portal/platform/brands:brand\string-operators]{\sphinxcrossref{\DUrole{std,std-ref}{Brand operators}}}}.

\end{itemize}
\paragraph{Client API access}
\begin{itemize}
\item {} 
Credentials: Client credentials defined in {\hyperref[administration_portal/brand/clients/operators:client\string-operators]{\sphinxcrossref{\DUrole{std,std-ref}{Client Operators}}}}.

\end{itemize}
\paragraph{User API access}
\begin{itemize}
\item {} 
Credentials: User credentials defined in {\hyperref[administration_portal/client/vpbx/users:users]{\sphinxcrossref{\DUrole{std,std-ref}{Users}}}}.

\end{itemize}

\begin{notice}{warning}{Warning:}
All credentials usernames are unique at brand level. This is why \emph{username + brand URL} duple is needed to
identify a user (both in API and in web portal).
\end{notice}

\begin{notice}{tip}{Tip:}
As both brand and client URLs are internally linked to the same brand (client within that brand), it is also
possible to access to client API using a brand URL + /api/client.
\end{notice}


\chapter{Built-in web client}
\label{api_rest/web_client:built-in-web-client}\label{api_rest/web_client::doc}
APIs come with their own web client so that you can test them easily. Go to Platform API for instance.

\noindent{\hspace*{\fill}\sphinxincludegraphics{{web-client}.png}\hspace*{\fill}}

You will need to get an access token with some valid admin credentials before anything else. You can do that from {[}Auth{]} \textgreater{} {[}POST /admin\_login{]} section. Click on \sphinxtitleref{Try it out} button, set your credentials and click on \sphinxtitleref{execute} to send the request. You should get a response that contains a token and a refresh token.

\noindent{\hspace*{\fill}\sphinxincludegraphics{{access-token}.png}\hspace*{\fill}}

Copy the token and set it on \sphinxtitleref{Authorize} button at the top of the page. The token ttl (time to live) is one hour by default, you can use the refresh token then to get a new one without sending admin credentials again.

Once you have got your token properly set, click on {[}GET /administrators{]} endpoint, \sphinxtitleref{Try it out} and \sphinxtitleref{Execute}. You may want to switch \sphinxtitleref{Response content type} as well (JSON or LD+JSON for this endpoint).

\noindent{\hspace*{\fill}\sphinxincludegraphics{{response}.png}\hspace*{\fill}}

It's possible to filter and sort response using \sphinxtitleref{Parameters} input fields as well.
\paragraph{Specification}

You can check out request and response models from the web client itself.

\noindent{\hspace*{\fill}\sphinxincludegraphics{{spec}.png}\hspace*{\fill}}


\chapter{Third party integrations}
\label{api_rest/integrations:third-party-integrations}\label{api_rest/integrations::doc}
Ivoz Provider makes use of \textbf{OpenAPI Specification 2.0} (which is identical to the Swagger 2.0 specification before it was
renamed to ``OpenAPI Specification'').

APIs are supposed to be the way to integrate third party applications with IvozProvider. Some community tools, such as
\href{https://github.com/swagger-api/swagger-codegen}{swagger-codegen}, may be of great help during the client development.
According to their github page the following language/framework code auto-generation is supported:
\begin{itemize}
\item {} 
ActionScript

\item {} 
Ada

\item {} 
Apex

\item {} 
Bash

\item {} 
C\# (.net 2.0, 3.5 or later)

\item {} 
C++ (cpprest, Qt5, Tizen)

\item {} 
Clojure

\item {} 
Dart

\item {} 
Elixir

\item {} 
Elm

\item {} 
Eiffel

\item {} 
Erlang

\item {} 
Go

\item {} 
Groovy

\item {} 
Haskell (http-client, Servant)

\item {} 
Java (Jersey1.x, Jersey2.x, OkHttp, Retrofit1.x, Retrofit2.x, Feign, RestTemplate, RESTEasy, Vertx, Google API Client Library for Java, Rest-assured)

\item {} 
Kotlin

\item {} 
Lua

\item {} 
Node.js (ES5, ES6, AngularJS with Google Closure Compiler annotations)

\item {} 
Objective-C

\item {} 
Perl

\item {} 
PHP

\item {} 
PowerShell

\item {} 
Python

\item {} 
R

\item {} 
Ruby

\item {} 
Rust (rust, rust-server)

\item {} 
Scala (akka, http4s, swagger-async-httpclient)

\item {} 
Swift (2.x, 3.x, 4.x)

\item {} 
Typescript (Angular1.x, Angular2.x, Fetch, jQuery, Node)

\end{itemize}

You'll find API specs in the URLs below:
\begin{itemize}
\item {} 
Platform API spec

\item {} 
Brand API spec

\item {} 
Client API spec

\end{itemize}


\chapter{Use Case}
\label{api_rest/use_case:use-case}\label{api_rest/use_case::doc}\label{api_rest/use_case:id1}
Let's put a little use case as an example: A platform admin wants to obtain the companies of one specific brand (companies are exposed on Brand API only). The operation would be:
\paragraph{On platform API (https://your-domain/api/platform)}
\begin{enumerate}
\item {} 
Login (request a token) as god admin on /admin\_login

\item {} 
Search target brand on /brands

\end{enumerate}
\paragraph{On Brand API (https://brand-domain/api/brand)}
\begin{enumerate}
\item {} 
Impersonate as a brand admin on Auth\textgreater{} /token/exchange (requires a god token and the brand Id. You can impersonate by the username of a brand administrator instead of a brand id as well)

\item {} 
Request brand companies using the endpoint /companies

\end{enumerate}


\chapter{ACLs}
\label{api_rest/acls:acls}\label{api_rest/acls::doc}\label{api_rest/acls:id1}
Credentials used for web access can be used with their API corresponding level. These administrators (global, brand, client)
have full access to all endpoints of their level.

Since 2.15, it is possible to create \textbf{restricted administrators} too.


\section{Restricted global/brand administrators}
\label{api_rest/acls:restricted-global-brand-administrators}
Enabling global/brand administrator \textbf{Restricted} option makes this administrator special:
\begin{itemize}
\item {} 
Cannot be used anymore to access web portal.

\item {} 
Full API endpoint access is restricted to read-only access to those endpoints.

\end{itemize}

Privileges can be fine-tuned in \emph{List of Administrator access privileges} subsection, where you can enable/disable
for each endpoint:
\begin{quote}
\begin{description}
\item[{Create privilege}] \leavevmode
Administrator with this privilege can create new items of given endpoint.

\item[{Read privilege}] \leavevmode
Administrator with this privilege can read existing items of given endpoint. Just watch existing items, no
modification is allowed.

\item[{Update privilege}] \leavevmode
Administrator with this privilege can modify existing items of given endpoint.

\item[{Delete privilege}] \leavevmode
Administrator with this privilege can delete existing items of given endpoint.

\end{description}
\end{quote}

\begin{notice}{note}{Note:}\begin{itemize}
\item {} 
Changing a non-rectricted administrator to restricted turns it into a read-only API-capable administrator.

\item {} 
Changing a restricted administrator to non-restricted turns it into a full access web+API capable administrator.

\end{itemize}
\end{notice}

\begin{notice}{hint}{Hint:}
You can easily select multiple endpoints in \emph{List of Administrator access privileges} and revoke/grant them all.
\end{notice}


\section{Client restricted administrators}
\label{api_rest/acls:client-restricted-administrators}
Opposed to global/brand administrators, \textbf{client restricted administrators can login into client web portal}. As a
consequence, privileges of a given client administrator apply to:
\begin{itemize}
\item {} 
Privileges for API integrations.

\item {} 
Web access to sections and available operations in those sections.

\end{itemize}

Privileges can be fine-tuned in \emph{List of Administrator access privileges} subsection too.
\paragraph{Example 1: Recordings-only client administrator}

To create a client administrator that only sees Recordings section:
\begin{enumerate}
\item {} 
Create a new restricted client administrator or turn a non-rectricted one into restricted.

\item {} 
Access to \textbf{List of Administrator access privileges}, select all endpoints and press \textbf{Revoke access}.

\item {} 
Edit \emph{Recordings} endpoint and enable Read access.

\end{enumerate}
\paragraph{Example 2: Fax-only client administrator}

To create a client administrator that only sees Fax section and can send/receive faxes:
\begin{enumerate}
\item {} 
Create a new restricted client administrator or turn a non-restricted one into restricted.

\item {} 
Access to \textbf{List of Administrator access privileges}, select all endpoints and press \textbf{Revoke access}.

\item {} 
Edit \emph{Faxes} endpoint and enable Read access.

\item {} 
Edit \emph{FaxesFiles} endpoint and enable Create/Update access.

\end{enumerate}



\renewcommand{\indexname}{Index}
\printindex
\end{document}
